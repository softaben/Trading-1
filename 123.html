<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion - Bon de Livraison</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== STYLES GENERAUX ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ===== HEADER ===== */
        .header {
            text-align: center;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* ===== SECTIONS PRINCIPALES ===== */
        .app-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            flex: 1;
            min-width: 350px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        
        /* ===== FORMULAIRES & TABLES ===== */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }

        /* ===== BON DE LIVRAISON (ECRAN) ===== */
        .delivery-note-screen {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* ===== STYLE DU BON (COMMUN PRINT/SCREEN) ===== */
        .delivery-header { text-align: center; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; }
        .company-name { font-size: 24px; font-weight: bold; }
        .delivery-title { text-align: center; font-size: 22px; margin: 20px 0; font-weight: bold; text-decoration: underline; }
        .delivery-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .delivery-table { width: 100%; border: 1px solid #333; }
        .delivery-table th { background: #2c3e50; color: white; border: 1px solid #333; text-align: center; }
        .delivery-table td { border: 1px solid #333; text-align: center; }
        .signature-area { display: flex; justify-content: space-between; margin-top: 40px; }
        .signature-box { width: 40%; text-align: center; border-top: 1px solid #333; padding-top: 10px; }

        /* ===== GESTION DE L'IMPRESSION ===== */
        .print-only { display: none; }

        @media print {
            /* إخفاء كل شيء في الصفحة */
            body * { visibility: hidden; }
            /* إظهار منطقة الطباعة فقط */
            .print-only, .print-only * { visibility: visible; }
            .print-only {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* تحسينات إضافية للطباعة */
            @page { size: A4; margin: 15mm; }
            .delivery-table th { background-color: #eee !important; color: black !important; -webkit-print-color-adjust: exact; }
        }

        .status-low { color: red; font-weight: bold; }
        .status-ok { color: green; }
        .message { padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-invoice"></i> Gestion des Bons de Livraison</h1>
            <p>Entreprise: ETTIJARA ALAAMA SOUSS</p>
        </div>

        <div class="app-wrapper">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-warehouse"></i> Stock</h2>
                <div id="message" class="message"></div>
                <div class="form-group">
                    <label>Produit</label>
                    <input type="text" id="productName" value="DALAA MOUCHOIR 550">
                </div>
                <div class="form-group">
                    <label>Quantité</label>
                    <input type="number" id="productQuantity" value="100">
                </div>
                <div class="form-group">
                    <label>Prix Unit (DH)</label>
                    <input type="number" id="productPrice" value="142">
                </div>
                <button class="btn btn-primary" id="addProduct">Ajouter au Stock</button>
                
                <table>
                    <thead>
                        <tr><th>Produit</th><th>Stock</th><th>Prix</th><th>Etat</th></tr>
                    </thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title"><i class="fas fa-truck"></i> Livraison</h2>
                <div class="form-group">
                    <label>Client</label>
                    <input type="text" id="clientName" value="EL MANSOURI">
                </div>
                <div class="form-group">
                    <label>Produit</label>
                    <select id="selectedProduct"></select>
                </div>
                <div class="form-group">
                    <label>Quantité à livrer</label>
                    <input type="number" id="deliveryQuantity" value="1">
                </div>
                <button class="btn btn-success" id="addToDelivery">Ajouter à la liste</button>
                <button class="btn btn-primary" id="generateNote">Générer le Bon</button>

                <table id="deliveryItemsTable">
                    <thead><tr><th>Produit</th><th>Qté</th><th>Total</th><th>Action</th></tr></thead>
                    <tbody id="deliveryItems"></tbody>
                </table>
            </div>
        </div>

        <div class="delivery-note-screen" id="deliveryNoteScreen">
            <h2 class="section-title">Aperçu avant impression</h2>
            <div id="previewContent"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" id="printBtn"><i class="fas fa-print"></i> Imprimer maintenant</button>
                <button class="btn btn-danger" onclick="location.reload()">Annuler</button>
            </div>
        </div>
    </div>

    <div class="print-only" id="printArea"></div>

    <script>
        let inventory = [{ id: 1, name: "DALAA MOUCHOIR 550", quantity: 100, price: 142 }];
        let deliveryList = [];

        function updateUI() {
            const invBody = document.getElementById('inventoryBody');
            const select = document.getElementById('selectedProduct');
            invBody.innerHTML = '';
            select.innerHTML = '<option value="">-- Choisir --</option>';

            inventory.forEach(p => {
                invBody.innerHTML += `<tr><td>${p.name}</td><td>${p.quantity}</td><td>${p.price}</td><td class="${p.quantity<10?'status-low':'status-ok'}">${p.quantity<10?'Bas':'OK'}</td></tr>`;
                if(p.quantity > 0) select.innerHTML += `<option value="${p.id}">${p.name} (${p.quantity})</option>`;
            });
        }

        document.getElementById('addProduct').onclick = () => {
            const name = document.getElementById('productName').value;
            const q = parseInt(document.getElementById('productQuantity').value);
            const p = parseFloat(document.getElementById('productPrice').value);
            if(name && q >= 0) {
                inventory.push({id: Date.now(), name, quantity: q, price: p});
                updateUI();
            }
        };

        document.getElementById('addToDelivery').onclick = () => {
            const id = parseInt(document.getElementById('selectedProduct').value);
            const q = parseInt(document.getElementById('deliveryQuantity').value);
            const product = inventory.find(p => p.id === id);

            if(product && q <= product.quantity && q > 0) {
                deliveryList.push({...product, deliveryQty: q});
                renderDeliveryList();
            } else {
                alert("Quantité insuffisante ou produit non sélectionné");
            }
        };

        function renderDeliveryList() {
            const body = document.getElementById('deliveryItems');
            body.innerHTML = '';
            deliveryList.forEach((item, index) => {
                body.innerHTML += `<tr><td>${item.name}</td><td>${item.deliveryQty}</td><td>${(item.deliveryQty * item.price).toFixed(2)} DH</td><td><button class="btn-danger" onclick="deliveryList.splice(${index},1);renderDeliveryList()">X</button></td></tr>`;
            });
        }

        document.getElementById('generateNote').onclick = () => {
            if(deliveryList.length === 0) return alert("La liste est vide");
            const html = createNoteHTML();
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('printArea').innerHTML = html;
            document.getElementById('deliveryNoteScreen').style.display = 'block';
            document.getElementById('deliveryNoteScreen').scrollIntoView();
        };

        function createNoteHTML() {
            const client = document.getElementById('clientName').value;
            const date = new Date().toLocaleDateString();
            let rows = '';
            let total = 0;
            deliveryList.forEach(item => {
                const sub = item.deliveryQty * item.price;
                total += sub;
                rows += `<tr><td>${item.name}</td><td>${item.deliveryQty}</td><td>${item.price}</td><td>${sub.toFixed(2)}</td></tr>`;
            });

            return `
                <div class="delivery-header">
                    <div class="company-name">ETTIJARA ALAAMA SOUSS</div>
                    <p>Ait Melloul, Agadir | Tél: 0525265980</p>
                </div>
                <div class="delivery-title">BON DE LIVRAISON</div>
                <div class="delivery-info">
                    <div><strong>Client:</strong> ${client}</div>
                    <div><strong>Date:</strong> ${date}</div>
                </div>
                <table class="delivery-table">
                    <thead><tr><th>Désignation</th><th>Qté</th><th>P.U</th><th>Montant</th></tr></thead>
                    <tbody>${rows}</tbody>
                    <tfoot><tr><th colspan="3" style="text-align:right">TOTAL:</th><th>${total.toFixed(2)} DH</th></tr></tfoot>
                </table>
                <div class="signature-area">
                    <div class="signature-box">Signature Client</div>
                    <div class="signature-box">Signature Entreprise</div>
                </div>
            `;
        }

        document.getElementById('printBtn').onclick = () => {
            window.print();
            // تحديث المخزون بعد الطباعة
            deliveryList.forEach(item => {
                const p = inventory.find(inv => inv.id === item.id);
                if(p) p.quantity -= item.deliveryQty;
            });
            deliveryList = [];
            renderDeliveryList();
            updateUI();
            document.getElementById('deliveryNoteScreen').style.display = 'none';
        };

        updateUI();
    </script>
</body>
</html>
