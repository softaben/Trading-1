<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA - Data-Driven Trading Analysis | ICT Scalping Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .auth-message {
            font-size: 18px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 400px;
        }

        .auth-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .auth-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            padding: 4px 12px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
        }

        .header-btn.primary {
            background-color: var(--notion-green);
            color: white;
        }

        .header-btn.blue {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Main Container */
        .main-container {
            max-width: 1600px;
            margin: 60px auto 20px;
            padding: 0 20px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title-section {
            flex: 1;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--notion-green), var(--notion-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--notion-text-light);
            max-width: 800px;
        }

        /* User Info Banner */
        .user-banner {
            background: linear-gradient(135deg, var(--notion-green-light), var(--notion-blue-light));
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--notion-gray-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .user-banner-content {
            flex: 1;
        }

        .user-banner-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-banner-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--notion-green);
        }

        .user-stat-label {
            font-size: 13px;
            color: var(--notion-text-light);
        }

        /* Filter Section */
        .filter-section {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .filter-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--notion-text);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select {
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            background-color: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 3px rgba(12, 140, 233, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 16px;
            border-top: 1px solid var(--notion-gray);
        }

        .filter-action-btn {
            padding: 10px 20px;
            background-color: var(--notion-gray);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .filter-action-btn:hover {
            background-color: var(--notion-gray-dark);
            transform: translateY(-2px);
        }

        .filter-action-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .filter-action-btn.primary:hover {
            background-color: #0d6c5d;
        }

        .filter-action-btn.blue {
            background-color: var(--notion-blue);
            color: white;
            border-color: var(--notion-blue);
        }

        .filter-action-btn.blue:hover {
            background-color: #0a7ac9;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Analytics Card */
        .analytics-card {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        .analytics-card-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .analytics-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analytics-card-title i {
            font-size: 20px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: var(--notion-gray-light);
            color: var(--notion-green);
        }

        .analytics-card-title h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .analytics-card-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            margin-top: 4px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            flex: 1;
        }

        canvas {
            display: block;
            max-width: 100%;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            padding: 20px;
            background-color: var(--notion-gray-light);
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--notion-gray-dark);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 18px;
        }

        .stat-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .stat-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .stat-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .stat-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .stat-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.positive {
            color: var(--notion-green);
        }

        .stat-value.negative {
            color: var(--notion-red);
        }

        .stat-label {
            font-size: 14px;
            color: var(--notion-text-light);
            margin-bottom: 8px;
        }

        .stat-description {
            font-size: 12px;
            color: var(--notion-text-light);
            font-style: italic;
        }

        /* Insights Card */
        .insights-card {
            background: linear-gradient(135deg, var(--notion-blue-light), var(--notion-purple-light));
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            border: 1px solid var(--notion-blue);
        }

        .insights-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insights-card-header i {
            font-size: 20px;
            color: var(--notion-blue);
        }

        .insights-card-header h3 {
            color: var(--notion-blue);
            font-weight: 600;
            margin: 0;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(12, 140, 233, 0.1);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insight-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .insight-icon.success {
            background-color: rgba(15, 123, 108, 0.1);
            color: var(--notion-green);
        }

        .insight-icon.warning {
            background-color: rgba(255, 107, 53, 0.1);
            color: var(--notion-orange);
        }

        .insight-icon.info {
            background-color: rgba(12, 140, 233, 0.1);
            color: var(--notion-blue);
        }

        .insight-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }

        .insight-action {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-top: 4px;
            font-style: italic;
        }

        /* Performance Badges */
        .performance-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .badge.success {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .badge.warning {
            background-color: var(--notion-yellow-light);
            color: var(--notion-yellow);
        }

        .badge.danger {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .badge.info {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--notion-text-light);
            flex-direction: column;
            gap: 16px;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export Section */
        .export-section {
            background-color: var(--notion-gray-light);
            padding: 24px;
            border-radius: 12px;
            margin-top: 32px;
            text-align: center;
        }

        .export-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
        }

        .export-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 24px;
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background-color: var(--notion-gray);
            transform: translateY(-2px);
        }

        .export-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .export-btn.primary:hover {
            background-color: #0d6c5d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 45px auto 20px;
                padding: 0 16px;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .analytics-card {
                padding: 16px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-banner-stats {
                justify-content: space-between;
            }
            
            .user-stat {
                min-width: 45%;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-banner-stats {
                flex-direction: column;
                gap: 12px;
            }
            
            .user-stat {
                width: 100%;
            }
            
            .export-actions {
                flex-direction: column;
            }
            
            .export-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Print Styles */
        @media print {
            .auth-overlay,
            .header,
            .filter-section,
            .export-section,
            .filter-action-btn {
                display: none !important;
            }
            
            .main-container {
                margin: 0;
                padding: 0;
            }
            
            .analytics-card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Checking authentication...</div>
        <div class="auth-buttons" id="authButtons" style="display: none;">
            <button class="auth-btn primary" id="goToLoginBtn">Go to Login Page</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="workspace-icon" style="width: 20px; height: 20px; background: linear-gradient(135deg, var(--notion-green), var(--notion-blue)); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">DTA</div>
        <div class="header-title">ICT Scalping Journal - Data-Driven Trading Analysis</div>
        <div class="header-actions">
            <a href="dashboard.html" class="header-btn">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
            <button class="header-btn blue" id="printReportBtn">
                <i class="fas fa-print"></i> Print Report
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title-section">
                <h1 class="page-title">ðŸ“ˆ Data-Driven Trading Analysis (DTA)</h1>
                <p class="page-subtitle">Advanced statistical analysis, pattern recognition, and actionable insights derived from your trading performance data</p>
            </div>
            <div class="header-actions">
                <button class="header-btn primary" id="generateReportBtn">
                    <i class="fas fa-file-alt"></i> Generate Full Report
                </button>
            </div>
        </div>

        <!-- User Info Banner -->
        <div class="user-banner" id="userBanner">
            <div class="user-banner-content">
                <div class="user-banner-title">
                    <i class="fas fa-chart-line"></i>
                    <span>Loading your trading analytics profile...</span>
                </div>
                <div class="user-banner-stats" id="userStats">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>
            <div id="performanceBadges" class="performance-badges">
                <!-- Performance badges will be populated by JavaScript -->
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-title">
                <i class="fas fa-sliders-h"></i>
                <span>Analysis Parameters & Timeframe Configuration</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Analysis Period:</span>
                    </label>
                    <select class="filter-select" id="timeframeSelect">
                        <option value="7">Last 7 Days (Weekly Analysis)</option>
                        <option value="30" selected>Last 30 Days (Monthly Analysis)</option>
                        <option value="90">Last 90 Days (Quarterly Analysis)</option>
                        <option value="180">Last 6 Months (Semi-Annual Analysis)</option>
                        <option value="365">Last 12 Months (Annual Analysis)</option>
                        <option value="all">All Historical Data (Full Analysis)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Currency Pairs:</span>
                    </label>
                    <select class="filter-select" id="currencySelect">
                        <option value="all">All Currency Pairs</option>
                        <option value="EURUSD">EUR/USD (Euro-Dollar)</option>
                        <option value="GBPUSD">GBP/USD (Cable)</option>
                        <option value="USDJPY">USD/JPY (Dollar-Yen)</option>
                        <option value="AUDUSD">AUD/USD (Aussie-Dollar)</option>
                        <option value="USDCAD">USD/CAD (Dollar-Loonie)</option>
                        <option value="XAUUSD">XAU/USD (Gold)</option>
                        <option value="custom">Custom Selection...</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-clock"></i>
                        <span>Trading Sessions:</span>
                    </label>
                    <select class="filter-select" id="sessionSelect">
                        <option value="all">All Trading Sessions</option>
                        <option value="London">London Session (08:00-16:00 GMT)</option>
                        <option value="New York">New York Session (13:00-21:00 GMT)</option>
                        <option value="Asian">Asian Session (23:00-07:00 GMT)</option>
                        <option value="Sydney">Sydney Session (22:00-06:00 GMT)</option>
                        <option value="Overlap">Session Overlaps (High Volatility)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-balance-scale"></i>
                        <span>Risk Level:</span>
                    </label>
                    <select class="filter-select" id="riskSelect">
                        <option value="all">All Risk Levels</option>
                        <option value="low">Low Risk (< 1%)</option>
                        <option value="medium" selected>Medium Risk (1-2%)</option>
                        <option value="high">High Risk (> 2%)</option>
                        <option value="extreme">Extreme Risk (> 5%)</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-action-btn" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Reset All Filters
                </button>
                <button class="filter-action-btn primary" onclick="updateAnalytics()">
                    <i class="fas fa-sync-alt"></i> Apply Filters & Update Analysis
                </button>
                <button class="filter-action-btn blue" onclick="saveAnalysisSettings()">
                    <i class="fas fa-save"></i> Save Settings as Preset
                </button>
            </div>
        </div>

        <!-- Analytics Grid -->
        <div id="analyticsContent">
            <div class="loading">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
                <div class="loading-text">Loading comprehensive Data-Driven Trading Analysis...</div>
                <div style="font-size: 14px; color: var(--notion-text-light); max-width: 400px; text-align: center;">
                    Analyzing your trading patterns, calculating statistics, and generating actionable insights
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <div class="export-title">
                <i class="fas fa-download"></i>
                <span>Export Analysis Results</span>
            </div>
            <div class="export-actions">
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i> Export Raw Data (CSV)
                </button>
                <button class="export-btn" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Export Analysis Report (PDF)
                </button>
                <button class="export-btn primary" onclick="exportFullReport()">
                    <i class="fas fa-chart-bar"></i> Generate Complete DTA Report
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let allUserTrades = [];
        let filteredTrades = [];
        let charts = {};
        let analysisResults = {};

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            
            // Setup event listeners
            document.getElementById('printReportBtn').addEventListener('click', printReport);
            document.getElementById('generateReportBtn').addEventListener('click', generateFullReport);
        });

        // Check Authentication - NO GUEST MODE
        async function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            const authButtons = document.getElementById('authButtons');
            
            try {
                // Check Firebase auth state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;
                        await initializePage();
                        authOverlay.classList.add('hidden');
                    } else {
                        // No user signed in - Show login option
                        authMessage.textContent = 'You need to sign in to access Data-Driven Trading Analysis';
                        authButtons.style.display = 'flex';
                        
                        // Setup auth button
                        document.getElementById('goToLoginBtn').onclick = () => {
                            window.location.href = 'index.html';
                        };
                        
                        // Auto-redirect after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 3000);
                    }
                });

            } catch (error) {
                console.error('Auth check error:', error);
                authMessage.textContent = 'Error checking authentication. Please try again.';
                authButtons.style.display = 'flex';
            }
        }

        // Initialize Page for authenticated users
        async function initializePage() {
            if (!currentUser) return;
            
            // Update user info
            updateUserInfo();
            
            // Add resize handler for charts
            window.addEventListener('resize', handleChartResize);
            
            // Load user trades
            await loadUserTrades();
        }

        // Update User Information
        function updateUserInfo() {
            if (!currentUser) return;
            
            const userName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader';
            
            document.getElementById('userBanner').querySelector('.user-banner-title span').textContent = 
                `Data-Driven Analysis for ${userName}`;
        }

        // Handle window resize for charts
        let resizeTimeout;
        function handleChartResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.resize === 'function') {
                        chart.resize();
                        chart.update('none');
                    }
                });
            }, 250);
        }

        // Load User Trades
        async function loadUserTrades() {
            try {
                if (!currentUser) return;
                
                const snapshot = await database.ref('userTrades/' + currentUser.uid + '/trades').once('value');
                allUserTrades = [];
                
                snapshot.forEach((childSnapshot) => {
                    const trade = childSnapshot.val();
                    trade.id = childSnapshot.key;
                    allUserTrades.push(trade);
                });

                // Sort by date (newest first)
                allUserTrades.sort((a, b) => {
                    const dateA = a.createdAt || a.date || 0;
                    const dateB = b.createdAt || b.date || 0;
                    return dateB - dateA;
                });

                // Apply initial filters
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading trades:', error);
                showError('Failed to load your trading data. Please check your connection and try again.');
            }
        }

        // Update Analytics based on filters
        function updateAnalytics() {
            const timeframe = document.getElementById('timeframeSelect').value;
            const currency = document.getElementById('currencySelect').value;
            const session = document.getElementById('sessionSelect').value;
            const riskLevel = document.getElementById('riskSelect').value;
            
            // Filter trades
            filteredTrades = allUserTrades.filter(trade => {
                // Currency filter
                if (currency !== 'all' && trade.pair !== currency) {
                    if (currency !== 'custom') return false;
                }
                
                // Session filter
                if (session !== 'all' && trade.session !== session) {
                    if (session !== 'Overlap' || !['London-New York', 'Asian-London'].includes(trade.session)) return false;
                }
                
                // Risk level filter
                if (riskLevel !== 'all') {
                    const riskPercent = parseFloat(trade.riskPercent) || 0;
                    switch(riskLevel) {
                        case 'low': if (riskPercent >= 1) return false; break;
                        case 'medium': if (riskPercent < 1 || riskPercent > 2) return false; break;
                        case 'high': if (riskPercent <= 2 || riskPercent > 5) return false; break;
                        case 'extreme': if (riskPercent <= 5) return false; break;
                    }
                }
                
                // Timeframe filter
                if (timeframe !== 'all') {
                    const daysAgo = parseInt(timeframe);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                    
                    const tradeDate = new Date(trade.date || trade.createdAt || 0);
                    if (tradeDate < cutoffDate) return false;
                }
                
                return true;
            });
            
            // Update analytics display
            displayAnalytics();
        }

        // Display Analytics
        function displayAnalytics() {
            if (filteredTrades.length === 0) {
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--notion-text-light);">
                        <div style="font-size: 64px; margin-bottom: 16px; color: var(--notion-gray-dark);">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--notion-text);">
                            No Trading Data Found
                        </div>
                        <div style="font-size: 16px; margin-bottom: 24px; max-width: 400px; margin: 0 auto 24px;">
                            No trades match your selected filters. Try adjusting your criteria or add more trades to your journal.
                        </div>
                        <button onclick="resetFilters()" class="filter-action-btn primary" style="margin: 8px;">
                            <i class="fas fa-redo"></i> Reset All Filters
                        </button>
                        <a href="add-trade.html" class="filter-action-btn blue" style="margin: 8px; text-decoration: none;">
                            <i class="fas fa-plus"></i> Add New Trade
                        </a>
                    </div>
                `;
                
                // Clear user stats
                document.getElementById('userStats').innerHTML = '';
                document.getElementById('performanceBadges').innerHTML = '';
                return;
            }
            
            // Calculate comprehensive analysis
            const stats = calculateComprehensiveStatistics();
            const patterns = identifyAdvancedPatterns();
            const insights = generateActionableInsights(stats, patterns);
            const recommendations = generateRecommendations(stats, patterns);
            
            // Store analysis results for export
            analysisResults = {
                stats,
                patterns,
                insights,
                recommendations,
                filteredTrades,
                analysisDate: new Date().toISOString(),
                user: currentUser.email,
                filters: {
                    timeframe: document.getElementById('timeframeSelect').value,
                    currency: document.getElementById('currencySelect').value,
                    session: document.getElementById('sessionSelect').value,
                    riskLevel: document.getElementById('riskSelect').value
                }
            };
            
            // Update user stats banner
            updateUserStatsBanner(stats);
            
            // Create analytics HTML
            const analyticsHTML = `
                <div class="analytics-grid">
                    <!-- Performance Dashboard -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-tachometer-alt"></i>
                                <div>
                                    <h2>Performance Dashboard</h2>
                                    <div class="analytics-card-subtitle">Key Performance Indicators (KPIs) & Overall Metrics</div>
                                </div>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-value ${stats.totalPL >= 0 ? 'positive' : 'negative'}">
                                    ${stats.totalPL >= 0 ? '+' : ''}$${stats.totalPL.toFixed(2)}
                                </div>
                                <div class="stat-label">Total P/L</div>
                                <div class="stat-description">Net profit/loss</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-value ${stats.winRate >= 50 ? 'positive' : 'negative'}">
                                    ${stats.winRate.toFixed(1)}%
                                </div>
                                <div class="stat-label">Win Rate</div>
                                <div class="stat-description">Win/Loss ratio</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon purple">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                <div class="stat-value">${stats.profitFactor.toFixed(2)}</div>
                                <div class="stat-label">Profit Factor</div>
                                <div class="stat-description">Gross profit / Gross loss</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon orange">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-value">${stats.expectancy.toFixed(2)}</div>
                                <div class="stat-label">Expectancy</div>
                                <div class="stat-description">Avg profit per trade</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="stat-value">${stats.totalTrades}</div>
                                <div class="stat-label">Total Trades</div>
                                <div class="stat-description">Sample size</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-value">${stats.avgRR.toFixed(2)}</div>
                                <div class="stat-label">Avg R:R</div>
                                <div class="stat-description">Risk/Reward ratio</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon purple">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="stat-value">${stats.avgEmotionScore.toFixed(1)}</div>
                                <div class="stat-label">Emotion Score</div>
                                <div class="stat-description">Pre-trade mindset</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon orange">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="stat-value">${stats.avgRiskPercent.toFixed(1)}%</div>
                                <div class="stat-label">Avg Risk</div>
                                <div class="stat-description">Per trade risk</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Trends & Predictions -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-chart-line"></i>
                                <div>
                                    <h2>Performance Trends & Predictions</h2>
                                    <div class="analytics-card-subtitle">Historical performance with future projections</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="trendPredictionChart"></canvas>
                        </div>
                        <div class="insights-card">
                            <div class="insights-card-header">
                                <i class="fas fa-lightbulb"></i>
                                <h3>Trend Analysis Insights</h3>
                            </div>
                            <ul class="insights-list">
                                ${insights.trends.slice(0, 3).map(insight => `
                                    <li>
                                        <div class="insight-icon ${insight.type}">
                                            <i class="fas fa-${insight.icon}"></i>
                                        </div>
                                        <div>
                                            <div class="insight-text">${insight.text}</div>
                                            ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Win/Loss Analysis -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-chart-pie"></i>
                                <div>
                                    <h2>Win/Loss Distribution Analysis</h2>
                                    <div class="analytics-card-subtitle">Detailed breakdown of trade outcomes</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="stat-value">${stats.wins}</div>
                                <div class="stat-label">Winning Trades</div>
                                <div class="stat-description">${stats.winRate.toFixed(1)}% of total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon red">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="stat-value">${stats.losses}</div>
                                <div class="stat-label">Losing Trades</div>
                                <div class="stat-description">${stats.lossRate.toFixed(1)}% of total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                <div class="stat-value">${stats.breakEvens}</div>
                                <div class="stat-label">Break Even Trades</div>
                                <div class="stat-description">${stats.breakEvenRate.toFixed(1)}% of total</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Analysis & Management -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-shield-alt"></i>
                                <div>
                                    <h2>Risk Analysis & Management</h2>
                                    <div class="analytics-card-subtitle">Risk exposure and management effectiveness</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="riskAnalysisChart"></canvas>
                        </div>
                        <div class="insights-card">
                            <div class="insights-card-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>Risk Management Insights</h3>
                            </div>
                            <ul class="insights-list">
                                ${insights.risk.slice(0, 3).map(insight => `
                                    <li>
                                        <div class="insight-icon ${insight.type}">
                                            <i class="fas fa-${insight.icon}"></i>
                                        </div>
                                        <div>
                                            <div class="insight-text">${insight.text}</div>
                                            ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Session & Time Analysis -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-clock"></i>
                                <div>
                                    <h2>Session & Time Analysis</h2>
                                    <div class="analytics-card-subtitle">Performance by trading session and time of day</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sessionAnalysisChart"></canvas>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon ${patterns.bestSession.rate >= 60 ? 'green' : 'blue'}">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div class="stat-value">${patterns.bestSession.name}</div>
                                <div class="stat-label">Best Session</div>
                                <div class="stat-description">${patterns.bestSession.rate.toFixed(1)}% win rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon ${patterns.worstSession.rate < 40 ? 'red' : 'orange'}">
                                    <i class="fas fa-exclamation"></i>
                                </div>
                                <div class="stat-value">${patterns.worstSession.name}</div>
                                <div class="stat-label">Worst Session</div>
                                <div class="stat-description">${patterns.worstSession.rate.toFixed(1)}% win rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pair Performance Analysis -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                <div>
                                    <h2>Currency Pair Performance</h2>
                                    <div class="analytics-card-subtitle">Profitability by currency pair</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="pairPerformanceChart"></canvas>
                        </div>
                        <div class="insights-card">
                            <div class="insights-card-header">
                                <i class="fas fa-star"></i>
                                <h3>Pair Performance Insights</h3>
                            </div>
                            <ul class="insights-list">
                                ${insights.pairs.slice(0, 3).map(insight => `
                                    <li>
                                        <div class="insight-icon ${insight.type}">
                                            <i class="fas fa-${insight.icon}"></i>
                                        </div>
                                        <div>
                                            <div class="insight-text">${insight.text}</div>
                                            ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Setup & Strategy Analysis -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-cube"></i>
                                <div>
                                    <h2>Setup & Strategy Analysis</h2>
                                    <div class="analytics-card-subtitle">Performance by trading setup and strategy</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="strategyAnalysisChart"></canvas>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-value">${patterns.bestSetup?.name || 'N/A'}</div>
                                <div class="stat-label">Best Setup</div>
                                <div class="stat-description">${patterns.bestSetup?.rate?.toFixed(1) || '0'}% win rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon red">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="stat-value">${patterns.worstSetup?.name || 'N/A'}</div>
                                <div class="stat-label">Worst Setup</div>
                                <div class="stat-description">${patterns.worstSetup?.rate?.toFixed(1) || '0'}% win rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Psychological Analysis -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-brain"></i>
                                <div>
                                    <h2>Psychological Analysis</h2>
                                    <div class="analytics-card-subtitle">Emotion impact on trading performance</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="emotionAnalysisChart"></canvas>
                        </div>
                        <div class="insights-card">
                            <div class="insights-card-header">
                                <i class="fas fa-user-circle"></i>
                                <h3>Psychological Insights</h3>
                            </div>
                            <ul class="insights-list">
                                ${insights.psychology.slice(0, 3).map(insight => `
                                    <li>
                                        <div class="insight-icon ${insight.type}">
                                            <i class="fas fa-${insight.icon}"></i>
                                        </div>
                                        <div>
                                            <div class="insight-text">${insight.text}</div>
                                            ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Recommendations & Action Plan -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">
                                <i class="fas fa-clipboard-check"></i>
                                <div>
                                    <h2>Actionable Recommendations</h2>
                                    <div class="analytics-card-subtitle">Personalized improvement strategies</div>
                                </div>
                            </div>
                        </div>
                        <div class="insights-card" style="background: linear-gradient(135deg, var(--notion-green-light), var(--notion-blue-light));">
                            <div class="insights-card-header">
                                <i class="fas fa-bullseye"></i>
                                <h3>Top 5 Improvement Areas</h3>
                            </div>
                            <ul class="insights-list">
                                ${recommendations.slice(0, 5).map((rec, index) => `
                                    <li>
                                        <div class="insight-icon ${rec.priority === 'high' ? 'warning' : rec.priority === 'medium' ? 'info' : 'success'}">
                                            ${index + 1}
                                        </div>
                                        <div>
                                            <div class="insight-text"><strong>${rec.title}:</strong> ${rec.description}</div>
                                            <div class="insight-action">
                                                <strong>Action:</strong> ${rec.action}
                                                ${rec.expectedImpact ? ` | Expected impact: ${rec.expectedImpact}` : ''}
                                            </div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="performance-badges" style="margin-top: 20px;">
                            <div class="badge ${stats.overallRating >= 8 ? 'success' : stats.overallRating >= 6 ? 'warning' : 'danger'}">
                                <i class="fas fa-chart-line"></i>
                                Overall Rating: ${stats.overallRating}/10
                            </div>
                            <div class="badge ${stats.consistencyScore >= 8 ? 'success' : stats.consistencyScore >= 6 ? 'warning' : 'danger'}">
                                <i class="fas fa-shield-alt"></i>
                                Consistency: ${stats.consistencyScore}/10
                            </div>
                            <div class="badge ${stats.riskManagementScore >= 8 ? 'success' : stats.riskManagementScore >= 6 ? 'warning' : 'danger'}">
                                <i class="fas fa-balance-scale"></i>
                                Risk Management: ${stats.riskManagementScore}/10
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analyticsContent').innerHTML = analyticsHTML;
            
            // Initialize charts
            setTimeout(() => {
                initializeCharts(stats, patterns);
            }, 100);
        }

        // Update User Stats Banner
        function updateUserStatsBanner(stats) {
            document.getElementById('userStats').innerHTML = `
                <div class="user-stat">
                    <div class="user-stat-value">${stats.totalTrades}</div>
                    <div class="user-stat-label">Total Trades Analyzed</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value ${stats.totalPL >= 0 ? 'positive' : 'negative'}">
                        ${stats.totalPL >= 0 ? '+' : ''}$${Math.abs(stats.totalPL).toFixed(0)}
                    </div>
                    <div class="user-stat-label">Net P/L</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">${stats.winRate.toFixed(0)}%</div>
                    <div class="user-stat-label">Win Rate</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">${stats.avgRR.toFixed(1)}</div>
                    <div class="user-stat-label">Avg R:R</div>
                </div>
            `;
            
            // Update performance badges
            const badgesHTML = `
                <div class="badge ${stats.totalPL >= 0 ? 'success' : 'danger'}">
                    <i class="fas fa-${stats.totalPL >= 0 ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${stats.totalPL >= 0 ? 'Profitable' : 'Losing'} Performance
                </div>
                <div class="badge ${stats.winRate >= 60 ? 'success' : stats.winRate >= 50 ? 'warning' : 'danger'}">
                    <i class="fas fa-percentage"></i>
                    Win Rate: ${stats.winRate >= 60 ? 'Excellent' : stats.winRate >= 50 ? 'Good' : 'Needs Improvement'}
                </div>
                <div class="badge ${stats.profitFactor >= 2 ? 'success' : stats.profitFactor >= 1.5 ? 'warning' : 'danger'}">
                    <i class="fas fa-chart-line"></i>
                    Profit Factor: ${stats.profitFactor.toFixed(1)}
                </div>
            `;
            
            document.getElementById('performanceBadges').innerHTML = badgesHTML;
        }

        // Calculate Comprehensive Statistics
        function calculateComprehensiveStatistics() {
            const totalTrades = filteredTrades.length;
            const wins = filteredTrades.filter(t => t.result === 'Win').length;
            const losses = filteredTrades.filter(t => t.result === 'Loss').length;
            const breakEvens = filteredTrades.filter(t => t.result === 'Break Even').length;
            
            const totalPL = filteredTrades.reduce((sum, trade) => sum + (trade.pl || 0), 0);
            const avgPL = totalTrades > 0 ? totalPL / totalTrades : 0;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const lossRate = totalTrades > 0 ? (losses / totalTrades) * 100 : 0;
            const breakEvenRate = totalTrades > 0 ? (breakEvens / totalTrades) * 100 : 0;
            
            // Calculate R:R statistics
            const rrTrades = filteredTrades.filter(t => t.rr);
            let avgRR = 2.0;
            if (rrTrades.length > 0) {
                const totalRR = rrTrades.reduce((sum, trade) => {
                    const rrMatch = trade.rr?.match(/1:(\d+\.?\d*)/);
                    return rrMatch ? sum + parseFloat(rrMatch[1]) : sum;
                }, 0);
                avgRR = totalRR / rrTrades.length;
            }
            
            // Calculate profit factor
            const totalWins = filteredTrades.filter(t => t.result === 'Win')
                .reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const totalLosses = filteredTrades.filter(t => t.result === 'Loss')
                .reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? Infinity : 0;
            
            // Calculate expectancy
            const avgWin = wins > 0 ? 
                filteredTrades.filter(t => t.result === 'Win')
                    .reduce((sum, trade) => sum + (trade.pl || 0), 0) / wins : 0;
            const avgLoss = losses > 0 ? 
                filteredTrades.filter(t => t.result === 'Loss')
                    .reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0) / losses : 0;
            const expectancy = (winRate/100 * avgWin) - (lossRate/100 * avgLoss);
            
            // Calculate risk statistics
            const riskTrades = filteredTrades.filter(t => t.riskPercent);
            const avgRiskPercent = riskTrades.length > 0 ? 
                riskTrades.reduce((sum, trade) => sum + (parseFloat(trade.riskPercent) || 0), 0) / riskTrades.length : 2;
            
            // Calculate emotion statistics
            const emotionTrades = filteredTrades.filter(t => t.emotionBefore);
            const avgEmotionScore = emotionTrades.length > 0 ? 
                emotionTrades.reduce((sum, trade) => sum + (trade.emotionBefore || 5), 0) / emotionTrades.length : 5;
            
            // Calculate largest win/loss
            const winAmounts = filteredTrades.filter(t => t.pl > 0).map(t => t.pl || 0);
            const lossAmounts = filteredTrades.filter(t => t.pl < 0).map(t => Math.abs(t.pl || 0));
            const largestWin = winAmounts.length > 0 ? Math.max(...winAmounts) : 0;
            const largestLoss = lossAmounts.length > 0 ? Math.max(...lossAmounts) : 0;
            
            // Calculate consecutive streaks
            let maxConsecutiveWins = 0;
            let maxConsecutiveLosses = 0;
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            
            filteredTrades.forEach(trade => {
                if (trade.result === 'Win') {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxConsecutiveWins = Math.max(maxConsecutiveWins, currentWinStreak);
                } else if (trade.result === 'Loss') {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxConsecutiveLosses = Math.max(maxConsecutiveLosses, currentLossStreak);
                } else {
                    currentWinStreak = 0;
                    currentLossStreak = 0;
                }
            });
            
            // Calculate drawdown
            let cumulativePL = 0;
            let peak = 0;
            let maxDrawdown = 0;
            
            const sortedTrades = [...filteredTrades].sort((a, b) => {
                const dateA = new Date(a.date || a.createdAt || 0);
                const dateB = new Date(b.date || b.createdAt || 0);
                return dateA - dateB;
            });
            
            sortedTrades.forEach(trade => {
                cumulativePL += trade.pl || 0;
                peak = Math.max(peak, cumulativePL);
                const drawdown = peak - cumulativePL;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            });
            
            // Calculate sharpe ratio (simplified)
            const plArray = filteredTrades.map(t => t.pl || 0);
            const avgReturn = plArray.reduce((a, b) => a + b, 0) / plArray.length;
            const variance = plArray.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / plArray.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? avgReturn / stdDev : 0;
            
            // Calculate overall rating (0-10)
            const overallRating = calculateOverallRating({
                winRate,
                profitFactor,
                avgRR,
                avgRiskPercent,
                maxDrawdown,
                expectancy
            });
            
            // Calculate consistency score
            const consistencyScore = calculateConsistencyScore(filteredTrades);
            
            // Calculate risk management score
            const riskManagementScore = calculateRiskManagementScore({
                avgRiskPercent,
                maxConsecutiveLosses,
                maxDrawdown,
                profitFactor
            });
            
            return {
                totalTrades,
                wins,
                losses,
                breakEvens,
                totalPL,
                avgPL,
                winRate,
                lossRate,
                breakEvenRate,
                avgRR,
                profitFactor,
                expectancy,
                avgRiskPercent,
                avgEmotionScore,
                largestWin,
                largestLoss,
                maxConsecutiveWins,
                maxConsecutiveLosses,
                maxDrawdown,
                sharpeRatio,
                overallRating,
                consistencyScore,
                riskManagementScore
            };
        }

        // Calculate Overall Rating
        function calculateOverallRating(metrics) {
            let score = 0;
            
            // Win rate contribution (max 3 points)
            if (metrics.winRate >= 60) score += 3;
            else if (metrics.winRate >= 50) score += 2;
            else if (metrics.winRate >= 40) score += 1;
            
            // Profit factor contribution (max 3 points)
            if (metrics.profitFactor >= 2) score += 3;
            else if (metrics.profitFactor >= 1.5) score += 2;
            else if (metrics.profitFactor >= 1) score += 1;
            
            // Risk/Reward contribution (max 2 points)
            if (metrics.avgRR >= 2) score += 2;
            else if (metrics.avgRR >= 1.5) score += 1;
            
            // Risk management contribution (max 1 point)
            if (metrics.avgRiskPercent <= 2) score += 1;
            
            // Drawdown contribution (max 1 point)
            if (metrics.maxDrawdown < 100) score += 1;
            
            return Math.min(10, score);
        }

        // Calculate Consistency Score
        function calculateConsistencyScore(trades) {
            if (trades.length < 10) return 5;
            
            const plArray = trades.map(t => t.pl || 0);
            const avg = plArray.reduce((a, b) => a + b, 0) / plArray.length;
            const variance = plArray.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / plArray.length;
            const stdDev = Math.sqrt(variance);
            
            // Lower std deviation = more consistent
            const consistency = Math.max(0, 10 - (stdDev / 10));
            return Math.min(10, consistency);
        }

        // Calculate Risk Management Score
        function calculateRiskManagementScore(metrics) {
            let score = 0;
            
            // Average risk contribution (max 3 points)
            if (metrics.avgRiskPercent <= 1) score += 3;
            else if (metrics.avgRiskPercent <= 2) score += 2;
            else if (metrics.avgRiskPercent <= 3) score += 1;
            
            // Consecutive losses contribution (max 3 points)
            if (metrics.maxConsecutiveLosses <= 2) score += 3;
            else if (metrics.maxConsecutiveLosses <= 4) score += 2;
            else if (metrics.maxConsecutiveLosses <= 6) score += 1;
            
            // Drawdown contribution (max 2 points)
            if (metrics.maxDrawdown < 50) score += 2;
            else if (metrics.maxDrawdown < 100) score += 1;
            
            // Profit factor contribution (max 2 points)
            if (metrics.profitFactor >= 1.5) score += 2;
            else if (metrics.profitFactor >= 1) score += 1;
            
            return Math.min(10, score);
        }

        // Identify Advanced Patterns
        function identifyAdvancedPatterns() {
            const patterns = {
                sessionPerformance: {},
                pairPerformance: {},
                setupPerformance: {},
                emotionPerformance: {},
                timeOfDayPerformance: {},
                dayOfWeekPerformance: {},
                bestSession: { name: 'N/A', rate: 0, pl: 0 },
                worstSession: { name: 'N/A', rate: 100, pl: 0 },
                bestSetup: { name: 'N/A', rate: 0, pl: 0 },
                worstSetup: { name: 'N/A', rate: 100, pl: 0 },
                bestPair: { name: 'N/A', rate: 0, pl: 0 },
                worstPair: { name: 'N/A', rate: 100, pl: 0 }
            };
            
            // Session performance
            const sessions = ['London', 'New York', 'Asian', 'Sydney', 'Other'];
            sessions.forEach(session => {
                const sessionTrades = filteredTrades.filter(t => t.session === session);
                const wins = sessionTrades.filter(t => t.result === 'Win').length;
                const total = sessionTrades.length;
                const rate = total > 0 ? (wins / total) * 100 : 0;
                const pl = sessionTrades.reduce((sum, t) => sum + (t.pl || 0), 0);
                
                patterns.sessionPerformance[session] = { total, wins, rate, pl };
                
                if (total >= 3) {
                    if (rate > patterns.bestSession.rate) {
                        patterns.bestSession = { name: session, rate, pl };
                    }
                    if (rate < patterns.worstSession.rate) {
                        patterns.worstSession = { name: session, rate, pl };
                    }
                }
            });
            
            // Pair performance
            const pairs = {};
            filteredTrades.forEach(trade => {
                const pair = trade.pair || 'Unknown';
                if (!pairs[pair]) {
                    pairs[pair] = { wins: 0, total: 0, pl: 0 };
                }
                pairs[pair].total++;
                pairs[pair].pl += trade.pl || 0;
                if (trade.result === 'Win') {
                    pairs[pair].wins++;
                }
            });
            
            Object.entries(pairs).forEach(([pair, data]) => {
                const rate = data.total > 0 ? (data.wins / data.total) * 100 : 0;
                patterns.pairPerformance[pair] = { ...data, rate };
                
                if (data.total >= 3) {
                    if (rate > patterns.bestPair.rate) {
                        patterns.bestPair = { name: pair, rate, pl: data.pl };
                    }
                    if (rate < patterns.worstPair.rate) {
                        patterns.worstPair = { name: pair, rate, pl: data.pl };
                    }
                }
            });
            
            // Setup performance
            const setups = {};
            filteredTrades.forEach(trade => {
                const setup = trade.model || 'Unknown';
                if (!setups[setup]) {
                    setups[setup] = { wins: 0, total: 0, pl: 0 };
                }
                setups[setup].total++;
                setups[setup].pl += trade.pl || 0;
                if (trade.result === 'Win') {
                    setups[setup].wins++;
                }
            });
            
            Object.entries(setups).forEach(([setup, data]) => {
                const rate = data.total > 0 ? (data.wins / data.total) * 100 : 0;
                patterns.setupPerformance[setup] = { ...data, rate };
                
                if (data.total >= 3) {
                    if (rate > patterns.bestSetup.rate) {
                        patterns.bestSetup = { name: setup, rate, pl: data.pl };
                    }
                    if (rate < patterns.worstSetup.rate) {
                        patterns.worstSetup = { name: setup, rate, pl: data.pl };
                    }
                }
            });
            
            // Emotion performance
            for (let i = 1; i <= 10; i++) {
                const emotionTrades = filteredTrades.filter(t => Math.round(t.emotionBefore || 5) === i);
                const wins = emotionTrades.filter(t => t.result === 'Win').length;
                patterns.emotionPerformance[i] = {
                    total: emotionTrades.length,
                    wins: wins,
                    rate: emotionTrades.length > 0 ? (wins / emotionTrades.length) * 100 : 0,
                    pl: emotionTrades.reduce((sum, t) => sum + (t.pl || 0), 0)
                };
            }
            
            return patterns;
        }

        // Generate Actionable Insights
        function generateActionableInsights(stats, patterns) {
            const insights = {
                trends: [],
                risk: [],
                pairs: [],
                psychology: [],
                general: []
            };
            
            // Trend insights
            if (stats.totalPL > 0) {
                insights.trends.push({
                    type: 'success',
                    icon: 'arrow-up',
                    text: `Positive cumulative profit trend with $${stats.totalPL.toFixed(2)} net gain`,
                    action: 'Maintain current strategy with focus on consistency'
                });
            } else {
                insights.trends.push({
                    type: 'warning',
                    icon: 'arrow-down',
                    text: `Negative cumulative trend with $${Math.abs(stats.totalPL).toFixed(2)} net loss`,
                    action: 'Review and adjust trading strategy immediately'
                });
            }
            
            if (stats.winRate >= 60) {
                insights.trends.push({
                    type: 'success',
                    icon: 'trophy',
                    text: `Excellent win rate of ${stats.winRate.toFixed(1)}% indicates strong entry timing`,
                    action: 'Continue with current entry criteria'
                });
            } else if (stats.winRate < 40) {
                insights.trends.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    text: `Low win rate of ${stats.winRate.toFixed(1)}% suggests need for better entry signals`,
                    action: 'Review entry criteria and waiting for higher probability setups'
                });
            }
            
            // Risk insights
            if (stats.avgRiskPercent > 2) {
                insights.risk.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    text: `Average risk per trade (${stats.avgRiskPercent.toFixed(1)}%) exceeds recommended 2% limit`,
                    action: 'Reduce position sizes to improve risk management'
                });
            }
            
            if (stats.maxConsecutiveLosses >= 3) {
                insights.risk.push({
                    type: 'warning',
                    icon: 'times-circle',
                    text: `${stats.maxConsecutiveLosses} consecutive losses indicates potential overtrading`,
                    action: 'Implement mandatory break after 2 consecutive losses'
                });
            }
            
            if (stats.maxDrawdown > 100) {
                insights.risk.push({
                    type: 'danger',
                    icon: 'skull-crossbones',
                    text: `Maximum drawdown of $${stats.maxDrawdown.toFixed(2)} is concerning`,
                    action: 'Review risk management and consider reducing trade frequency'
                });
            }
            
            // Pair insights
            if (patterns.bestPair.rate >= 60 && patterns.bestPair.pl > 0) {
                insights.pairs.push({
                    type: 'success',
                    icon: 'star',
                    text: `${patterns.bestPair.name} is your best performing pair with ${patterns.bestPair.rate.toFixed(1)}% win rate`,
                    action: 'Consider focusing more on this pair'
                });
            }
            
            if (patterns.worstPair.rate < 40 && patterns.worstPair.pl < 0) {
                insights.pairs.push({
                    type: 'warning',
                    icon: 'exclamation',
                    text: `${patterns.worstPair.name} underperforms with ${patterns.worstPair.rate.toFixed(1)}% win rate`,
                    action: 'Review strategy for this pair or reduce exposure'
                });
            }
            
            // Psychology insights
            const highEmotionTrades = filteredTrades.filter(t => (t.emotionBefore || 5) >= 7);
            const highEmotionWinRate = highEmotionTrades.length > 0 ? 
                (highEmotionTrades.filter(t => t.result === 'Win').length / highEmotionTrades.length) * 100 : 0;
            
            if (highEmotionWinRate < 40 && highEmotionTrades.length >= 3) {
                insights.psychology.push({
                    type: 'warning',
                    icon: 'brain',
                    text: `Trades with high emotion (â‰¥7) have only ${highEmotionWinRate.toFixed(1)}% win rate`,
                    action: 'Avoid trading when emotional; implement trading plan checklist'
                });
            }
            
            // General insights
            if (stats.profitFactor >= 2) {
                insights.general.push({
                    type: 'success',
                    icon: 'chart-line',
                    text: `Excellent profit factor of ${stats.profitFactor.toFixed(2)} indicates good risk-adjusted returns`,
                    action: 'Continue current risk management approach'
                });
            }
            
            if (stats.avgRR >= 2) {
                insights.general.push({
                    type: 'success',
                    icon: 'balance-scale',
                    text: `Strong average risk/reward ratio of 1:${stats.avgRR.toFixed(2)}`,
                    action: 'Maintain discipline in taking profits at target levels'
                });
            }
            
            return insights;
        }

        // Generate Recommendations
        function generateRecommendations(stats, patterns) {
            const recommendations = [];
            
            // Based on win rate
            if (stats.winRate < 40) {
                recommendations.push({
                    title: "Improve Entry Accuracy",
                    description: "Your win rate indicates need for better trade selection",
                    action: "Focus on higher probability setups with clearer entry signals",
                    priority: "high",
                    expectedImpact: "Increase win rate by 10-15%"
                });
            }
            
            // Based on risk management
            if (stats.avgRiskPercent > 2) {
                recommendations.push({
                    title: "Reduce Position Sizing",
                    description: "You're risking too much per trade",
                    action: "Reduce risk per trade to maximum 2% of account",
                    priority: "high",
                    expectedImpact: "Reduce drawdowns and improve consistency"
                });
            }
            
            // Based on consecutive losses
            if (stats.maxConsecutiveLosses >= 3) {
                recommendations.push({
                    title: "Implement Loss Streak Rules",
                    description: "Too many consecutive losses indicates emotional trading",
                    action: "Take a mandatory break after 2 consecutive losses",
                    priority: "medium",
                    expectedImpact: "Prevent revenge trading and larger drawdowns"
                });
            }
            
            // Based on best/worst sessions
            if (patterns.bestSession.rate - patterns.worstSession.rate > 20) {
                recommendations.push({
                    title: "Focus on Best Performing Session",
                    description: "Significant performance difference between sessions",
                    action: `Concentrate trading during ${patterns.bestSession.name} session`,
                    priority: "medium",
                    expectedImpact: "Improve overall win rate and profitability"
                });
            }
            
            // Based on pair performance
            if (patterns.bestPair.rate - patterns.worstPair.rate > 30) {
                recommendations.push({
                    title: "Optimize Currency Pair Focus",
                    description: "Large performance gap between currency pairs",
                    action: `Reduce or eliminate trading ${patterns.worstPair.name}, focus on ${patterns.bestPair.name}`,
                    priority: "medium",
                    expectedImpact: "Increase average profitability per trade"
                });
            }
            
            // Based on profit factor
            if (stats.profitFactor < 1) {
                recommendations.push({
                    title: "Review Exit Strategy",
                    description: "Losing more on losses than gaining on wins",
                    action: "Let winners run longer and cut losses quicker",
                    priority: "high",
                    expectedImpact: "Turn losing strategy into profitable one"
                });
            }
            
            // Always include these general recommendations
            recommendations.push({
                title: "Maintain Trading Journal",
                description: "Continuous tracking is key to improvement",
                action: "Review each trade thoroughly before entering next one",
                priority: "low",
                expectedImpact: "Gradual long-term improvement"
            });
            
            recommendations.push({
                title: "Backtest Strategy Changes",
                description: "Test improvements before implementing live",
                action: "Paper trade new strategies for minimum 20 trades",
                priority: "low",
                expectedImpact: "Reduce costly live trading mistakes"
            });
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
        }

        // Initialize Charts
        function initializeCharts(stats, patterns) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Trend Prediction Chart
            const trendCtx = document.getElementById('trendPredictionChart');
            if (trendCtx) {
                const monthlyData = calculateMonthlyPerformance();
                const months = monthlyData.map(d => d.month);
                const actualPL = monthlyData.map(d => d.pl);
                const predictedPL = predictNextMonths(actualPL);
                
                charts.trendPredictionChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: [...months, 'Next Month', 'Month+2'],
                        datasets: [
                            {
                                label: 'Actual P/L',
                                data: [...actualPL, null, null],
                                borderColor: '#0f7b6c',
                                backgroundColor: 'rgba(15, 123, 108, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3
                            },
                            {
                                label: 'Predicted P/L',
                                data: [...actualPL.slice(-3), ...predictedPL],
                                borderColor: '#0c8ce9',
                                backgroundColor: 'rgba(12, 140, 233, 0.05)',
                                borderDash: [5, 5],
                                tension: 0.4,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Distribution Chart
            const distCtx = document.getElementById('distributionChart');
            if (distCtx) {
                charts.distributionChart = new Chart(distCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Winning Trades', 'Losing Trades', 'Break Even'],
                        datasets: [{
                            data: [stats.wins, stats.losses, stats.breakEvens],
                            backgroundColor: [
                                'rgba(15, 123, 108, 0.7)',
                                'rgba(209, 69, 59, 0.7)',
                                'rgba(112, 113, 110, 0.7)'
                            ],
                            borderColor: [
                                '#0f7b6c',
                                '#d1453b',
                                '#70716e'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} trades (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Risk Analysis Chart
            const riskCtx = document.getElementById('riskAnalysisChart');
            if (riskCtx) {
                const riskLevels = ['< 1%', '1-2%', '2-3%', '> 3%'];
                const riskData = calculateRiskDistribution();
                
                charts.riskAnalysisChart = new Chart(riskCtx, {
                    type: 'bar',
                    data: {
                        labels: riskLevels,
                        datasets: [{
                            label: 'Number of Trades',
                            data: riskData,
                            backgroundColor: [
                                'rgba(15, 123, 108, 0.7)',
                                'rgba(12, 140, 233, 0.7)',
                                'rgba(255, 107, 53, 0.7)',
                                'rgba(209, 69, 59, 0.7)'
                            ],
                            borderColor: [
                                '#0f7b6c',
                                '#0c8ce9',
                                '#ff6b35',
                                '#d1453b'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Trades'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Risk Level (% of Account)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Session Analysis Chart
            const sessionCtx = document.getElementById('sessionAnalysisChart');
            if (sessionCtx) {
                const sessions = ['London', 'New York', 'Asian', 'Sydney'];
                const winRates = sessions.map(session => 
                    patterns.sessionPerformance[session]?.rate || 0
                );
                
                charts.sessionAnalysisChart = new Chart(sessionCtx, {
                    type: 'radar',
                    data: {
                        labels: sessions,
                        datasets: [{
                            label: 'Win Rate %',
                            data: winRates,
                            backgroundColor: 'rgba(12, 140, 233, 0.2)',
                            borderColor: '#0c8ce9',
                            borderWidth: 2,
                            pointBackgroundColor: '#0c8ce9',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Pair Performance Chart
            const pairCtx = document.getElementById('pairPerformanceChart');
            if (pairCtx) {
                const pairData = Object.entries(patterns.pairPerformance)
                    .filter(([_, data]) => data.total >= 3)
                    .sort((a, b) => b[1].pl - a[1].pl)
                    .slice(0, 6);
                
                charts.pairPerformanceChart = new Chart(pairCtx, {
                    type: 'bar',
                    data: {
                        labels: pairData.map(([pair]) => pair),
                        datasets: [{
                            label: 'Total P/L ($)',
                            data: pairData.map(([_, data]) => data.pl),
                            backgroundColor: pairData.map(([_, data]) => 
                                data.pl >= 0 ? 'rgba(15, 123, 108, 0.7)' : 'rgba(209, 69, 59, 0.7)'
                            ),
                            borderColor: pairData.map(([_, data]) => 
                                data.pl >= 0 ? '#0f7b6c' : '#d1453b'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Strategy Analysis Chart
            const strategyCtx = document.getElementById('strategyAnalysisChart');
            if (strategyCtx) {
                const setupData = Object.entries(patterns.setupPerformance)
                    .filter(([_, data]) => data.total >= 2)
                    .sort((a, b) => b[1].rate - a[1].rate)
                    .slice(0, 5);
                
                charts.strategyAnalysisChart = new Chart(strategyCtx, {
                    type: 'horizontalBar',
                    data: {
                        labels: setupData.map(([setup]) => setup.length > 15 ? setup.substring(0, 12) + '...' : setup),
                        datasets: [{
                            label: 'Win Rate %',
                            data: setupData.map(([_, data]) => data.rate),
                            backgroundColor: setupData.map(([_, data]) => 
                                data.rate >= 60 ? 'rgba(15, 123, 108, 0.7)' : 
                                data.rate >= 40 ? 'rgba(12, 140, 233, 0.7)' : 'rgba(209, 69, 59, 0.7)'
                            ),
                            borderColor: setupData.map(([_, data]) => 
                                data.rate >= 60 ? '#0f7b6c' : 
                                data.rate >= 40 ? '#0c8ce9' : '#d1453b'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Emotion Analysis Chart
            const emotionCtx = document.getElementById('emotionAnalysisChart');
            if (emotionCtx) {
                const emotionData = [];
                for (let i = 1; i <= 10; i++) {
                    emotionData.push(patterns.emotionPerformance[i]?.rate || 0);
                }
                
                charts.emotionAnalysisChart = new Chart(emotionCtx, {
                    type: 'line',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                        datasets: [{
                            label: 'Win Rate by Emotion Score',
                            data: emotionData,
                            borderColor: '#6940a5',
                            backgroundColor: 'rgba(105, 64, 165, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Win Rate %'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Emotion Score (1-10)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Calculate Monthly Performance
        function calculateMonthlyPerformance() {
            const monthlyPerformance = {};
            filteredTrades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                
                if (!monthlyPerformance[monthKey]) {
                    monthlyPerformance[monthKey] = { month: monthName, pl: 0, trades: 0 };
                }
                monthlyPerformance[monthKey].pl += trade.pl || 0;
                monthlyPerformance[monthKey].trades++;
            });
            
            return Object.values(monthlyPerformance)
                .sort((a, b) => {
                    const [aYear, aMonth] = a.month.split(' ');
                    const [bYear, bMonth] = b.month.split(' ');
                    return new Date(`${aMonth} 1, ${aYear}`) - new Date(`${bMonth} 1, ${bYear}`);
                })
                .slice(-6); // Last 6 months
        }

        // Predict Next Months
        function predictNextMonths(historicalData) {
            if (historicalData.length < 3) return [0, 0];
            
            // Simple moving average prediction
            const lastThree = historicalData.slice(-3);
            const avg = lastThree.reduce((a, b) => a + b, 0) / lastThree.length;
            
            // Add some randomness for realistic prediction
            const randomFactor = 0.2;
            const prediction1 = avg * (1 + (Math.random() * randomFactor * 2 - randomFactor));
            const prediction2 = prediction1 * (1 + (Math.random() * randomFactor * 2 - randomFactor));
            
            return [prediction1, prediction2];
        }

        // Calculate Risk Distribution
        function calculateRiskDistribution() {
            const distribution = [0, 0, 0, 0]; // <1%, 1-2%, 2-3%, >3%
            
            filteredTrades.forEach(trade => {
                const riskPercent = parseFloat(trade.riskPercent) || 0;
                if (riskPercent < 1) distribution[0]++;
                else if (riskPercent <= 2) distribution[1]++;
                else if (riskPercent <= 3) distribution[2]++;
                else distribution[3]++;
            });
            
            return distribution;
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('timeframeSelect').value = '30';
            document.getElementById('currencySelect').value = 'all';
            document.getElementById('sessionSelect').value = 'all';
            document.getElementById('riskSelect').value = 'medium';
            updateAnalytics();
        }

        // Save Analysis Settings
        function saveAnalysisSettings() {
            const settings = {
                timeframe: document.getElementById('timeframeSelect').value,
                currency: document.getElementById('currencySelect').value,
                session: document.getElementById('sessionSelect').value,
                riskLevel: document.getElementById('riskSelect').value,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('dtaSettings', JSON.stringify(settings));
            alert('Analysis settings saved as preset!');
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredTrades.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Date', 'Pair', 'Direction', 'Model', 'Result', 'P/L', 'Risk %', 'R:R', 'Session', 'Emotion', 'Notes'];
            const csvData = [
                headers.join(','),
                ...filteredTrades.map(trade => {
                    const date = new Date(trade.date || trade.createdAt || 0).toLocaleString();
                    return [
                        `"${date}"`,
                        trade.pair || '',
                        trade.direction || '',
                        trade.model || '',
                        trade.result || '',
                        trade.pl || 0,
                        trade.riskPercent || '',
                        trade.rr || '',
                        trade.session || '',
                        trade.emotionBefore || '',
                        `"${(trade.notes || '').replace(/"/g, '""')}"`
                    ].join(',');
                })
            ].join('\n');
            
            downloadCSV(csvData, `trading-analysis-${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Export to PDF
        function exportToPDF() {
            alert('PDF export feature would generate a professional report with charts and insights.\nThis would typically require a backend service or PDF generation library.');
            // In a real implementation, this would:
            // 1. Generate HTML report
            // 2. Convert to PDF using a library like jsPDF or html2pdf
            // 3. Download the PDF
        }

        // Export Full Report
        function exportFullReport() {
            if (!analysisResults.stats) {
                alert('Please run analysis first before generating report');
                return;
            }
            
            const report = generateFullReport();
            const blob = new Blob([report], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dta-report-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate Full Report
        function generateFullReport() {
            const { stats, patterns, insights, recommendations } = analysisResults;
            
            return `<!DOCTYPE html>
<html>
<head>
    <title>DTA Report - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .section { margin-bottom: 30px; }
        .metric { display: inline-block; margin: 10px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .positive { color: green; }
        .negative { color: red; }
        .insight { background: #f0f8ff; padding: 15px; margin: 10px 0; border-left: 4px solid #0c8ce9; }
        .recommendation { background: #f0fff0; padding: 15px; margin: 10px 0; border-left: 4px solid #0f7b6c; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Data-Driven Trading Analysis Report</h1>
        <p>Generated: ${new Date().toLocaleString()}</p>
        <p>Trader: ${currentUser.email}</p>
        <p>Period: ${analysisResults.filters.timeframe === 'all' ? 'All Time' : 'Last ' + analysisResults.filters.timeframe + ' days'}</p>
    </div>
    
    <div class="section">
        <h2>Performance Summary</h2>
        <div class="metric">Total P/L: <span class="${stats.totalPL >= 0 ? 'positive' : 'negative'}">$${stats.totalPL.toFixed(2)}</span></div>
        <div class="metric">Win Rate: ${stats.winRate.toFixed(1)}%</div>
        <div class="metric">Total Trades: ${stats.totalTrades}</div>
        <div class="metric">Profit Factor: ${stats.profitFactor.toFixed(2)}</div>
        <div class="metric">Avg R:R: ${stats.avgRR.toFixed(2)}</div>
        <div class="metric">Expectancy: $${stats.expectancy.toFixed(2)}</div>
    </div>
    
    <div class="section">
        <h2>Key Insights</h2>
        ${Object.values(insights).flat().map(insight => `
            <div class="insight">
                <strong>${insight.icon ? 'ðŸ“Š ' : ''}${insight.text}</strong>
                ${insight.action ? `<br><em>Action: ${insight.action}</em>` : ''}
            </div>
        `).join('')}
    </div>
    
    <div class="section">
        <h2>Top Recommendations</h2>
        ${recommendations.slice(0, 5).map((rec, i) => `
            <div class="recommendation">
                <h3>${i + 1}. ${rec.title} [${rec.priority.toUpperCase()}]</h3>
                <p>${rec.description}</p>
                <p><strong>Action:</strong> ${rec.action}</p>
                ${rec.expectedImpact ? `<p><strong>Expected Impact:</strong> ${rec.expectedImpact}</p>` : ''}
            </div>
        `).join('')}
    </div>
    
    <div class="section">
        <h2>Performance Ratings</h2>
        <div class="metric">Overall: ${stats.overallRating}/10</div>
        <div class="metric">Consistency: ${stats.consistencyScore}/10</div>
        <div class="metric">Risk Management: ${stats.riskManagementScore}/10</div>
    </div>
    
    <div class="section">
        <h2>Best Performing</h2>
        <p>Session: ${patterns.bestSession.name} (${patterns.bestSession.rate.toFixed(1)}% win rate)</p>
        <p>Currency Pair: ${patterns.bestPair.name} (${patterns.bestPair.rate.toFixed(1)}% win rate)</p>
        <p>Setup: ${patterns.bestSetup.name} (${patterns.bestSetup.rate.toFixed(1)}% win rate)</p>
    </div>
</body>
</html>`;
        }

        // Download CSV
        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Generate Full Report
        function generateFullReport() {
            alert('Generating comprehensive DTA report...');
            // This would generate a full HTML report with all analysis
        }

        // Show Error
        function showError(message) {
            document.getElementById('analyticsContent').innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--notion-text-light);">
                    <div style="font-size: 64px; margin-bottom: 16px; color: var(--notion-red);">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--notion-text);">
                        Analysis Error
                    </div>
                    <div style="font-size: 16px; margin-bottom: 24px; max-width: 400px; margin: 0 auto 24px;">
                        ${message}
                    </div>
                    <button onclick="loadUserTrades()" class="filter-action-btn primary">
                        <i class="fas fa-redo"></i> Retry Loading Data
                    </button>
                </div>
            `;
        }

        // Expose functions to global scope
        window.updateAnalytics = updateAnalytics;
        window.resetFilters = resetFilters;
        window.loadUserTrades = loadUserTrades;
        window.exportToCSV = exportToCSV;
        window.exportToPDF = exportToPDF;
        window.exportFullReport = exportFullReport;
        window.printReport = printReport;
        window.generateFullReport = generateFullReport;
        window.saveAnalysisSettings = saveAnalysisSettings;
    </script>
</body>
</html>
