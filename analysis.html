<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA - Data-Driven Trading Analysis | ICT Scalping Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .auth-message {
            font-size: 16px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 300px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
            width: 100%;
            max-width: 250px;
        }

        .auth-btn {
            padding: 14px 20px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .auth-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .mobile-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit;
            text-align: left;
        }

        .mobile-menu-item.primary {
            background-color: var(--notion-green);
            color: white;
        }

        .mobile-menu-item.blue {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Main Container */
        .main-container {
            margin: 50px 0 0 0;
            padding: 0;
            width: 100%;
        }

        /* Page Header */
        .page-header {
            padding: 20px 16px;
            background: linear-gradient(135deg, var(--notion-green-light), var(--notion-blue-light));
            margin-bottom: 0;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--notion-text);
            line-height: 1.3;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* User Banner */
        .user-banner {
            background: white;
            padding: 16px;
            margin: 0;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .user-banner-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .user-stat {
            background-color: var(--notion-gray-light);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--notion-gray-dark);
        }

        .user-stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--notion-green);
        }

        .user-stat-value.negative {
            color: var(--notion-red);
        }

        .user-stat-label {
            font-size: 12px;
            color: var(--notion-text-light);
        }

        /* Performance Badges */
        .performance-badges {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 16px;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .performance-badges::-webkit-scrollbar {
            display: none;
        }

        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .badge.success {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .badge.warning {
            background-color: var(--notion-yellow-light);
            color: var(--notion-yellow);
        }

        .badge.danger {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .badge.info {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        /* Filter Section */
        .filter-section {
            background-color: white;
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .filter-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            background-color: white;
            font-size: 15px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .filter-action-btn {
            flex: 1;
            padding: 14px;
            background-color: var(--notion-gray);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .filter-action-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .filter-action-btn.blue {
            background-color: var(--notion-blue);
            color: white;
            border-color: var(--notion-blue);
        }

        /* Analytics Tabs */
        .analytics-tabs {
            position: sticky;
            top: 50px;
            background: white;
            z-index: 10;
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .analytics-tabs::-webkit-scrollbar {
            display: none;
        }

        .analytics-tab {
            padding: 16px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text-light);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .analytics-tab.active {
            color: var(--notion-green);
            border-bottom-color: var(--notion-green);
            background-color: var(--notion-green-light);
        }

        /* Analytics Content */
        .analytics-content {
            padding: 16px;
        }

        .analytics-pane {
            display: none;
        }

        .analytics-pane.active {
            display: block;
        }

        /* Analytics Card */
        .analytics-card {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .analytics-card-header {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analytics-card-header i {
            font-size: 20px;
            color: var(--notion-green);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: var(--notion-gray-light);
        }

        .analytics-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            flex: 1;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-bottom: 16px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            padding: 16px;
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--notion-gray-dark);
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 16px;
        }

        .stat-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .stat-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .stat-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .stat-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .stat-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.positive {
            color: var(--notion-green);
        }

        .stat-value.negative {
            color: var(--notion-red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 4px;
        }

        .stat-description {
            font-size: 11px;
            color: var(--notion-text-light);
            font-style: italic;
        }

        /* Insights Card */
        .insights-card {
            background: linear-gradient(135deg, var(--notion-blue-light), var(--notion-purple-light));
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid var(--notion-blue);
        }

        .insights-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .insights-header i {
            font-size: 18px;
            color: var(--notion-blue);
        }

        .insights-header h3 {
            color: var(--notion-blue);
            font-weight: 600;
            font-size: 15px;
            margin: 0;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(12, 140, 233, 0.1);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .insights-list li:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .insight-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .insight-icon.success {
            background-color: rgba(15, 123, 108, 0.1);
            color: var(--notion-green);
        }

        .insight-icon.warning {
            background-color: rgba(255, 107, 53, 0.1);
            color: var(--notion-orange);
        }

        .insight-icon.info {
            background-color: rgba(12, 140, 233, 0.1);
            color: var(--notion-blue);
        }

        .insight-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
        }

        .insight-action {
            font-size: 11px;
            color: var(--notion-text-light);
            margin-top: 4px;
            font-style: italic;
            line-height: 1.3;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--notion-text-light);
            flex-direction: column;
            gap: 16px;
        }

        .loading i {
            animation: spin 1s linear infinite;
            font-size: 32px;
        }

        .loading-text {
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export Section */
        .export-section {
            background-color: var(--notion-gray-light);
            padding: 20px 16px;
            margin-top: 20px;
        }

        .export-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
            text-align: center;
        }

        .export-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .export-btn {
            padding: 14px;
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .export-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--notion-text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--notion-gray-dark);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--notion-text);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--notion-green);
            background-color: var(--notion-green-light);
        }

        .bottom-nav-btn i {
            font-size: 18px;
        }

        /* Mobile Optimizations */
        @media (max-width: 360px) {
            .user-stats-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .analytics-tab {
                padding: 14px 16px;
                font-size: 13px;
            }
            
            .chart-container {
                height: 220px;
            }
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-container {
                margin: 0;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .page-header {
                border-radius: 12px;
                margin-bottom: 20px;
            }
            
            .user-banner {
                border-radius: 12px;
                margin-bottom: 20px;
            }
            
            .filter-section {
                border-radius: 12px;
                margin-bottom: 20px;
            }
            
            .analytics-tabs {
                position: static;
                border-radius: 12px 12px 0 0;
                margin-bottom: 0;
            }
            
            .analytics-content {
                background: white;
                border-radius: 0 0 12px 12px;
                border: 1px solid var(--notion-gray-dark);
                border-top: none;
                padding: 20px;
            }
            
            .export-section {
                border-radius: 12px;
                margin-top: 30px;
            }
        }

        /* Prevent horizontal scroll */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Better touch targets */
        button,
        select,
        .analytics-tab,
        .mobile-menu-item {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Prevent text selection on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* Smooth scrolling */
        .analytics-content,
        .mobile-menu {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Checking authentication...</div>
        <div class="auth-buttons" id="authButtons" style="display: none;">
            <button class="auth-btn primary" id="goToLoginBtn">Go to Login Page</button>
        </div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header-title">DTA Analysis</div>
        </div>
        <button class="mobile-menu-btn" id="mobilePrintBtn">
            <i class="fas fa-print"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" class="mobile-menu-item">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
        <button class="mobile-menu-item primary" id="mobileRefreshBtn">
            <i class="fas fa-sync-alt"></i>
            Refresh Analysis
        </button>
        <button class="mobile-menu-item blue" id="mobileExportBtn">
            <i class="fas fa-file-export"></i>
            Export Report
        </button>
        <button class="mobile-menu-item" id="mobileResetBtn">
            <i class="fas fa-redo"></i>
            Reset Filters
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">ðŸ“ˆ Data-Driven Trading Analysis</h1>
            <p class="page-subtitle">Advanced statistical analysis and actionable insights for your trading performance</p>
        </div>

        <!-- User Banner -->
        <div class="user-banner" id="userBanner">
            <div class="user-banner-title">
                <i class="fas fa-chart-line"></i>
                <span>Loading your analysis...</span>
            </div>
            <div class="user-stats-grid" id="userStats">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Performance Badges -->
        <div class="performance-badges" id="performanceBadges">
            <!-- Performance badges will be populated by JavaScript -->
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-title">
                <i class="fas fa-sliders-h"></i>
                <span>Analysis Filters</span>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Time Period</label>
                <select class="filter-select" id="timeframeSelect">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365">Last Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Currency Pair</label>
                <select class="filter-select" id="currencySelect">
                    <option value="all">All Pairs</option>
                    <option value="EURUSD">EUR/USD</option>
                    <option value="GBPUSD">GBP/USD</option>
                    <option value="USDJPY">USD/JPY</option>
                    <option value="AUDUSD">AUD/USD</option>
                    <option value="USDCAD">USD/CAD</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Trading Session</label>
                <select class="filter-select" id="sessionSelect">
                    <option value="all">All Sessions</option>
                    <option value="London">London</option>
                    <option value="New York">New York</option>
                    <option value="Asian">Asian</option>
                    <option value="Sydney">Sydney</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Risk Level</label>
                <select class="filter-select" id="riskSelect">
                    <option value="all">All Risks</option>
                    <option value="low">Low (< 1%)</option>
                    <option value="medium" selected>Medium (1-2%)</option>
                    <option value="high">High (> 2%)</option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button class="filter-action-btn" id="resetFiltersBtn">
                    <i class="fas fa-redo"></i>
                    Reset
                </button>
                <button class="filter-action-btn primary" id="applyFiltersBtn">
                    <i class="fas fa-filter"></i>
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Analytics Tabs -->
        <div class="analytics-tabs" id="analyticsTabs">
            <div class="analytics-tab active" data-tab="overview">
                <i class="fas fa-tachometer-alt"></i>
                Overview
            </div>
            <div class="analytics-tab" data-tab="performance">
                <i class="fas fa-chart-line"></i>
                Performance
            </div>
            <div class="analytics-tab" data-tab="risk">
                <i class="fas fa-shield-alt"></i>
                Risk
            </div>
            <div class="analytics-tab" data-tab="insights">
                <i class="fas fa-lightbulb"></i>
                Insights
            </div>
        </div>

        <!-- Analytics Content -->
        <div class="analytics-content">
            <!-- Overview Pane -->
            <div class="analytics-pane active" id="overviewPane">
                <div class="loading" id="overviewLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="loading-text">Loading overview analysis...</div>
                </div>
                <div id="overviewContent" style="display: none;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Performance Pane -->
            <div class="analytics-pane" id="performancePane">
                <div class="loading" id="performanceLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="loading-text">Loading performance analysis...</div>
                </div>
                <div id="performanceContent" style="display: none;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Risk Pane -->
            <div class="analytics-pane" id="riskPane">
                <div class="loading" id="riskLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="loading-text">Loading risk analysis...</div>
                </div>
                <div id="riskContent" style="display: none;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Insights Pane -->
            <div class="analytics-pane" id="insightsPane">
                <div class="loading" id="insightsLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="loading-text">Loading insights...</div>
                </div>
                <div id="insightsContent" style="display: none;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <div class="export-title">
                <i class="fas fa-download"></i>
                Export Options
            </div>
            <div class="export-actions">
                <button class="export-btn" id="exportCSVBtn">
                    <i class="fas fa-file-csv"></i>
                    Export CSV Data
                </button>
                <button class="export-btn primary" id="exportReportBtn">
                    <i class="fas fa-file-alt"></i>
                    Generate Full Report
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn active" data-tab="overview">
            <i class="fas fa-tachometer-alt"></i>
            Overview
        </button>
        <button class="bottom-nav-btn" data-tab="performance">
            <i class="fas fa-chart-line"></i>
            Performance
        </button>
        <button class="bottom-nav-btn" data-tab="risk">
            <i class="fas fa-shield-alt"></i>
            Risk
        </button>
        <button class="bottom-nav-btn" data-tab="insights">
            <i class="fas fa-lightbulb"></i>
            Insights
        </button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let allUserTrades = [];
        let filteredTrades = [];
        let charts = {};
        let analysisResults = {};
        let currentTab = 'overview';

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobilePrintBtn').addEventListener('click', printReport);
            document.getElementById('mobileRefreshBtn').addEventListener('click', loadUserTrades);
            document.getElementById('mobileExportBtn').addEventListener('click', exportFullReport);
            document.getElementById('mobileResetBtn').addEventListener('click', resetFilters);
            
            // Filter buttons
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('applyFiltersBtn').addEventListener('click', updateAnalytics);
            
            // Export buttons
            document.getElementById('exportCSVBtn').addEventListener('click', exportToCSV);
            document.getElementById('exportReportBtn').addEventListener('click', exportFullReport);
            
            // Tab navigation
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (mobileMenu.classList.contains('active') && 
                    !mobileMenu.contains(event.target) && 
                    !mobileMenuBtn.contains(event.target)) {
                    mobileMenu.classList.remove('active');
                }
            });
        }

        // Switch Tab
        function switchTab(tabId) {
            currentTab = tabId;
            
            // Update tabs
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            
            // Update panes
            document.querySelectorAll('.analytics-pane').forEach(pane => {
                pane.classList.toggle('active', pane.id === `${tabId}Pane`);
            });
            
            // Load data for the tab if needed
            if (filteredTrades.length > 0) {
                updateTabContent(tabId);
            }
        }

        // Check Authentication
        async function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            const authButtons = document.getElementById('authButtons');
            
            try {
                // Check Firebase auth state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;
                        await initializePage();
                        authOverlay.classList.add('hidden');
                    } else {
                        // No user signed in - Show login option
                        authMessage.textContent = 'You need to sign in to access Data-Driven Trading Analysis';
                        authButtons.style.display = 'flex';
                        
                        // Setup auth button
                        document.getElementById('goToLoginBtn').onclick = () => {
                            window.location.href = 'index.html';
                        };
                        
                        // Auto-redirect after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 3000);
                    }
                });

            } catch (error) {
                console.error('Auth check error:', error);
                authMessage.textContent = 'Error checking authentication. Please try again.';
                authButtons.style.display = 'flex';
            }
        }

        // Initialize Page for authenticated users
        async function initializePage() {
            if (!currentUser) return;
            
            // Update user info
            updateUserInfo();
            
            // Load user trades
            await loadUserTrades();
        }

        // Update User Information
        function updateUserInfo() {
            if (!currentUser) return;
            
            const userName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader';
            
            document.getElementById('userBanner').querySelector('span').textContent = 
                `Analysis for ${userName}`;
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Load User Trades
        async function loadUserTrades() {
            try {
                if (!currentUser) return;
                
                // Show loading state
                showLoadingState();
                
                const snapshot = await database.ref('userTrades/' + currentUser.uid + '/trades').once('value');
                allUserTrades = [];
                
                snapshot.forEach((childSnapshot) => {
                    const trade = childSnapshot.val();
                    trade.id = childSnapshot.key;
                    allUserTrades.push(trade);
                });

                // Sort by date (newest first)
                allUserTrades.sort((a, b) => {
                    const dateA = a.createdAt || a.date || 0;
                    const dateB = b.createdAt || b.date || 0;
                    return dateB - dateA;
                });

                // Apply initial filters
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading trades:', error);
                showError('Failed to load your trading data. Please check your connection and try again.');
            }
        }

        // Show Loading State
        function showLoadingState() {
            document.getElementById('userStats').innerHTML = `
                <div class="user-stat">
                    <div class="user-stat-value">...</div>
                    <div class="user-stat-label">Loading</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">...</div>
                    <div class="user-stat-label">Loading</div>
                </div>
            `;
            
            document.getElementById('performanceBadges').innerHTML = `
                <div class="badge info">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading Analysis...
                </div>
            `;
        }

        // Update Analytics based on filters
        function updateAnalytics() {
            const timeframe = document.getElementById('timeframeSelect').value;
            const currency = document.getElementById('currencySelect').value;
            const session = document.getElementById('sessionSelect').value;
            const riskLevel = document.getElementById('riskSelect').value;
            
            // Filter trades
            filteredTrades = allUserTrades.filter(trade => {
                // Currency filter
                if (currency !== 'all' && trade.pair !== currency) return false;
                
                // Session filter
                if (session !== 'all' && trade.session !== session) return false;
                
                // Risk level filter
                if (riskLevel !== 'all') {
                    const riskPercent = parseFloat(trade.riskPercent) || 0;
                    switch(riskLevel) {
                        case 'low': if (riskPercent >= 1) return false; break;
                        case 'medium': if (riskPercent < 1 || riskPercent > 2) return false; break;
                        case 'high': if (riskPercent <= 2) return false; break;
                    }
                }
                
                // Timeframe filter
                if (timeframe !== 'all') {
                    const daysAgo = parseInt(timeframe);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                    
                    const tradeDate = new Date(trade.date || trade.createdAt || 0);
                    if (tradeDate < cutoffDate) return false;
                }
                
                return true;
            });
            
            // Update analytics display
            displayAnalytics();
        }

        // Display Analytics
        function displayAnalytics() {
            if (filteredTrades.length === 0) {
                showEmptyState();
                return;
            }
            
            // Calculate analysis
            const stats = calculateBasicStatistics();
            const patterns = identifyBasicPatterns();
            const insights = generateBasicInsights(stats, patterns);
            
            // Store analysis results
            analysisResults = {
                stats,
                patterns,
                insights,
                filteredTrades
            };
            
            // Update user stats banner
            updateUserStatsBanner(stats);
            
            // Update current tab content
            updateTabContent(currentTab);
        }

        // Show Empty State
        function showEmptyState() {
            document.getElementById('userStats').innerHTML = `
                <div class="user-stat">
                    <div class="user-stat-value">0</div>
                    <div class="user-stat-label">No Trades</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">$0</div>
                    <div class="user-stat-label">No Data</div>
                </div>
            `;
            
            document.getElementById('performanceBadges').innerHTML = `
                <div class="badge warning">
                    <i class="fas fa-exclamation-circle"></i>
                    No Data Found
                </div>
            `;
            
            document.getElementById('overviewContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="empty-state-title">No Trading Data</div>
                    <div class="empty-state-text">
                        No trades match your selected filters. Try adjusting your criteria or add more trades to your journal.
                    </div>
                    <button onclick="resetFilters()" class="filter-action-btn primary" style="margin-top: 16px;">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                </div>
            `;
            
            document.getElementById('overviewLoading').style.display = 'none';
            document.getElementById('overviewContent').style.display = 'block';
        }

        // Update User Stats Banner
        function updateUserStatsBanner(stats) {
            document.getElementById('userStats').innerHTML = `
                <div class="user-stat">
                    <div class="user-stat-value">${stats.totalTrades}</div>
                    <div class="user-stat-label">Total Trades</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value ${stats.totalPL >= 0 ? '' : 'negative'}">
                        ${stats.totalPL >= 0 ? '+' : ''}$${Math.abs(stats.totalPL).toFixed(0)}
                    </div>
                    <div class="user-stat-label">Net P/L</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">${stats.winRate.toFixed(0)}%</div>
                    <div class="user-stat-label">Win Rate</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value">${stats.avgRR.toFixed(1)}</div>
                    <div class="user-stat-label">Avg R:R</div>
                </div>
            `;
            
            // Update performance badges
            const badgesHTML = `
                <div class="badge ${stats.totalPL >= 0 ? 'success' : 'danger'}">
                    <i class="fas fa-${stats.totalPL >= 0 ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${stats.totalPL >= 0 ? 'Profitable' : 'Losing'}
                </div>
                <div class="badge ${stats.winRate >= 60 ? 'success' : stats.winRate >= 50 ? 'warning' : 'danger'}">
                    <i class="fas fa-percentage"></i>
                    Win Rate: ${stats.winRate >= 60 ? 'High' : stats.winRate >= 50 ? 'Good' : 'Low'}
                </div>
                <div class="badge ${stats.profitFactor >= 2 ? 'success' : stats.profitFactor >= 1.5 ? 'warning' : 'danger'}">
                    <i class="fas fa-chart-line"></i>
                    PF: ${stats.profitFactor.toFixed(1)}
                </div>
            `;
            
            document.getElementById('performanceBadges').innerHTML = badgesHTML;
        }

        // Update Tab Content
        function updateTabContent(tabId) {
            if (!analysisResults.stats || filteredTrades.length === 0) return;
            
            const { stats, patterns, insights } = analysisResults;
            
            switch(tabId) {
                case 'overview':
                    updateOverviewTab(stats, patterns, insights);
                    break;
                case 'performance':
                    updatePerformanceTab(stats, patterns);
                    break;
                case 'risk':
                    updateRiskTab(stats, patterns);
                    break;
                case 'insights':
                    updateInsightsTab(insights);
                    break;
            }
        }

        // Update Overview Tab
        function updateOverviewTab(stats, patterns, insights) {
            const overviewHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-tachometer-alt"></i>
                        <div class="analytics-card-title">Performance Summary</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value ${stats.totalPL >= 0 ? 'positive' : 'negative'}">
                                ${stats.totalPL >= 0 ? '+' : ''}$${stats.totalPL.toFixed(0)}
                            </div>
                            <div class="stat-label">Net P/L</div>
                            <div class="stat-description">Total profit/loss</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value ${stats.winRate >= 50 ? 'positive' : 'negative'}">
                                ${stats.winRate.toFixed(1)}%
                            </div>
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-description">Success rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stat-value">${stats.totalTrades}</div>
                            <div class="stat-label">Total Trades</div>
                            <div class="stat-description">Sample size</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="stat-value">${stats.profitFactor.toFixed(2)}</div>
                            <div class="stat-label">Profit Factor</div>
                            <div class="stat-description">Risk efficiency</div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-chart-pie"></i>
                        <div class="analytics-card-title">Win/Loss Distribution</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                
                <div class="insights-card">
                    <div class="insights-header">
                        <i class="fas fa-lightbulb"></i>
                        <h3>Key Insights</h3>
                    </div>
                    <ul class="insights-list">
                        ${insights.slice(0, 3).map(insight => `
                            <li>
                                <div class="insight-icon ${insight.type}">
                                    <i class="fas fa-${insight.icon}"></i>
                                </div>
                                <div>
                                    <div class="insight-text">${insight.text}</div>
                                    ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('overviewLoading').style.display = 'none';
            document.getElementById('overviewContent').innerHTML = overviewHTML;
            document.getElementById('overviewContent').style.display = 'block';
            
            // Initialize chart
            setTimeout(() => {
                initializeDistributionChart(stats);
            }, 100);
        }

        // Update Performance Tab
        function updatePerformanceTab(stats, patterns) {
            const performanceHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-chart-line"></i>
                        <div class="analytics-card-title">Performance Trend</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-clock"></i>
                        <div class="analytics-card-title">Session Performance</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sessionChart"></canvas>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="analytics-card-title">Pair Performance</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="pairChart"></canvas>
                    </div>
                </div>
            `;
            
            document.getElementById('performanceLoading').style.display = 'none';
            document.getElementById('performanceContent').innerHTML = performanceHTML;
            document.getElementById('performanceContent').style.display = 'block';
            
            // Initialize charts
            setTimeout(() => {
                initializePerformanceCharts(stats, patterns);
            }, 100);
        }

        // Update Risk Tab
        function updateRiskTab(stats, patterns) {
            const riskHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-shield-alt"></i>
                        <div class="analytics-card-title">Risk Analysis</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon ${stats.avgRiskPercent <= 2 ? 'green' : 'orange'}">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value">${stats.avgRiskPercent.toFixed(1)}%</div>
                            <div class="stat-label">Avg Risk</div>
                            <div class="stat-description">Per trade</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon ${stats.maxConsecutiveLosses <= 3 ? 'green' : 'red'}">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value">${stats.maxConsecutiveLosses}</div>
                            <div class="stat-label">Max Loss Streak</div>
                            <div class="stat-description">Consecutive losses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-value">${stats.largestWin.toFixed(0)}</div>
                            <div class="stat-label">Largest Win</div>
                            <div class="stat-description">Biggest profit</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-value">${Math.abs(stats.largestLoss).toFixed(0)}</div>
                            <div class="stat-label">Largest Loss</div>
                            <div class="stat-description">Biggest loss</div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-chart-bar"></i>
                        <div class="analytics-card-title">Risk Distribution</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
                
                <div class="insights-card">
                    <div class="insights-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Risk Management Insights</h3>
                    </div>
                    <ul class="insights-list">
                        ${generateRiskInsights(stats).slice(0, 3).map(insight => `
                            <li>
                                <div class="insight-icon ${insight.type}">
                                    <i class="fas fa-${insight.icon}"></i>
                                </div>
                                <div>
                                    <div class="insight-text">${insight.text}</div>
                                    ${insight.action ? `<div class="insight-action">${insight.action}</div>` : ''}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('riskLoading').style.display = 'none';
            document.getElementById('riskContent').innerHTML = riskHTML;
            document.getElementById('riskContent').style.display = 'block';
            
            // Initialize chart
            setTimeout(() => {
                initializeRiskChart(stats);
            }, 100);
        }

        // Update Insights Tab
        function updateInsightsTab(insights) {
            const insightsHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-bullseye"></i>
                        <div class="analytics-card-title">Top Recommendations</div>
                    </div>
                    <div class="insights-card" style="background: linear-gradient(135deg, var(--notion-green-light), var(--notion-blue-light));">
                        <div class="insights-header">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>Actionable Improvements</h3>
                        </div>
                        <ul class="insights-list">
                            ${generateRecommendations().slice(0, 5).map((rec, index) => `
                                <li>
                                    <div class="insight-icon ${rec.priority === 'high' ? 'warning' : rec.priority === 'medium' ? 'info' : 'success'}">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <div class="insight-text"><strong>${rec.title}:</strong> ${rec.description}</div>
                                        <div class="insight-action">
                                            <strong>Action:</strong> ${rec.action}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-star"></i>
                        <div class="analytics-card-title">Best Performing Areas</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="stat-value">${analysisResults.patterns?.bestSession?.name || 'N/A'}</div>
                            <div class="stat-label">Best Session</div>
                            <div class="stat-description">${analysisResults.patterns?.bestSession?.rate?.toFixed(1) || '0'}% win rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-value">${analysisResults.patterns?.bestPair?.name || 'N/A'}</div>
                            <div class="stat-label">Best Pair</div>
                            <div class="stat-description">${analysisResults.patterns?.bestPair?.rate?.toFixed(1) || '0'}% win rate</div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <i class="fas fa-chart-line"></i>
                        <div class="analytics-card-title">Overall Performance Rating</div>
                    </div>
                    <div class="performance-badges" style="margin: 0; padding: 16px 0;">
                        <div class="badge ${analysisResults.stats?.overallRating >= 8 ? 'success' : analysisResults.stats?.overallRating >= 6 ? 'warning' : 'danger'}">
                            <i class="fas fa-chart-line"></i>
                            Overall: ${analysisResults.stats?.overallRating || 0}/10
                        </div>
                        <div class="badge ${analysisResults.stats?.consistencyScore >= 8 ? 'success' : analysisResults.stats?.consistencyScore >= 6 ? 'warning' : 'danger'}">
                            <i class="fas fa-shield-alt"></i>
                            Consistency: ${analysisResults.stats?.consistencyScore || 0}/10
                        </div>
                        <div class="badge ${analysisResults.stats?.riskManagementScore >= 8 ? 'success' : analysisResults.stats?.riskManagementScore >= 6 ? 'warning' : 'danger'}">
                            <i class="fas fa-balance-scale"></i>
                            Risk Mgmt: ${analysisResults.stats?.riskManagementScore || 0}/10
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('insightsLoading').style.display = 'none';
            document.getElementById('insightsContent').innerHTML = insightsHTML;
            document.getElementById('insightsContent').style.display = 'block';
        }

        // Calculate Basic Statistics
        function calculateBasicStatistics() {
            const totalTrades = filteredTrades.length;
            const wins = filteredTrades.filter(t => t.result === 'Win').length;
            const losses = filteredTrades.filter(t => t.result === 'Loss').length;
            const breakEvens = filteredTrades.filter(t => t.result === 'Break Even').length;
            
            const totalPL = filteredTrades.reduce((sum, trade) => sum + (trade.pl || 0), 0);
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            
            // Calculate R:R statistics
            const rrTrades = filteredTrades.filter(t => t.rr);
            let avgRR = 2.0;
            if (rrTrades.length > 0) {
                const totalRR = rrTrades.reduce((sum, trade) => {
                    const rrMatch = trade.rr?.match(/1:(\d+\.?\d*)/);
                    return rrMatch ? sum + parseFloat(rrMatch[1]) : sum;
                }, 0);
                avgRR = totalRR / rrTrades.length;
            }
            
            // Calculate profit factor
            const totalWins = filteredTrades.filter(t => t.result === 'Win')
                .reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const totalLosses = filteredTrades.filter(t => t.result === 'Loss')
                .reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? Infinity : 0;
            
            // Calculate risk statistics
            const riskTrades = filteredTrades.filter(t => t.riskPercent);
            const avgRiskPercent = riskTrades.length > 0 ? 
                riskTrades.reduce((sum, trade) => sum + (parseFloat(trade.riskPercent) || 0), 0) / riskTrades.length : 2;
            
            // Calculate largest win/loss
            const winAmounts = filteredTrades.filter(t => t.pl > 0).map(t => t.pl || 0);
            const lossAmounts = filteredTrades.filter(t => t.pl < 0).map(t => Math.abs(t.pl || 0));
            const largestWin = winAmounts.length > 0 ? Math.max(...winAmounts) : 0;
            const largestLoss = lossAmounts.length > 0 ? Math.max(...lossAmounts) : 0;
            
            // Calculate consecutive losses
            let maxConsecutiveLosses = 0;
            let currentStreak = 0;
            filteredTrades.forEach(trade => {
                if (trade.result === 'Loss') {
                    currentStreak++;
                    maxConsecutiveLosses = Math.max(maxConsecutiveLosses, currentStreak);
                } else {
                    currentStreak = 0;
                }
            });
            
            // Calculate ratings
            const overallRating = Math.min(10, 
                (winRate >= 60 ? 3 : winRate >= 50 ? 2 : winRate >= 40 ? 1 : 0) +
                (profitFactor >= 2 ? 3 : profitFactor >= 1.5 ? 2 : profitFactor >= 1 ? 1 : 0) +
                (avgRR >= 2 ? 2 : avgRR >= 1.5 ? 1 : 0) +
                (avgRiskPercent <= 2 ? 1 : 0)
            );
            
            const consistencyScore = calculateConsistencyScore(filteredTrades);
            const riskManagementScore = calculateRiskManagementScore(avgRiskPercent, maxConsecutiveLosses, profitFactor);
            
            return {
                totalTrades,
                wins,
                losses,
                breakEvens,
                totalPL,
                winRate,
                avgRR,
                profitFactor,
                avgRiskPercent,
                largestWin,
                largestLoss,
                maxConsecutiveLosses,
                overallRating,
                consistencyScore,
                riskManagementScore
            };
        }

        // Calculate Consistency Score
        function calculateConsistencyScore(trades) {
            if (trades.length < 5) return 5;
            
            const plArray = trades.map(t => t.pl || 0);
            const avg = plArray.reduce((a, b) => a + b, 0) / plArray.length;
            const variance = plArray.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / plArray.length;
            const stdDev = Math.sqrt(variance);
            
            const consistency = Math.max(0, 10 - (stdDev / 10));
            return Math.min(10, consistency);
        }

        // Calculate Risk Management Score
        function calculateRiskManagementScore(avgRiskPercent, maxConsecutiveLosses, profitFactor) {
            let score = 0;
            
            if (avgRiskPercent <= 1) score += 3;
            else if (avgRiskPercent <= 2) score += 2;
            else if (avgRiskPercent <= 3) score += 1;
            
            if (maxConsecutiveLosses <= 2) score += 3;
            else if (maxConsecutiveLosses <= 4) score += 2;
            else if (maxConsecutiveLosses <= 6) score += 1;
            
            if (profitFactor >= 1.5) score += 2;
            else if (profitFactor >= 1) score += 1;
            
            return Math.min(10, score);
        }

        // Identify Basic Patterns
        function identifyBasicPatterns() {
            const patterns = {
                sessionPerformance: {},
                pairPerformance: {},
                bestSession: { name: 'N/A', rate: 0 },
                worstSession: { name: 'N/A', rate: 100 },
                bestPair: { name: 'N/A', rate: 0 },
                worstPair: { name: 'N/A', rate: 100 }
            };
            
            // Session performance
            const sessions = ['London', 'New York', 'Asian', 'Sydney'];
            sessions.forEach(session => {
                const sessionTrades = filteredTrades.filter(t => t.session === session);
                const wins = sessionTrades.filter(t => t.result === 'Win').length;
                const total = sessionTrades.length;
                const rate = total > 0 ? (wins / total) * 100 : 0;
                
                patterns.sessionPerformance[session] = { total, wins, rate };
                
                if (total >= 3) {
                    if (rate > patterns.bestSession.rate) {
                        patterns.bestSession = { name: session, rate };
                    }
                    if (rate < patterns.worstSession.rate) {
                        patterns.worstSession = { name: session, rate };
                    }
                }
            });
            
            // Pair performance
            const pairs = {};
            filteredTrades.forEach(trade => {
                const pair = trade.pair || 'Unknown';
                if (!pairs[pair]) {
                    pairs[pair] = { wins: 0, total: 0 };
                }
                pairs[pair].total++;
                if (trade.result === 'Win') {
                    pairs[pair].wins++;
                }
            });
            
            Object.entries(pairs).forEach(([pair, data]) => {
                const rate = data.total > 0 ? (data.wins / data.total) * 100 : 0;
                patterns.pairPerformance[pair] = { ...data, rate };
                
                if (data.total >= 3) {
                    if (rate > patterns.bestPair.rate) {
                        patterns.bestPair = { name: pair, rate };
                    }
                    if (rate < patterns.worstPair.rate) {
                        patterns.worstPair = { name: pair, rate };
                    }
                }
            });
            
            return patterns;
        }

        // Generate Basic Insights
        function generateBasicInsights(stats, patterns) {
            const insights = [];
            
            // Win rate insights
            if (stats.winRate >= 60) {
                insights.push({
                    type: 'success',
                    icon: 'trophy',
                    text: `Excellent win rate of ${stats.winRate.toFixed(1)}%`,
                    action: 'Maintain your current entry strategy'
                });
            } else if (stats.winRate < 40) {
                insights.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    text: `Low win rate of ${stats.winRate.toFixed(1)}%`,
                    action: 'Review entry criteria and wait for better setups'
                });
            }
            
            // Profit factor insights
            if (stats.profitFactor >= 2) {
                insights.push({
                    type: 'success',
                    icon: 'chart-line',
                    text: `Strong profit factor of ${stats.profitFactor.toFixed(2)}`,
                    action: 'Good risk management - continue current approach'
                });
            } else if (stats.profitFactor < 1) {
                insights.push({
                    type: 'danger',
                    icon: 'exclamation-circle',
                    text: `Profit factor below 1 (${stats.profitFactor.toFixed(2)})`,
                    action: 'Cut losses quicker and let winners run longer'
                });
            }
            
            // Risk insights
            if (stats.avgRiskPercent > 2) {
                insights.push({
                    type: 'warning',
                    icon: 'balance-scale',
                    text: `High average risk (${stats.avgRiskPercent.toFixed(1)}%)`,
                    action: 'Reduce position sizes to max 2% per trade'
                });
            }
            
            // Session insights
            if (patterns.bestSession.rate - patterns.worstSession.rate > 20) {
                insights.push({
                    type: 'info',
                    icon: 'clock',
                    text: `Best performance in ${patterns.bestSession.name} session`,
                    action: `Focus more trading during ${patterns.bestSession.name} session`
                });
            }
            
            // Add general insight if not enough
            if (insights.length < 3) {
                insights.push({
                    type: 'info',
                    icon: 'brain',
                    text: `Average R:R ratio of 1:${stats.avgRR.toFixed(1)}`,
                    action: 'Maintain discipline in taking profits at targets'
                });
            }
            
            return insights;
        }

        // Generate Risk Insights
        function generateRiskInsights(stats) {
            const insights = [];
            
            if (stats.avgRiskPercent > 2) {
                insights.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    text: `Average risk per trade (${stats.avgRiskPercent.toFixed(1)}%) exceeds 2% limit`,
                    action: 'Reduce position sizes to improve risk management'
                });
            }
            
            if (stats.maxConsecutiveLosses >= 3) {
                insights.push({
                    type: 'warning',
                    icon: 'times-circle',
                    text: `${stats.maxConsecutiveLosses} consecutive losses indicates potential overtrading`,
                    action: 'Take a break after 2 consecutive losses'
                });
            }
            
            if (stats.profitFactor < 1.5) {
                insights.push({
                    type: 'info',
                    icon: 'balance-scale',
                    text: `Profit factor of ${stats.profitFactor.toFixed(2)} can be improved`,
                    action: 'Focus on better exit strategies'
                });
            }
            
            return insights;
        }

        // Generate Recommendations
        function generateRecommendations() {
            const { stats, patterns } = analysisResults;
            const recommendations = [];
            
            if (stats.winRate < 40) {
                recommendations.push({
                    title: "Improve Entry Accuracy",
                    description: "Win rate indicates need for better trade selection",
                    action: "Focus on higher probability setups only",
                    priority: "high"
                });
            }
            
            if (stats.avgRiskPercent > 2) {
                recommendations.push({
                    title: "Reduce Position Sizes",
                    description: "You're risking too much per trade",
                    action: "Maximum 2% risk per trade",
                    priority: "high"
                });
            }
            
            if (stats.maxConsecutiveLosses >= 3) {
                recommendations.push({
                    title: "Implement Loss Rules",
                    description: "Too many consecutive losses",
                    action: "Stop trading after 2 losses in a row",
                    priority: "medium"
                });
            }
            
            if (patterns.bestSession.rate - patterns.worstSession.rate > 20) {
                recommendations.push({
                    title: "Optimize Trading Times",
                    description: "Large performance difference between sessions",
                    action: `Focus on ${patterns.bestSession.name} session`,
                    priority: "medium"
                });
            }
            
            if (stats.profitFactor < 1) {
                recommendations.push({
                    title: "Review Exit Strategy",
                    description: "Losing more than winning",
                    action: "Let winners run, cut losses quickly",
                    priority: "high"
                });
            }
            
            // Always include general recommendations
            recommendations.push({
                title: "Maintain Trading Journal",
                description: "Continuous improvement requires tracking",
                action: "Review each trade before entering next",
                priority: "low"
            });
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
        }

        // Initialize Distribution Chart
        function initializeDistributionChart(stats) {
            const ctx = document.getElementById('distributionChart');
            if (!ctx || !stats) return;
            
            // Destroy existing chart
            if (charts.distributionChart) {
                charts.distributionChart.destroy();
            }
            
            charts.distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses', 'Break Even'],
                    datasets: [{
                        data: [stats.wins, stats.losses, stats.breakEvens],
                        backgroundColor: [
                            'rgba(15, 123, 108, 0.7)',
                            'rgba(209, 69, 59, 0.7)',
                            'rgba(112, 113, 110, 0.7)'
                        ],
                        borderColor: [
                            '#0f7b6c',
                            '#d1453b',
                            '#70716e'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize Performance Charts
        function initializePerformanceCharts(stats, patterns) {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart');
            if (perfCtx) {
                if (charts.performanceChart) {
                    charts.performanceChart.destroy();
                }
                
                const monthlyData = calculateMonthlyPerformanceData();
                const months = monthlyData.map(d => d.month);
                const plData = monthlyData.map(d => d.pl);
                
                charts.performanceChart = new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Monthly P/L ($)',
                            data: plData,
                            borderColor: '#0f7b6c',
                            backgroundColor: 'rgba(15, 123, 108, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Session Chart
            const sessionCtx = document.getElementById('sessionChart');
            if (sessionCtx) {
                if (charts.sessionChart) {
                    charts.sessionChart.destroy();
                }
                
                const sessions = ['London', 'New York', 'Asian', 'Sydney'];
                const winRates = sessions.map(session => 
                    patterns.sessionPerformance[session]?.rate || 0
                );
                
                charts.sessionChart = new Chart(sessionCtx, {
                    type: 'bar',
                    data: {
                        labels: sessions,
                        datasets: [{
                            label: 'Win Rate %',
                            data: winRates,
                            backgroundColor: winRates.map(rate => 
                                rate >= 60 ? 'rgba(15, 123, 108, 0.7)' : 
                                rate >= 40 ? 'rgba(12, 140, 233, 0.7)' : 'rgba(209, 69, 59, 0.7)'
                            ),
                            borderColor: winRates.map(rate => 
                                rate >= 60 ? '#0f7b6c' : 
                                rate >= 40 ? '#0c8ce9' : '#d1453b'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Pair Chart
            const pairCtx = document.getElementById('pairChart');
            if (pairCtx) {
                if (charts.pairChart) {
                    charts.pairChart.destroy();
                }
                
                const pairData = Object.entries(patterns.pairPerformance)
                    .filter(([_, data]) => data.total >= 2)
                    .sort((a, b) => b[1].rate - a[1].rate)
                    .slice(0, 5);
                
                charts.pairChart = new Chart(pairCtx, {
                    type: 'horizontalBar',
                    data: {
                        labels: pairData.map(([pair]) => pair.length > 10 ? pair.substring(0, 8) + '...' : pair),
                        datasets: [{
                            label: 'Win Rate %',
                            data: pairData.map(([_, data]) => data.rate),
                            backgroundColor: pairData.map(([_, data]) => 
                                data.rate >= 60 ? 'rgba(15, 123, 108, 0.7)' : 
                                data.rate >= 40 ? 'rgba(12, 140, 233, 0.7)' : 'rgba(209, 69, 59, 0.7)'
                            ),
                            borderColor: pairData.map(([_, data]) => 
                                data.rate >= 60 ? '#0f7b6c' : 
                                data.rate >= 40 ? '#0c8ce9' : '#d1453b'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize Risk Chart
        function initializeRiskChart(stats) {
            const ctx = document.getElementById('riskChart');
            if (!ctx || !stats) return;
            
            if (charts.riskChart) {
                charts.riskChart.destroy();
            }
            
            const riskLevels = ['< 1%', '1-2%', '2-3%', '> 3%'];
            const riskData = calculateRiskDistribution();
            
            charts.riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: riskLevels,
                    datasets: [{
                        label: 'Number of Trades',
                        data: riskData,
                        backgroundColor: [
                            'rgba(15, 123, 108, 0.7)',
                            'rgba(12, 140, 233, 0.7)',
                            'rgba(255, 107, 53, 0.7)',
                            'rgba(209, 69, 59, 0.7)'
                        ],
                        borderColor: [
                            '#0f7b6c',
                            '#0c8ce9',
                            '#ff6b35',
                            '#d1453b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Calculate Monthly Performance Data
        function calculateMonthlyPerformanceData() {
            const monthlyData = {};
            filteredTrades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                const monthKey = date.toLocaleDateString('en-US', { month: 'short' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { month: monthKey, pl: 0 };
                }
                monthlyData[monthKey].pl += trade.pl || 0;
            });
            
            return Object.values(monthlyData).slice(-6);
        }

        // Calculate Risk Distribution
        function calculateRiskDistribution() {
            const distribution = [0, 0, 0, 0];
            
            filteredTrades.forEach(trade => {
                const riskPercent = parseFloat(trade.riskPercent) || 0;
                if (riskPercent < 1) distribution[0]++;
                else if (riskPercent <= 2) distribution[1]++;
                else if (riskPercent <= 3) distribution[2]++;
                else distribution[3]++;
            });
            
            return distribution;
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('timeframeSelect').value = '30';
            document.getElementById('currencySelect').value = 'all';
            document.getElementById('sessionSelect').value = 'all';
            document.getElementById('riskSelect').value = 'medium';
            updateAnalytics();
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredTrades.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Date', 'Pair', 'Direction', 'Result', 'P/L', 'Risk %', 'R:R', 'Session'];
            const csvData = [
                headers.join(','),
                ...filteredTrades.map(trade => {
                    const date = new Date(trade.date || trade.createdAt || 0).toLocaleDateString();
                    return [
                        `"${date}"`,
                        trade.pair || '',
                        trade.direction || '',
                        trade.result || '',
                        trade.pl || 0,
                        trade.riskPercent || '',
                        trade.rr || '',
                        trade.session || ''
                    ].join(',');
                })
            ].join('\n');
            
            downloadCSV(csvData, `trading-analysis-${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Export Full Report
        function exportFullReport() {
            if (!analysisResults.stats) {
                alert('Please run analysis first before generating report');
                return;
            }
            
            const report = generateFullReportHTML();
            const blob = new Blob([report], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dta-report-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate Full Report HTML
        function generateFullReportHTML() {
            const { stats, insights } = analysisResults;
            
            return `<!DOCTYPE html>
<html>
<head>
    <title>DTA Report - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #0f7b6c; }
        .section { margin-bottom: 30px; }
        .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .metric { padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; margin: 5px 0; }
        .positive { color: #0f7b6c; }
        .negative { color: #d1453b; }
        .insight { background: #f0f8ff; padding: 15px; margin: 10px 0; border-left: 4px solid #0c8ce9; border-radius: 4px; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Data-Driven Trading Analysis Report</h1>
        <p>Generated: ${new Date().toLocaleString()}</p>
        <p>Trader: ${currentUser.email}</p>
    </div>
    
    <div class="section">
        <h2>Performance Summary</h2>
        <div class="metric-grid">
            <div class="metric">
                <div>Total P/L</div>
                <div class="metric-value ${stats.totalPL >= 0 ? 'positive' : 'negative'}">$${stats.totalPL.toFixed(2)}</div>
            </div>
            <div class="metric">
                <div>Win Rate</div>
                <div class="metric-value">${stats.winRate.toFixed(1)}%</div>
            </div>
            <div class="metric">
                <div>Total Trades</div>
                <div class="metric-value">${stats.totalTrades}</div>
            </div>
            <div class="metric">
                <div>Profit Factor</div>
                <div class="metric-value">${stats.profitFactor.toFixed(2)}</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Key Insights</h2>
        ${insights.map(insight => `
            <div class="insight">
                <strong>${insight.text}</strong>
                <br><em>${insight.action}</em>
            </div>
        `).join('')}
    </div>
    
    <div class="section no-print">
        <p><em>Note: This is a summary report. For detailed analysis, use the web interface.</em></p>
    </div>
</body>
</html>`;
        }

        // Download CSV
        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Show Error
        function showError(message) {
            document.getElementById('overviewContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="empty-state-title">Analysis Error</div>
                    <div class="empty-state-text">
                        ${message}
                    </div>
                    <button onclick="loadUserTrades()" class="filter-action-btn primary" style="margin-top: 16px;">
                        <i class="fas fa-redo"></i> Retry Loading
                    </button>
                </div>
            `;
            
            document.getElementById('overviewLoading').style.display = 'none';
            document.getElementById('overviewContent').style.display = 'block';
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                    chart.update();
                }
            });
        });

        // Expose functions to global scope
        window.resetFilters = resetFilters;
        window.updateAnalytics = updateAnalytics;
        window.loadUserTrades = loadUserTrades;
        window.exportToCSV = exportToCSV;
        window.exportFullReport = exportFullReport;
        window.printReport = printReport;
    </script>
</body>
</html>
