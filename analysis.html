<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA | Advanced Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .auth-message {
            font-size: 16px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 300px;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .mobile-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit;
            text-align: left;
        }

        .mobile-menu-item.primary {
            background-color: var(--notion-green);
            color: white;
        }

        /* Main Container */
        .main-container {
            margin: 50px 0 60px 0;
            padding: 0;
            width: 100%;
        }

        /* Page Header */
        .page-header {
            padding: 20px 16px;
            background: linear-gradient(135deg, var(--notion-purple-light), var(--notion-blue-light));
            margin-bottom: 0;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--notion-text);
            line-height: 1.3;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Analysis Controls */
        .analysis-controls {
            padding: 16px;
            background-color: white;
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        .control-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 6px;
            display: block;
        }

        .control-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            color: var(--notion-text);
        }

        .control-select:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 2px rgba(12, 140, 233, 0.1);
        }

        .control-btn {
            padding: 10px 20px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            background-color: white;
            color: var(--notion-text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            align-self: flex-end;
        }

        .control-btn:hover {
            background-color: var(--notion-gray);
        }

        .control-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .control-btn.primary:hover {
            background-color: #0c6b5d;
        }

        /* Performance Overview */
        .performance-overview {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action {
            font-size: 13px;
            color: var(--notion-blue);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-card {
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--notion-text-light);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-value.positive {
            color: var(--notion-green);
        }

        .metric-value.negative {
            color: var(--notion-red);
        }

        .metric-change {
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--notion-green);
        }

        .metric-change.negative {
            color: var(--notion-red);
        }

        /* Charts Grid */
        .charts-grid {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .chart-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            padding: 20px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Detailed Statistics */
        .detailed-stats {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 12px;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-box {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            padding: 16px;
            text-align: center;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 18px;
        }

        .stat-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .stat-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .stat-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .stat-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .stat-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .stat-box .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-box .stat-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 8px;
        }

        .stat-description {
            font-size: 11px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Win/Loss Analysis */
        .win-loss-analysis {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 16px;
        }

        @media (min-width: 768px) {
            .analysis-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .analysis-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            padding: 20px;
        }

        .analysis-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .analysis-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .analysis-card-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .analysis-card-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .analysis-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .analysis-list {
            list-style: none;
            padding: 0;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--notion-gray);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-item-label {
            font-size: 13px;
            color: var(--notion-text);
        }

        .analysis-item-value {
            font-size: 13px;
            font-weight: 500;
        }

        .analysis-item-value.positive {
            color: var(--notion-green);
        }

        .analysis-item-value.negative {
            color: var(--notion-red);
        }

        /* Session Analysis */
        .session-analysis {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        /* Pair Analysis */
        .pair-analysis {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .pair-list {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            overflow: hidden;
        }

        .pair-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--notion-gray);
        }

        .pair-item:last-child {
            border-bottom: none;
        }

        .pair-name {
            font-size: 14px;
            font-weight: 500;
            flex: 2;
        }

        .pair-stats {
            flex: 1;
            text-align: center;
        }

        .pair-stat {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .pair-stat-value {
            font-weight: 600;
        }

        .pair-stat-value.positive {
            color: var(--notion-green);
        }

        .pair-stat-value.negative {
            color: var(--notion-red);
        }

        /* Insights & Recommendations */
        .insights-recommendations {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 16px;
        }

        @media (min-width: 768px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .insight-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            padding: 20px;
        }

        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .insight-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .insight-card-icon.success {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .insight-card-icon.warning {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .insight-card-icon.info {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .insight-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .insight-card-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--notion-text);
        }

        .insight-card-content ul {
            padding-left: 20px;
            margin-top: 8px;
        }

        .insight-card-content li {
            margin-bottom: 4px;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--notion-text-light);
            flex-direction: column;
            gap: 16px;
        }

        .loading i {
            animation: spin 1s linear infinite;
            font-size: 32px;
        }

        .loading-text {
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--notion-text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--notion-gray-dark);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--notion-text);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--notion-blue);
            background-color: var(--notion-blue-light);
        }

        .bottom-nav-btn i {
            font-size: 18px;
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
            }
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-container {
                margin: 0;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .page-header {
                border-radius: 12px 12px 0 0;
            }
            
            .performance-overview {
                border-radius: 0;
            }
            
            .charts-grid {
                border-radius: 0;
            }
            
            .detailed-stats {
                border-radius: 0;
            }
            
            .win-loss-analysis {
                border-radius: 0;
            }
            
            .session-analysis {
                border-radius: 0;
            }
            
            .pair-analysis {
                border-radius: 0;
            }
            
            .insights-recommendations {
                border-radius: 0 0 12px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Loading advanced analytics...</div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header-title">Advanced Analytics</div>
        </div>
        <button class="mobile-menu-btn" id="mobileRefreshBtn">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" class="mobile-menu-item">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <a href="journal.html" class="mobile-menu-item">
            <i class="fas fa-book"></i>
            Trading Journal
        </a>
        <a href="add-trade.html" class="mobile-menu-item primary">
            <i class="fas fa-plus-circle"></i>
            Add New Trade
        </a>
        <button class="mobile-menu-item" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">ðŸ“ˆ Advanced Analytics</h1>
            <p class="page-subtitle">Deep dive into your trading performance with detailed metrics and insights</p>
        </div>

        <!-- Analysis Controls -->
        <div class="analysis-controls">
            <div class="control-group">
                <label class="control-label">Time Period</label>
                <select class="control-select" id="timePeriod">
                    <option value="all">All Time</option>
                    <option value="month">Last Month</option>
                    <option value="quarter">Last Quarter</option>
                    <option value="year">Last Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Metric Focus</label>
                <select class="control-select" id="metricFocus">
                    <option value="all">All Metrics</option>
                    <option value="performance">Performance</option>
                    <option value="risk">Risk Management</option>
                    <option value="consistency">Consistency</option>
                    <option value="patterns">Trading Patterns</option>
                </select>
            </div>
            
            <button class="control-btn primary" id="generateReportBtn">
                <i class="fas fa-file-pdf"></i>
                Generate PDF Report
            </button>
        </div>

        <!-- Performance Overview -->
        <div class="performance-overview" id="performanceOverview">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <span>Performance Overview</span>
                </div>
            </div>
            
            <div class="loading" id="metricsLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Calculating performance metrics...</div>
            </div>
            
            <div id="metricsContent" style="display: none;">
                <div class="metrics-grid">
                    <!-- Key metrics will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Equity Curve</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Win/Loss Distribution</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="winLossChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Monthly Performance</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Risk vs Reward</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="riskRewardChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="detailed-stats">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calculator"></i>
                    <span>Detailed Statistics</span>
                </div>
            </div>
            
            <div class="stats-grid" id="detailedStats">
                <!-- Detailed stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Win/Loss Analysis -->
        <div class="win-loss-analysis">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-balance-scale"></i>
                    <span>Win/Loss Analysis</span>
                </div>
            </div>
            
            <div class="analysis-cards">
                <div class="analysis-card">
                    <div class="analysis-card-header">
                        <div class="analysis-card-icon green">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="analysis-card-title">Winning Trades Analysis</div>
                    </div>
                    <ul class="analysis-list" id="winningTradesList">
                        <!-- Winning trades analysis -->
                    </ul>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-card-header">
                        <div class="analysis-card-icon red">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="analysis-card-title">Losing Trades Analysis</div>
                    </div>
                    <ul class="analysis-list" id="losingTradesList">
                        <!-- Losing trades analysis -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Session Analysis -->
        <div class="session-analysis">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clock"></i>
                    <span>Session Analysis</span>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Performance by Trading Session</div>
                </div>
                <div class="chart-container">
                    <canvas id="sessionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Pair Analysis -->
        <div class="pair-analysis">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Pair Analysis</span>
                </div>
            </div>
            
            <div class="pair-list" id="pairList">
                <!-- Pairs analysis will be populated by JavaScript -->
            </div>
        </div>

        <!-- Insights & Recommendations -->
        <div class="insights-recommendations">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-lightbulb"></i>
                    <span>Insights & Recommendations</span>
                </div>
            </div>
            
            <div class="insights-grid" id="insightsGrid">
                <!-- Insights will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-home"></i>
            Dashboard
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='journal.html'">
            <i class="fas fa-book"></i>
            Journal
        </button>
        <button class="bottom-nav-btn active">
            <i class="fas fa-chart-line"></i>
            Analysis
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='settings.html'">
            <i class="fas fa-cog"></i>
            Settings
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let userTrades = [];
        let analyticsData = {};
        let charts = {};

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobileRefreshBtn').addEventListener('click', loadAnalyticsData);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);
            
            // Controls
            document.getElementById('timePeriod').addEventListener('change', handleTimePeriodChange);
            document.getElementById('metricFocus').addEventListener('change', updateAnalyticsFocus);
            document.getElementById('generateReportBtn').addEventListener('click', generatePDFReport);
        }

        // Check Authentication
        function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await initializeAnalytics();
                    authOverlay.classList.add('hidden');
                } else {
                    authMessage.textContent = 'You need to sign in to access advanced analytics';
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            });
        }

        // Initialize Analytics
        async function initializeAnalytics() {
            await loadAnalyticsData();
        }

        // Load Analytics Data
        async function loadAnalyticsData() {
            try {
                // Show loading states
                document.getElementById('metricsLoading').style.display = 'flex';
                document.getElementById('metricsContent').style.display = 'none';
                
                // Load user trades
                const snapshot = await database.ref('userTrades/' + currentUser.uid + '/trades').once('value');
                userTrades = [];
                
                snapshot.forEach((childSnapshot) => {
                    const trade = childSnapshot.val();
                    trade.id = childSnapshot.key;
                    userTrades.push(trade);
                });

                // Sort by date (oldest first for charts)
                userTrades.sort((a, b) => {
                    const dateA = a.createdAt || a.date || 0;
                    const dateB = b.createdAt || b.date || 0;
                    return dateA - dateB;
                });

                // Calculate analytics data
                analyticsData = calculateAnalyticsData();
                
                // Update all sections
                updatePerformanceMetrics();
                updateDetailedStatistics();
                updateWinLossAnalysis();
                updateCharts();
                updatePairAnalysis();
                updateInsightsAndRecommendations();
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError('Failed to load analytics data. Please check your connection and try again.');
            }
        }

        // Calculate Analytics Data
        function calculateAnalyticsData() {
            if (userTrades.length === 0) {
                return {
                    totalTrades: 0,
                    winRate: 0,
                    netPL: 0,
                    profitFactor: 0,
                    // ... other metrics with default values
                };
            }

            const totalTrades = userTrades.length;
            const winningTrades = userTrades.filter(t => t.result === 'Win');
            const losingTrades = userTrades.filter(t => t.result === 'Loss');
            
            const wins = winningTrades.length;
            const losses = losingTrades.length;
            const winRate = (wins / totalTrades) * 100;
            
            const netPL = userTrades.reduce((sum, trade) => sum + (trade.pl || 0), 0);
            
            const totalWins = winningTrades.reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const totalLosses = losingTrades.reduce((sum, trade) => sum + Math.abs(trade.pl || 0), 0);
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? Infinity : 0;
            
            // Calculate average win/loss
            const avgWin = wins > 0 ? totalWins / wins : 0;
            const avgLoss = losses > 0 ? totalLosses / losses : 0;
            const avgWinLossRatio = avgLoss > 0 ? avgWin / avgLoss : 0;
            
            // Calculate risk metrics
            const rrRatios = userTrades
                .filter(t => t.rr && !isNaN(t.rr))
                .map(t => parseFloat(t.rr));
            const avgRR = rrRatios.length > 0 ? 
                rrRatios.reduce((a, b) => a + b, 0) / rrRatios.length : 0;
            
            const riskPercents = userTrades
                .filter(t => t.riskPercent && !isNaN(t.riskPercent))
                .map(t => parseFloat(t.riskPercent));
            const avgRiskPercent = riskPercents.length > 0 ? 
                riskPercents.reduce((a, b) => a + b, 0) / riskPercents.length : 0;
            
            // Calculate consistency metrics
            const monthlyPerformance = calculateMonthlyPerformance();
            const winStreak = calculateLongestStreak(winningTrades, 'Win');
            const lossStreak = calculateLongestStreak(losingTrades, 'Loss');
            
            // Calculate pair performance
            const pairPerformance = calculatePairPerformance();
            
            // Calculate session performance
            const sessionPerformance = calculateSessionPerformance();
            
            // Calculate drawdown
            const drawdown = calculateDrawdown();
            
            // Calculate Sharpe ratio (simplified)
            const sharpeRatio = calculateSharpeRatio();
            
            return {
                totalTrades,
                wins,
                losses,
                winRate,
                netPL,
                profitFactor,
                avgWin,
                avgLoss,
                avgWinLossRatio,
                avgRR,
                avgRiskPercent,
                monthlyPerformance,
                winStreak,
                lossStreak,
                pairPerformance,
                sessionPerformance,
                drawdown,
                sharpeRatio,
                totalWins,
                totalLosses
            };
        }

        // Calculate Monthly Performance
        function calculateMonthlyPerformance() {
            const monthlyData = {};
            
            userTrades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                        pl: 0,
                        trades: 0,
                        wins: 0
                    };
                }
                
                monthlyData[monthKey].pl += trade.pl || 0;
                monthlyData[monthKey].trades += 1;
                if (trade.result === 'Win') monthlyData[monthKey].wins += 1;
            });
            
            return Object.values(monthlyData).slice(-6); // Last 6 months
        }

        // Calculate Longest Streak
        function calculateLongestStreak(trades, result) {
            let currentStreak = 0;
            let longestStreak = 0;
            
            userTrades.forEach(trade => {
                if (trade.result === result) {
                    currentStreak++;
                    longestStreak = Math.max(longestStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            });
            
            return longestStreak;
        }

        // Calculate Pair Performance
        function calculatePairPerformance() {
            const pairData = {};
            
            userTrades.forEach(trade => {
                const pair = trade.pair || 'Unknown';
                
                if (!pairData[pair]) {
                    pairData[pair] = {
                        pair,
                        trades: 0,
                        wins: 0,
                        losses: 0,
                        pl: 0
                    };
                }
                
                pairData[pair].trades++;
                pairData[pair].pl += trade.pl || 0;
                
                if (trade.result === 'Win') {
                    pairData[pair].wins++;
                } else if (trade.result === 'Loss') {
                    pairData[pair].losses++;
                }
            });
            
            return Object.values(pairData)
                .sort((a, b) => b.trades - a.trades)
                .slice(0, 5); // Top 5 pairs
        }

        // Calculate Session Performance
        function calculateSessionPerformance() {
            const sessionData = {
                'London': { trades: 0, pl: 0, wins: 0 },
                'New York': { trades: 0, pl: 0, wins: 0 },
                'Tokyo': { trades: 0, pl: 0, wins: 0 },
                'Sydney': { trades: 0, pl: 0, wins: 0 },
                'Other': { trades: 0, pl: 0, wins: 0 }
            };
            
            userTrades.forEach(trade => {
                const session = trade.session || 'Other';
                const sessionKey = session.split(' ')[0]; // Get first word
                
                if (sessionData[sessionKey]) {
                    sessionData[sessionKey].trades++;
                    sessionData[sessionKey].pl += trade.pl || 0;
                    if (trade.result === 'Win') sessionData[sessionKey].wins++;
                } else {
                    sessionData.Other.trades++;
                    sessionData.Other.pl += trade.pl || 0;
                    if (trade.result === 'Win') sessionData.Other.wins++;
                }
            });
            
            return sessionData;
        }

        // Calculate Drawdown
        function calculateDrawdown() {
            if (userTrades.length === 0) return 0;
            
            let peak = 0;
            let maxDrawdown = 0;
            let cumulativePL = 0;
            
            userTrades.forEach(trade => {
                cumulativePL += trade.pl || 0;
                
                if (cumulativePL > peak) {
                    peak = cumulativePL;
                }
                
                const drawdown = peak - cumulativePL;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            });
            
            return maxDrawdown;
        }

        // Calculate Sharpe Ratio (simplified)
        function calculateSharpeRatio() {
            if (userTrades.length < 2) return 0;
            
            const plValues = userTrades.map(t => t.pl || 0);
            const mean = plValues.reduce((a, b) => a + b, 0) / plValues.length;
            
            const variance = plValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / plValues.length;
            const stdDev = Math.sqrt(variance);
            
            return stdDev > 0 ? mean / stdDev : 0;
        }

        // Update Performance Metrics
        function updatePerformanceMetrics() {
            if (userTrades.length === 0) {
                showEmptyAnalytics();
                return;
            }
            
            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-label">Net Profit/Loss</div>
                        <div class="metric-change ${analyticsData.netPL >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${analyticsData.netPL >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(analyticsData.netPL).toFixed(0)}
                        </div>
                    </div>
                    <div class="metric-value ${analyticsData.netPL >= 0 ? 'positive' : 'negative'}">
                        ${analyticsData.netPL >= 0 ? '+' : ''}$${Math.abs(analyticsData.netPL).toFixed(0)}
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-change ${analyticsData.winRate >= 50 ? 'positive' : 'negative'}">
                            <i class="fas fa-${analyticsData.winRate >= 50 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${analyticsData.winRate.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-value ${analyticsData.winRate >= 50 ? 'positive' : 'negative'}">
                        ${analyticsData.winRate.toFixed(1)}%
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-label">Profit Factor</div>
                        <div class="metric-change ${analyticsData.profitFactor >= 1.5 ? 'positive' : 'negative'}">
                            <i class="fas fa-${analyticsData.profitFactor >= 1.5 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${analyticsData.profitFactor.toFixed(2)}
                        </div>
                    </div>
                    <div class="metric-value">
                        ${analyticsData.profitFactor.toFixed(2)}
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-change positive">
                            <i class="fas fa-chart-line"></i>
                            ${analyticsData.totalTrades}
                        </div>
                    </div>
                    <div class="metric-value">
                        ${analyticsData.totalTrades}
                    </div>
                </div>
            `;
            
            document.getElementById('metricsLoading').style.display = 'none';
            document.getElementById('metricsContent').innerHTML = metricsHTML;
            document.getElementById('metricsContent').style.display = 'block';
        }

        // Update Detailed Statistics
        function updateDetailedStatistics() {
            const statsHTML = `
                <div class="stat-box">
                    <div class="stat-icon green">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-value">${analyticsData.wins}</div>
                    <div class="stat-label">Winning Trades</div>
                    <div class="stat-description">${analyticsData.winRate.toFixed(1)}% success rate</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon red">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value">${analyticsData.losses}</div>
                    <div class="stat-label">Losing Trades</div>
                    <div class="stat-description">${(100 - analyticsData.winRate).toFixed(1)}% of total</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon blue">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="stat-value">${analyticsData.avgRR.toFixed(2)}</div>
                    <div class="stat-label">Average R:R</div>
                    <div class="stat-description">Risk to reward ratio</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon purple">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-value">${analyticsData.avgRiskPercent.toFixed(1)}%</div>
                    <div class="stat-label">Avg Risk %</div>
                    <div class="stat-description">Per trade risk</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon orange">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-value">${analyticsData.winStreak}</div>
                    <div class="stat-label">Best Win Streak</div>
                    <div class="stat-description">Consecutive wins</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon red">
                        <i class="fas fa-skull-crossbones"></i>
                    </div>
                    <div class="stat-value">${analyticsData.lossStreak}</div>
                    <div class="stat-label">Worst Loss Streak</div>
                    <div class="stat-description">Consecutive losses</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon green">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-value">$${analyticsData.avgWin.toFixed(0)}</div>
                    <div class="stat-label">Average Win</div>
                    <div class="stat-description">Per winning trade</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon red">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-value">$${analyticsData.avgLoss.toFixed(0)}</div>
                    <div class="stat-label">Average Loss</div>
                    <div class="stat-description">Per losing trade</div>
                </div>
            `;
            
            document.getElementById('detailedStats').innerHTML = statsHTML;
        }

        // Update Win/Loss Analysis
        function updateWinLossAnalysis() {
            const winningHTML = `
                <li class="analysis-item">
                    <span class="analysis-item-label">Average Win</span>
                    <span class="analysis-item-value positive">$${analyticsData.avgWin.toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Largest Win</span>
                    <span class="analysis-item-value positive">$${Math.max(...userTrades.filter(t => t.result === 'Win').map(t => t.pl || 0)).toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Smallest Win</span>
                    <span class="analysis-item-value positive">$${Math.min(...userTrades.filter(t => t.result === 'Win').map(t => t.pl || 0)).toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Total Wins Amount</span>
                    <span class="analysis-item-value positive">$${analyticsData.totalWins.toFixed(0)}</span>
                </li>
            `;
            
            const losingHTML = `
                <li class="analysis-item">
                    <span class="analysis-item-label">Average Loss</span>
                    <span class="analysis-item-value negative">$${analyticsData.avgLoss.toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Largest Loss</span>
                    <span class="analysis-item-value negative">$${Math.min(...userTrades.filter(t => t.result === 'Loss').map(t => t.pl || 0)).toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Smallest Loss</span>
                    <span class="analysis-item-value negative">$${Math.max(...userTrades.filter(t => t.result === 'Loss').map(t => t.pl || 0)).toFixed(0)}</span>
                </li>
                <li class="analysis-item">
                    <span class="analysis-item-label">Total Losses Amount</span>
                    <span class="analysis-item-value negative">$${analyticsData.totalLosses.toFixed(0)}</span>
                </li>
            `;
            
            document.getElementById('winningTradesList').innerHTML = winningHTML;
            document.getElementById('losingTradesList').innerHTML = losingHTML;
        }

        // Update Charts
        function updateCharts() {
            updateEquityChart();
            updateWinLossChart();
            updateMonthlyChart();
            updateRiskRewardChart();
            updateSessionChart();
        }

        // Update Equity Chart
        function updateEquityChart() {
            const ctx = document.getElementById('equityChart');
            if (charts.equityChart) {
                charts.equityChart.destroy();
            }
            
            let cumulative = 0;
            const equityData = userTrades.map(trade => {
                cumulative += trade.pl || 0;
                return cumulative;
            });
            
            const dates = userTrades.map(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            charts.equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Equity Curve',
                        data: equityData,
                        borderColor: '#0f7b6c',
                        backgroundColor: 'rgba(15, 123, 108, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Equity: $${context.raw.toFixed(0)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 0 }
                        },
                        y: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Win/Loss Chart
        function updateWinLossChart() {
            const ctx = document.getElementById('winLossChart');
            if (charts.winLossChart) {
                charts.winLossChart.destroy();
            }
            
            const winTrades = userTrades.filter(t => t.result === 'Win');
            const lossTrades = userTrades.filter(t => t.result === 'Loss');
            const breakEvenTrades = userTrades.filter(t => t.result === 'Break Even');
            
            charts.winLossChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses', 'Break Even'],
                    datasets: [{
                        data: [winTrades.length, lossTrades.length, breakEvenTrades.length],
                        backgroundColor: [
                            '#0f7b6c',
                            '#d1453b',
                            '#70716e'
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} trades (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Monthly Chart
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart');
            if (charts.monthlyChart) {
                charts.monthlyChart.destroy();
            }
            
            const monthlyData = analyticsData.monthlyPerformance;
            
            charts.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: 'Monthly P/L',
                        data: monthlyData.map(m => m.pl),
                        backgroundColor: monthlyData.map(m => m.pl >= 0 ? '#0f7b6c' : '#d1453b'),
                        borderWidth: 1,
                        borderColor: 'white',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P/L: $${context.raw.toFixed(0)}`;
                                },
                                afterLabel: function(context) {
                                    const data = monthlyData[context.dataIndex];
                                    return `Trades: ${data.trades} | Wins: ${data.wins}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Risk/Reward Chart
        function updateRiskRewardChart() {
            const ctx = document.getElementById('riskRewardChart');
            if (charts.riskRewardChart) {
                charts.riskRewardChart.destroy();
            }
            
            const winningTrades = userTrades.filter(t => t.result === 'Win');
            const losingTrades = userTrades.filter(t => t.result === 'Loss');
            
            const winRisks = winningTrades.map(t => t.riskPercent || 0).filter(r => r > 0);
            const lossRisks = losingTrades.map(t => t.riskPercent || 0).filter(r => r > 0);
            
            const winRRs = winningTrades.map(t => t.rr || 0).filter(rr => rr > 0);
            const lossRRs = losingTrades.map(t => t.rr || 0).filter(rr => rr > 0);
            
            charts.riskRewardChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Winning Trades',
                            data: winningTrades.map(t => ({
                                x: t.rr || 0,
                                y: t.pl || 0
                            })),
                            backgroundColor: 'rgba(15, 123, 108, 0.6)',
                            borderColor: '#0f7b6c',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Losing Trades',
                            data: losingTrades.map(t => ({
                                x: t.rr || 0,
                                y: t.pl || 0
                            })),
                            backgroundColor: 'rgba(209, 69, 59, 0.6)',
                            borderColor: '#d1453b',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const trade = userTrades[context.dataIndex];
                                    return `P/L: $${trade.pl || 0} | R:R: ${trade.rr || 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Risk:Reward Ratio'
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)'
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    }
                }
            });
        }

        // Update Session Chart
        function updateSessionChart() {
            const ctx = document.getElementById('sessionChart');
            if (charts.sessionChart) {
                charts.sessionChart.destroy();
            }
            
            const sessionData = analyticsData.sessionPerformance;
            const sessions = Object.keys(sessionData);
            const plData = sessions.map(s => sessionData[s].pl);
            const winRates = sessions.map(s => {
                const session = sessionData[s];
                return session.trades > 0 ? (session.wins / session.trades) * 100 : 0;
            });
            
            charts.sessionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sessions,
                    datasets: [
                        {
                            label: 'P/L ($)',
                            data: plData,
                            backgroundColor: plData.map(p => p >= 0 ? '#0f7b6c' : '#d1453b'),
                            borderWidth: 1,
                            borderColor: 'white',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Win Rate (%)',
                            data: winRates,
                            backgroundColor: 'rgba(12, 140, 233, 0.2)',
                            borderColor: '#0c8ce9',
                            borderWidth: 2,
                            type: 'line',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 10,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'P/L ($)'
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Win Rate (%)'
                            },
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Pair Analysis
        function updatePairAnalysis() {
            const pairList = document.getElementById('pairList');
            const pairs = analyticsData.pairPerformance;
            
            if (pairs.length === 0) {
                pairList.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-state-text">
                            Not enough pair data available
                        </div>
                    </div>
                `;
                return;
            }
            
            let pairsHTML = '';
            
            pairs.forEach(pair => {
                const winRate = pair.trades > 0 ? (pair.wins / pair.trades) * 100 : 0;
                
                pairsHTML += `
                    <div class="pair-item">
                        <div class="pair-name">${pair.pair}</div>
                        <div class="pair-stats">
                            <div class="pair-stat">
                                <span class="pair-stat-value ${pair.pl >= 0 ? 'positive' : 'negative'}">
                                    $${pair.pl >= 0 ? '+' : ''}${pair.pl.toFixed(0)}
                                </span>
                            </div>
                            <div class="pair-stat">
                                ${pair.trades} trades | ${winRate.toFixed(0)}% win rate
                            </div>
                        </div>
                    </div>
                `;
            });
            
            pairList.innerHTML = pairsHTML;
        }

        // Update Insights and Recommendations
        function updateInsightsAndRecommendations() {
            const insightsGrid = document.getElementById('insightsGrid');
            const insights = generateInsights();
            
            let insightsHTML = '';
            
            insights.forEach(insight => {
                insightsHTML += `
                    <div class="insight-card">
                        <div class="insight-card-header">
                            <div class="insight-card-icon ${insight.type}">
                                <i class="fas fa-${insight.icon}"></i>
                            </div>
                            <div class="insight-card-title">${insight.title}</div>
                        </div>
                        <div class="insight-card-content">
                            ${insight.content}
                        </div>
                    </div>
                `;
            });
            
            insightsGrid.innerHTML = insightsHTML;
        }

        // Generate Insights
        function generateInsights() {
            const insights = [];
            
            // Win rate insight
            if (analyticsData.winRate >= 60) {
                insights.push({
                    type: 'success',
                    icon: 'trophy',
                    title: 'Excellent Win Rate',
                    content: `Your win rate of ${analyticsData.winRate.toFixed(1)}% is well above average. Focus on maintaining your edge and consider slightly increasing position sizes.`
                });
            } else if (analyticsData.winRate < 40) {
                insights.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    title: 'Low Win Rate Detected',
                    content: `Your win rate of ${analyticsData.winRate.toFixed(1)}% needs improvement. Consider:<br>
                    <ul>
                        <li>Reviewing your entry criteria</li>
                        <li>Waiting for better setups</li>
                        <li>Improving risk management</li>
                    </ul>`
                });
            } else {
                insights.push({
                    type: 'info',
                    icon: 'balance-scale',
                    title: 'Solid Performance',
                    content: `Your win rate of ${analyticsData.winRate.toFixed(1)}% is within the average range. Focus on consistency and risk management to improve.`
                });
            }
            
            // Profit factor insight
            if (analyticsData.profitFactor >= 2) {
                insights.push({
                    type: 'success',
                    icon: 'chart-line',
                    title: 'Strong Profit Factor',
                    content: `Your profit factor of ${analyticsData.profitFactor.toFixed(2)} indicates excellent risk management. Your winning trades are significantly larger than your losses.`
                });
            } else if (analyticsData.profitFactor < 1) {
                insights.push({
                    type: 'warning',
                    icon: 'exclamation-circle',
                    title: 'Profit Factor Below 1',
                    content: `Your profit factor of ${analyticsData.profitFactor.toFixed(2)} means losses exceed wins. Immediate action needed:<br>
                    <ul>
                        <li>Cut losses faster</li>
                        <li>Let winners run longer</li>
                        <li>Review risk per trade</li>
                    </ul>`
                });
            } else {
                insights.push({
                    type: 'info',
                    icon: 'calculator',
                    title: 'Good Profit Factor',
                    content: `Your profit factor of ${analyticsData.profitFactor.toFixed(2)} shows positive expectancy. Continue focusing on risk:reward ratios.`
                });
            }
            
            // Risk management insight
            if (analyticsData.avgRR >= 2) {
                insights.push({
                    type: 'success',
                    icon: 'target',
                    title: 'Excellent R:R Ratios',
                    content: `Your average risk:reward ratio of ${analyticsData.avgRR.toFixed(2)} is very good. This allows for lower win rates while remaining profitable.`
                });
            } else if (analyticsData.avgRR < 1) {
                insights.push({
                    type: 'warning',
                    icon: 'bullseye',
                    title: 'Poor R:R Ratios',
                    content: `Your average risk:reward ratio of ${analyticsData.avgRR.toFixed(2)} is too low. You're risking more than you're aiming to gain. Aim for at least 1:1.5.`
                });
            }
            
            // Consistency insight
            if (analyticsData.winStreak >= 5) {
                insights.push({
                    type: 'success',
                    icon: 'fire',
                    title: 'Impressive Win Streak',
                    content: `Your longest win streak of ${analyticsData.winStreak} consecutive wins shows excellent consistency during favorable conditions.`
                });
            }
            
            if (analyticsData.lossStreak >= 5) {
                insights.push({
                    type: 'warning',
                    icon: 'skull-crossbones',
                    title: 'Consecutive Losses Concern',
                    content: `Your longest loss streak of ${analyticsData.lossStreak} suggests you may be overtrading or not adapting to changing market conditions.`
                });
            }
            
            // Session insight
            const sessionData = analyticsData.sessionPerformance;
            let bestSession = null;
            let bestPL = -Infinity;
            
            for (const [session, data] of Object.entries(sessionData)) {
                if (data.pl > bestPL && data.trades > 0) {
                    bestPL = data.pl;
                    bestSession = session;
                }
            }
            
            if (bestSession && bestPL > 0) {
                insights.push({
                    type: 'info',
                    icon: 'clock',
                    title: 'Best Performing Session',
                    content: `Your ${bestSession} session shows the best performance with $${bestPL.toFixed(0)} profit. Consider focusing more on this trading window.`
                });
            }
            
            return insights.slice(0, 4); // Limit to 4 insights
        }

        // Handle Time Period Change
        function handleTimePeriodChange() {
            // In a real implementation, this would filter trades by time period
            // For now, we'll just reload with the same data
            loadAnalyticsData();
        }

        // Update Analytics Focus
        function updateAnalyticsFocus() {
            const focus = document.getElementById('metricFocus').value;
            // In a real implementation, this would highlight relevant sections
            // For now, we'll just log the selection
            console.log('Analytics focus changed to:', focus);
        }

        // Generate PDF Report
        function generatePDFReport() {
            if (userTrades.length === 0) {
                alert('No data available to generate report');
                return;
            }
            
            // In a real implementation, this would generate a PDF report
            // For now, we'll create a simplified CSV export
            exportAnalyticsData();
        }

        // Export Analytics Data
        function exportAnalyticsData() {
            const headers = [
                'Metric', 'Value', 'Description'
            ];
            
            const metrics = [
                ['Total Trades', analyticsData.totalTrades, 'Number of trades taken'],
                ['Win Rate', `${analyticsData.winRate.toFixed(1)}%`, 'Percentage of winning trades'],
                ['Net Profit/Loss', `$${analyticsData.netPL.toFixed(0)}`, 'Total profit/loss'],
                ['Profit Factor', analyticsData.profitFactor.toFixed(2), 'Ratio of gross profit to gross loss'],
                ['Average R:R', analyticsData.avgRR.toFixed(2), 'Average risk:reward ratio'],
                ['Average Risk %', `${analyticsData.avgRiskPercent.toFixed(1)}%`, 'Average risk per trade'],
                ['Best Win Streak', analyticsData.winStreak, 'Longest consecutive winning streak'],
                ['Worst Loss Streak', analyticsData.lossStreak, 'Longest consecutive losing streak'],
                ['Average Win', `$${analyticsData.avgWin.toFixed(0)}`, 'Average profit per winning trade'],
                ['Average Loss', `$${analyticsData.avgLoss.toFixed(0)}`, 'Average loss per losing trade'],
                ['Sharpe Ratio', analyticsData.sharpeRatio.toFixed(2), 'Risk-adjusted return']
            ];
            
            const csvData = [
                headers.join(','),
                ...metrics.map(metric => metric.join(','))
            ].join('\n');
            
            downloadCSV(csvData, `trading-analytics-${new Date().toISOString().split('T')[0]}.csv`);
            
            alert('Analytics report generated successfully! Check your downloads folder.');
        }

        // Download CSV
        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Show Empty Analytics
        function showEmptyAnalytics() {
            const emptyHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="empty-state-title">No Analytics Data Available</div>
                    <div class="empty-state-text">
                        Start by adding trades to your journal to generate detailed analytics and insights.
                    </div>
                    <a href="add-trade.html" class="mobile-menu-item primary" style="margin-top: 16px; text-align: center;">
                        <i class="fas fa-plus-circle"></i>
                        Add Your First Trade
                    </a>
                </div>
            `;
            
            document.getElementById('performanceOverview').innerHTML = emptyHTML;
        }

        // Show Error
        function showError(message) {
            const errorHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="empty-state-title">Analytics Error</div>
                    <div class="empty-state-text">
                        ${message}
                    </div>
                    <button onclick="loadAnalyticsData()" class="mobile-menu-item primary" style="margin-top: 16px; text-align: center;">
                        <i class="fas fa-redo"></i>
                        Retry Loading
                    </button>
                </div>
            `;
            
            document.getElementById('performanceOverview').innerHTML = errorHTML;
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout User
        function logoutUser() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            });
        }

        // Expose functions to global scope
        window.toggleMobileMenu = toggleMobileMenu;
        window.logoutUser = logoutUser;
        window.loadAnalyticsData = loadAnalyticsData;
    </script>
</body>
</html>
