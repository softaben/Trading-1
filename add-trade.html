
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Trade - ICT Scalping Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sync-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
        }

        .sync-status.syncing {
            background-color: var(--notion-yellow-light);
            color: var(--notion-yellow);
        }

        .sync-status.synced {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .sync-status.error {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .header-btn {
            padding: 4px 12px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
        }

        .header-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        .header-btn.danger {
            background-color: var(--notion-red);
            color: white;
        }

        .header-btn.green {
            background-color: var(--notion-green);
            color: white;
        }

        /* Main Container */
        .main-container {
            max-width: 800px;
            margin: 60px auto 20px;
            padding: 0 20px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .page-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--notion-blue);
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--notion-text-light);
            margin-bottom: 24px;
        }

        /* Trade Form Container */
        .trade-form-container {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* Form Steps */
        .form-steps {
            display: flex;
            border-bottom: 1px solid var(--notion-gray-dark);
            background-color: var(--notion-gray-light);
        }

        .step {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 14px;
            font-weight: 500;
        }

        .step.active {
            background-color: white;
            color: var(--notion-blue);
            font-weight: 600;
        }

        .step.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--notion-blue);
        }

        .step-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        /* Form Content */
        .form-content {
            padding: 32px;
        }

        .form-section {
            margin-bottom: 32px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--notion-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--notion-blue);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
        }

        .form-label.required::after {
            content: '*';
            color: var(--notion-red);
            margin-left: 4px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 3px rgba(12, 140, 233, 0.1);
        }

        .form-control.select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2370716e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        /* Input Groups */
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group .form-control {
            flex: 1;
        }

        .input-group-text {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            color: var(--notion-text-light);
            min-width: 40px;
            text-align: center;
        }

        /* Quick Input Buttons */
        .quick-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-btn {
            padding: 6px 12px;
            background-color: var(--notion-gray);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-btn:hover {
            background-color: var(--notion-gray-dark);
        }

        .quick-btn.active {
            background-color: var(--notion-blue);
            color: white;
            border-color: var(--notion-blue);
        }

        /* Radio and Checkbox Groups */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 8px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input, .checkbox-option input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Result Card */
        .result-card {
            background-color: var(--notion-gray-light);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .result-badge.win {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .result-badge.loss {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .result-badge.be {
            background-color: var(--notion-gray);
            color: var(--notion-text-light);
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.positive {
            color: var(--notion-green);
        }

        .stat-value.negative {
            color: var(--notion-red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--notion-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Image Links Section */
        .image-links-container {
            background-color: var(--notion-gray-light);
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .image-links-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .image-links-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-links-instructions {
            background-color: white;
            border: 1px solid var(--notion-blue-light);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .instruction-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px 0;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .step-number {
            width: 24px;
            height: 24px;
            background-color: var(--notion-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .image-link-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .image-link-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .image-link-input:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 3px rgba(12, 140, 233, 0.1);
        }

        .image-links-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .image-link-preview {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .image-link-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .image-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .image-link-info {
            padding: 12px;
        }

        .image-link-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .image-link-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            padding-top: 24px;
            border-top: 1px solid var(--notion-gray-dark);
            margin-top: 32px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
            justify-content: center;
        }

        .action-btn.prev {
            background-color: var(--notion-gray);
            color: var(--notion-text);
        }

        .action-btn.prev:hover {
            background-color: var(--notion-gray-dark);
        }

        .action-btn.next {
            background-color: var(--notion-blue);
            color: white;
        }

        .action-btn.next:hover {
            background-color: #0a7ac9;
        }

        .action-btn.submit {
            background-color: var(--notion-green);
            color: white;
        }

        .action-btn.submit:hover {
            background-color: #0d6a5d;
        }

        .action-btn.cancel {
            background-color: var(--notion-red);
            color: white;
        }

        .action-btn.cancel:hover {
            background-color: #c13c33;
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background-color: var(--notion-gray);
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--notion-blue);
            transition: width 0.3s ease;
            width: 25%;
        }

        /* Success Message */
        .success-message {
            text-align: center;
            padding: 60px 20px;
            animation: fadeIn 0.5s ease;
        }

        .success-icon {
            font-size: 64px;
            color: var(--notion-green);
            margin-bottom: 24px;
        }

        .success-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--notion-green);
        }

        .success-text {
            font-size: 16px;
            color: var(--notion-text-light);
            margin-bottom: 32px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--notion-text-light);
        }

        .loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* TradingView Button */
        .tradingview-btn {
            background-color: #2962FF;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .tradingview-btn:hover {
            background-color: #1a4ed8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 45px auto 20px;
                padding: 0 16px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .form-content {
                padding: 20px;
            }
            
            .form-steps {
                flex-direction: column;
            }
            
            .step {
                padding: 12px;
                text-align: left;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .header-actions {
                display: none;
            }
            
            .image-link-input-container {
                flex-direction: column;
            }
            
            .image-links-preview {
                grid-template-columns: 1fr;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.success {
            background-color: var(--notion-green);
        }

        .notification.error {
            background-color: var(--notion-red);
        }

        .notification.info {
            background-color: var(--notion-blue);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ICT Model Info */
        .model-info {
            background-color: var(--notion-blue-light);
            border: 1px solid var(--notion-blue);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
            font-size: 13px;
            color: var(--notion-text);
            display: none;
        }

        .model-info.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .model-info h4 {
            margin-bottom: 8px;
            color: var(--notion-blue);
            font-weight: 600;
        }

        /* Help Text */
        .help-text {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .help-text i {
            font-size: 14px;
        }

        /* TradingView Instructions Modal */
        .instructions-modal {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .instructions-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--notion-blue);
        }

        .instructions-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--notion-text-light);
        }

        /* Step by Step Guide */
        .tradingview-guide {
            margin-top: 24px;
        }

        .guide-step {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--notion-gray);
        }

        .guide-step:last-child {
            border-bottom: none;
        }

        .guide-step-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--notion-text);
        }

        .guide-step-image {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            margin-top: 12px;
            border: 1px solid var(--notion-gray-dark);
        }

        .video-guide {
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .video-guide h4 {
            margin-bottom: 8px;
            color: var(--notion-blue);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="workspace-icon" style="width: 20px; height: 20px; background-color: var(--notion-blue); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">T</div>
        <div class="header-title">ICT Scalping Journal - Add Trade</div>
        <div class="header-actions">
            <div class="sync-status synced" id="syncStatus">
                <i class="fas fa-cloud"></i> Synced
            </div>
            <a href="index.html" class="header-btn">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="AllTrades.html" class="header-btn">
                <i class="fas fa-table"></i> View All Trades
            </a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">➕ Add New Trade</h1>
            <p class="page-subtitle">Record your ICT scalping trades with detailed analysis</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Trade Form Container -->
        <div class="trade-form-container">
            <!-- Form Steps -->
            <div class="form-steps">
                <div class="step active" data-step="1">
                    <i class="fas fa-calendar-alt step-icon"></i>
                    <span>Basic Info</span>
                </div>
                <div class="step" data-step="2">
                    <i class="fas fa-chart-line step-icon"></i>
                    <span>Trade Setup</span>
                </div>
                <div class="step" data-step="3">
                    <i class="fas fa-calculator step-icon"></i>
                    <span>Risk Management</span>
                </div>
                <div class="step" data-step="4">
                    <i class="fas fa-sticky-note step-icon"></i>
                    <span>Review & Save</span>
                </div>
            </div>

            <!-- Form Content -->
            <div class="form-content">
                <!-- Step 1: Basic Information -->
                <div class="form-section" id="step1" style="display: block;">
                    <div class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        Basic Information
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-clock"></i> Date & Time
                            </label>
                            <input type="datetime-local" class="form-control" id="tradeDateTime" required>
                            <div class="help-text">
                                <i class="fas fa-info-circle"></i> Set to current date/time by default
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-globe"></i> Trading Session
                            </label>
                            <select class="form-control select" id="tradeSession" required>
                                <option value="">Select session...</option>
                                <option value="London" selected>London Session (07:00-16:00 GMT)</option>
                                <option value="New York">New York Session (13:00-22:00 GMT)</option>
                                <option value="Asian">Asian Session (00:00-09:00 GMT)</option>
                                <option value="Sydney">Sydney Session (22:00-07:00 GMT)</option>
                                <option value="Overlap">Session Overlap</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">
                            <i class="fas fa-coins"></i> Currency Pair
                        </label>
                        <div class="quick-inputs">
                            <button type="button" class="quick-btn active" data-pair="EURUSD">EUR/USD</button>
                            <button type="button" class="quick-btn" data-pair="GBPUSD">GBP/USD</button>
                            <button type="button" class="quick-btn" data-pair="USDJPY">USD/JPY</button>
                            <button type="button" class="quick-btn" data-pair="AUDUSD">AUD/USD</button>
                            <button type="button" class="quick-btn" data-pair="USDCAD">USD/CAD</button>
                            <button type="button" class="quick-btn" data-pair="NZDUSD">NZD/USD</button>
                        </div>
                        <input type="text" class="form-control" id="tradePair" placeholder="Or enter custom pair..." value="EURUSD" required>
                    </div>
                </div>

                <!-- Step 2: Trade Setup -->
                <div class="form-section" id="step2" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Trade Setup & ICT Analysis
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-cube"></i> ICT Model
                            </label>
                            <select class="form-control select" id="tradeModel" required>
                                <option value="">Select ICT model...</option>
                                <option value="FVG" selected>Fair Value Gap (FVG)</option>
                                <option value="Liquidity Sweep">Liquidity Sweep</option>
                                <option value="Order Block">Order Block (OB)</option>
                                <option value="Breaker">Breaker Block</option>
                                <option value="MIT">Market Structure Shift (MSS)</option>
                                <option value="BOS">Break of Structure (BOS)</option>
                                <option value="CHoCH">Change of Character (CHoCH)</option>
                                <option value="Premium/Discount">Premium/Discount Zone</option>
                                <option value="Kill Zone">Kill Zone Entry</option>
                                <option value="Other">Other ICT Concept</option>
                            </select>
                            <div class="model-info" id="modelInfo">
                                <h4>Fair Value Gap (FVG)</h4>
                                <p>A three-candle pattern where the middle candle's range doesn't overlap with the first candle's range. Used to identify potential reversal zones.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-arrow-up"></i> Direction
                            </label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="direction" value="Buy" checked>
                                    <span>Buy (Long)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="direction" value="Sell">
                                    <span>Sell (Short)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-chart-bar"></i> Timeframe
                            </label>
                            <div class="quick-inputs">
                                <button type="button" class="quick-btn active" data-tf="1H">1H</button>
                                <button type="button" class="quick-btn" data-tf="15M">15M</button>
                                <button type="button" class="quick-btn" data-tf="5M">5M</button>
                                <button type="button" class="quick-btn" data-tf="1M">1M</button>
                                <button type="button" class="quick-btn" data-tf="Daily">Daily</button>
                            </div>
                            <input type="text" class="form-control" id="tradeTimeframe" value="1H" placeholder="Enter timeframe...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-layer-group"></i> Entry Type
                            </label>
                            <select class="form-control select" id="entryType">
                                <option value="Market">Market Order</option>
                                <option value="Limit">Limit Order</option>
                                <option value="Stop">Stop Order</option>
                                <option value="Stop Limit">Stop Limit</option>
                            </select>
                        </div>
                    </div>

                    <!-- Entry Price Field (مضاف) -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-bullseye"></i> Entry Price (Optional)
                        </label>
                        <input type="number" step="0.00001" class="form-control" id="entryPrice" placeholder="e.g., 1.08500">
                        <div class="help-text">
                            <i class="fas fa-info-circle"></i> Optional: Enter exact entry price for better analysis
                        </div>
                    </div>

                    <!-- Image Links Section -->
                    <div class="form-group">
                        <div class="image-links-container">
                            <div class="image-links-header">
                                <div class="image-links-title">
                                    <i class="fas fa-image"></i> TradingView Chart Images
                                </div>
                                <button type="button" class="tradingview-btn" id="showInstructions">
                                    <i class="fas fa-question-circle"></i> How to Copy Links
                                </button>
                            </div>
                            
                            <div class="image-links-instructions">
                                <p style="font-weight: 500; color: var(--notion-blue); margin-bottom: 12px;">
                                    <i class="fas fa-lightbulb"></i> Quick Guide: How to add TradingView chart images
                                </p>
                                <div class="instruction-steps">
                                    <div class="instruction-step">
                                        <div class="step-number">1</div>
                                        <div class="step-text">Right-click on your TradingView chart</div>
                                    </div>
                                    <div class="instruction-step">
                                        <div class="step-number">2</div>
                                        <div class="step-text">Select "Copy image" or "Save image"</div>
                                    </div>
                                    <div class="instruction-step">
                                        <div class="step-number">3</div>
                                        <div class="step-text">Paste the image link in the box below (or upload directly)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="image-link-input-container">
                                <input type="text" class="image-link-input" id="imageLinkInput" 
                                       placeholder="Paste TradingView image link here... (e.g., https://www.tradingview.com/x/ABC123/)">
                                <button type="button" class="action-btn primary" id="addImageLinkBtn">
                                    <i class="fas fa-plus"></i> Add Link
                                </button>
                            </div>

                            <!-- Alternative: Direct URL paste area -->
                            <div style="margin-top: 16px;">
                                <label class="form-label">
                                    <i class="fas fa-paste"></i> Or paste multiple links (one per line):
                                </label>
                                <textarea class="form-control" id="bulkImageLinks" rows="3" 
                                          placeholder="Paste multiple TradingView image links here, one per line...
https://www.tradingview.com/x/ABC123/
https://www.tradingview.com/x/DEF456/
https://www.tradingview.com/x/GHI789/"></textarea>
                                <div class="help-text">
                                    <i class="fas fa-info-circle"></i> You can paste multiple links separated by new lines
                                </div>
                            </div>

                            <div class="image-links-preview" id="imageLinksPreview">
                                <!-- Image links will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Risk Management -->
                <div class="form-section" id="step3" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        Risk Management
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-percentage"></i> Risk Percentage
                            </label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="riskPercent" value="1.0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="quick-inputs">
                                <button type="button" class="quick-btn" data-risk="0.5">0.5%</button>
                                <button type="button" class="quick-btn active" data-risk="1.0">1.0%</button>
                                <button type="button" class="quick-btn" data-risk="1.5">1.5%</button>
                                <button type="button" class="quick-btn" data-risk="2.0">2.0%</button>
                                <button type="button" class="quick-btn" data-risk="3.0">3.0%</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-bullseye"></i> Reward Percentage
                            </label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="rewardPercent" value="2.0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="quick-inputs">
                                <button type="button" class="quick-btn" data-reward="1.0">1.0%</button>
                                <button type="button" class="quick-btn active" data-reward="2.0">2.0%</button>
                                <button type="button" class="quick-btn" data-reward="3.0">3.0%</button>
                                <button type="button" class="quick-btn" data-reward="4.0">4.0%</button>
                                <button type="button" class="quick-btn" data-reward="5.0">5.0%</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-balance-scale"></i> Risk/Reward Ratio
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">1 :</span>
                                <input type="number" step="0.01" class="form-control" id="rrRatio" value="2.0" readonly>
                            </div>
                            <div class="help-text">
                                <i class="fas fa-calculator"></i> Auto-calculated from Risk/Reward percentages
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-wallet"></i> Account Size ($)
                            </label>
                            <input type="number" step="100" class="form-control" id="accountSize" value="10000" placeholder="e.g., 10000">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-weight-hanging"></i> Lot Size
                            </label>
                            <input type="number" step="0.01" class="form-control" id="lotSize" value="0.10" placeholder="e.g., 0.10">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-dollar-sign"></i> Position Size ($)
                            </label>
                            <input type="number" step="0.01" class="form-control" id="positionSize" value="100" readonly>
                            <div class="help-text">
                                <i class="fas fa-info-circle"></i> Auto-calculated: Risk % × Account Size
                            </div>
                        </div>
                    </div>

                    <div class="result-card" id="riskResultCard">
                        <div class="result-header">
                            <div class="result-title">
                                <i class="fas fa-chart-pie"></i> Risk Analysis
                            </div>
                            <div class="result-badge" id="riskBadge">1:2.0</div>
                        </div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="riskAmount">$100.00</div>
                                <div class="stat-label">Risk Amount</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value positive" id="rewardAmount">$200.00</div>
                                <div class="stat-label">Reward Amount</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="riskPerPip">$1.00</div>
                                <div class="stat-label">Risk per Pip</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review & Save -->
                <div class="form-section" id="step4" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-sticky-note"></i>
                        Review & Save Trade
                    </div>

                    <div class="form-group">
                        <label class="form-label required">
                            <i class="fas fa-flag-checkered"></i> Trade Result
                        </label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="result" value="Win" checked>
                                <span style="color: var(--notion-green); font-weight: 500;">Win</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="result" value="Loss">
                                <span style="color: var(--notion-red); font-weight: 500;">Loss</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="result" value="Break Even">
                                <span style="color: var(--notion-text-light); font-weight: 500;">Break Even</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-dollar-sign"></i> P/L Amount ($)
                            </label>
                            <input type="number" step="0.01" class="form-control" id="plAmount" value="200.00" placeholder="e.g., 200.00">
                            <div class="help-text">
                                <i class="fas fa-sync-alt"></i> Auto-calculated based on result and risk
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-brain"></i> Emotion (Before Trade)
                            </label>
                            <select class="form-control select" id="emotionBefore">
                                <option value="1">1 - Very Anxious</option>
                                <option value="2">2 - Anxious</option>
                                <option value="3">3 - Nervous</option>
                                <option value="4">4 - Slightly Nervous</option>
                                <option value="5">5 - Neutral</option>
                                <option value="6">6 - Confident</option>
                                <option value="7" selected>7 - Very Confident</option>
                                <option value="8">8 - Excited</option>
                                <option value="9">9 - Overconfident</option>
                                <option value="10">10 - Reckless</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-dots"></i> Trade Notes
                        </label>
                        <textarea class="form-control" id="tradeNotes" rows="4" placeholder="Describe your trade setup, what worked well, what could be improved, key lessons learned..."></textarea>
                        <div class="help-text">
                            <i class="fas fa-lightbulb"></i> Tip: Include specific ICT concepts used and market conditions
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tags"></i> Tags (Optional)
                        </label>
                        <input type="text" class="form-control" id="tradeTags" placeholder="e.g., FVG, London Session, High Volatility">
                        <div class="help-text">
                            <i class="fas fa-hashtag"></i> Separate tags with commas
                        </div>
                    </div>

                    <!-- Image Links Summary -->
                    <div class="result-card" id="imagesSummary" style="display: none;">
                        <div class="result-header">
                            <div class="result-title">
                                <i class="fas fa-images"></i> Chart Images
                            </div>
                            <div class="result-badge" id="imagesCount">0 images</div>
                        </div>
                        <div id="imagesPreviewSummary">
                            <!-- Will show first few image previews -->
                        </div>
                    </div>

                    <div class="result-card" id="reviewCard">
                        <div class="result-header">
                            <div class="result-title">
                                <i class="fas fa-check-circle"></i> Trade Summary
                            </div>
                            <div class="result-badge win" id="reviewBadge">Win</div>
                        </div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="reviewPair">EUR/USD</div>
                                <div class="stat-label">Pair</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="reviewSession">London</div>
                                <div class="stat-label">Session</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value positive" id="reviewPL">+$200.00</div>
                                <div class="stat-label">P/L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="reviewRR">1:2.0</div>
                                <div class="stat-label">R:R</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div class="success-message" id="successMessage" style="display: none;">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="success-title">Trade Saved Successfully!</div>
                    <div class="success-text">
                        Your trade has been saved to the cloud database. You can view it in your trading journal.
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="action-btn green" id="addAnotherBtn">
                            <i class="fas fa-plus"></i> Add Another Trade
                        </button>
                        <a href="index.html" class="action-btn">
                            <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                        </a>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions" id="formActions">
                    <button class="action-btn prev" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <div style="display: flex; gap: 12px; margin-left: auto;">
                        <button class="action-btn cancel" id="cancelBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn next" id="nextBtn">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="action-btn submit" id="submitBtn" style="display: none;">
                            <i class="fas fa-save"></i> Save Trade
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div class="modal-overlay" id="instructionsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="instructions-modal">
            <div class="instructions-header">
                <div class="instructions-title">
                    <i class="fas fa-question-circle"></i> How to Add TradingView Images
                </div>
                <button class="instructions-close" id="closeInstructions">&times;</button>
            </div>
            
            <div class="tradingview-guide">
                <div class="guide-step">
                    <div class="guide-step-title">Method 1: Copy Image Address (Recommended)</div>
                    <p>1. Right-click on your TradingView chart</p>
                    <p>2. Select "Copy image address" or "Copy image link"</p>
                    <p>3. Paste the link in the input field above</p>
                </div>
                
                <div class="guide-step">
                    <div class="guide-step-title">Method 2: Share Function</div>
                    <p>1. Click the "Share" button on TradingView</p>
                    <p>2. Select "Copy link" or "Share image"</p>
                    <p>3. Paste the shared link in the input field</p>
                </div>
                
                <div class="guide-step">
                    <div class="guide-step-title">Method 3: Direct URL</div>
                    <p>1. TradingView images typically have URLs like:</p>
                    <p style="font-family: monospace; background: var(--notion-gray); padding: 8px; border-radius: 4px;">
                        https://www.tradingview.com/x/ABC123DEF456/
                    </p>
                    <p>2. Copy and paste any TradingView image URL</p>
                </div>
                
                <div class="video-guide">
                    <h4><i class="fas fa-video"></i> Video Tutorial</h4>
                    <p>Watch this short video to learn how to copy TradingView image links:</p>
                    <div style="text-align: center; margin-top: 12px;">
                        <button class="action-btn primary" onclick="window.open('https://youtube.com/shorts/tradingview-image-tutorial', '_blank')">
                            <i class="fab fa-youtube"></i> Watch Tutorial
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--notion-gray);">
                <p style="font-size: 14px; color: var(--notion-text-light);">
                    <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> You can add multiple images by pasting multiple links (one per line) in the bulk input area.
                </p>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database References
        const tradesRef = database.ref('trades');

        // Global Variables
        let currentStep = 1;
        let totalSteps = 4;
        let tradeData = {};
        let imageLinks = []; // Array to store TradingView image links
        let isSubmitting = false;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            initDateTime();
            setupEventListeners();
            setupFirebase();
            updateProgressBar();
            calculateRiskReward();
            updateReviewSummary();
        });

        // Initialize Date and Time
        function initDateTime() {
            const now = new Date();
            // Format to YYYY-MM-DDTHH:MM
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('tradeDateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Setup Firebase Connection
        function setupFirebase() {
            updateSyncStatus('Connecting to Firebase...', 'syncing');
            
            // Check connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    updateSyncStatus('Connected to Firebase', 'synced');
                } else {
                    updateSyncStatus('Offline - Data will sync when connected', 'error');
                }
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Step Navigation
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    const stepNumber = parseInt(this.getAttribute('data-step'));
                    if (stepNumber < currentStep) {
                        goToStep(stepNumber);
                    }
                });
            });

            // Next/Previous Buttons
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('submitBtn').addEventListener('click', submitTrade);

            // Cancel Button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? All unsaved data will be lost.')) {
                    window.location.href = 'index.html';
                }
            });

            // Add Another Trade Button
            document.getElementById('addAnotherBtn').addEventListener('click', resetForm);

            // Quick Input Buttons
            setupQuickInputs();

            // Risk Management Calculations
            document.getElementById('riskPercent').addEventListener('input', calculateRiskReward);
            document.getElementById('rewardPercent').addEventListener('input', calculateRiskReward);
            document.getElementById('accountSize').addEventListener('input', calculateRiskReward);
            document.getElementById('lotSize').addEventListener('input', calculateRiskReward);

            // Trade Result Change
            document.querySelectorAll('input[name="result"]').forEach(radio => {
                radio.addEventListener('change', updatePLAmount);
            });

            // Image Link Management
            document.getElementById('addImageLinkBtn').addEventListener('click', addImageLink);
            document.getElementById('imageLinkInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addImageLink();
                }
            });
            document.getElementById('bulkImageLinks').addEventListener('blur', processBulkLinks);

            // Instructions Modal
            document.getElementById('showInstructions').addEventListener('click', showInstructions);
            document.getElementById('closeInstructions').addEventListener('click', hideInstructions);
            document.getElementById('instructionsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideInstructions();
                }
            });

            // ICT Model Info
            document.getElementById('tradeModel').addEventListener('change', showModelInfo);
        }

        // Setup Quick Input Buttons
        function setupQuickInputs() {
            // Currency Pair Buttons
            document.querySelectorAll('.quick-btn[data-pair]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quick-btn[data-pair]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tradePair').value = this.getAttribute('data-pair');
                    updateReviewSummary();
                });
            });

            // Timeframe Buttons
            document.querySelectorAll('.quick-btn[data-tf]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quick-btn[data-tf]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tradeTimeframe').value = this.getAttribute('data-tf');
                });
            });

            // Risk Percentage Buttons
            document.querySelectorAll('.quick-btn[data-risk]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quick-btn[data-risk]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('riskPercent').value = this.getAttribute('data-risk');
                    calculateRiskReward();
                });
            });

            // Reward Percentage Buttons
            document.querySelectorAll('.quick-btn[data-reward]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quick-btn[data-reward]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('rewardPercent').value = this.getAttribute('data-reward');
                    calculateRiskReward();
                });
            });
        }

        // Navigation Functions
        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step before proceeding
                if (validateStep(currentStep)) {
                    goToStep(currentStep + 1);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        function goToStep(step) {
            // Hide current step
            document.getElementById(`step${currentStep}`).style.display = 'none';
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');

            // Show new step
            document.getElementById(`step${step}`).style.display = 'block';
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

            // Update current step
            currentStep = step;

            // Update progress bar
            updateProgressBar();

            // Update navigation buttons
            updateNavigationButtons();

            // Update review summary if on last step
            if (currentStep === 4) {
                updateReviewSummary();
                updatePLAmount();
                updateImagesSummary();
            }
        }

        function updateProgressBar() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            if (currentStep === 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'flex';
                submitBtn.style.display = 'none';
            } else if (currentStep === totalSteps) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'flex';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                submitBtn.style.display = 'none';
            }
        }

        // Step Validation
        function validateStep(step) {
            switch(step) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                    return validateStep3();
                default:
                    return true;
            }
        }

        function validateStep1() {
            const dateTime = document.getElementById('tradeDateTime').value;
            const session = document.getElementById('tradeSession').value;
            const pair = document.getElementById('tradePair').value;

            if (!dateTime) {
                showNotification('Please select date and time', 'error');
                return false;
            }

            if (!session) {
                showNotification('Please select trading session', 'error');
                return false;
            }

            if (!pair) {
                showNotification('Please select currency pair', 'error');
                return false;
            }

            return true;
        }

        function validateStep2() {
            const model = document.getElementById('tradeModel').value;
            const direction = document.querySelector('input[name="direction"]:checked');

            if (!model) {
                showNotification('Please select ICT model', 'error');
                return false;
            }

            if (!direction) {
                showNotification('Please select trade direction', 'error');
                return false;
            }

            return true;
        }

        function validateStep3() {
            const riskPercent = parseFloat(document.getElementById('riskPercent').value);
            const rewardPercent = parseFloat(document.getElementById('rewardPercent').value);

            if (!riskPercent || riskPercent <= 0) {
                showNotification('Please enter valid risk percentage', 'error');
                return false;
            }

            if (!rewardPercent || rewardPercent <= 0) {
                showNotification('Please enter valid reward percentage', 'error');
                return false;
            }

            if (riskPercent > 10) {
                if (!confirm(`You're risking ${riskPercent}% of your account. Are you sure?`)) {
                    return false;
                }
            }

            return true;
        }

        // Risk Management Calculations
        function calculateRiskReward() {
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
            const rewardPercent = parseFloat(document.getElementById('rewardPercent').value) || 2;
            const accountSize = parseFloat(document.getElementById('accountSize').value) || 10000;
            const lotSize = parseFloat(document.getElementById('lotSize').value) || 0.1;

            // Calculate R:R Ratio
            const rrRatio = (rewardPercent / riskPercent).toFixed(2);
            document.getElementById('rrRatio').value = rrRatio;

            // Calculate amounts
            const riskAmount = (accountSize * riskPercent / 100).toFixed(2);
            const rewardAmount = (accountSize * rewardPercent / 100).toFixed(2);

            // Calculate risk per pip (approximate)
            const riskPerPip = (riskAmount / 100).toFixed(2); // Assuming 100 pip stop loss

            // Update UI
            document.getElementById('riskAmount').textContent = `$${riskAmount}`;
            document.getElementById('rewardAmount').textContent = `$${rewardAmount}`;
            document.getElementById('riskPerPip').textContent = `$${riskPerPip}`;
            document.getElementById('positionSize').value = riskAmount;
            document.getElementById('riskBadge').textContent = `1:${rrRatio}`;

            // Update trade data
            tradeData.riskAmount = parseFloat(riskAmount);
            tradeData.rewardAmount = parseFloat(rewardAmount);
            tradeData.rrRatio = parseFloat(rrRatio);
        }

        function updatePLAmount() {
            const result = document.querySelector('input[name="result"]:checked').value;
            const riskAmount = tradeData.riskAmount || 100;
            const rewardAmount = tradeData.rewardAmount || 200;
            const rrRatio = tradeData.rrRatio || 2;

            let plAmount = 0;
            if (result === 'Win') {
                plAmount = rewardAmount;
            } else if (result === 'Loss') {
                plAmount = -riskAmount;
            } else {
                plAmount = 0;
            }

            document.getElementById('plAmount').value = plAmount.toFixed(2);
            updateReviewSummary();
        }

        // Image Link Management
        function addImageLink() {
            const input = document.getElementById('imageLinkInput');
            const link = input.value.trim();
            
            if (!link) {
                showNotification('Please enter an image link', 'error');
                return;
            }

            // Validate TradingView URL
            if (!isValidTradingViewLink(link) && !isValidImageLink(link)) {
                if (!confirm('This doesn\'t look like a TradingView image link. Do you want to add it anyway?')) {
                    return;
                }
            }

            // Check for duplicates
            if (imageLinks.some(img => img.url === link)) {
                showNotification('This image link is already added', 'info');
                input.value = '';
                return;
            }

            // Add to array
            const imageId = Date.now().toString();
            imageLinks.push({
                id: imageId,
                url: link,
                name: `Chart Image ${imageLinks.length + 1}`
            });

            // Clear input
            input.value = '';

            // Update preview
            updateImageLinksPreview();

            showNotification('Image link added successfully!', 'success');
        }

        function processBulkLinks() {
            const textarea = document.getElementById('bulkImageLinks');
            const links = textarea.value.split('\n')
                .map(link => link.trim())
                .filter(link => link.length > 0);

            let addedCount = 0;
            let duplicateCount = 0;

            links.forEach(link => {
                // Validate link
                if (isValidTradingViewLink(link) || isValidImageLink(link)) {
                    // Check for duplicates
                    if (!imageLinks.some(img => img.url === link)) {
                        const imageId = Date.now().toString() + Math.random();
                        imageLinks.push({
                            id: imageId,
                            url: link,
                            name: `Chart Image ${imageLinks.length + 1}`
                        });
                        addedCount++;
                    } else {
                        duplicateCount++;
                    }
                }
            });

            // Update preview
            updateImageLinksPreview();

            // Clear textarea
            textarea.value = '';

            // Show notification
            if (addedCount > 0 || duplicateCount > 0) {
                let message = '';
                if (addedCount > 0) {
                    message += `Added ${addedCount} new image link${addedCount > 1 ? 's' : ''}. `;
                }
                if (duplicateCount > 0) {
                    message += `Skipped ${duplicateCount} duplicate link${duplicateCount > 1 ? 's' : ''}.`;
                }
                showNotification(message, 'info');
            }
        }

        function removeImageLink(imageId) {
            imageLinks = imageLinks.filter(img => img.id !== imageId);
            updateImageLinksPreview();
            showNotification('Image link removed', 'info');
        }

        function updateImageLinksPreview() {
            const preview = document.getElementById('imageLinksPreview');
            
            if (imageLinks.length === 0) {
                preview.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--notion-text-light);">
                        <i class="fas fa-image"></i><br>
                        No image links added yet.<br>
                        <small>Add TradingView chart images using the methods above.</small>
                    </div>
                `;
                return;
            }

            let html = '';
            imageLinks.forEach((image, index) => {
                // Generate thumbnail preview for known image URLs
                const thumbnail = getImageThumbnail(image.url);
                
                html += `
                    <div class="image-link-preview">
                        ${thumbnail ? `<img src="${thumbnail}" class="image-thumbnail" alt="${image.name}">` : ''}
                        <div class="image-link-info">
                            <div class="image-link-name">${image.name}</div>
                            <div style="font-size: 11px; color: var(--notion-text-light); word-break: break-all; margin-top: 4px;">
                                ${image.url.substring(0, 50)}${image.url.length > 50 ? '...' : ''}
                            </div>
                            <div class="image-link-actions">
                                <button type="button" class="quick-btn" onclick="viewImageLink('${image.url}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button type="button" class="quick-btn" onclick="removeImageLink('${image.id}')" style="background-color: var(--notion-red-light); color: var(--notion-red);">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            preview.innerHTML = html;
        }

        function updateImagesSummary() {
            const summaryCard = document.getElementById('imagesSummary');
            const imagesCount = document.getElementById('imagesCount');
            const previewSummary = document.getElementById('imagesPreviewSummary');
            
            if (imageLinks.length === 0) {
                summaryCard.style.display = 'none';
                return;
            }

            summaryCard.style.display = 'block';
            imagesCount.textContent = `${imageLinks.length} image${imageLinks.length > 1 ? 's' : ''}`;

            // Show first 3 images in summary
            let html = `<div style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto; padding: 8px 0;">`;
            imageLinks.slice(0, 3).forEach((image, index) => {
                const thumbnail = getImageThumbnail(image.url);
                if (thumbnail) {
                    html += `
                        <div style="flex-shrink: 0; width: 80px; height: 60px; border-radius: 4px; overflow: hidden; border: 1px solid var(--notion-gray-dark);">
                            <img src="${thumbnail}" style="width: 100%; height: 100%; object-fit: cover;" alt="Chart ${index + 1}">
                        </div>
                    `;
                }
            });
            
            if (imageLinks.length > 3) {
                html += `<div style="flex-shrink: 0; width: 80px; height: 60px; border-radius: 4px; background-color: var(--notion-gray); display: flex; align-items: center; justify-content: center; color: var(--notion-text-light); font-size: 12px;">
                    +${imageLinks.length - 3} more
                </div>`;
            }
            
            html += `</div>`;
            previewSummary.innerHTML = html;
        }

        // Utility Functions for Image Links
        function isValidTradingViewLink(url) {
            return url.includes('tradingview.com') && 
                   (url.includes('/x/') || url.includes('/chart/'));
        }

        function isValidImageLink(url) {
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
            return imageExtensions.some(ext => url.toLowerCase().includes(ext)) ||
                   url.startsWith('data:image/') ||
                   url.includes('i.imgur.com') ||
                   url.includes('imgur.com') ||
                   url.includes('cloudinary.com') ||
                   url.includes('images.unsplash.com');
        }

        function getImageThumbnail(url) {
            // For TradingView URLs, we can't get thumbnails directly due to CORS
            // Return a placeholder or attempt to create a thumbnail
            if (url.includes('tradingview.com')) {
                // Return a TradingView logo as placeholder
                return 'https://www.tradingview.com/static/images/tradingview-logo.svg';
            } else if (isValidImageLink(url)) {
                // For direct image links, use the URL itself
                return url;
            }
            return null;
        }

        function viewImageLink(url) {
            window.open(url, '_blank');
        }

        // Update Review Summary
        function updateReviewSummary() {
            // Get all values
            const pair = document.getElementById('tradePair').value || 'EUR/USD';
            const session = document.getElementById('tradeSession').value || 'London';
            const model = document.getElementById('tradeModel').value || 'FVG';
            const direction = document.querySelector('input[name="direction"]:checked')?.value || 'Buy';
            const result = document.querySelector('input[name="result"]:checked')?.value || 'Win';
            
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
            const rewardPercent = parseFloat(document.getElementById('rewardPercent').value) || 2;
            const rrRatio = (rewardPercent / riskPercent).toFixed(2);
            
            const plAmount = parseFloat(document.getElementById('plAmount').value) || 200;
            const plSign = plAmount >= 0 ? '+' : '';

            // Update UI
            document.getElementById('reviewPair').textContent = pair;
            document.getElementById('reviewSession').textContent = session;
            document.getElementById('reviewPL').textContent = `${plSign}$${Math.abs(plAmount).toFixed(2)}`;
            document.getElementById('reviewRR').textContent = `1:${rrRatio}`;

            // Update badge
            const badge = document.getElementById('reviewBadge');
            badge.textContent = result;
            badge.className = `result-badge ${result.toLowerCase()}`;

            // Update PL color
            const plElement = document.getElementById('reviewPL');
            plElement.className = plAmount >= 0 ? 'stat-value positive' : 'stat-value negative';
        }

        // Show ICT Model Info
        function showModelInfo() {
            const model = document.getElementById('tradeModel').value;
            const infoElement = document.getElementById('modelInfo');
            
            const modelInfo = {
                'FVG': {
                    title: 'Fair Value Gap (FVG)',
                    description: 'A three-candle pattern where the middle candle\'s range doesn\'t overlap with the first candle\'s range. Used to identify potential reversal zones.'
                },
                'Liquidity Sweep': {
                    title: 'Liquidity Sweep',
                    description: 'When price moves beyond a previous high/low to trigger stop losses before reversing. Often creates optimal trade entries.'
                },
                'Order Block': {
                    title: 'Order Block (OB)',
                    description: 'A specific candle or group of candles that represents institutional order flow. Used as support/resistance levels.'
                },
                'Breaker': {
                    title: 'Breaker Block',
                    description: 'A specific type of order block that breaks structure and often leads to strong reversals.'
                },
                'MIT': {
                    title: 'Market Structure Shift (MSS)',
                    description: 'A change in market direction confirmed by breaking previous structure and creating new higher highs/lows.'
                },
                'BOS': {
                    title: 'Break of Structure (BOS)',
                    description: 'When price breaks through a significant level, indicating continuation of the trend.'
                },
                'CHoCH': {
                    title: 'Change of Character (CHoCH)',
                    description: 'A change in how price moves, often signaling a potential trend change.'
                },
                'Premium/Discount': {
                    title: 'Premium/Discount Zone',
                    description: 'Price levels where institutions are likely to buy (discount) or sell (premium).'
                },
                'Kill Zone': {
                    title: 'Kill Zone Entry',
                    description: 'Specific time windows (usually London/New York opens) where institutional activity is highest.'
                }
            };

            if (modelInfo[model]) {
                infoElement.innerHTML = `
                    <h4>${modelInfo[model].title}</h4>
                    <p>${modelInfo[model].description}</p>
                `;
                infoElement.classList.add('active');
            } else {
                infoElement.classList.remove('active');
            }
        }

        // Instructions Modal
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'flex';
        }

        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }

        // Submit Trade to Firebase - FIXED VERSION
        async function submitTrade() {
            if (isSubmitting) return;
            
            // Validate final step
            if (!validateStep(4)) {
                return;
            }

            isSubmitting = true;
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                updateSyncStatus('Saving trade to cloud...', 'syncing');

                // Collect all trade data
                const tradeData = {
                    // Basic Info
                    date: document.getElementById('tradeDateTime').value,
                    session: document.getElementById('tradeSession').value,
                    pair: document.getElementById('tradePair').value,
                    
                    // Trade Setup
                    model: document.getElementById('tradeModel').value,
                    direction: document.querySelector('input[name="direction"]:checked').value,
                    timeframe: document.getElementById('tradeTimeframe').value,
                    entryType: document.getElementById('entryType').value,
                    entryPrice: document.getElementById('entryPrice').value || null,
                    
                    // Image Links - Store as array of URLs
                    imageLinks: imageLinks.map(img => img.url),
                    
                    // Risk Management
                    riskPercent: parseFloat(document.getElementById('riskPercent').value),
                    rewardPercent: parseFloat(document.getElementById('rewardPercent').value),
                    rr: `1:${(parseFloat(document.getElementById('rewardPercent').value) / parseFloat(document.getElementById('riskPercent').value)).toFixed(2)}`,
                    accountSize: parseFloat(document.getElementById('accountSize').value) || 10000,
                    lotSize: parseFloat(document.getElementById('lotSize').value) || 0.1,
                    riskAmount: parseFloat(document.getElementById('positionSize').value) || 100,
                    rewardAmount: (parseFloat(document.getElementById('positionSize').value) || 100) * 
                                 (parseFloat(document.getElementById('rewardPercent').value) / parseFloat(document.getElementById('riskPercent').value)),
                    
                    // Results
                    result: document.querySelector('input[name="result"]:checked').value,
                    pl: parseFloat(document.getElementById('plAmount').value),
                    returnAmount: parseFloat(document.getElementById('plAmount').value),
                    
                    // Psychology
                    emotionBefore: parseInt(document.getElementById('emotionBefore').value),
                    
                    // Notes
                    notes: document.getElementById('tradeNotes').value,
                    tags: document.getElementById('tradeTags').value,
                    
                    // Metadata
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active',
                    source: 'web_form'
                };

                // Generate trade ID
                const tradeId = Date.now().toString();

                // Save to Firebase
                await tradesRef.child(tradeId).set(tradeData);

                // Show success
                document.getElementById('step4').style.display = 'none';
                document.getElementById('formActions').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                updateSyncStatus('Trade saved successfully!', 'synced');
                
                showNotification('Trade saved successfully!', 'success');

                // Log to console for debugging
                console.log('Trade saved successfully:', tradeData);

            } catch (error) {
                console.error('Error saving trade:', error);
                updateSyncStatus('Failed to save trade', 'error');
                showNotification('Failed to save trade. Please check your connection.', 'error');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            } finally {
                isSubmitting = false;
            }
        }

        // Reset Form - FIXED VERSION
        function resetForm() {
            // Reset all form fields individually
            document.getElementById('tradeDateTime').value = '';
            initDateTime(); // Reset to current date/time
            
            document.getElementById('tradeSession').value = 'London';
            document.getElementById('tradePair').value = 'EURUSD';
            document.getElementById('tradeModel').value = 'FVG';
            document.querySelector('input[name="direction"][value="Buy"]').checked = true;
            document.getElementById('tradeTimeframe').value = '1H';
            document.getElementById('entryType').value = 'Market';
            document.getElementById('entryPrice').value = '';
            document.getElementById('riskPercent').value = '1.0';
            document.getElementById('rewardPercent').value = '2.0';
            document.getElementById('accountSize').value = '10000';
            document.getElementById('lotSize').value = '0.10';
            document.querySelector('input[name="result"][value="Win"]').checked = true;
            document.getElementById('emotionBefore').value = '7';
            document.getElementById('tradeNotes').value = '';
            document.getElementById('tradeTags').value = '';
            document.getElementById('imageLinkInput').value = '';
            document.getElementById('bulkImageLinks').value = '';
            
            // Reset quick buttons
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.quick-btn[data-pair="EURUSD"]').classList.add('active');
            document.querySelector('.quick-btn[data-tf="1H"]').classList.add('active');
            document.querySelector('.quick-btn[data-risk="1.0"]').classList.add('active');
            document.querySelector('.quick-btn[data-reward="2.0"]').classList.add('active');
            
            // Reset image links
            imageLinks = [];
            updateImageLinksPreview();
            updateImagesSummary();
            
            // Recalculate
            calculateRiskReward();
            updatePLAmount();
            
            // Reset to step 1
            goToStep(1);
            
            // Show form, hide success message
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('formActions').style.display = 'flex';
            
            // Focus on first field
            document.getElementById('tradeDateTime').focus();
            
            showNotification('Form reset. Ready to add new trade.', 'info');
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Update Sync Status
        function updateSyncStatus(message, status) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'sync-status ' + status;
                
                const icon = status === 'synced' ? 'fa-cloud' : 
                            status === 'syncing' ? 'fa-sync fa-spin' : 
                            'fa-cloud-slash';
                statusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            }
        }

        // Helper function for validateStep(4)
        function validateStep(step) {
            if (step === 4) {
                const result = document.querySelector('input[name="result"]:checked');
                if (!result) {
                    showNotification('Please select trade result', 'error');
                    return false;
                }
                return true;
            }
            return true;
        }
    </script>
</body>
</html>
