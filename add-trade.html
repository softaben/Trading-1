<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA | Add Trade</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reuse the same CSS variables and base styles */
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-green: #0f7b6c;
            --notion-red: #d1453b;
            --notion-purple: #6940a5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Auth Overlay (same as analytics) */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .auth-message {
            font-size: 16px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 300px;
        }

        /* Mobile Header (same as analytics) */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .mobile-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Menu (same as analytics) */
        .mobile-menu {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit;
            text-align: left;
        }

        .mobile-menu-item.primary {
            background-color: var(--notion-green);
            color: white;
        }

        /* Main Container */
        .main-container {
            margin: 50px 0 60px 0;
            padding: 0;
            width: 100%;
        }

        /* Page Header */
        .page-header {
            padding: 20px 16px;
            background: linear-gradient(135deg, var(--notion-purple-light), var(--notion-blue-light));
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--notion-text);
            line-height: 1.3;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Trade Form */
        .trade-form-container {
            padding: 20px 16px;
            background-color: white;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--notion-gray);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 16px;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--notion-red);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            color: var(--notion-text);
            background-color: white;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--notion-green);
            box-shadow: 0 0 0 2px rgba(15, 123, 108, 0.1);
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--notion-red);
        }

        .error-message {
            color: var(--notion-red);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-top: 4px;
        }

        /* Risk Calculator */
        .risk-calculator {
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
            border: 1px solid var(--notion-gray-dark);
        }

        .calculator-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .calculator-label {
            font-size: 13px;
            color: var(--notion-text);
            min-width: 100px;
        }

        .calculator-value {
            font-weight: 600;
            color: var(--notion-green);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 12px;
            padding: 20px 0;
            border-top: 1px solid var(--notion-gray-dark);
            margin-top: 30px;
        }

        .form-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .form-btn.primary {
            background-color: var(--notion-green);
            color: white;
        }

        .form-btn.primary:hover {
            background-color: #0c6b5d;
        }

        .form-btn.secondary {
            background-color: var(--notion-gray);
            color: var(--notion-text);
        }

        .form-btn.secondary:hover {
            background-color: var(--notion-gray-dark);
        }

        .form-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Result Preview */
        .result-preview {
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--notion-gray-dark);
            display: none;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .preview-result {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .preview-result.win {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .preview-result.loss {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .preview-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-label {
            font-size: 12px;
            color: var(--notion-text-light);
        }

        .preview-value {
            font-size: 14px;
            font-weight: 500;
        }

        /* Bottom Navigation (same as analytics) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--notion-blue);
            background-color: var(--notion-blue-light);
        }

        .bottom-nav-btn i {
            font-size: 18px;
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-container {
                margin: 0;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            
            .page-header {
                border-radius: 12px 12px 0 0;
            }
            
            .trade-form-container {
                border-radius: 0 0 12px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Loading trade form...</div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header-title" id="formTitle">Add New Trade</div>
        </div>
        <button class="mobile-menu-btn" id="mobileBackBtn">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" class="mobile-menu-item">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <a href="journal.html" class="mobile-menu-item">
            <i class="fas fa-book"></i>
            Trading Journal
        </a>
        <a href="analysis.html" class="mobile-menu-item">
            <i class="fas fa-chart-line"></i>
            Analysis
        </a>
        <a href="add-trade.html" class="mobile-menu-item primary">
            <i class="fas fa-plus-circle"></i>
            Add New Trade
        </a>
        <button class="mobile-menu-item" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle">➕ Add New Trade</h1>
            <p class="page-subtitle">Record your trade details for better tracking and analysis</p>
        </div>

        <!-- Result Preview -->
        <div class="result-preview" id="resultPreview">
            <div class="preview-header">
                <div class="preview-title">Trade Preview</div>
                <div class="preview-result" id="previewResult">Win</div>
            </div>
            <div class="preview-grid">
                <div class="preview-item">
                    <div class="preview-label">Pair</div>
                    <div class="preview-value" id="previewPair">EUR/USD</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Direction</div>
                    <div class="preview-value" id="previewDirection">Long</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">P/L</div>
                    <div class="preview-value" id="previewPL">+$250</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">R:R</div>
                    <div class="preview-value" id="previewRR">1:2</div>
                </div>
            </div>
        </div>

        <!-- Trade Form -->
        <div class="trade-form-container">
            <form id="tradeForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        <span>Basic Information</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" for="tradeDate">Date & Time</label>
                            <input type="datetime-local" class="form-input" id="tradeDate" required>
                            <div class="error-message" id="tradeDateError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="tradePair">Currency Pair</label>
                            <select class="form-select" id="tradePair" required>
                                <option value="">Select a pair</option>
                                <option value="EUR/USD">EUR/USD</option>
                                <option value="GBP/USD">GBP/USD</option>
                                <option value="USD/JPY">USD/JPY</option>
                                <option value="AUD/USD">AUD/USD</option>
                                <option value="USD/CAD">USD/CAD</option>
                                <option value="NZD/USD">NZD/USD</option>
                                <option value="USD/CHF">USD/CHF</option>
                                <option value="EUR/GBP">EUR/GBP</option>
                                <option value="EUR/JPY">EUR/JPY</option>
                                <option value="GBP/JPY">GBP/JPY</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="tradePairError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="tradeDirection">Direction</label>
                            <select class="form-select" id="tradeDirection" required>
                                <option value="">Select direction</option>
                                <option value="Long">Long (Buy)</option>
                                <option value="Short">Short (Sell)</option>
                            </select>
                            <div class="error-message" id="tradeDirectionError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="tradeResult">Result</label>
                            <select class="form-select" id="tradeResult" required>
                                <option value="">Select result</option>
                                <option value="Win">Win</option>
                                <option value="Loss">Loss</option>
                                <option value="Break Even">Break Even</option>
                            </select>
                            <div class="error-message" id="tradeResultError"></div>
                        </div>
                    </div>
                </div>

                <!-- Trade Details -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        <span>Trade Details</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="entryPrice">Entry Price</label>
                            <input type="number" step="0.00001" class="form-input" id="entryPrice" placeholder="e.g., 1.12345">
                            <div class="error-message" id="entryPriceError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="exitPrice">Exit Price</label>
                            <input type="number" step="0.00001" class="form-input" id="exitPrice" placeholder="e.g., 1.12545">
                            <div class="error-message" id="exitPriceError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="positionSize">Position Size (Lots)</label>
                            <input type="number" step="0.01" class="form-input" id="positionSize" placeholder="e.g., 0.10">
                            <div class="error-message" id="positionSizeError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="tradePL">Profit/Loss ($)</label>
                            <input type="number" step="0.01" class="form-input" id="tradePL" placeholder="e.g., 250.50" required>
                            <div class="error-message" id="tradePLError"></div>
                        </div>
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        <span>Risk Management</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="stopLoss">Stop Loss (Pips)</label>
                            <input type="number" step="1" class="form-input" id="stopLoss" placeholder="e.g., 20">
                            <div class="error-message" id="stopLossError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="takeProfit">Take Profit (Pips)</label>
                            <input type="number" step="1" class="form-input" id="takeProfit" placeholder="e.g., 40">
                            <div class="error-message" id="takeProfitError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="riskReward">Risk:Reward Ratio</label>
                            <input type="number" step="0.1" class="form-input" id="riskReward" placeholder="e.g., 2.0">
                            <div class="error-message" id="riskRewardError"></div>
                            <div class="form-hint">Calculated automatically if SL/TP provided</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="riskPercent">Risk %</label>
                            <input type="number" step="0.01" class="form-input" id="riskPercent" placeholder="e.g., 1.5">
                            <div class="error-message" id="riskPercentError"></div>
                            <div class="form-hint">Percentage of account risked</div>
                        </div>
                    </div>
                    
                    <!-- Risk Calculator -->
                    <div class="risk-calculator" id="riskCalculator" style="display: none;">
                        <div class="calculator-row">
                            <div class="calculator-label">Risk Amount:</div>
                            <div class="calculator-value" id="riskAmount">$0.00</div>
                        </div>
                        <div class="calculator-row">
                            <div class="calculator-label">Reward Amount:</div>
                            <div class="calculator-value" id="rewardAmount">$0.00</div>
                        </div>
                        <div class="calculator-row">
                            <div class="calculator-label">Actual R:R:</div>
                            <div class="calculator-value" id="actualRR">0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-sticky-note"></i>
                        <span>Additional Information</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="tradeSession">Trading Session</label>
                            <select class="form-select" id="tradeSession">
                                <option value="">Select session</option>
                                <option value="London">London</option>
                                <option value="New York">New York</option>
                                <option value="Tokyo">Tokyo</option>
                                <option value="Sydney">Sydney</option>
                                <option value="London/New York Overlap">London/New York Overlap</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="tradeSessionError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="tradeSetup">Setup/Strategy</label>
                            <select class="form-select" id="tradeSetup">
                                <option value="">Select setup</option>
                                <option value="Breakout">Breakout</option>
                                <option value="Pullback">Pullback</option>
                                <option value="Trend Following">Trend Following</option>
                                <option value="Range Trading">Range Trading</option>
                                <option value="Support/Resistance">Support/Resistance</option>
                                <option value="News Trading">News Trading</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="tradeSetupError"></div>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label" for="tradeNotes">Trade Notes</label>
                            <textarea class="form-textarea" id="tradeNotes" placeholder="Enter any additional notes about this trade..."></textarea>
                            <div class="error-message" id="tradeNotesError"></div>
                            <div class="form-hint">What went well? What could be improved? Any lessons learned?</div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="form-btn secondary" id="cancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="form-btn primary" id="submitBtn">
                        <i class="fas fa-save"></i>
                        Save Trade
                        <div class="btn-loading" id="submitLoading"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-home"></i>
            Dashboard
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='journal.html'">
            <i class="fas fa-book"></i>
            Journal
        </button>
        <button class="bottom-nav-btn active">
            <i class="fas fa-plus-circle"></i>
            Add Trade
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='settings.html'">
            <i class="fas fa-cog"></i>
            Settings
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let isEditMode = false;
        let editTradeId = null;
        let currentTradeData = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
            setupForm();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobileBackBtn').addEventListener('click', goBack);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);
            
            // Form
            document.getElementById('cancelBtn').addEventListener('click', cancelForm);
            document.getElementById('tradeForm').addEventListener('submit', submitForm);
            
            // Auto-calculate R:R
            document.getElementById('stopLoss').addEventListener('input', calculateRiskReward);
            document.getElementById('takeProfit').addEventListener('input', calculateRiskReward);
            document.getElementById('tradePL').addEventListener('input', updatePreview);
            
            // Auto-update preview
            document.getElementById('tradePair').addEventListener('change', updatePreview);
            document.getElementById('tradeDirection').addEventListener('change', updatePreview);
            document.getElementById('tradeResult').addEventListener('change', updatePreview);
            document.getElementById('riskReward').addEventListener('input', updatePreview);
        }

        // Setup Form
        function setupForm() {
            // Set default date to now
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('tradeDate').value = localDateTime;
            
            // Check for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('edit')) {
                isEditMode = true;
                editTradeId = urlParams.get('edit');
                document.getElementById('formTitle').textContent = 'Edit Trade';
                document.getElementById('pageTitle').textContent = '✏️ Edit Trade';
                loadTradeForEditing();
            }
        }

        // Check Authentication
        function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    authOverlay.classList.add('hidden');
                } else {
                    authMessage.textContent = 'Redirecting to login...';
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            });
        }

        // Load Trade for Editing
        async function loadTradeForEditing() {
            try {
                const snapshot = await database.ref(`userTrades/${currentUser.uid}/trades/${editTradeId}`).once('value');
                currentTradeData = snapshot.val();
                
                if (!currentTradeData) {
                    throw new Error('Trade not found');
                }
                
                // Populate form fields
                if (currentTradeData.date) {
                    const date = new Date(currentTradeData.date);
                    const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                    document.getElementById('tradeDate').value = localDateTime;
                }
                
                document.getElementById('tradePair').value = currentTradeData.pair || '';
                document.getElementById('tradeDirection').value = currentTradeData.direction || '';
                document.getElementById('tradeResult').value = currentTradeData.result || '';
                document.getElementById('entryPrice').value = currentTradeData.entryPrice || '';
                document.getElementById('exitPrice').value = currentTradeData.exitPrice || '';
                document.getElementById('positionSize').value = currentTradeData.positionSize || '';
                document.getElementById('tradePL').value = currentTradeData.pl || '';
                document.getElementById('stopLoss').value = currentTradeData.stopLoss || '';
                document.getElementById('takeProfit').value = currentTradeData.takeProfit || '';
                document.getElementById('riskReward').value = currentTradeData.rr || '';
                document.getElementById('riskPercent').value = currentTradeData.riskPercent || '';
                document.getElementById('tradeSession').value = currentTradeData.session || '';
                document.getElementById('tradeSetup').value = currentTradeData.setup || '';
                document.getElementById('tradeNotes').value = currentTradeData.notes || '';
                
                // Update preview
                updatePreview();
                
            } catch (error) {
                console.error('Error loading trade for editing:', error);
                alert('Failed to load trade for editing. Redirecting to add new trade.');
                isEditMode = false;
                editTradeId = null;
                currentTradeData = null;
                document.getElementById('formTitle').textContent = 'Add New Trade';
                document.getElementById('pageTitle').textContent = '➕ Add New Trade';
            }
        }

        // Calculate Risk:Reward
        function calculateRiskReward() {
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            
            if (stopLoss > 0 && takeProfit > 0) {
                const rrRatio = takeProfit / stopLoss;
                document.getElementById('riskReward').value = rrRatio.toFixed(2);
                
                // Show risk calculator
                const riskCalculator = document.getElementById('riskCalculator');
                riskCalculator.style.display = 'block';
                
                // Update risk calculator values
                const positionSize = parseFloat(document.getElementById('positionSize').value) || 0.1; // Default 0.1 lots
                const riskAmount = positionSize * stopLoss * 10; // Simplified calculation
                const rewardAmount = positionSize * takeProfit * 10;
                
                document.getElementById('riskAmount').textContent = `$${riskAmount.toFixed(2)}`;
                document.getElementById('rewardAmount').textContent = `$${rewardAmount.toFixed(2)}`;
                document.getElementById('actualRR').textContent = rrRatio.toFixed(2);
            }
        }

        // Update Preview
        function updatePreview() {
            const pair = document.getElementById('tradePair').value;
            const direction = document.getElementById('tradeDirection').value;
            const result = document.getElementById('tradeResult').value;
            const pl = parseFloat(document.getElementById('tradePL').value) || 0;
            const rr = document.getElementById('riskReward').value;
            
            if (pair && direction && result) {
                // Show preview
                const preview = document.getElementById('resultPreview');
                preview.style.display = 'block';
                
                // Update preview values
                document.getElementById('previewPair').textContent = pair;
                document.getElementById('previewDirection').textContent = direction;
                document.getElementById('previewPL').textContent = `${pl >= 0 ? '+' : ''}$${Math.abs(pl).toFixed(2)}`;
                document.getElementById('previewPL').style.color = pl >= 0 ? 'var(--notion-green)' : 'var(--notion-red)';
                document.getElementById('previewRR').textContent = rr ? `1:${parseFloat(rr).toFixed(1)}` : 'N/A';
                
                // Update result badge
                const resultBadge = document.getElementById('previewResult');
                resultBadge.textContent = result;
                resultBadge.className = 'preview-result ' + result.toLowerCase().replace(' ', '-');
            }
        }

        // Submit Form
        async function submitForm(e) {
            e.preventDefault();
            
            // Clear previous errors
            clearErrors();
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Get form data
            const tradeData = {
                date: new Date(document.getElementById('tradeDate').value).getTime(),
                pair: document.getElementById('tradePair').value,
                direction: document.getElementById('tradeDirection').value,
                result: document.getElementById('tradeResult').value,
                pl: parseFloat(document.getElementById('tradePL').value),
                rr: document.getElementById('riskReward').value ? parseFloat(document.getElementById('riskReward').value) : null,
                riskPercent: document.getElementById('riskPercent').value ? parseFloat(document.getElementById('riskPercent').value) : null,
                session: document.getElementById('tradeSession').value || null,
                setup: document.getElementById('tradeSetup').value || null,
                notes: document.getElementById('tradeNotes').value || null,
                entryPrice: document.getElementById('entryPrice').value || null,
                exitPrice: document.getElementById('exitPrice').value || null,
                positionSize: document.getElementById('positionSize').value || null,
                stopLoss: document.getElementById('stopLoss').value || null,
                takeProfit: document.getElementById('takeProfit').value || null,
                createdAt: currentTradeData?.createdAt || Date.now(),
                updatedAt: Date.now()
            };
            
            // Show loading
            const submitBtn = document.getElementById('submitBtn');
            const submitLoading = document.getElementById('submitLoading');
            submitBtn.disabled = true;
            submitLoading.style.display = 'block';
            submitBtn.querySelector('i').style.display = 'none';
            
            try {
                let successMessage;
                
                if (isEditMode && editTradeId) {
                    // Update existing trade
                    await database.ref(`userTrades/${currentUser.uid}/trades/${editTradeId}`).update(tradeData);
                    successMessage = 'Trade updated successfully!';
                } else {
                    // Create new trade
                    tradeData.createdAt = Date.now();
                    const newTradeRef = database.ref(`userTrades/${currentUser.uid}/trades`).push();
                    await newTradeRef.set(tradeData);
                    successMessage = 'Trade added successfully!';
                }
                
                // Show success message
                alert(successMessage);
                
                // Redirect to journal
                window.location.href = 'journal.html';
                
            } catch (error) {
                console.error('Error saving trade:', error);
                alert('Failed to save trade. Please try again.');
                
                // Reset button
                submitBtn.disabled = false;
                submitLoading.style.display = 'none';
                submitBtn.querySelector('i').style.display = 'inline-block';
            }
        }

        // Validate Form
        function validateForm() {
            let isValid = true;
            
            // Required fields
            const requiredFields = [
                'tradeDate',
                'tradePair',
                'tradeDirection',
                'tradeResult',
                'tradePL'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showError(fieldId, 'This field is required');
                    isValid = false;
                }
            });
            
            // Validate numeric fields
            const numericFields = ['tradePL'];
            numericFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field.value && isNaN(parseFloat(field.value))) {
                    showError(fieldId, 'Please enter a valid number');
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Show Error
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');
            
            field.classList.add('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        // Clear Errors
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            
            document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(el => {
                el.classList.remove('error');
            });
        }

        // Cancel Form
        function cancelForm() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                window.location.href = 'journal.html';
            }
        }

        // Go Back
        function goBack() {
            window.history.back();
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout User
        function logoutUser() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            });
        }
    </script>
</body>
</html>
