
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التداول المتطور | النسخة المطورة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            orderBy,
            where,
            doc,
            setDoc,
            getDoc,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDujj4l-YZQJGQ9pHWw9Vw8-5F1PoS-1Gc",
            authDomain: "trading-1-7a65f.firebaseapp.com",
            projectId: "trading-1-7a65f",
            storageBucket: "trading-1-7a65f.appspot.com",
            messagingSenderId: "93180755697",
            appId: "1:93180755697:web:a0f20638fea2813036f350",
            measurementId: "G-HEQZ07LEKS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebase = {
            auth,
            db,
            authFunctions: {
                signInWithEmailAndPassword,
                createUserWithEmailAndPassword,
                signOut,
                onAuthStateChanged,
                signInAnonymously
            },
            firestoreFunctions: {
                collection,
                addDoc,
                getDocs,
                query,
                orderBy,
                where,
                doc,
                setDoc,
                getDoc,
                deleteDoc,
                serverTimestamp
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await signInAnonymously(auth);
                console.log("Firebase connection test successful");
            } catch (error) {
                console.error("Firebase connection test failed:", error);
            }
        });
    </script>

    <style>
        :root {
            --primary: #9e9e9e;
            --secondary: #757575;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #607d8b;
            --dark: #121212;
            --light: #e0e0e0;
            --bg-gradient: linear-gradient(135deg, #121212, #000000);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--bg-gradient);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #3d-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .tabs {
            display: flex;
            position: relative;
            margin-bottom: 30px;
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 5px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 1;
            color: var(--secondary);
            border-radius: 8px;
        }
        
        .tab:hover {
            color: var(--light);
        }
        
        .tab.active {
            color: var(--light);
        }
        
        .tab-highlight {
            position: absolute;
            top: 5px;
            height: calc(100% - 10px);
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            z-index: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .capital-stat-profit {
            color: var(--success);
        }
        
        .capital-stat-loss {
            color: var(--danger);
        }
        
        .recent-trades-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .recent-trades-container h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .trade-card {
            background: rgba(40,40,40,0.7);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            transition: all 0.3s ease;
        }
        
        .trade-card.loss {
            border-left-color: var(--danger);
        }
        
        .trade-card:hover {
            background: rgba(50,50,50,0.7);
        }
        
        .show-details-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .show-details-btn:hover {
            color: var(--light);
        }
        
        .trade-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .trade-details.active {
            max-height: 500px;
        }
        
        .trade-image {
            max-width: 100%;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .trade-image:hover {
            transform: scale(1.02);
        }
        
        .trade-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .analyze-btn {
            background: rgba(96, 125, 139, 0.2);
            border: 1px solid var(--info);
            color: var(--light);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .analyze-btn:hover {
            background: rgba(96, 125, 139, 0.4);
        }
        
        .trades-container {
            display: grid;
            grid-template-columns: 300px 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .trades-container {
                grid-template-columns: 1fr;
            }
        }
        
        .trade-form-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            height: fit-content;
        }
        
        .trade-form-container h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(50,50,50,0.7);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: var(--light);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .submit-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            background: #388e3c;
        }
        
        .chart-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .chart-container h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .calendar-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav button {
            background: rgba(50,50,50,0.7);
            border: none;
            color: var(--light);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 10px;
            color: var(--primary);
            font-weight: bold;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            background: rgba(40,40,40,0.7);
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: rgba(60,60,60,0.7);
        }
        
        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }
        
        .calendar-day-number {
            font-size: 0.9rem;
        }
        
        .calendar-day-trades {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 3px;
        }
        
        .trade-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .trade-indicator.profit {
            background: var(--success);
        }
        
        .trade-indicator.loss {
            background: var(--danger);
        }
        
        .day-details {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30,30,30,0.95);
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .day-details.active {
            display: block;
        }
        
        .day-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-details {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .ai-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .ai-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chat-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            height: 70vh;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        .user-message {
            background: rgba(96, 125, 139, 0.3);
            margin-left: auto;
            border-top-right-radius: 0;
        }
        
        .ai-message {
            background: rgba(66, 66, 66, 0.7);
            margin-right: auto;
            border-top-left-radius: 0;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(50,50,50,0.7);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: var(--light);
        }
        
        .send-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: #455a64;
        }
        
        .ai-analysis-container {
            background: rgba(30,30,30,0.7);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            height: fit-content;
        }
        
        .ai-analysis-card {
            background: rgba(40,40,40,0.7);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .ai-analysis-content {
            line-height: 1.6;
        }
        
        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 20px 0;
        }
        
        .loading-dots span {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }
        
        .modal-content {
            display: block;
            margin: auto;
            max-width: 90%;
            max-height: 80vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
        }
        
        .navigation {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            z-index: 101;
        }
        
        .nav-btn {
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 0 20px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .nav-btn:hover {
            opacity: 1;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .notification.warning {
            background: rgba(255, 152, 0, 0.8);
        }
        
        .notification.info {
            background: rgba(96, 125, 139, 0.8);
        }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .auth-container {
            background: #121212;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .auth-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .auth-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            background: rgba(50,50,50,0.7);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: var(--light);
        }
        
        #auth-error {
            color: var(--danger);
            margin-top: 15px;
            text-align: center;
            min-height: 20px;
        }
        
        #user-status {
            margin-top: 15px;
            text-align: center;
        }
        
        #user-email {
            display: none;
            color: var(--primary);
        }
        
        #logout-btn {
            display: none;
            margin-top: 10px;
            background: var(--danger);
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #logout-btn:hover {
            background: #d32f2f;
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        #login-btn {
            background: var(--success);
        }
        
        #login-btn:hover {
            background: #388e3c;
        }
        
        #register-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        #register-btn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <!-- البيئة ثلاثية الأبعاد -->
    <div id="3d-container"></div>
    
    <!-- نافذة المصادقة -->
    <div id="auth-modal" style="display: none;">
        <div class="auth-container">
            <h2><i class="fas fa-user"></i> تسجيل الدخول</h2>
            
            <div class="form-group">
                <label for="auth-email"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                <input type="email" id="auth-email" required class="auth-input">
            </div>
            
            <div class="form-group">
                <label for="auth-password"><i class="fas fa-lock"></i> كلمة المرور</label>
                <input type="password" id="auth-password" required class="auth-input">
            </div>
            
            <button id="login-btn" class="auth-btn"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
            <button id="register-btn" class="auth-btn"><i class="fas fa-user-plus"></i> إنشاء حساب جديد</button>
            
            <div id="auth-error"></div>
        </div>
    </div>
    
    <!-- التطبيق الرئيسي -->
    <div class="app-container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> نظام التداول المتطور</h1>
            <div id="user-status">
                <span id="user-email"></span>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>
        </div>
        
        <!-- نظام التبويبات -->
        <div class="tabs">
            <div class="tab-highlight"></div>
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-home"></i> لوحة التحكم
            </div>
            <div class="tab" data-tab="trades">
                <i class="fas fa-exchange-alt"></i> إدارة الصفقات
            </div>
            <div class="tab" data-tab="analytics">
                <i class="fas fa-chart-pie"></i> التحليلات
            </div>
            <div class="tab" data-tab="calendar">
                <i class="fas fa-calendar-alt"></i> التقويم
            </div>
            <div class="tab" data-tab="ai">
                <i class="fas fa-robot"></i> مساعد الذكاء الاصطناعي
            </div>
        </div>
        
        <!-- محتوى التبويبات -->
        <div class="tab-content active" id="dashboard">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-chart-bar"></i> إجمالي الصفقات</h3>
                    <div class="stat-value" id="total-trades">0</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-percentage"></i> معدل الربح</h3>
                    <div class="stat-value" id="win-rate">0%</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-arrow-up"></i> إجمالي الأرباح</h3>
                    <div class="stat-value" id="total-profit">$0</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-arrow-down"></i> إجمالي الخسائر</h3>
                    <div class="stat-value" id="total-loss">$0</div>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-wallet"></i> رأس المال الأولي</h3>
                    <div class="stat-value" id="initial-capital">$10,000</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-coins"></i> رأس المال الحالي</h3>
                    <div class="stat-value" id="current-capital">$10,000</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-plus-circle"></i> صافي الربح/الخسارة</h3>
                    <div class="stat-value" id="net-profit">$0</div>
                </div>
                
                <div class="stat-card">
                    <h3><i class="fas fa-chart-line"></i> عائد الاستثمار (ROI)</h3>
                    <div class="stat-value" id="roi">0%</div>
                </div>
            </div>
            
            <div class="recent-trades-container">
                <h2><i class="fas fa-history"></i> أحدث الصفقات</h2>
                <div id="recent-trades">
                    <p style="text-align: center;">جارٍ تحميل البيانات...</p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="trades">
            <div class="trades-container">
                <div class="trade-form-container">
                    <h2><i class="fas fa-plus-circle"></i> إضافة صفقة جديدة</h2>
                    <form id="trade-form">
                        <div class="form-group">
                            <label for="symbol">الرمز</label>
                            <input type="text" id="symbol" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="date">التاريخ</label>
                            <input type="date" id="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="session">الجلسة</label>
                            <select id="session" required>
                                <option value="london">لندن</option>
                                <option value="new-york">نيويورك</option>
                                <option value="tokyo">طوكيو</option>
                                <option value="sydney">سيدني</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="type">النوع</label>
                            <select id="type" required>
                                <option value="buy">شراء</option>
                                <option value="sell">بيع</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="amount">المبلغ ($)</label>
                            <input type="number" step="0.01" id="amount" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="size">الحجم (لوت)</label>
                            <input type="number" step="0.01" id="size" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetRR">نسبة المخاطرة/العائد المستهدفة</label>
                            <input type="number" step="0.1" id="targetRR" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="image">رابط الصورة (اختياري)</label>
                            <input type="url" id="image">
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">ملاحظات (اختياري)</label>
                            <textarea id="notes"></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn"><i class="fas fa-save"></i> حفظ الصفقة</button>
                    </form>
                </div>
                
                <div class="all-trades-container">
                    <h2><i class="fas fa-list"></i> جميع الصفقات</h2>
                    <div id="all-trades">
                        <p style="text-align: center;">جارٍ تحميل البيانات...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="analytics">
            <div class="chart-container">
                <h2><i class="fas fa-chart-bar"></i> أداء الصفقات حسب الجلسة</h2>
                <div class="chart-wrapper">
                    <canvas id="sessionChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h2><i class="fas fa-chart-pie"></i> توزيع الصفقات حسب النوع</h2>
                <div class="chart-wrapper">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h2><i class="fas fa-chart-line"></i> تطور رأس المال مع الوقت</h2>
                <div class="chart-wrapper">
                    <canvas id="capitalChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="calendar">
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button id="prev-month"><i class="fas fa-chevron-right"></i> الشهر السابق</button>
                        <button id="next-month">الشهر التالي <i class="fas fa-chevron-left"></i></button>
                    </div>
                    <div class="calendar-title" id="calendar-title">الشهر الحالي</div>
                </div>
                
                <div class="calendar-grid" id="calendar-days-header">
                    <div class="calendar-day-header">الأحد</div>
                    <div class="calendar-day-header">السبت</div>
                    <div class="calendar-day-header">الجمعة</div>
                    <div class="calendar-day-header">الخميس</div>
                    <div class="calendar-day-header">الأربعاء</div>
                    <div class="calendar-day-header">الثلاثاء</div>
                    <div class="calendar-day-header">الإثنين</div>
                </div>
                
                <div class="calendar-grid" id="calendar-days">
                    <!-- سيتم ملؤه ديناميكياً -->
                </div>
            </div>
            
            <div class="day-details" id="day-details">
                <div class="day-details-header">
                    <h3 id="day-details-title">تفاصيل الصفقات</h3>
                    <button class="close-details">&times;</button>
                </div>
                <div id="day-trades">
                    <!-- سيتم ملؤه ديناميكياً -->
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="ai">
            <div class="ai-container">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message ai-message">
                            مرحباً! أنا مساعدك في التداول. كيف يمكنني مساعدتك اليوم؟
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="user-input" placeholder="اكتب رسالتك هنا...">
                        <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                
                <div class="ai-analysis-container">
                    <h2><i class="fas fa-robot"></i> تحليل الصفقات</h2>
                    <div id="ai-analysis-results">
                        <div class="ai-analysis-card">
                            <div class="ai-analysis-header">
                                <i class="fas fa-info-circle"></i>
                                <h3>نصائح لتحسين أدائك</h3>
                            </div>
                            <div class="ai-analysis-content">
                                <p>1. ركز على جلسات التداول التي تحقق لك أفضل النتائج</p>
                                <p>2. حافظ على نسبة مخاطرة/عائد لا تقل عن 1:2</p>
                                <p>3. استخدم وقف الخسارة في جميع صفقاتك</p>
                                <p>4. سجل جميع صفقاتك لتحليل أدائك لاحقاً</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة الصورة -->
    <div id="imageModal" class="image-modal">
        <span class="close-btn">&times;</span>
        <img class="modal-content" id="modalImage">
        <div class="navigation">
            <div class="nav-btn" id="prevBtn"><i class="fas fa-chevron-right"></i></div>
            <div class="nav-btn" id="nextBtn"><i class="fas fa-chevron-left"></i></div>
        </div>
    </div>

    <!-- عنصر الإشعار -->
    <div class="notification" id="notification"></div>

    <script>
        // البيانات التطبيق
        let trades = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentImageIndex = 0;
        let tradeImages = [];
        let initialCapital = 10000;
        let sessionChart, typeChart, capitalChart;
        
        // تهيئة البيئة ثلاثية الأبعاد
        function init3DEnvironment() {
            const container = document.getElementById('3d-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);
            
            // إنشاء أشكال هندسية متطورة
            const geometries = [
                new THREE.IcosahedronGeometry(1, 1),
                new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16),
                new THREE.OctahedronGeometry(1, 0),
                new THREE.DodecahedronGeometry(1, 0)
            ];
            
            const shapes = [];
            const colors = [0x9e9e9e, 0x757575, 0x616161, 0x424242, 0x212121];
            
            for (let i = 0; i < 15; i++) {
                const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                const material = new THREE.MeshPhongMaterial({ 
                    color: colors[Math.floor(Math.random() * colors.length)],
                    wireframe: true,
                    transparent: true,
                    opacity: 0.7,
                    shininess: 100
                });
                
                const shape = new THREE.Mesh(geometry, material);
                shape.position.x = Math.random() * 40 - 20;
                shape.position.y = Math.random() * 40 - 20;
                shape.position.z = Math.random() * 40 - 20;
                shape.rotation.x = Math.random() * Math.PI;
                shape.rotation.y = Math.random() * Math.PI;
                shape.scale.setScalar(Math.random() * 0.5 + 0.5);
                
                shapes.push(shape);
                scene.add(shape);
            }
            
            // إضافة إضاءة
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            camera.position.z = 30;
            
            // التحريك
            function animate() {
                requestAnimationFrame(animate);
                
                shapes.forEach(shape => {
                    shape.rotation.x += 0.001;
                    shape.rotation.y += 0.002;
                    shape.rotation.z += 0.0005;
                    
                    // حركة طفيفة للأشكال
                    shape.position.x += Math.sin(Date.now() * 0.001 + shape.position.y) * 0.01;
                    shape.position.y += Math.cos(Date.now() * 0.001 + shape.position.x) * 0.01;
                });
                
                renderer.render(scene, camera);
            }
            
            animate();
            
            // التكيف مع تغيير حجم النافذة
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }
        
        // تحميل التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            init3DEnvironment();
            setupAuth();
            setupTabs();
            
            // معالجة نموذج إضافة الصفقة
            document.getElementById('trade-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                addTrade();
            });
            
            // أحداث أزرار التقويم
            document.getElementById('prev-month')?.addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                loadCalendar();
            });
            
            document.getElementById('next-month')?.addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                loadCalendar();
            });
            
            // تعيين تاريخ اليوم كقيمة افتراضية
            document.getElementById('date') && (document.getElementById('date').valueAsDate = new Date());
            
            // أحداث معاينة الصورة
            document.querySelector('.close-btn').onclick = function() {
                document.getElementById('imageModal').style.display = "none";
            }
            
            document.getElementById('prevBtn').onclick = function() {
                currentImageIndex = (currentImageIndex - 1 + tradeImages.length) % tradeImages.length;
                document.getElementById('modalImage').src = tradeImages[currentImageIndex].src;
            }
            
            document.getElementById('nextBtn').onclick = function() {
                currentImageIndex = (currentImageIndex + 1) % tradeImages.length;
                document.getElementById('modalImage').src = tradeImages[currentImageIndex].src;
            }
            
            window.onclick = function(event) {
                const modal = document.getElementById('imageModal');
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            
            document.addEventListener('keydown', function(event) {
                const modal = document.getElementById('imageModal');
                if (modal.style.display === "block") {
                    if (event.key === "Escape") {
                        modal.style.display = "none";
                    } else if (event.key === "ArrowLeft") {
                        currentImageIndex = (currentImageIndex - 1 + tradeImages.length) % tradeImages.length;
                        document.getElementById('modalImage').src = tradeImages[currentImageIndex].src;
                    } else if (event.key === "ArrowRight") {
                        currentImageIndex = (currentImageIndex + 1) % tradeImages.length;
                        document.getElementById('modalImage').src = tradeImages[currentImageIndex].src;
                    }
                }
            });

            // الدردشة مع الذكاء الاصطناعي
            document.getElementById('send-btn')?.addEventListener('click', sendMessage);
            document.getElementById('user-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // إغلاق تفاصيل اليوم
            document.querySelector('.close-details')?.addEventListener('click', function() {
                document.getElementById('day-details').classList.remove('active');
            });
        });
        
        // نظام المصادقة المحسن
        function setupAuth() {
            const authModal = document.getElementById('auth-modal');
            const authEmail = document.getElementById('auth-email');
            const authPassword = document.getElementById('auth-password');
            const authError = document.getElementById('auth-error');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userEmail = document.getElementById('user-email');

            // متابعة حالة المصادقة
            firebase.authFunctions.onAuthStateChanged(firebase.auth, async (user) => {
                if (user && user.email) { // تأكد أن المستخدم مسجل وليس مجهولاً
                    authModal.style.display = 'none';
                    userEmail.textContent = user.email;
                    userEmail.style.display = 'inline';
                    logoutBtn.style.display = 'inline-block';
                    
                    // تحميل بيانات المستخدم الأولية
                    try {
                        const userDoc = await firebase.firestoreFunctions.getDoc(
                            firebase.firestoreFunctions.doc(firebase.db, 'users', user.uid)
                        );
                        
                        if (!userDoc.exists()) {
                            await firebase.firestoreFunctions.setDoc(
                                firebase.firestoreFunctions.doc(firebase.db, 'users', user.uid),
                                {
                                    email: user.email,
                                    initialCapital: 10000,
                                    createdAt: firebase.firestoreFunctions.serverTimestamp()
                                }
                            );
                        } else if (userDoc.data().initialCapital) {
                            initialCapital = userDoc.data().initialCapital;
                        }
                        
                        // تحميل لوحة التحكم بعد التأكد من وجود بيانات المستخدم
                        loadDashboard();
                    } catch (error) {
                        showNotification('حدث خطأ في تحميل بيانات المستخدم', 'error');
                        console.error("Error loading user data:", error);
                    }
                } else {
                    authModal.style.display = 'flex';
                    userEmail.style.display = 'none';
                    logoutBtn.style.display = 'none';
                }
            });

            // تسجيل الدخول
            loginBtn.addEventListener('click', async () => {
                try {
                    await firebase.authFunctions.signInWithEmailAndPassword(
                        firebase.auth,
                        authEmail.value,
                        authPassword.value
                    );
                    authError.textContent = '';
                } catch (error) {
                    authError.textContent = getAuthErrorMessage(error.code);
                    console.error("Login error:", error);
                }
            });

            // تسجيل جديد
            registerBtn.addEventListener('click', async () => {
                try {
                    const userCredential = await firebase.authFunctions.createUserWithEmailAndPassword(
                        firebase.auth,
                        authEmail.value,
                        authPassword.value
                    );
                    
                    // حفظ بيانات المستخدم الأساسية
                    await firebase.firestoreFunctions.setDoc(
                        firebase.firestoreFunctions.doc(firebase.db, 'users', userCredential.user.uid),
                        {
                            email: authEmail.value,
                            initialCapital: 10000,
                            createdAt: firebase.firestoreFunctions.serverTimestamp()
                        }
                    );
                    
                    authError.textContent = '';
                    showNotification('تم إنشاء الحساب بنجاح!', 'success');
                } catch (error) {
                    authError.textContent = getAuthErrorMessage(error.code);
                    console.error("Registration error:", error);
                }
            });

            // تسجيل الخروج
            logoutBtn.addEventListener('click', () => {
                firebase.authFunctions.signOut(firebase.auth);
            });

            // مساعدة: ترجمة أكواد الأخطاء
            function getAuthErrorMessage(code) {
                const messages = {
                    'auth/email-already-in-use': 'البريد الإلكتروني مستخدم بالفعل',
                    'auth/invalid-email': 'بريد إلكتروني غير صالح',
                    'auth/operation-not-allowed': 'عملية غير مسموح بها',
                    'auth/weak-password': 'كلمة المرور ضعيفة (يجب أن تكون 6 أحرف على الأقل)',
                    'auth/user-disabled': 'الحساب معطل',
                    'auth/user-not-found': 'لا يوجد حساب بهذا البريد',
                    'auth/wrong-password': 'كلمة المرور غير صحيحة'
                };
                return messages[code] || 'حدث خطأ غير متوقع';
            }
        }

        // نظام التبويبات
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabHighlight = document.querySelector('.tab-highlight');
            
            // تحديد موضع التظليل الأولي
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && tabHighlight) {
                tabHighlight.style.width = `${activeTab.offsetWidth}px`;
                tabHighlight.style.left = `${activeTab.offsetLeft}px`;
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // تحريك التظليل
                    if (tabHighlight) {
                        tabHighlight.style.width = `${this.offsetWidth}px`;
                        tabHighlight.style.left = `${this.offsetLeft}px`;
                    }
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'dashboard') loadDashboard();
                    if (tabId === 'trades') loadTrades();
                    if (tabId === 'analytics') initCharts();
                    if (tabId === 'calendar') loadCalendar();
                    if (tabId === 'ai') scrollToBottom();
                });
            });
        }

        // إضافة صفقة جديدة - النسخة المحسنة
        async function addTrade() {
            const user = firebase.auth.currentUser;
            if (!user || !user.email) {
                showNotification('يجب تسجيل الدخول بإيميل صالح لإضافة صفقة', 'error');
                return;
            }

            try {
                const amount = parseFloat(document.getElementById('amount').value);
                const size = parseFloat(document.getElementById('size').value);
                const targetRR = parseFloat(document.getElementById('targetRR').value);

                const newTrade = {
                    symbol: document.getElementById('symbol').value,
                    date: document.getElementById('date').value,
                    session: document.getElementById('session').value,
                    type: document.getElementById('type').value,
                    amount: amount,
                    size: size,
                    targetRR: targetRR,
                    image: document.getElementById('image').value || null,
                    notes: document.getElementById('notes').value || null,
                    isProfit: amount >= 0,
                    riskReward: calculateRiskReward(amount, size, targetRR),
                    createdAt: firebase.firestoreFunctions.serverTimestamp()
                };

                // إضافة الصفقة إلى Firestore
                const docRef = await firebase.firestoreFunctions.addDoc(
                    firebase.firestoreFunctions.collection(firebase.db, 'users', user.uid, 'trades'),
                    newTrade
                );

                showNotification('تم حفظ الصفقة بنجاح!', 'success');
                document.getElementById('trade-form').reset();
                document.getElementById('date').valueAsDate = new Date();
                
                // إضافة ID للصفقة المحفوظة حديثاً
                newTrade.id = docRef.id;
                trades.unshift(newTrade);
                
                // تحديث الواجهة دون الحاجة لإعادة تحميل كل البيانات
                updateDashboardStats();
                renderRecentTrades();
                renderAllTrades();
                
            } catch (error) {
                showNotification('حدث خطأ في حفظ الصفقة: ' + error.message, 'danger');
                console.error("Error adding trade:", error);
            }
        }

        // حساب نسبة المخاطرة/العائد
        function calculateRiskReward(amount, size, targetRR) {
            const actualRR = Math.abs(amount) / (size * 100);
            return {
                target: targetRR,
                actual: actualRR.toFixed(2),
                achieved: (actualRR >= targetRR)
            };
        }

        // تحميل لوحة التحكم
        async function loadDashboard() {
            await loadTrades();
            updateDashboardStats();
            
            if (trades.length === 0) {
                document.getElementById('recent-trades').innerHTML = '<p style="text-align: center;">لا توجد صفقات مسجلة بعد</p>';
                return;
            }
            
            // أحدث الصفقات
            renderRecentTrades();
        }

        // تحميل جميع الصفقات - النسخة المحسنة
        async function loadTrades() {
            const user = firebase.auth.currentUser;
            if (!user || !user.email) return;

            showLoading(true);
            
            try {
                const q = firebase.firestoreFunctions.query(
                    firebase.firestoreFunctions.collection(firebase.db, 'users', user.uid, 'trades'),
                    firebase.firestoreFunctions.orderBy('date', 'desc'),
                    firebase.firestoreFunctions.orderBy('createdAt', 'desc')
                );
                
                const querySnapshot = await firebase.firestoreFunctions.getDocs(q);
                
                trades = [];
                querySnapshot.forEach(doc => {
                    const trade = doc.data();
                    trade.id = doc.id;
                    trades.push(trade);
                });
                
                renderAllTrades();
                initCharts();
                
            } catch (error) {
                showNotification('حدث خطأ في تحميل الصفقات: ' + error.message, 'danger');
                console.error("Error loading trades:", error);
            } finally {
                showLoading(false);
            }
        }

        // تحديث إحصائيات لوحة التحكم
        function updateDashboardStats() {
            if (trades.length === 0) {
                document.getElementById('total-trades').textContent = '0';
                document.getElementById('win-rate').textContent = '0%';
                document.getElementById('total-profit').textContent = '$0';
                document.getElementById('total-loss').textContent = '$0';
                document.getElementById('current-capital').textContent = `$${initialCapital.toFixed(2)}`;
                document.getElementById('net-profit').textContent = '$0';
                document.getElementById('roi').textContent = '0%';
                return;
            }

            const totalTrades = trades.length;
            const profitableTrades = trades.filter(t => t.isProfit).length;
            const winRate = ((profitableTrades / totalTrades) * 100).toFixed(1);
            
            const totalProfit = trades.filter(t => t.isProfit).reduce((sum, t) => sum + t.amount, 0);
            const totalLoss = trades.filter(t => !t.isProfit).reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netProfit = totalProfit - totalLoss;
            const currentCapital = initialCapital + netProfit;
            const roi = ((netProfit / initialCapital) * 100).toFixed(2);

            // تحديث واجهة المستخدم
            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('total-profit').textContent = `$${totalProfit.toFixed(2)}`;
            document.getElementById('total-loss').textContent = `$${totalLoss.toFixed(2)}`;
            document.getElementById('current-capital').textContent = `$${currentCapital.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `$${netProfit.toFixed(2)}`;
            document.getElementById('roi').textContent = `${roi}%`;
        }

        // عرض أحدث الصفقات
        function renderRecentTrades() {
            if (!trades.length) return;
            
            const recentTrades = trades.slice(0, 5);
            let html = '';
            
            recentTrades.forEach(trade => {
                html += generateTradeCardHTML(trade);
            });
            
            document.getElementById('recent-trades').innerHTML = html;
        }

        // عرض جميع الصفقات
        function renderAllTrades() {
            if (!trades.length) {
                document.getElementById('all-trades').innerHTML = '<p style="text-align: center;">لا توجد صفقات مسجلة بعد</p>';
                return;
            }
            
            let html = '';
            
            trades.forEach(trade => {
                html += generateTradeCardHTML(trade, true);
            });
            
            document.getElementById('all-trades').innerHTML = html;
        }

        // إنشاء بطاقة صفقة
        function generateTradeCardHTML(trade, showDelete = false) {
            const rrStatus = trade.riskReward.achieved ? 
                `<span style="color: var(--success)"><i class="fas fa-check-circle"></i>` : 
                `<span style="color: var(--danger)"><i class="fas fa-times-circle"></i>`;
            
            const deleteButton = showDelete ? `
                <button onclick="deleteTrade('${trade.id}')" style="padding: 5px 10px; background: var(--danger); border: none; border-radius: 5px; color: white; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            ` : '';
            
            return `
                <div class="trade-card ${trade.isProfit ? 'profit' : 'loss'}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <h3>${trade.symbol} <span style="font-size: 0.8em; color: ${trade.isProfit ? 'var(--success)' : 'var(--danger)'}">
                            (${trade.isProfit ? 'ربح' : 'خسارة'}: $${Math.abs(trade.amount).toFixed(2)})
                        </span></h3>
                        <div>
                            <span style="font-size: 0.9em; opacity: 0.7; margin-right: 10px;">${formatDate(trade.date)}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div><i class="fas fa-exchange-alt"></i> ${trade.type === 'buy' ? 'شراء' : 'بيع'} (${trade.session})</div>
                        <div><i class="fas fa-money-bill-wave"></i> حجم: ${trade.size.toFixed(2)} لوت</div>
                        <div><i class="fas fa-bullseye"></i> Target R:R: ${trade.targetRR} ${rrStatus}</span></div>
                        ${showDelete ? `<div><i class="fas fa-robot"></i> Actual R:R: ${trade.riskReward.actual}</div>` : ''}
                    </div>
                    ${trade.notes ? `<div style="margin-top: 10px;"><i class="fas fa-sticky-note"></i> ${trade.notes}</div>` : ''}
                    
                    <button class="show-details-btn" onclick="toggleDetails(this)">
                        <i class="fas fa-chevron-down"></i> عرض التفاصيل
                    </button>
                    
                    <div class="trade-details">
                        ${trade.image ? `
                            <div style="margin-top: 10px;">
                                <img src="${trade.image}" class="trade-image" onclick="openImageModal(this)">
                            </div>
                        ` : ''}
                    </div>

                    <div class="trade-actions">
                        <button class="analyze-btn" onclick="analyzeTrade('${trade.id}')">
                            <i class="fas fa-robot"></i> تحليل بالذكاء الاصطناعي
                        </button>
                    </div>
                </div>
            `;
        }

        // تبديل عرض التفاصيل
        function toggleDetails(button) {
            const details = button.nextElementSibling;
            details.classList.toggle('active');
            
            const icon = button.querySelector('i');
            if (details.classList.contains('active')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                button.textContent = button.textContent.replace('عرض', 'إخفاء');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                button.textContent = button.textContent.replace('إخفاء', 'عرض');
            }
        }

        // فتح معاينة الصورة
        function openImageModal(imgElement) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            // جمع جميع صور الصفقات
            tradeImages = Array.from(document.querySelectorAll('.trade-image'));
            currentImageIndex = tradeImages.indexOf(imgElement);
            
            modal.style.display = "block";
            modalImg.src = imgElement.src;
        }

        // تحميل التقويم
        function loadCalendar() {
            const calendarDays = document.getElementById('calendar-days');
            const calendarTitle = document.getElementById('calendar-title');
            
            // تحديث عنوان التقويم
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                              "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            calendarTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // حساب أول يوم من الشهر
            const firstDay = new Date(currentYear, currentMonth, 1);
            // حساب آخر يوم من الشهر
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            // حساب عدد الأيام في الشهر
            const daysInMonth = lastDay.getDate();
            // حساب يوم الأسبوع لأول يوم في الشهر (0-6 حيث 0 هو الأحد)
            const startingDay = firstDay.getDay();
            
            // مسح التقويم الحالي
            calendarDays.innerHTML = '';
            
            // إضافة أيام فارغة لمواءمة بداية الشهر
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarDays.appendChild(emptyDay);
            }
            
            // إضافة أيام الشهر
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.innerHTML = `<div class="calendar-day-number">${i}</div>`;
                
                // البحث عن الصفقات لهذا اليوم
                const currentDate = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                const dayTrades = trades.filter(trade => trade.date === currentDate);
                
                // إضافة مؤشرات الصفقات
                if (dayTrades.length > 0) {
                    const tradesContainer = document.createElement('div');
                    tradesContainer.classList.add('calendar-day-trades');
                    
                    dayTrades.forEach(trade => {
                        const indicator = document.createElement('div');
                        indicator.classList.add('trade-indicator', trade.isProfit ? 'profit' : 'loss');
                        tradesContainer.appendChild(indicator);
                    });
                    
                    dayElement.appendChild(tradesContainer);
                    
                    // إضافة حدث النقر لعرض التفاصيل
                    dayElement.addEventListener('click', () => showDayTrades(currentDate));
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        // عرض صفقات يوم معين
        function showDayTrades(date) {
            const dayTrades = trades.filter(trade => trade.date === date);
            const dayDetails = document.getElementById('day-details');
            const dayTradesContainer = document.getElementById('day-trades');
            const dayDetailsTitle = document.getElementById('day-details-title');
            
            if (dayTrades.length === 0) return;
            
            // تحديث العنوان
            const formattedDate = formatDate(date);
            dayDetailsTitle.textContent = `صفقات ${formattedDate}`;
            
            // عرض الصفقات
            let html = '';
            dayTrades.forEach(trade => {
                html += generateTradeCardHTML(trade);
            });
            
            dayTradesContainer.innerHTML = html;
            dayDetails.classList.add('active');
        }

        // تهيئة المخططات
        function initCharts() {
            if (trades.length === 0) return;
            
            // تدمير المخططات القديمة إذا كانت موجودة
            if (sessionChart) sessionChart.destroy();
            if (typeChart) typeChart.destroy();
            if (capitalChart) capitalChart.destroy();
            
            // تحليل البيانات
            const sessions = ['london', 'new-york', 'tokyo', 'sydney', 'other'];
            const sessionLabels = ['لندن', 'نيويورك', 'طوكيو', 'سيدني', 'أخرى'];
            
            const sessionProfits = sessions.map(session => {
                const sessionTrades = trades.filter(t => t.session === session && t.isProfit);
                return sessionTrades.reduce((sum, t) => sum + t.amount, 0);
            });
            
            const sessionLosses = sessions.map(session => {
                const sessionTrades = trades.filter(t => t.session === session && !t.isProfit);
                return sessionTrades.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            });
            
            // مخطط أداء الصفقات حسب الجلسة
            const sessionCtx = document.getElementById('sessionChart').getContext('2d');
            sessionChart = new Chart(sessionCtx, {
                type: 'bar',
                data: {
                    labels: sessionLabels,
                    datasets: [
                        {
                            label: 'الأرباح',
                            data: sessionProfits,
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'الخسائر',
                            data: sessionLosses,
                            backgroundColor: 'rgba(244, 67, 54, 0.7)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'المبلغ ($)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    }
                }
            });
            
            // مخطط توزيع الصفقات حسب النوع
            const buyTrades = trades.filter(t => t.type === 'buy');
            const sellTrades = trades.filter(t => t.type === 'sell');
            
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            typeChart = new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: ['صفقات شراء', 'صفقات بيع'],
                    datasets: [{
                        data: [buyTrades.length, sellTrades.length],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    }
                }
            });
            
            // مخطط تطور رأس المال
            const capitalData = calculateCapitalOverTime();
            const capitalCtx = document.getElementById('capitalChart').getContext('2d');
            capitalChart = new Chart(capitalCtx, {
                type: 'line',
                data: {
                    labels: capitalData.dates,
                    datasets: [{
                        label: 'رأس المال',
                        data: capitalData.capital,
                        backgroundColor: 'rgba(96, 125, 139, 0.2)',
                        borderColor: 'rgba(96, 125, 139, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'رأس المال ($)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    }
                }
            });
        }

        // حساب تطور رأس المال مع الوقت
        function calculateCapitalOverTime() {
            if (trades.length === 0) return { dates: [], capital: [] };
            
            // فرز الصفقات حسب التاريخ
            const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const dates = [];
            const capital = [];
            let currentCapital = initialCapital;
            
            // إضافة نقطة البداية
            dates.push(formatDate(sortedTrades[0].date, true));
            capital.push(currentCapital);
            
            sortedTrades.forEach(trade => {
                currentCapital += trade.isProfit ? trade.amount : -Math.abs(trade.amount);
                dates.push(formatDate(trade.date, true));
                capital.push(currentCapital);
            });
            
            return { dates, capital };
        }

        // حذف صفقة
        async function deleteTrade(id) {
            if (!confirm('هل أنت متأكد من حذف هذه الصفقة؟')) return;
            
            const user = firebase.auth.currentUser;
            if (!user) return;
            
            try {
                await firebase.firestoreFunctions.deleteDoc(
                    firebase.firestoreFunctions.doc(firebase.db, 'users', user.uid, 'trades', id)
                );
                
                // تحديث القائمة المحلية
                trades = trades.filter(trade => trade.id !== id);
                
                showNotification('تم حذف الصفقة بنجاح', 'success');
                updateDashboardStats();
                renderRecentTrades();
                renderAllTrades();
                initCharts();
            } catch (error) {
                showNotification('حدث خطأ في حذف الصفقة: ' + error.message, 'danger');
                console.error("Error deleting trade:", error);
            }
        }

        // تحليل الصفقة بالذكاء الاصطناعي
        async function analyzeTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;
            
            // عرض تبويب الذكاء الاصطناعي
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab[data-tab="ai"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('ai').classList.add('active');
            
            // تحريك التظليل
            const tabHighlight = document.querySelector('.tab-highlight');
            const activeTab = document.querySelector('.tab.active');
            tabHighlight.style.width = `${activeTab.offsetWidth}px`;
            tabHighlight.style.left = `${activeTab.offsetLeft}px`;
            
            // عرض رسالة في الدردشة
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message ai-message">
                    أقوم بتحليل الصفقة المحددة، يرجى الانتظار...
                </div>
            `;
            
            // عرض نتائج التحليل
            const analysisResults = document.getElementById('ai-analysis-results');
            analysisResults.innerHTML = `
                <div class="ai-analysis-card">
                    <div class="ai-analysis-header">
                        <i class="fas fa-robot"></i>
                        <h3>تحليل الصفقة #${tradeId}</h3>
                    </div>
                    <div id="trade-analysis-content">
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const user = firebase.auth.currentUser;
                if (user) {
                    // جلب تحليل محفوظ إذا كان موجوداً
                    const analysisDoc = await firebase.firestoreFunctions.getDoc(
                        firebase.firestoreFunctions.doc(firebase.db, 'users', user.uid, 'tradeAnalysis', tradeId)
                    );
                    
                    if (analysisDoc.exists()) {
                        document.getElementById('trade-analysis-content').innerHTML = analysisDoc.data().analysis;
                    } else {
                        // إنشاء تحليل جديد وحفظه
                        const analysis = generateTradeAnalysis(trade);
                        document.getElementById('trade-analysis-content').innerHTML = analysis;
                        
                        await firebase.firestoreFunctions.setDoc(
                            firebase.firestoreFunctions.doc(firebase.db, 'users', user.uid, 'tradeAnalysis', tradeId),
                            {
                                analysis,
                                createdAt: firebase.firestoreFunctions.serverTimestamp()
                            }
                        );
                    }
                } else {
                    document.getElementById('trade-analysis-content').innerHTML = generateTradeAnalysis(trade);
                }
                
                // إضافة رسالة الدردشة
                addMessage(`لقد قمت بتحليل الصفقة #${tradeId}. إليك النتائج الرئيسية:\n\n${generateTradeSummary(trade)}`, 'ai');
            } catch (error) {
                document.getElementById('trade-analysis-content').innerHTML = generateTradeAnalysis(trade);
                showNotification('حدث خطأ في تحليل الصفقة: ' + error.message, 'danger');
                console.error("Error analyzing trade:", error);
            }
        }

        // إنشاء تحليل الصفقة
        function generateTradeAnalysis(trade) {
            const insights = getTradeInsights(trade);
            
            return `
                <div class="ai-analysis-content">
                    <h4>ملخص الصفقة</h4>
                    <p>${generateTradeSummary(trade)}</p>
                    
                    <h4>نقاط القوة</h4>
                    <ul>
                        ${insights.strengths.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                    
                    <h4>نقاط الضعف</h4>
                    <ul>
                        ${insights.weaknesses.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                    
                    <h4>نصائح للتحسين</h4>
                    <ul>
                        ${insights.improvements.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                    
                    <h4>التقييم العام</h4>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${insights.score >= 7 ? 'var(--success)' : insights.score >= 4 ? 'var(--warning)' : 'var(--danger)'}">
                            ${insights.score}/10
                        </div>
                        <div>
                            ${insights.score >= 7 ? 'صفقة ممتازة' : insights.score >= 4 ? 'صفقة متوسطة' : 'صفقة ضعيفة'}
                        </div>
                    </div>
                </div>
            `;
        }

        // إنشاء ملخص الصفقة
        function generateTradeSummary(trade) {
            return `
                قمت ب${trade.type === 'buy' ? 'شراء' : 'بيع'} ${trade.symbol} خلال جلسة ${getSessionName(trade.session)} 
                بحجم ${trade.size} لوت. الصفقة كانت ${trade.isProfit ? 'ربحية' : 'خاسرة'} بمبلغ $${Math.abs(trade.amount)}. 
                نسبة المخاطرة/العائد المستهدفة كانت ${trade.targetRR}:1 بينما النسبة الفعلية كانت ${trade.riskReward.actual}:1.
            `;
        }

        // الحصول على اسم الجلسة
        function getSessionName(session) {
            const sessions = {
                'london': 'لندن',
                'new-york': 'نيويورك',
                'tokyo': 'طوكيو',
                'sydney': 'سيدني',
                'other': 'أخرى'
            };
            return sessions[session] || session;
        }

        // الحصول على رؤى الصفقة
        function getTradeInsights(trade) {
            const strengths = [];
            const weaknesses = [];
            const improvements = [];
            let score = 5; // متوسط
            
            // تحليل نسبة المخاطرة/العائد
            if (trade.riskReward.achieved) {
                strengths.push(`حقق نسبة مخاطرة/عائد جيدة (${trade.riskReward.actual}:1) مقارنة بالهدف (${trade.targetRR}:1)`);
                score += 2;
            } else {
                weaknesses.push(`لم تحقق نسبة مخاطرة/عائد المستهدفة (${trade.riskReward.actual}:1 مقارنة بـ ${trade.targetRR}:1)`);
                score -= 1;
                improvements.push(`حاول تحسين نقاط الدخول لتحقيق نسبة مخاطرة/عائد أفضل`);
            }
            
            // تحليل حجم الصفقة
            if (trade.size <= 1) {
                strengths.push(`حجم الصفقة معقول (${trade.size} لوت) مما يدل على إدارة مخاطر جيدة`);
                score += 1;
            } else {
                weaknesses.push(`حجم الصفقة كبير (${trade.size} لوت) مما يزيد المخاطر`);
                score -= 1;
                improvements.push(`فكر في تقليل حجم الصفقة لإدارة أفضل للمخاطر`);
            }
            
            // تحليل الربح/الخسارة
            if (trade.isProfit) {
                strengths.push(`الصفقة حققت ربحاً جيداً بمبلغ $${trade.amount}`);
                score += 1;
            } else {
                weaknesses.push(`الصفقة خاسرة بمبلغ $${Math.abs(trade.amount)}`);
                score -= 1;
                improvements.push(`راجع استراتيجيتك لتفادي تكرار مثل هذه الخسائر`);
            }
            
            // نصائح عامة
            improvements.push(`حافظ على نسبة مخاطرة لا تزيد عن 1-2% من رأس مالك في كل صفقة`);
            improvements.push(`استخدم وقف الخسارة المتحرك لحماية الأرباح`);
            
            // ضبط النتيجة بين 0 و 10
            score = Math.max(0, Math.min(10, score));
            
            return { strengths, weaknesses, improvements, score };
        }

        // إرسال رسالة إلى الذكاء الاصطناعي
        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // إضافة رسالة المستخدم
            addMessage(message, 'user');
            
            // مسح حقل الإدخال
            input.value = '';
            
            // إظهار رد الذكاء الاصطناعي
            setTimeout(() => {
                const responses = [
                    "أنا هنا لمساعدتك في تحليل صفقاتك وتقديم النصائح. هل لديك أي صفقة محددة تريد تحليلها؟",
                    "يمكنك مشاركة تفاصيل صفقتك وسأساعدك في تحليلها وتقديم التوصيات.",
                    "لتحسين أدائك، أنصحك بالتركيز على جلسات التداول التي تحقق لك أفضل النتائج.",
                    "تذكر أن إدارة المخاطر هي المفتاح للنجاح في التداول على المدى الطويل.",
                    "يمكنك النقر على أي صفقة ثم اختيار 'تحليل بالذكاء الاصطناعي' للحصول على تحليل مفصل."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'ai');
            }, 1000);
        }

        // إضافة رسالة إلى الدردشة
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            messageElement.textContent = text;
            
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }

        // التمرير إلى أسفل الدردشة
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // تنسيق التاريخ
        function formatDate(dateString, short = false) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const options = short ? { day: 'numeric', month: 'short' } : { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('ar-EG', options);
        }

        // عرض إشعار
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // إظهار/إخفاء مؤشر التحميل
        function showLoading(show) {
            const loaders = document.querySelectorAll('.loader');
            const contents = document.querySelectorAll('#recent-trades, #all-trades');
            
            loaders.forEach(loader => {
                loader.style.display = show ? 'block' : 'none';
            });
            
            contents.forEach(content => {
                content.style.display = show ? 'none' : 'block';
                if (show) {
                    content.innerHTML = '<div class="loader"></div>';
                }
            });
        }
    </script>
</body>
</html>
