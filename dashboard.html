<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA Dashboard | Data-Driven Trading Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .auth-message {
            font-size: 16px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 300px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
            width: 100%;
            max-width: 250px;
        }

        .auth-btn {
            padding: 14px 20px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .auth-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .mobile-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit;
            text-align: left;
        }

        .mobile-menu-item.primary {
            background-color: var(--notion-green);
            color: white;
        }

        .mobile-menu-item.blue {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Main Container */
        .main-container {
            margin: 50px 0 0 0;
            padding: 0;
            width: 100%;
        }

        /* Page Header */
        .page-header {
            padding: 20px 16px;
            background: linear-gradient(135deg, var(--notion-green-light), var(--notion-blue-light));
            margin-bottom: 0;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--notion-text);
            line-height: 1.3;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Today's Stats */
        .todays-stats {
            padding: 16px;
            background-color: white;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            padding: 16px;
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            text-align: center;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 16px;
        }

        .stat-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .stat-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .stat-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .stat-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.positive {
            color: var(--notion-green);
        }

        .stat-value.negative {
            color: var(--notion-red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--notion-green);
        }

        .stat-change.negative {
            color: var(--notion-red);
        }

        /* Dashboard Sections */
        .dashboard-section {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action {
            font-size: 13px;
            color: var(--notion-blue);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        /* Performance Chart */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 16px;
        }

        /* Recent Trades */
        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th {
            text-align: left;
            padding: 12px 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            font-weight: 500;
            border-bottom: 1px solid var(--notion-gray-dark);
            background-color: var(--notion-gray-light);
        }

        .trades-table td {
            padding: 12px 8px;
            font-size: 14px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .trade-result {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }

        .trade-result.win {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .trade-result.loss {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .trade-result.break-even {
            background-color: var(--notion-gray);
            color: var(--notion-text-light);
        }

        /* Daily Plan */
        .daily-plan-card {
            background-color: var(--notion-blue-light);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .plan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .plan-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-blue);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .plan-progress {
            font-size: 12px;
            color: var(--notion-text-light);
            font-weight: 500;
        }

        .plan-items {
            list-style: none;
            padding: 0;
        }

        .plan-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(12, 140, 233, 0.1);
        }

        .plan-item:last-child {
            border-bottom: none;
        }

        .plan-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--notion-blue);
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .plan-checkbox.checked {
            background-color: var(--notion-blue);
            color: white;
        }

        .plan-checkbox.checked i {
            font-size: 12px;
        }

        .plan-text {
            font-size: 14px;
            color: var(--notion-text);
            flex: 1;
        }

        .plan-text.completed {
            text-decoration: line-through;
            color: var(--notion-text-light);
        }

        /* Quick Actions */
        .quick-actions {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-btn {
            padding: 16px;
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .action-btn i {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .action-btn.green i {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .action-btn.blue i {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .action-btn.purple i {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .action-btn.orange i {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .action-label {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .action-description {
            font-size: 11px;
            color: var(--notion-text-light);
            text-align: center;
        }

        /* Insights */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insight-item {
            padding: 12px;
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .insight-icon.success {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .insight-icon.warning {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .insight-icon.info {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .insight-content {
            flex: 1;
        }

        .insight-text {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .insight-time {
            font-size: 11px;
            color: var(--notion-text-light);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--notion-text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--notion-gray-dark);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--notion-text);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--notion-text-light);
            flex-direction: column;
            gap: 16px;
        }

        .loading i {
            animation: spin 1s linear infinite;
            font-size: 32px;
        }

        .loading-text {
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--notion-green);
            background-color: var(--notion-green-light);
        }

        .bottom-nav-btn i {
            font-size: 18px;
        }

        /* Mobile Optimizations */
        @media (max-width: 360px) {
            .stats-grid,
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .trades-table {
                font-size: 12px;
            }
            
            .trades-table th,
            .trades-table td {
                padding: 8px 4px;
            }
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-container {
                margin: 0;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .page-header {
                border-radius: 12px 12px 0 0;
                margin-bottom: 0;
            }
            
            .todays-stats {
                border-radius: 0;
            }
            
            .dashboard-section {
                border-radius: 0;
            }
            
            .dashboard-section:last-child {
                border-radius: 0 0 12px 12px;
                border-bottom: none;
            }
            
            .quick-actions {
                border-radius: 12px;
                margin-top: 20px;
            }
            
            .actions-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Prevent horizontal scroll */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Better touch targets */
        button,
        select,
        .mobile-menu-item,
        .action-btn {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Prevent text selection on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Loading dashboard...</div>
        <div class="auth-buttons" id="authButtons" style="display: none;">
            <button class="auth-btn primary" id="goToLoginBtn">Go to Login Page</button>
        </div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header-title">DTA Dashboard</div>
        </div>
        <button class="mobile-menu-btn" id="mobileRefreshBtn">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="analysis.html" class="mobile-menu-item">
            <i class="fas fa-chart-line"></i>
            Advanced Analysis
        </a>
        <a href="journal.html" class="mobile-menu-item">
            <i class="fas fa-book"></i>
            Trading Journal
        </a>
        <a href="plan.html" class="mobile-menu-item blue">
            <i class="fas fa-clipboard-list"></i>
            Trading Plan
        </a>
        <button class="mobile-menu-item primary" id="mobileAddTradeBtn">
            <i class="fas fa-plus-circle"></i>
            Add New Trade
        </button>
        <button class="mobile-menu-item" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="greetingTitle">ðŸ“Š Good Morning</h1>
            <p class="page-subtitle" id="greetingSubtitle">Welcome back! Here's your trading day at a glance</p>
        </div>

        <!-- Today's Stats -->
        <div class="todays-stats" id="todaysStats">
            <div class="loading" id="statsLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Loading today's stats...</div>
            </div>
            <div id="statsContent" style="display: none;">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Daily Plan -->
        <div class="dashboard-section" id="dailyPlanSection">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Today's Trading Plan</span>
                </div>
                <a href="plan.html" class="section-action">
                    Edit Plan
                    <i class="fas fa-edit"></i>
                </a>
            </div>
            <div class="daily-plan-card" id="dailyPlanCard">
                <div class="plan-header">
                    <div class="plan-title">
                        <i class="fas fa-calendar-day"></i>
                        Daily Checklist
                    </div>
                    <div class="plan-progress" id="planProgress">0/0 completed</div>
                </div>
                <ul class="plan-items" id="dailyPlanItems">
                    <!-- Plan items will be populated by JavaScript -->
                </ul>
            </div>
        </div>

        <!-- Performance Overview -->
        <div class="dashboard-section" id="performanceSection">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <span>Weekly Performance</span>
                </div>
                <a href="analysis.html" class="section-action">
                    View Details
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="dashboard-section" id="recentTradesSection">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    <span>Recent Trades</span>
                </div>
                <a href="journal.html" class="section-action">
                    View All
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="loading" id="tradesLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Loading recent trades...</div>
            </div>
            <div id="tradesContent" style="display: none;">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pair</th>
                            <th>Result</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody id="recentTradesTable">
                        <!-- Trades will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Insights -->
        <div class="dashboard-section" id="insightsSection">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-lightbulb"></i>
                    <span>Quick Insights</span>
                </div>
            </div>
            <div class="loading" id="insightsLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Generating insights...</div>
            </div>
            <ul class="insights-list" id="insightsList" style="display: none;">
                <!-- Insights will be populated by JavaScript -->
            </ul>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-bolt"></i>
                    <span>Quick Actions</span>
                </div>
            </div>
            <div class="actions-grid">
                <a href="add-trade.html" class="action-btn green">
                    <i class="fas fa-plus-circle"></i>
                    <div class="action-label">Add Trade</div>
                    <div class="action-description">Record a new trade</div>
                </a>
                <a href="analysis.html" class="action-btn blue">
                    <i class="fas fa-chart-line"></i>
                    <div class="action-label">Run Analysis</div>
                    <div class="action-description">Detailed analytics</div>
                </a>
                <a href="plan.html" class="action-btn purple">
                    <i class="fas fa-clipboard-list"></i>
                    <div class="action-label">Trading Plan</div>
                    <div class="action-description">Daily checklist</div>
                </a>
                <a href="#" class="action-btn orange" id="exportDataBtn">
                    <i class="fas fa-download"></i>
                    <div class="action-label">Export Data</div>
                    <div class="action-description">Download CSV</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn active">
            <i class="fas fa-home"></i>
            Dashboard
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='journal.html'">
            <i class="fas fa-book"></i>
            Journal
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='plan.html'">
            <i class="fas fa-clipboard-list"></i>
            Plan
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='settings.html'">
            <i class="fas fa-cog"></i>
            Settings
        </button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let userTrades = [];
        let dailyPlan = [];
        let performanceChart = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
            updateGreeting();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobileRefreshBtn').addEventListener('click', loadDashboardData);
            document.getElementById('mobileAddTradeBtn').addEventListener('click', () => {
                window.location.href = 'add-trade.html';
            });
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);
            
            // Export button
            document.getElementById('exportDataBtn').addEventListener('click', exportDashboardData);
            
            // Auth button
            document.getElementById('goToLoginBtn')?.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }

        // Update Greeting
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = "Good ";
            
            if (hour < 12) greeting = "Good Morning";
            else if (hour < 18) greeting = "Good Afternoon";
            else greeting = "Good Evening";
            
            document.getElementById('greetingTitle').textContent = `ðŸ“Š ${greeting}`;
        }

        // Check Authentication
        function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            const authButtons = document.getElementById('authButtons');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    await initializeDashboard();
                    authOverlay.classList.add('hidden');
                } else {
                    // No user signed in
                    authMessage.textContent = 'You need to sign in to access the dashboard';
                    authButtons.style.display = 'flex';
                    
                    // Auto-redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            });
        }

        // Initialize Dashboard
        async function initializeDashboard() {
            if (!currentUser) return;
            
            // Update user greeting
            updateUserGreeting();
            
            // Load dashboard data
            await loadDashboardData();
        }

        // Update User Greeting
        function updateUserGreeting() {
            const userName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader';
            const timeOfDay = getTimeOfDay();
            
            document.getElementById('greetingSubtitle').textContent = 
                `Welcome back, ${userName}! Here's your trading ${timeOfDay} at a glance`;
        }

        // Get Time of Day
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            return 'evening';
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                // Show loading states
                document.getElementById('statsLoading').style.display = 'flex';
                document.getElementById('statsContent').style.display = 'none';
                document.getElementById('tradesLoading').style.display = 'flex';
                document.getElementById('tradesContent').style.display = 'none';
                document.getElementById('insightsLoading').style.display = 'flex';
                document.getElementById('insightsList').style.display = 'none';
                
                // Load user trades
                const tradesSnapshot = await database.ref('userTrades/' + currentUser.uid + '/trades').once('value');
                userTrades = [];
                
                tradesSnapshot.forEach((childSnapshot) => {
                    const trade = childSnapshot.val();
                    trade.id = childSnapshot.key;
                    userTrades.push(trade);
                });

                // Sort by date (newest first)
                userTrades.sort((a, b) => {
                    const dateA = a.createdAt || a.date || 0;
                    const dateB = b.createdAt || b.date || 0;
                    return dateB - dateA;
                });

                // Load daily plan
                await loadDailyPlan();

                // Update dashboard sections
                updateTodaysStats();
                updateDailyPlan();
                updateRecentTrades();
                updateQuickInsights();
                updatePerformanceChart();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data. Please check your connection and try again.');
            }
        }

        // Load Daily Plan
        async function loadDailyPlan() {
            try {
                const today = new Date().toDateString();
                const planRef = database.ref('dailyPlans/' + currentUser.uid + '/' + today);
                
                const snapshot = await planRef.once('value');
                if (snapshot.exists()) {
                    dailyPlan = snapshot.val();
                } else {
                    // Create default plan if none exists
                    dailyPlan = getDefaultDailyPlan();
                    await planRef.set(dailyPlan);
                }
            } catch (error) {
                console.error('Error loading daily plan:', error);
                dailyPlan = getDefaultDailyPlan();
            }
        }

        // Get Default Daily Plan
        function getDefaultDailyPlan() {
            const today = new Date().toDateString();
            return {
                date: today,
                completed: 0,
                total: 5,
                items: [
                    { id: 1, text: "Review economic calendar and news", completed: false, category: "pre-market" },
                    { id: 2, text: "Analyze key support/resistance levels", completed: false, category: "pre-market" },
                    { id: 3, text: "Set daily risk limit (max 2%)", completed: false, category: "risk" },
                    { id: 4, text: "Wait for confirmed setups only", completed: false, category: "execution" },
                    { id: 5, text: "Review trades and journal entries", completed: false, category: "post-market" }
                ]
            };
        }

        // Update Today's Stats
        function updateTodaysStats() {
            if (userTrades.length === 0) {
                showEmptyStats();
                return;
            }
            
            const stats = calculateTodayStats();
            
            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value ${stats.todayPL >= 0 ? 'positive' : 'negative'}">
                            ${stats.todayPL >= 0 ? '+' : ''}$${Math.abs(stats.todayPL).toFixed(0)}
                        </div>
                        <div class="stat-label">Today's P/L</div>
                        <div class="stat-change ${stats.dailyChange >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${stats.dailyChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(stats.dailyChange)}% vs target
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value ${stats.winRate >= 50 ? 'positive' : 'negative'}">
                            ${stats.winRate.toFixed(0)}%
                        </div>
                        <div class="stat-label">Today's Win Rate</div>
                        <div class="stat-change ${stats.winRate >= 50 ? 'positive' : 'negative'}">
                            <i class="fas fa-${stats.winRate >= 50 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${stats.todayTrades} trades
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="stat-value">${stats.planProgress}%</div>
                        <div class="stat-label">Plan Progress</div>
                        <div class="stat-change positive">
                            <i class="fas fa-check-circle"></i>
                            ${dailyPlan.completed}/${dailyPlan.total} items
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="stat-value">${stats.riskUsed.toFixed(1)}%</div>
                        <div class="stat-label">Risk Used Today</div>
                        <div class="stat-change ${stats.riskUsed <= 2 ? 'positive' : 'negative'}">
                            <i class="fas fa-${stats.riskUsed <= 2 ? 'check' : 'exclamation'}"></i>
                            ${stats.riskUsed <= 2 ? 'Within limit' : 'Over limit'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsLoading').style.display = 'none';
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statsContent').style.display = 'block';
        }

        // Calculate Today's Stats
        function calculateTodayStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayTrades = userTrades.filter(trade => {
                const tradeDate = new Date(trade.date || trade.createdAt || 0);
                return tradeDate >= today;
            });
            
            const todayWins = todayTrades.filter(t => t.result === 'Win').length;
            const todayWinRate = todayTrades.length > 0 ? (todayWins / todayTrades.length) * 100 : 0;
            const todayPL = todayTrades.reduce((sum, trade) => sum + (trade.pl || 0), 0);
            
            const totalRisk = todayTrades.reduce((sum, trade) => {
                return sum + (trade.riskPercent || 0);
            }, 0);
            
            const planProgress = dailyPlan.total > 0 ? (dailyPlan.completed / dailyPlan.total) * 100 : 0;
            
            // Calculate daily change vs target (simplified)
            const dailyTarget = 100; // $100 daily target
            const dailyChange = dailyTarget > 0 ? ((todayPL - dailyTarget) / dailyTarget) * 100 : 0;
            
            return {
                todayTrades: todayTrades.length,
                todayWins,
                todayWinRate,
                todayPL,
                dailyChange: Math.round(dailyChange),
                planProgress: Math.round(planProgress),
                riskUsed: totalRisk
            };
        }

        // Show Empty Stats
        function showEmptyStats() {
            const statsHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="empty-state-title">Ready to Trade?</div>
                    <div class="empty-state-text">
                        Start your trading day by reviewing your plan and adding trades.
                    </div>
                    <a href="plan.html" class="mobile-menu-item primary" style="margin-top: 16px; text-align: center;">
                        <i class="fas fa-clipboard-list"></i>
                        Review Trading Plan
                    </a>
                </div>
            `;
            
            document.getElementById('statsLoading').style.display = 'none';
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statsContent').style.display = 'block';
        }

        // Update Daily Plan
        function updateDailyPlan() {
            const planItemsContainer = document.getElementById('dailyPlanItems');
            const progressElement = document.getElementById('planProgress');
            
            if (!dailyPlan.items || dailyPlan.items.length === 0) {
                dailyPlan = getDefaultDailyPlan();
            }
            
            let completedCount = 0;
            let planHTML = '';
            
            dailyPlan.items.forEach(item => {
                if (item.completed) completedCount++;
                
                planHTML += `
                    <li class="plan-item">
                        <div class="plan-checkbox ${item.completed ? 'checked' : ''}" 
                             data-item-id="${item.id}"
                             onclick="togglePlanItem(${item.id})">
                            ${item.completed ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                        <div class="plan-text ${item.completed ? 'completed' : ''}">
                            ${item.text}
                        </div>
                    </li>
                `;
            });
            
            planItemsContainer.innerHTML = planHTML;
            progressElement.textContent = `${completedCount}/${dailyPlan.items.length} completed`;
            
            // Update completed count in plan object
            dailyPlan.completed = completedCount;
            dailyPlan.total = dailyPlan.items.length;
            
            // Save updated plan
            saveDailyPlan();
        }

        // Toggle Plan Item
        async function togglePlanItem(itemId) {
            const item = dailyPlan.items.find(item => item.id === itemId);
            if (item) {
                item.completed = !item.completed;
                updateDailyPlan();
            }
        }

        // Save Daily Plan
        async function saveDailyPlan() {
            try {
                const today = new Date().toDateString();
                const planRef = database.ref('dailyPlans/' + currentUser.uid + '/' + today);
                await planRef.set(dailyPlan);
            } catch (error) {
                console.error('Error saving daily plan:', error);
            }
        }

        // Update Recent Trades
        function updateRecentTrades() {
            if (userTrades.length === 0) {
                document.getElementById('tradesLoading').style.display = 'none';
                document.getElementById('recentTradesTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px 20px; color: var(--notion-text-light);">
                            No trades recorded yet. <a href="add-trade.html" style="color: var(--notion-blue);">Add your first trade</a>
                        </td>
                    </tr>
                `;
                document.getElementById('tradesContent').style.display = 'block';
                return;
            }
            
            const recentTrades = userTrades.slice(0, 5);
            
            let tableHTML = '';
            recentTrades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const pl = trade.pl || 0;
                const plFormatted = pl >= 0 ? `+$${pl.toFixed(0)}` : `-$${Math.abs(pl).toFixed(0)}`;
                
                tableHTML += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${trade.pair || 'N/A'}</td>
                        <td>
                            <span class="trade-result ${trade.result?.toLowerCase().replace(' ', '-') || ''}">
                                ${trade.result || 'N/A'}
                            </span>
                        </td>
                        <td style="color: ${pl >= 0 ? 'var(--notion-green)' : 'var(--notion-red)'}; font-weight: 500;">
                            ${plFormatted}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('tradesLoading').style.display = 'none';
            document.getElementById('recentTradesTable').innerHTML = tableHTML;
            document.getElementById('tradesContent').style.display = 'block';
        }

        // Update Quick Insights
        function updateQuickInsights() {
            if (userTrades.length === 0) {
                document.getElementById('insightsLoading').style.display = 'none';
                document.getElementById('insightsList').innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-state-text">
                            Add trades to get personalized insights and recommendations.
                        </div>
                    </div>
                `;
                document.getElementById('insightsList').style.display = 'block';
                return;
            }
            
            const insights = generateQuickInsights();
            
            let insightsHTML = '';
            insights.forEach(insight => {
                insightsHTML += `
                    <li class="insight-item">
                        <div class="insight-icon ${insight.type}">
                            <i class="fas fa-${insight.icon}"></i>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">${insight.text}</div>
                            <div class="insight-time">${insight.time}</div>
                        </div>
                    </li>
                `;
            });
            
            document.getElementById('insightsLoading').style.display = 'none';
            document.getElementById('insightsList').innerHTML = insightsHTML;
            document.getElementById('insightsList').style.display = 'block';
        }

        // Generate Quick Insights
        function generateQuickInsights() {
            const insights = [];
            const stats = calculateTodayStats();
            
            // Plan progress insight
            if (dailyPlan.completed >= dailyPlan.total) {
                insights.push({
                    type: 'success',
                    icon: 'trophy',
                    text: 'Excellent! You completed all your daily plan items.',
                    time: 'Today'
                });
            } else if (dailyPlan.completed === 0) {
                insights.push({
                    type: 'warning',
                    icon: 'clipboard-list',
                    text: 'Start your trading day by reviewing your daily plan.',
                    time: 'Action needed'
                });
            }
            
            // Today's performance insight
            if (stats.todayPL > 0) {
                insights.push({
                    type: 'success',
                    icon: 'chart-line',
                    text: `Great start! You're up $${stats.todayPL.toFixed(0)} today.`,
                    time: 'Today\'s performance'
                });
            }
            
            // Risk management insight
            if (stats.riskUsed > 2) {
                insights.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    text: `You've used ${stats.riskUsed.toFixed(1)}% risk today. Consider reducing position sizes.`,
                    time: 'Risk alert'
                });
            }
            
            // Add general insight if needed
            if (insights.length < 3) {
                insights.push({
                    type: 'info',
                    icon: 'clock',
                    text: 'The London session is now open. Watch for volatility spikes.',
                    time: 'Market hours'
                });
            }
            
            return insights.slice(0, 3);
        }

        // Update Performance Chart
        function updatePerformanceChart() {
            if (userTrades.length < 3) {
                // Don't show chart if not enough data
                document.getElementById('performanceChart').style.display = 'none';
                return;
            }
            
            document.getElementById('performanceChart').style.display = 'block';
            
            const ctx = document.getElementById('performanceChart');
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            const weeklyData = calculateWeeklyPerformanceData();
            const weeks = weeklyData.map(d => d.week);
            const plData = weeklyData.map(d => d.pl);
            
            // Calculate cumulative P/L
            let cumulative = 0;
            const cumulativeData = plData.map(value => {
                cumulative += value;
                return cumulative;
            });
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Weekly P/L',
                        data: plData,
                        borderColor: '#0f7b6c',
                        backgroundColor: 'rgba(15, 123, 108, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointBackgroundColor: '#0f7b6c',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P/L: $${context.raw.toFixed(0)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate Weekly Performance Data
        function calculateWeeklyPerformanceData() {
            const weeklyData = {};
            
            userTrades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || 0);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = { week: weekKey, pl: 0 };
                }
                weeklyData[weekKey].pl += trade.pl || 0;
            });
            
            // Sort by date and get last 6 weeks
            return Object.values(weeklyData)
                .sort((a, b) => {
                    const dateA = new Date('2024/' + a.week);
                    const dateB = new Date('2024/' + b.week);
                    return dateA - dateB;
                })
                .slice(-6);
        }

        // Export Dashboard Data
        function exportDashboardData() {
            if (userTrades.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Date', 'Pair', 'Direction', 'Result', 'P/L', 'Risk %', 'R:R', 'Session'];
            const csvData = [
                headers.join(','),
                ...userTrades.map(trade => {
                    const date = new Date(trade.date || trade.createdAt || 0).toLocaleDateString();
                    return [
                        `"${date}"`,
                        trade.pair || '',
                        trade.direction || '',
                        trade.result || '',
                        trade.pl || 0,
                        trade.riskPercent || '',
                        trade.rr || '',
                        trade.session || ''
                    ].join(',');
                })
            ].join('\n');
            
            downloadCSV(csvData, `trading-dashboard-${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Download CSV
        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout User
        function logoutUser() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            });
        }

        // Show Error
        function showError(message) {
            const errorHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="empty-state-title">Dashboard Error</div>
                    <div class="empty-state-text">
                        ${message}
                    </div>
                    <button onclick="loadDashboardData()" class="mobile-menu-item primary" style="margin-top: 16px; text-align: center;">
                        <i class="fas fa-redo"></i>
                        Retry Loading
                    </button>
                </div>
            `;
            
            document.getElementById('todaysStats').innerHTML = errorHTML;
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (performanceChart) {
                performanceChart.resize();
                performanceChart.update();
            }
        });

        // Expose functions to global scope
        window.loadDashboardData = loadDashboardData;
        window.togglePlanItem = togglePlanItem;
        window.toggleMobileMenu = toggleMobileMenu;
        window.logoutUser = logoutUser;
    </script>
</body>
</html>
