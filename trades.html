<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTA | Trading Plan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Notion Style Variables */
        :root {
            --notion-bg: #ffffff;
            --notion-gray-bg: #f7f6f3;
            --notion-gray-bg-light: #fbfbfa;
            --notion-gray-border: #e9e9e7;
            --notion-gray-border-hover: #d9d9d7;
            --notion-text: #37352f;
            --notion-text-gray: #9b9a97;
            --notion-text-light: #b3b2af;
            
            /* Notion Colors */
            --notion-blue: #0c8ce9;
            --notion-blue-bg: #e9f5fd;
            --notion-green: #0f7b6c;
            --notion-green-bg: #e9f7f5;
            --notion-red: #d1453b;
            --notion-red-bg: #fdebec;
            --notion-purple: #6940a5;
            --notion-purple-bg: #f2eff9;
            --notion-orange: #ff6b35;
            --notion-orange-bg: #fef0ea;
            --notion-yellow: #ffb800;
            --notion-yellow-bg: #fef9e6;
            --notion-brown: #64473a;
            --notion-brown-bg: #f5f0ed;
            --notion-pink: #d6409f;
            --notion-pink-bg: #fceff8;
            
            /* Notion Sizes */
            --notion-radius: 6px;
            --notion-radius-lg: 8px;
            --notion-padding: 14px;
            --notion-margin: 12px;
            --notion-gap: 10px;
            
            /* Font Sizes */
            --notion-font-xs: 12px;
            --notion-font-sm: 13px;
            --notion-font-base: 14px;
            --notion-font-lg: 16px;
            --notion-font-xl: 20px;
            --notion-font-2xl: 24px;
            
            /* Spacing */
            --notion-space-xs: 4px;
            --notion-space-sm: 8px;
            --notion-space-md: 12px;
            --notion-space-lg: 16px;
            --notion-space-xl: 20px;
            --notion-space-2xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            font-size: var(--notion-font-base);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Fast Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--notion-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.2s ease;
            padding: var(--notion-space-2xl);
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--notion-blue) 0%, var(--notion-green) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--notion-space-xl);
            box-shadow: 0 4px 12px rgba(12, 140, 233, 0.15);
        }

        .loading-logo i {
            color: white;
            font-size: 28px;
        }

        .loading-text {
            font-size: var(--notion-font-lg);
            font-weight: 600;
            color: var(--notion-text);
            margin-bottom: var(--notion-space-md);
        }

        .loading-subtext {
            font-size: var(--notion-font-sm);
            color: var(--notion-text-gray);
            text-align: center;
            max-width: 280px;
        }

        /* Main App Container */
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--notion-bg);
            position: relative;
        }

        /* Header - Notion Style */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-border);
            display: flex;
            align-items: center;
            padding: 0 var(--notion-space-lg);
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--notion-space-md);
            flex: 1;
        }

        .header-title {
            font-size: var(--notion-font-lg);
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--notion-space-sm);
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--notion-radius);
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--notion-text-gray);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .header-btn:hover {
            background: var(--notion-gray-bg);
            color: var(--notion-text);
        }

        .header-btn.active {
            background: var(--notion-gray-bg);
            color: var(--notion-text);
        }

        /* Main Content */
        .main-content {
            margin-top: 56px;
            padding-bottom: 80px;
        }

        /* Page Header - Notion Style */
        .page-header {
            padding: var(--notion-space-2xl) var(--notion-space-lg) var(--notion-space-lg);
            background: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-border);
        }

        .page-title {
            font-size: var(--notion-font-2xl);
            font-weight: 700;
            color: var(--notion-text);
            margin-bottom: var(--notion-space-sm);
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: var(--notion-space-sm);
            min-height: 36px;
        }

        .page-title i {
            font-size: 20px;
            color: var(--notion-text-gray);
        }

        .page-subtitle {
            font-size: var(--notion-font-sm);
            color: var(--notion-text-gray);
            line-height: 1.5;
        }

        /* Notion Toggle Block */
        .notion-toggle {
            background: var(--notion-bg);
            border-radius: var(--notion-radius);
            margin-bottom: 1px;
        }

        .notion-toggle-header {
            padding: var(--notion-space-md) var(--notion-space-lg);
            display: flex;
            align-items: center;
            gap: var(--notion-space-md);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s ease;
            border-radius: var(--notion-radius);
        }

        .notion-toggle-header:hover {
            background: var(--notion-gray-bg);
        }

        .notion-toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--notion-text-gray);
        }

        .notion-toggle-title {
            flex: 1;
            font-size: var(--notion-font-base);
            font-weight: 500;
            color: var(--notion-text);
        }

        .notion-toggle-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--notion-text-light);
            transition: transform 0.2s ease;
        }

        .notion-toggle-arrow.rotated {
            transform: rotate(90deg);
        }

        .notion-toggle-content {
            padding: 0 var(--notion-space-lg) var(--notion-space-lg) 44px;
            display: none;
        }

        .notion-toggle-content.expanded {
            display: block;
        }

        /* Notion Callout Block */
        .notion-callout {
            background: var(--notion-gray-bg);
            border: 1px solid var(--notion-gray-border);
            border-radius: var(--notion-radius);
            padding: var(--notion-space-lg);
            margin-bottom: var(--notion-space-md);
            display: flex;
            gap: var(--notion-space-md);
            align-items: flex-start;
            position: relative;
        }

        .callout-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .callout-content {
            flex: 1;
        }

        .callout-title {
            font-size: var(--notion-font-base);
            font-weight: 500;
            color: var(--notion-text);
            margin-bottom: var(--notion-space-xs);
        }

        .callout-text {
            font-size: var(--notion-font-sm);
            color: var(--notion-text-gray);
            line-height: 1.5;
        }

        /* Notion Checklist */
        .notion-checklist {
            margin: var(--notion-space-sm) 0;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: var(--notion-space-sm);
            padding: var(--notion-space-xs) 0;
            min-height: 28px;
            position: relative;
        }

        .checklist-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 1.5px solid var(--notion-gray-border);
            background: var(--notion-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .checklist-checkbox:hover {
            border-color: var(--notion-gray-border-hover);
            background: var(--notion-gray-bg);
        }

        .checklist-checkbox.checked {
            background: var(--notion-green);
            border-color: var(--notion-green);
        }

        .checklist-checkbox.checked i {
            color: white;
            font-size: 10px;
        }

        .checklist-text {
            flex: 1;
            font-size: var(--notion-font-base);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 22px;
            padding-top: 1px;
        }

        /* Editable Content */
        .editable {
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.15s ease;
            outline: none;
            cursor: text;
        }

        .editable:empty:before {
            content: attr(data-placeholder);
            color: var(--notion-text-light);
        }

        .edit-mode .editable:hover {
            background: var(--notion-gray-bg);
        }

        .edit-mode .editable:focus {
            background: var(--notion-blue-bg);
            box-shadow: 0 0 0 1px var(--notion-blue);
        }

        /* Notion Slider */
        .notion-slider {
            width: 100%;
            margin: var(--notion-space-md) 0;
        }

        .slider-container {
            padding: var(--notion-space-sm) 0;
        }

        .slider-value {
            font-size: var(--notion-font-xl);
            font-weight: 600;
            color: var(--notion-text);
            margin-bottom: var(--notion-space-xs);
        }

        .slider-label {
            font-size: var(--notion-font-sm);
            color: var(--notion-text-gray);
            margin-bottom: var(--notion-space-sm);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--notion-gray-border);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--notion-blue);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Notion Progress Bar - Enhanced */
        .notion-progress {
            margin: var(--notion-space-md) 0;
            background: var(--notion-gray-bg);
            border: 1px solid var(--notion-gray-border);
            border-radius: var(--notion-radius);
            padding: var(--notion-space-md);
            position: relative;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--notion-space-sm);
        }

        .progress-label {
            font-size: var(--notion-font-base);
            color: var(--notion-text);
            font-weight: 500;
            flex: 1;
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: var(--notion-space-sm);
        }

        .progress-value {
            font-size: var(--notion-font-lg);
            font-weight: 600;
            color: var(--notion-green);
            min-width: 50px;
            text-align: right;
        }

        .progress-edit-btn {
            width: 28px;
            height: 28px;
            background: var(--notion-gray-border);
            border: none;
            border-radius: var(--notion-radius);
            color: var(--notion-text-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .progress-edit-btn:hover {
            background: var(--notion-blue);
            color: white;
        }

        .progress-bar-container {
            position: relative;
            margin: var(--notion-space-sm) 0;
        }

        .progress-bar {
            height: 8px;
            background: var(--notion-gray-border);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--notion-green) 0%, var(--notion-blue) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-marker {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--notion-green);
            border-radius: 50%;
            cursor: pointer;
            transform: translateX(-8px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 2;
        }

        .progress-marker:hover {
            transform: translateX(-8px) scale(1.1);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: var(--notion-space-xs);
            font-size: var(--notion-font-xs);
            color: var(--notion-text-gray);
        }

        .progress-description {
            font-size: var(--notion-font-sm);
            color: var(--notion-text-gray);
            margin-top: var(--notion-space-sm);
            line-height: 1.4;
        }

        /* Progress Slider Modal */
        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--notion-space-lg);
        }

        .progress-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--notion-bg);
            border-radius: var(--notion-radius-lg);
            padding: var(--notion-space-xl);
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--notion-space-lg);
        }

        .modal-title {
            font-size: var(--notion-font-lg);
            font-weight: 600;
            color: var(--notion-text);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--notion-text-gray);
            font-size: 20px;
            cursor: pointer;
            padding: var(--notion-space-xs);
        }

        .modal-slider {
            margin: var(--notion-space-xl) 0;
        }

        .modal-value {
            font-size: var(--notion-font-2xl);
            font-weight: 700;
            color: var(--notion-blue);
            text-align: center;
            margin-bottom: var(--notion-space-lg);
        }

        .modal-actions {
            display: flex;
            gap: var(--notion-space-md);
            margin-top: var(--notion-space-xl);
        }

        .modal-btn {
            flex: 1;
            padding: var(--notion-space-md);
            border: none;
            border-radius: var(--notion-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .modal-btn-primary {
            background: var(--notion-blue);
            color: white;
        }

        .modal-btn-primary:hover {
            background: #0a7dcc;
        }

        .modal-btn-secondary {
            background: var(--notion-gray-bg);
            color: var(--notion-text);
        }

        .modal-btn-secondary:hover {
            background: var(--notion-gray-border);
        }

        /* Notion Textarea */
        .notion-textarea {
            width: 100%;
            min-height: 100px;
            padding: var(--notion-space-md);
            background: var(--notion-gray-bg);
            border: 1px solid var(--notion-gray-border);
            border-radius: var(--notion-radius);
            font-family: inherit;
            font-size: var(--notion-font-base);
            color: var(--notion-text);
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .notion-textarea:focus {
            border-color: var(--notion-blue);
            background: var(--notion-bg);
        }

        /* Notion Action Buttons */
        .notion-actions {
            display: flex;
            gap: var(--notion-space-sm);
            padding: var(--notion-space-lg);
            background: var(--notion-bg);
            border-top: 1px solid var(--notion-gray-border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 900;
        }

        .notion-btn {
            flex: 1;
            padding: var(--notion-space-md);
            border: none;
            border-radius: var(--notion-radius);
            font-size: var(--notion-font-base);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--notion-space-sm);
            transition: all 0.15s ease;
        }

        .notion-btn i {
            font-size: 14px;
        }

        .notion-btn-primary {
            background: var(--notion-green);
            color: white;
        }

        .notion-btn-primary:hover {
            background: #0c6b5d;
        }

        .notion-btn-secondary {
            background: var(--notion-gray-bg);
            color: var(--notion-text);
        }

        .notion-btn-secondary:hover {
            background: var(--notion-gray-border);
        }

        .notion-btn-outline {
            background: transparent;
            border: 1px solid var(--notion-gray-border);
            color: var(--notion-text);
        }

        .notion-btn-outline:hover {
            background: var(--notion-gray-bg);
        }

        /* Delete Button */
        .delete-btn {
            position: absolute;
            top: var(--notion-space-md);
            right: var(--notion-space-md);
            width: 28px;
            height: 28px;
            background: var(--notion-red-bg);
            border: none;
            border-radius: var(--notion-radius);
            color: var(--notion-red);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: all 0.15s ease;
            z-index: 1;
        }

        .notion-callout:hover .delete-btn,
        .notion-checklist:hover .delete-btn,
        .notion-progress:hover .delete-btn,
        .slider-container:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: var(--notion-red);
            color: white;
        }

        /* Delete Section Button */
        .delete-section-btn {
            position: absolute;
            top: var(--notion-space-md);
            right: var(--notion-space-lg);
            width: 28px;
            height: 28px;
            background: var(--notion-red-bg);
            border: none;
            border-radius: var(--notion-radius);
            color: var(--notion-red);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .notion-toggle:hover .delete-section-btn {
            opacity: 1;
        }

        .delete-section-btn:hover {
            background: var(--notion-red);
            color: white;
        }

        /* Color Variants */
        .notion-callout.blue {
            background: var(--notion-blue-bg);
            border-color: rgba(12, 140, 233, 0.2);
        }

        .notion-callout.green {
            background: var(--notion-green-bg);
            border-color: rgba(15, 123, 108, 0.2);
        }

        .notion-callout.red {
            background: var(--notion-red-bg);
            border-color: rgba(209, 69, 59, 0.2);
        }

        .notion-callout.purple {
            background: var(--notion-purple-bg);
            border-color: rgba(105, 64, 165, 0.2);
        }

        .notion-callout.orange {
            background: var(--notion-orange-bg);
            border-color: rgba(255, 107, 53, 0.2);
        }

        .notion-callout.yellow {
            background: var(--notion-yellow-bg);
            border-color: rgba(255, 184, 0, 0.2);
        }

        /* Edit Mode Badge */
        .edit-mode-badge {
            position: fixed;
            top: 64px;
            right: var(--notion-space-lg);
            background: var(--notion-purple);
            color: white;
            padding: var(--notion-space-xs) var(--notion-space-sm);
            border-radius: var(--notion-radius);
            font-size: var(--notion-font-xs);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--notion-space-xs);
            z-index: 950;
            box-shadow: 0 2px 8px rgba(105, 64, 165, 0.2);
        }

        /* Add Button */
        .add-item-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--notion-space-sm);
            padding: var(--notion-space-sm) var(--notion-space-md);
            background: var(--notion-gray-bg);
            border: 1px dashed var(--notion-gray-border);
            border-radius: var(--notion-radius);
            color: var(--notion-text-gray);
            font-size: var(--notion-font-sm);
            cursor: pointer;
            margin-top: var(--notion-space-md);
            transition: all 0.15s ease;
        }

        .add-item-btn:hover {
            background: var(--notion-gray-border);
            border-color: var(--notion-text-light);
            color: var(--notion-text);
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            bottom: 80px;
            left: var(--notion-space-lg);
            right: var(--notion-space-lg);
            background: var(--notion-bg);
            border-radius: var(--notion-radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border: 1px solid var(--notion-gray-border);
            z-index: 950;
            display: none;
            overflow: hidden;
        }

        .mobile-menu.active {
            display: block;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--notion-space-md);
            padding: var(--notion-space-md) var(--notion-space-lg);
            color: var(--notion-text);
            text-decoration: none;
            border-bottom: 1px solid var(--notion-gray-border);
            transition: background-color 0.1s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: var(--notion-gray-bg);
        }

        .menu-item i {
            width: 20px;
            color: var(--notion-text-gray);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--notion-green);
            color: white;
            padding: 12px 20px;
            border-radius: var(--notion-radius);
            font-size: var(--notion-font-sm);
            font-weight: 500;
            z-index: 10000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .toast.error {
            background: var(--notion-red);
        }

        .toast.show {
            display: block;
        }

        /* Responsive Adjustments */
        @media (max-width: 380px) {
            .page-header {
                padding: var(--notion-space-xl) var(--notion-space-md) var(--notion-space-md);
            }
            
            .notion-toggle-header {
                padding: var(--notion-space-md);
            }
            
            .notion-callout {
                padding: var(--notion-space-md);
            }
            
            .notion-actions {
                padding: var(--notion-space-md);
            }
            
            .modal-content {
                padding: var(--notion-space-lg);
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 700px;
                margin: 0 auto;
                box-shadow: 0 0 0 1px var(--notion-gray-border);
                min-height: 100vh;
            }
            
            .app-header {
                max-width: 700px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .notion-actions {
                max-width: 700px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --notion-bg: #1a1a1a;
                --notion-gray-bg: #2a2a2a;
                --notion-gray-bg-light: #252525;
                --notion-gray-border: #3a3a3a;
                --notion-gray-border-hover: #4a4a4a;
                --notion-text: #f0f0f0;
                --notion-text-gray: #a0a0a0;
                --notion-text-light: #666666;
            }
        }

        /* Performance Optimizations */
        .will-change {
            will-change: transform, opacity;
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Fast Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="loading-text">Trading Plan</div>
        <div class="loading-subtext">Loading your trading strategy...</div>
    </div>

    <!-- Progress Modal -->
    <div class="progress-modal" id="progressModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Edit Progress</div>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-value" id="modalValue">50%</div>
            <div class="modal-slider">
                <input type="range" id="modalSlider" min="0" max="100" step="1" value="50" class="notion-slider">
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="modalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Fixed Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="header-btn" id="backBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="header-title">Trading Plan</div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="editModeBtn">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="header-btn" id="saveBtn">
                    <i class="fas fa-save"></i>
                </button>
                <button class="header-btn" id="menuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </header>

        <!-- Edit Mode Badge -->
        <div class="edit-mode-badge" id="editModeBadge" style="display: none;">
            <i class="fas fa-edit"></i>
            Edit Mode
        </div>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="dashboard.html" class="menu-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="journal.html" class="menu-item">
                <i class="fas fa-book"></i>
                <span>Trading Journal</span>
            </a>
            <a href="analysis.html" class="menu-item">
                <i class="fas fa-chart-line"></i>
                <span>Analysis</span>
            </a>
            <button class="menu-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-map"></i>
                    <span class="editable" data-placeholder="Trading Plan" data-field="pageTitle" contenteditable="false">Trading Plan</span>
                </div>
                <div class="page-subtitle">Your comprehensive trading strategy and rules. Tap sections to expand.</div>
            </div>

            <!-- Trading Plan Content -->
            <div id="planContent" style="padding: 0 var(--notion-space-lg);">
                <!-- Content will be loaded here -->
            </div>

            <!-- Bottom Actions -->
            <div class="notion-actions">
                <button class="notion-btn notion-btn-outline" id="addSectionBtn">
                    <i class="fas fa-plus"></i>
                    Add Section
                </button>
                <button class="notion-btn notion-btn-primary" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
        </main>
    </div>

    <script>
        // Fast loading and offline support
        (function() {
            'use strict';
            
            // Global state
            const AppState = {
                isEditMode: false,
                currentUser: null,
                tradingPlan: null,
                isOnline: navigator.onLine,
                lastSaveTime: null,
                currentEditProgress: null
            };

            // Default trading plan structure (Notion-like)
            const DefaultPlan = {
                pageTitle: "Trading Plan",
                sections: [
                    {
                        id: 'market-analysis',
                        title: 'Market Analysis',
                        icon: 'fas fa-chart-line',
                        color: 'blue',
                        expanded: false,
                        content: [
                            {
                                id: 'market-hours',
                                type: 'callout',
                                color: 'blue',
                                icon: 'fas fa-clock',
                                title: 'Trading Hours',
                                content: '• London: 3:00 AM - 12:00 PM EST\n• New York: 8:00 AM - 5:00 PM EST\n• Tokyo: 7:00 PM - 4:00 AM EST\n• Sydney: 5:00 PM - 2:00 AM EST'
                            },
                            {
                                id: 'economic-calendar',
                                type: 'callout',
                                color: 'green',
                                icon: 'fas fa-calendar-alt',
                                title: 'Economic Calendar',
                                content: '• High Impact: NFP, CPI, FOMC, GDP\n• Medium Impact: Retail Sales, PMI\n• Low Impact: Consumer Sentiment\n• Strategy: Avoid trading 30min before/after high impact news'
                            },
                            {
                                id: 'preferred-markets',
                                type: 'callout',
                                color: 'purple',
                                icon: 'fas fa-globe',
                                title: 'Preferred Markets',
                                content: '• Major Pairs: EUR/USD, GBP/USD, USD/JPY\n• Cross Pairs: EUR/GBP, EUR/JPY\n• Commodities: XAU/USD (Gold)\n• Indices: S&P 500, DAX 30'
                            }
                        ]
                    },
                    {
                        id: 'trading-rules',
                        title: 'Trading Rules',
                        icon: 'fas fa-gavel',
                        color: 'green',
                        expanded: false,
                        content: [
                            {
                                id: 'rules-checklist',
                                type: 'checklist',
                                items: [
                                    { id: 'rule1', text: 'Only trade in direction of daily trend', checked: false },
                                    { id: 'rule2', text: 'Wait for pullback to key support/resistance', checked: false },
                                    { id: 'rule3', text: 'Confirm with at least 2 indicators (RSI, MACD)', checked: false },
                                    { id: 'rule4', text: 'Enter during London/New York overlap', checked: false },
                                    { id: 'rule5', text: 'Take profit at 1:2 or 1:3 risk-reward ratio', checked: false },
                                    { id: 'rule6', text: 'Move stop loss to breakeven after 1:1', checked: false },
                                    { id: 'rule7', text: 'Close position before high impact news', checked: false },
                                    { id: 'rule8', text: 'Never move stop loss away from price', checked: false }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'risk-management',
                        title: 'Risk Management',
                        icon: 'fas fa-shield-alt',
                        color: 'red',
                        expanded: false,
                        content: [
                            {
                                id: 'risk-per-trade',
                                type: 'slider',
                                label: 'Risk Per Trade',
                                value: 1.5,
                                min: 0.5,
                                max: 5,
                                step: 0.5,
                                unit: '%'
                            },
                            {
                                id: 'daily-max-loss',
                                type: 'slider',
                                label: 'Daily Max Loss',
                                value: 5,
                                min: 1,
                                max: 10,
                                step: 1,
                                unit: '%'
                            },
                            {
                                id: 'weekly-max-loss',
                                type: 'slider',
                                label: 'Weekly Max Loss',
                                value: 15,
                                min: 5,
                                max: 25,
                                step: 5,
                                unit: '%'
                            },
                            {
                                id: 'max-drawdown',
                                type: 'slider',
                                label: 'Max Account Drawdown',
                                value: 20,
                                min: 10,
                                max: 50,
                                step: 5,
                                unit: '%'
                            }
                        ]
                    },
                    {
                        id: 'psychology',
                        title: 'Trading Psychology',
                        icon: 'fas fa-brain',
                        color: 'purple',
                        expanded: false,
                        content: [
                            {
                                id: 'psychology1',
                                type: 'callout',
                                color: 'purple',
                                icon: 'fas fa-balance-scale',
                                title: 'Stay Disciplined',
                                content: 'Follow your plan even when emotions run high'
                            },
                            {
                                id: 'psychology2',
                                type: 'callout',
                                color: 'orange',
                                icon: 'fas fa-running',
                                title: 'Take Breaks',
                                content: 'Step away after 2 consecutive losses'
                            },
                            {
                                id: 'psychology3',
                                type: 'callout',
                                color: 'green',
                                icon: 'fas fa-chart-line',
                                title: 'Focus on Process',
                                content: "Don't focus on P&L, focus on execution"
                            },
                            {
                                id: 'psychology4',
                                type: 'callout',
                                color: 'blue',
                                icon: 'fas fa-book',
                                title: 'Review Daily',
                                content: 'Journal every trade win or lose'
                            }
                        ]
                    },
                    {
                        id: 'goals',
                        title: 'Trading Goals',
                        icon: 'fas fa-bullseye',
                        color: 'orange',
                        expanded: false,
                        content: [
                            {
                                id: 'goal1',
                                type: 'progress',
                                label: 'Monthly Profit Target',
                                value: 60,
                                target: 100,
                                description: 'Achieve 10% monthly return on account'
                            },
                            {
                                id: 'goal2',
                                type: 'progress',
                                label: 'Consistency Goal',
                                value: 75,
                                target: 100,
                                description: 'Maintain 55% win rate for 3 consecutive months'
                            },
                            {
                                id: 'goal3',
                                type: 'progress',
                                label: 'Risk Management',
                                value: 90,
                                target: 100,
                                description: 'Never exceed daily loss limit for 30 days'
                            },
                            {
                                id: 'goal4',
                                type: 'progress',
                                label: 'Education Goal',
                                value: 50,
                                target: 100,
                                description: 'Complete 2 trading courses this quarter'
                            }
                        ]
                    },
                    {
                        id: 'journal',
                        title: 'Daily Journal Prompts',
                        icon: 'fas fa-book-open',
                        color: 'green',
                        expanded: false,
                        content: [
                            {
                                id: 'prompt1',
                                type: 'textarea',
                                label: 'What was the market condition today?',
                                value: ''
                            },
                            {
                                id: 'prompt2',
                                type: 'textarea',
                                label: 'Did I follow my trading plan today?',
                                value: ''
                            },
                            {
                                id: 'prompt3',
                                type: 'textarea',
                                label: 'What did I learn from today\'s trades?',
                                value: ''
                            },
                            {
                                id: 'prompt4',
                                type: 'textarea',
                                label: 'How was my emotional state during trading?',
                                value: ''
                            }
                        ]
                    }
                ]
            };

            // Initialize app immediately
            document.addEventListener('DOMContentLoaded', async function() {
                // Hide loading screen after minimal delay
                setTimeout(hideLoadingScreen, 300);
                
                // Load cached data immediately
                await loadCachedData();
                
                // Render the plan
                renderPlan();
                
                // Setup event listeners
                setupEventListeners();
                
                // Check for updates in background
                setTimeout(checkForUpdates, 1000);
            });

            // Hide loading screen
            function hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 200);
                }
            }

            // Load cached data
            async function loadCachedData() {
                try {
                    const cached = localStorage.getItem('trading_plan_v3');
                    if (cached) {
                        const data = JSON.parse(cached);
                        if (data && data.sections) {
                            AppState.tradingPlan = data;
                            console.log('Loaded cached trading plan');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('No valid cache found');
                }
                
                // Use default plan
                AppState.tradingPlan = JSON.parse(JSON.stringify(DefaultPlan));
                
                // Try to load from Firebase in background
                if (typeof firebase !== 'undefined') {
                    loadFromFirebase();
                }
            }

            // Load from Firebase (background)
            async function loadFromFirebase() {
                try {
                    // This would load from Firebase
                    // For now, just save the default
                    await savePlan();
                } catch (error) {
                    console.log('Firebase load failed, using local data');
                }
            }

            // Render the entire plan
            function renderPlan() {
                const container = document.getElementById('planContent');
                if (!container || !AppState.tradingPlan) return;
                
                // Update page title
                const pageTitle = document.querySelector('[data-field="pageTitle"]');
                if (pageTitle && AppState.tradingPlan.pageTitle) {
                    pageTitle.textContent = AppState.tradingPlan.pageTitle;
                }
                
                // Clear container
                container.innerHTML = '';
                
                // Render each section
                AppState.tradingPlan.sections.forEach((section, sectionIndex) => {
                    const sectionElement = createSectionElement(section, sectionIndex);
                    container.appendChild(sectionElement);
                });
                
                // Update edit mode
                updateEditMode();
            }

            // Create a section element
            function createSectionElement(section, sectionIndex) {
                const div = document.createElement('div');
                div.className = 'notion-toggle';
                
                // Create header
                const header = document.createElement('div');
                header.className = 'notion-toggle-header';
                header.dataset.sectionIndex = sectionIndex;
                
                header.innerHTML = `
                    <div class="notion-toggle-icon">
                        <i class="${section.icon}" style="color: var(--notion-${section.color})"></i>
                    </div>
                    <div class="notion-toggle-title editable" 
                         data-placeholder="Section Title"
                         data-section="${sectionIndex}"
                         data-field="title"
                         contenteditable="${AppState.isEditMode}">
                        ${section.title || 'Section Title'}
                    </div>
                    <div class="notion-toggle-arrow ${section.expanded ? 'rotated' : ''}">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    ${AppState.isEditMode ? `
                        <button class="delete-section-btn" onclick="deleteSection(${sectionIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                `;
                
                // Create content
                const content = document.createElement('div');
                content.className = `notion-toggle-content ${section.expanded ? 'expanded' : ''}`;
                content.dataset.sectionIndex = sectionIndex;
                
                if (section.expanded) {
                    renderSectionContent(content, section, sectionIndex);
                }
                
                div.appendChild(header);
                div.appendChild(content);
                
                return div;
            }

            // Render section content
            function renderSectionContent(container, section, sectionIndex) {
                container.innerHTML = '';
                
                section.content.forEach((item, itemIndex) => {
                    let itemElement;
                    
                    switch (item.type) {
                        case 'callout':
                            itemElement = createCalloutElement(item, sectionIndex, itemIndex);
                            break;
                        case 'checklist':
                            itemElement = createChecklistElement(item, sectionIndex, itemIndex);
                            break;
                        case 'slider':
                            itemElement = createSliderElement(item, sectionIndex, itemIndex);
                            break;
                        case 'progress':
                            itemElement = createProgressElement(item, sectionIndex, itemIndex);
                            break;
                        case 'textarea':
                            itemElement = createTextareaElement(item, sectionIndex, itemIndex);
                            break;
                        default:
                            itemElement = document.createElement('div');
                    }
                    
                    if (itemElement) {
                        container.appendChild(itemElement);
                    }
                });
                
                // Add "Add Item" button in edit mode
                if (AppState.isEditMode) {
                    const addButton = document.createElement('button');
                    addButton.className = 'add-item-btn';
                    addButton.innerHTML = '<i class="fas fa-plus"></i> Add Item';
                    addButton.onclick = () => addSectionItem(sectionIndex);
                    container.appendChild(addButton);
                }
            }

            // Create callout element
            function createCalloutElement(item, sectionIndex, itemIndex) {
                const div = document.createElement('div');
                div.className = `notion-callout ${item.color || ''}`;
                
                div.innerHTML = `
                    <div class="callout-icon">
                        <i class="${item.icon || 'fas fa-info-circle'}" style="color: var(--notion-${item.color || 'blue'})"></i>
                    </div>
                    <div class="callout-content">
                        <div class="callout-title editable" 
                             data-placeholder="Title"
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-field="title"
                             contenteditable="${AppState.isEditMode}">
                            ${item.title || 'Title'}
                        </div>
                        <div class="callout-text editable" 
                             data-placeholder="Content..."
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-field="content"
                             contenteditable="${AppState.isEditMode}">
                            ${item.content || 'Content...'}
                        </div>
                    </div>
                    ${AppState.isEditMode ? `
                        <button class="delete-btn" onclick="deleteItem(${sectionIndex}, ${itemIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                `;
                
                return div;
            }

            // Create checklist element
            function createChecklistElement(item, sectionIndex, itemIndex) {
                const div = document.createElement('div');
                div.className = 'notion-checklist';
                
                item.items.forEach((checkItem, checkIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item';
                    
                    itemDiv.innerHTML = `
                        <div class="checklist-checkbox ${checkItem.checked ? 'checked' : ''}" 
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-check="${checkIndex}">
                            ${checkItem.checked ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                        <div class="checklist-text editable"
                             data-placeholder="Checklist item..."
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-check="${checkIndex}"
                             data-field="text"
                             contenteditable="${AppState.isEditMode}">
                            ${checkItem.text || 'Checklist item...'}
                        </div>
                        ${AppState.isEditMode ? `
                            <button class="delete-btn" onclick="deleteChecklistItem(${sectionIndex}, ${itemIndex}, ${checkIndex})" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%);">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    `;
                    
                    div.appendChild(itemDiv);
                });
                
                // Add "Add Item" button for checklist in edit mode
                if (AppState.isEditMode) {
                    const addButton = document.createElement('button');
                    addButton.className = 'add-item-btn';
                    addButton.innerHTML = '<i class="fas fa-plus"></i> Add Checklist Item';
                    addButton.onclick = () => addChecklistItem(sectionIndex, itemIndex);
                    div.appendChild(addButton);
                }
                
                // Add delete button for the entire checklist
                if (AppState.isEditMode) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteItem(sectionIndex, itemIndex);
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = 'var(--notion-space-md)';
                    deleteBtn.style.right = 'var(--notion-space-md)';
                    div.style.position = 'relative';
                    div.appendChild(deleteBtn);
                }
                
                return div;
            }

            // Create slider element
            function createSliderElement(item, sectionIndex, itemIndex) {
                const div = document.createElement('div');
                div.className = 'slider-container';
                div.style.position = 'relative';
                
                div.innerHTML = `
                    <div class="slider-value">${item.value}${item.unit || ''}</div>
                    <div class="slider-label editable"
                         data-placeholder="Label"
                         data-section="${sectionIndex}"
                         data-item="${itemIndex}"
                         data-field="label"
                         contenteditable="${AppState.isEditMode}">
                        ${item.label || 'Label'}
                    </div>
                    <input type="range" 
                           class="notion-slider" 
                           min="${item.min || 0}" 
                           max="${item.max || 100}" 
                           step="${item.step || 1}" 
                           value="${item.value || 0}"
                           data-section="${sectionIndex}"
                           data-item="${itemIndex}">
                `;
                
                return div;
            }

            // Create progress element with advanced controls
            function createProgressElement(item, sectionIndex, itemIndex) {
                const div = document.createElement('div');
                div.className = 'notion-progress';
                
                const percentage = Math.round((item.value / item.target) * 100);
                
                div.innerHTML = `
                    <div class="progress-header">
                        <div class="progress-label editable"
                             data-placeholder="Goal"
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-field="label"
                             contenteditable="${AppState.isEditMode}">
                            ${item.label || 'Goal'}
                        </div>
                        <div class="progress-controls">
                            <div class="progress-value">${item.value}%</div>
                            <button class="progress-edit-btn" onclick="editProgress(${sectionIndex}, ${itemIndex})">
                                <i class="fas fa-sliders-h"></i>
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                            <div class="progress-marker" 
                                 style="left: ${percentage}%"
                                 data-section="${sectionIndex}"
                                 data-item="${itemIndex}"></div>
                        </div>
                        <div class="progress-labels">
                            <span>0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    ${item.description ? `
                        <div class="progress-description editable"
                             data-placeholder="Description..."
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-field="description"
                             contenteditable="${AppState.isEditMode}">
                            ${item.description}
                        </div>
                    ` : ''}
                `;
                
                return div;
            }

            // Create textarea element
            function createTextareaElement(item, sectionIndex, itemIndex) {
                const div = document.createElement('div');
                div.className = 'notion-callout';
                
                div.innerHTML = `
                    <div class="callout-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="callout-content">
                        <div class="callout-title editable"
                             data-placeholder="Question"
                             data-section="${sectionIndex}"
                             data-item="${itemIndex}"
                             data-field="label"
                             contenteditable="${AppState.isEditMode}">
                            ${item.label || 'Question'}
                        </div>
                        <textarea class="notion-textarea"
                                  data-section="${sectionIndex}"
                                  data-item="${itemIndex}"
                                  placeholder="Your answer...">${item.value || ''}</textarea>
                    </div>
                `;
                
                return div;
            }

            // Setup event listeners
            function setupEventListeners() {
                // Back button
                document.getElementById('backBtn').addEventListener('click', () => {
                    window.history.back();
                });

                // Edit mode toggle
                document.getElementById('editModeBtn').addEventListener('click', toggleEditMode);

                // Save button
                document.getElementById('saveBtn').addEventListener('click', savePlan);

                // Menu button
                document.getElementById('menuBtn').addEventListener('click', toggleMobileMenu);

                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', logout);

                // Export button
                document.getElementById('exportBtn').addEventListener('click', exportPlan);

                // Add section button
                document.getElementById('addSectionBtn').addEventListener('click', addNewSection);

                // Modal controls
                document.getElementById('modalClose').addEventListener('click', closeProgressModal);
                document.getElementById('modalCancel').addEventListener('click', closeProgressModal);
                document.getElementById('modalSave').addEventListener('click', saveProgress);
                document.getElementById('modalSlider').addEventListener('input', updateModalValue);

                // Toggle section headers
                document.addEventListener('click', function(e) {
                    const header = e.target.closest('.notion-toggle-header');
                    if (header && !e.target.closest('.editable') && !e.target.closest('.delete-section-btn')) {
                        toggleSection(parseInt(header.dataset.sectionIndex));
                    }
                });

                // Checkbox clicks
                document.addEventListener('click', function(e) {
                    const checkbox = e.target.closest('.checklist-checkbox');
                    if (checkbox && !AppState.isEditMode) {
                        toggleCheckbox(checkbox);
                    }
                });

                // Slider changes
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('notion-slider')) {
                        updateSlider(e.target);
                    }
                });

                // Textarea changes
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('notion-textarea')) {
                        updateTextarea(e.target);
                    }
                });

                // Editable content changes
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('editable')) {
                        updateEditable(e.target);
                    }
                });

                // Progress marker drag
                setupProgressDrag();

                // Online/offline detection
                window.addEventListener('online', () => {
                    AppState.isOnline = true;
                    syncWithServer();
                });

                window.addEventListener('offline', () => {
                    AppState.isOnline = false;
                });
            }

            // Setup progress marker drag
            function setupProgressDrag() {
                document.addEventListener('mousedown', startDrag);
                document.addEventListener('touchstart', startDrag);
                
                function startDrag(e) {
                    const marker = e.target.closest('.progress-marker');
                    if (!marker || !AppState.isEditMode) return;
                    
                    e.preventDefault();
                    
                    const sectionIndex = parseInt(marker.dataset.section);
                    const itemIndex = parseInt(marker.dataset.item);
                    const progressBar = marker.closest('.progress-bar-container');
                    
                    if (!progressBar) return;
                    
                    let isDragging = true;
                    
                    function onDrag(e) {
                        if (!isDragging) return;
                        
                        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                        const rect = progressBar.getBoundingClientRect();
                        let percentage = ((clientX - rect.left) / rect.width) * 100;
                        
                        // Clamp between 0 and 100
                        percentage = Math.max(0, Math.min(100, percentage));
                        
                        // Update marker position
                        marker.style.left = percentage + '%';
                        
                        // Update progress fill
                        const fill = progressBar.querySelector('.progress-fill');
                        if (fill) {
                            fill.style.width = percentage + '%';
                        }
                        
                        // Update value display
                        const valueDisplay = marker.closest('.notion-progress').querySelector('.progress-value');
                        if (valueDisplay) {
                            valueDisplay.textContent = Math.round(percentage) + '%';
                        }
                    }
                    
                    function stopDrag() {
                        if (!isDragging) return;
                        isDragging = false;
                        
                        // Get final percentage
                        const percentage = parseFloat(marker.style.left);
                        
                        // Update data
                        if (!isNaN(percentage) && AppState.tradingPlan && 
                            AppState.tradingPlan.sections[sectionIndex] &&
                            AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) {
                            
                            AppState.tradingPlan.sections[sectionIndex].content[itemIndex].value = Math.round(percentage);
                            
                            // Auto-save
                            savePlan(true);
                            showToast('Progress updated');
                        }
                        
                        // Remove event listeners
                        document.removeEventListener('mousemove', onDrag);
                        document.removeEventListener('touchmove', onDrag);
                        document.removeEventListener('mouseup', stopDrag);
                        document.removeEventListener('touchend', stopDrag);
                    }
                    
                    // Add event listeners
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('touchmove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
            }

            // Toggle section expansion
            function toggleSection(sectionIndex) {
                if (!AppState.tradingPlan || !AppState.tradingPlan.sections[sectionIndex]) return;
                
                const section = AppState.tradingPlan.sections[sectionIndex];
                section.expanded = !section.expanded;
                
                // Update UI
                const content = document.querySelector(`.notion-toggle-content[data-section-index="${sectionIndex}"]`);
                const arrow = document.querySelector(`.notion-toggle-header[data-section-index="${sectionIndex}"] .notion-toggle-arrow`);
                
                if (content && arrow) {
                    if (section.expanded) {
                        renderSectionContent(content, section, sectionIndex);
                        content.classList.add('expanded');
                        arrow.classList.add('rotated');
                    } else {
                        content.classList.remove('expanded');
                        arrow.classList.remove('rotated');
                    }
                }
            }

            // Toggle edit mode
            function toggleEditMode() {
                AppState.isEditMode = !AppState.isEditMode;
                updateEditMode();
                
                // Re-render to show/hide edit controls
                renderPlan();
            }

            // Update edit mode UI
            function updateEditMode() {
                const badge = document.getElementById('editModeBadge');
                const editBtn = document.getElementById('editModeBtn');
                
                if (AppState.isEditMode) {
                    badge.style.display = 'flex';
                    editBtn.classList.add('active');
                    editBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    document.body.classList.add('edit-mode');
                } else {
                    badge.style.display = 'none';
                    editBtn.classList.remove('active');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    document.body.classList.remove('edit-mode');
                }
            }

            // Toggle checkbox
            function toggleCheckbox(checkbox) {
                const sectionIndex = parseInt(checkbox.dataset.section);
                const itemIndex = parseInt(checkbox.dataset.item);
                const checkIndex = parseInt(checkbox.dataset.check);
                
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex].items[checkIndex]) return;
                
                const item = AppState.tradingPlan.sections[sectionIndex].content[itemIndex].items[checkIndex];
                item.checked = !item.checked;
                
                // Update UI
                if (item.checked) {
                    checkbox.classList.add('checked');
                    checkbox.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                }
                
                // Auto-save
                savePlan(true);
            }

            // Update slider
            function updateSlider(slider) {
                const sectionIndex = parseInt(slider.dataset.section);
                const itemIndex = parseInt(slider.dataset.item);
                
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) return;
                
                const item = AppState.tradingPlan.sections[sectionIndex].content[itemIndex];
                item.value = parseFloat(slider.value);
                
                // Update displayed value
                const valueDisplay = slider.parentNode.querySelector('.slider-value');
                if (valueDisplay) {
                    valueDisplay.textContent = item.value + (item.unit || '');
                }
                
                // Auto-save
                savePlan(true);
            }

            // Update textarea
            function updateTextarea(textarea) {
                const sectionIndex = parseInt(textarea.dataset.section);
                const itemIndex = parseInt(textarea.dataset.item);
                
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) return;
                
                AppState.tradingPlan.sections[sectionIndex].content[itemIndex].value = textarea.value;
                
                // Auto-save after delay
                debouncedSave();
            }

            // Update editable content
            function updateEditable(element) {
                const sectionIndex = element.dataset.section;
                const itemIndex = element.dataset.item;
                const checkIndex = element.dataset.check;
                const field = element.dataset.field;
                
                if (!AppState.tradingPlan) return;
                
                // Update page title
                if (field === 'pageTitle') {
                    AppState.tradingPlan.pageTitle = element.textContent;
                }
                // Update section title
                else if (field === 'title' && itemIndex === undefined) {
                    AppState.tradingPlan.sections[sectionIndex].title = element.textContent;
                }
                // Update item fields
                else if (field && itemIndex !== undefined) {
                    const item = AppState.tradingPlan.sections[sectionIndex].content[itemIndex];
                    
                    if (checkIndex !== undefined) {
                        // Checklist item text
                        if (item.items && item.items[checkIndex]) {
                            item.items[checkIndex][field] = element.textContent;
                        }
                    } else {
                        // Regular item field
                        item[field] = element.textContent;
                    }
                }
                
                // Auto-save after delay
                debouncedSave();
            }

            // Edit progress (open modal)
            window.editProgress = function(sectionIndex, itemIndex) {
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) return;
                
                const item = AppState.tradingPlan.sections[sectionIndex].content[itemIndex];
                AppState.currentEditProgress = { sectionIndex, itemIndex };
                
                // Set modal values
                document.getElementById('modalTitle').textContent = item.label || 'Edit Progress';
                document.getElementById('modalValue').textContent = item.value + '%';
                document.getElementById('modalSlider').value = item.value;
                
                // Show modal
                document.getElementById('progressModal').classList.add('active');
            };

            // Update modal value display
            function updateModalValue() {
                const slider = document.getElementById('modalSlider');
                document.getElementById('modalValue').textContent = slider.value + '%';
            }

            // Save progress from modal
            function saveProgress() {
                if (!AppState.currentEditProgress) return;
                
                const { sectionIndex, itemIndex } = AppState.currentEditProgress;
                const slider = document.getElementById('modalSlider');
                const value = parseInt(slider.value);
                
                if (AppState.tradingPlan && 
                    AppState.tradingPlan.sections[sectionIndex] &&
                    AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) {
                    
                    AppState.tradingPlan.sections[sectionIndex].content[itemIndex].value = value;
                    
                    // Update UI
                    renderPlan();
                    
                    // Save
                    savePlan(true);
                    showToast('Progress updated');
                }
                
                closeProgressModal();
            }

            // Close progress modal
            function closeProgressModal() {
                document.getElementById('progressModal').classList.remove('active');
                AppState.currentEditProgress = null;
            }

            // Add new section
            function addNewSection() {
                if (!AppState.tradingPlan) return;
                
                const newSection = {
                    id: 'section-' + Date.now(),
                    title: 'New Section',
                    icon: 'fas fa-plus-circle',
                    color: 'blue',
                    expanded: true,
                    content: []
                };
                
                AppState.tradingPlan.sections.push(newSection);
                renderPlan();
                savePlan(true);
                showToast('New section added');
            }

            // Add item to section
            function addSectionItem(sectionIndex) {
                if (!AppState.tradingPlan || !AppState.tradingPlan.sections[sectionIndex]) return;
                
                const newItem = {
                    id: 'item-' + Date.now(),
                    type: 'callout',
                    color: 'blue',
                    icon: 'fas fa-info-circle',
                    title: 'New Item',
                    content: 'Add your content here...'
                };
                
                AppState.tradingPlan.sections[sectionIndex].content.push(newItem);
                renderPlan();
                savePlan(true);
                showToast('Item added');
            }

            // Add checklist item
            function addChecklistItem(sectionIndex, itemIndex) {
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) return;
                
                const checklist = AppState.tradingPlan.sections[sectionIndex].content[itemIndex];
                if (!checklist.items) checklist.items = [];
                
                checklist.items.push({
                    id: 'check-' + Date.now(),
                    text: 'New checklist item...',
                    checked: false
                });
                
                renderPlan();
                savePlan(true);
                showToast('Checklist item added');
            }

            // Delete section
            window.deleteSection = function(sectionIndex) {
                if (!AppState.tradingPlan || !AppState.tradingPlan.sections[sectionIndex]) return;
                
                if (confirm('Are you sure you want to delete this entire section? This action cannot be undone.')) {
                    AppState.tradingPlan.sections.splice(sectionIndex, 1);
                    renderPlan();
                    savePlan(true);
                    showToast('Section deleted');
                }
            };

            // Delete item
            window.deleteItem = function(sectionIndex, itemIndex) {
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex]) return;
                
                if (confirm('Are you sure you want to delete this item?')) {
                    AppState.tradingPlan.sections[sectionIndex].content.splice(itemIndex, 1);
                    renderPlan();
                    savePlan(true);
                    showToast('Item deleted');
                }
            };

            // Delete checklist item
            window.deleteChecklistItem = function(sectionIndex, itemIndex, checkIndex) {
                if (!AppState.tradingPlan || 
                    !AppState.tradingPlan.sections[sectionIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex] ||
                    !AppState.tradingPlan.sections[sectionIndex].content[itemIndex].items[checkIndex]) return;
                
                if (confirm('Are you sure you want to delete this checklist item?')) {
                    AppState.tradingPlan.sections[sectionIndex].content[itemIndex].items.splice(checkIndex, 1);
                    renderPlan();
                    savePlan(true);
                    showToast('Checklist item deleted');
                }
            };

            // Save plan (with auto-save option)
            async function savePlan(autoSave = false) {
                try {
                    // Update timestamp
                    AppState.tradingPlan.lastUpdated = Date.now();
                    AppState.lastSaveTime = Date.now();
                    
                    // Save to localStorage
                    localStorage.setItem('trading_plan_v3', JSON.stringify(AppState.tradingPlan));
                    
                    // Save to Firebase if available and online
                    if (AppState.isOnline && typeof firebase !== 'undefined') {
                        await saveToFirebase();
                    }
                    
                    // Show feedback if not auto-save
                    if (!autoSave) {
                        showToast('Plan saved successfully!');
                    }
                    
                    console.log('Plan saved at:', new Date().toLocaleTimeString());
                } catch (error) {
                    console.error('Error saving plan:', error);
                    if (!autoSave) {
                        showToast('Error saving plan', 'error');
                    }
                }
            }

            // Save to Firebase
            async function saveToFirebase() {
                // Firebase save implementation would go here
                // For now, just log
                console.log('Would save to Firebase');
            }

            // Show toast notification
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Debounced save function
            let saveTimeout;
            function debouncedSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => savePlan(true), 1000);
            }

            // Toggle mobile menu
            function toggleMobileMenu() {
                const menu = document.getElementById('mobileMenu');
                menu.classList.toggle('active');
            }

            // Logout
            function logout() {
                // Clear local data
                localStorage.removeItem('trading_plan_v3');
                
                // Redirect to login
                window.location.href = 'index.html';
            }

            // Export plan
            function exportPlan() {
                // Create printable version
                const printContent = document.createElement('div');
                printContent.innerHTML = `
                    <div style="padding: 20px; font-family: 'Inter', sans-serif;">
                        <h1 style="color: var(--notion-text); margin-bottom: 20px;">${AppState.tradingPlan.pageTitle}</h1>
                        ${AppState.tradingPlan.sections.map(section => `
                            <div style="margin-bottom: 30px;">
                                <h2 style="color: var(--notion-text); margin-bottom: 15px;">
                                    <i class="${section.icon}" style="color: var(--notion-${section.color}); margin-right: 10px;"></i>
                                    ${section.title}
                                </h2>
                                ${section.content.map(item => {
                                    switch(item.type) {
                                        case 'callout':
                                            return `<div style="background: var(--notion-${item.color}-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                                <strong>${item.title}</strong><br>
                                                ${item.content.replace(/\n/g, '<br>')}
                                            </div>`;
                                        case 'checklist':
                                            return `<div style="margin-bottom: 10px;">
                                                ${item.items.map(checkItem => `
                                                    <div style="margin: 5px 0;">
                                                        ${checkItem.checked ? '✓' : '○'} ${checkItem.text}
                                                    </div>
                                                `).join('')}
                                            </div>`;
                                        case 'progress':
                                            return `<div style="margin-bottom: 10px;">
                                                <strong>${item.label}</strong>: ${item.value}%<br>
                                                <div style="background: #e9e9e7; height: 8px; border-radius: 4px; margin: 5px 0;">
                                                    <div style="background: var(--notion-green); width: ${item.value}%; height: 100%; border-radius: 4px;"></div>
                                                </div>
                                                <small>${item.description}</small>
                                            </div>`;
                                        default:
                                            return '';
                                    }
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Open print dialog
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${AppState.tradingPlan.pageTitle}</title>
                            <style>
                                body { font-family: 'Inter', sans-serif; padding: 20px; }
                                h1 { color: #37352f; }
                                h2 { color: #37352f; margin-top: 30px; }
                                @media print {
                                    body { padding: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printContent.innerHTML}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            }

            // Check for updates
            function checkForUpdates() {
                if (AppState.isOnline) {
                    // Check for Firebase updates
                    syncWithServer();
                }
            }

            // Sync with server
            async function syncWithServer() {
                // Implementation for syncing with Firebase
                console.log('Syncing with server...');
            }

            // Make functions available globally
            window.AppState = AppState;
            window.savePlan = savePlan;
            window.toggleEditMode = toggleEditMode;
            window.exportPlan = exportPlan;

        })();
    </script>
</body>
</html>
