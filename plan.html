<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTA | Trading Plan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .auth-message {
            font-size: 16px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 300px;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .mobile-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit;
            text-align: left;
        }

        .mobile-menu-item.primary {
            background-color: var(--notion-green);
            color: white;
        }

        .mobile-menu-item.blue {
            background-color: var(--notion-blue);
            color: white;
        }

        /* Main Container */
        .main-container {
            margin: 50px 0 60px 0;
            padding: 0;
            width: 100%;
        }

        /* Page Header */
        .page-header {
            padding: 20px 16px;
            background: linear-gradient(135deg, var(--notion-purple-light), var(--notion-blue-light));
            margin-bottom: 0;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--notion-text);
            line-height: 1.3;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Plan Summary */
        .plan-summary {
            padding: 16px;
            background-color: white;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .summary-card {
            padding: 16px;
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            text-align: center;
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 18px;
        }

        .summary-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .summary-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .summary-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .summary-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 4px;
        }

        .summary-change {
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .summary-change.positive {
            color: var(--notion-green);
        }

        .summary-change.negative {
            color: var(--notion-red);
        }

        /* Plan Sections */
        .plan-section {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action {
            font-size: 13px;
            color: var(--notion-blue);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Checklist */
        .checklist {
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            overflow: hidden;
        }

        .checklist-header {
            padding: 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .checklist-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist-progress {
            font-size: 12px;
            color: var(--notion-text-light);
            font-weight: 500;
        }

        .checklist-items {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--notion-gray);
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .checklist-item:hover {
            background-color: var(--notion-gray-light);
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--notion-gray-dark);
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .checklist-checkbox.checked {
            background-color: var(--notion-green);
            border-color: var(--notion-green);
            color: white;
        }

        .checklist-text {
            flex: 1;
            font-size: 14px;
            color: var(--notion-text);
        }

        .checklist-text.completed {
            text-decoration: line-through;
            color: var(--notion-text-light);
        }

        .checklist-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .checklist-item:hover .checklist-actions {
            opacity: 1;
        }

        .checklist-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: none;
            background-color: var(--notion-gray);
            color: var(--notion-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .checklist-action-btn:hover {
            background-color: var(--notion-gray-dark);
        }

        .checklist-action-btn.edit {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .checklist-action-btn.delete {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        /* Add Item Form */
        .add-item-form {
            padding: 16px;
            background-color: var(--notion-gray-light);
            border-top: 1px solid var(--notion-gray-dark);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-bottom: 6px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            color: var(--notion-text);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 2px rgba(12, 140, 233, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            color: var(--notion-text);
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .form-btn {
            padding: 10px 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            background-color: white;
            color: var(--notion-text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            flex: 1;
        }

        .form-btn:hover {
            background-color: var(--notion-gray);
        }

        .form-btn.primary {
            background-color: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .form-btn.primary:hover {
            background-color: #0c6b5d;
        }

        /* Plan Templates */
        .plan-templates {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .template-card {
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .template-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
        }

        .template-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .template-icon.blue {
            background-color: var(--notion-blue-light);
            color: var(--notion-blue);
        }

        .template-icon.purple {
            background-color: var(--notion-purple-light);
            color: var(--notion-purple);
        }

        .template-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .template-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-description {
            font-size: 11px;
            color: var(--notion-text-light);
            line-height: 1.4;
        }

        /* Risk Rules */
        .risk-rules {
            padding: 20px 16px;
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .rules-list {
            list-style: none;
            padding: 0;
        }

        .rule-item {
            padding: 12px 16px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rule-item:last-child {
            margin-bottom: 0;
        }

        .rule-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .rule-icon.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .rule-icon.orange {
            background-color: var(--notion-orange-light);
            color: var(--notion-orange);
        }

        .rule-icon.green {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .rule-content {
            flex: 1;
        }

        .rule-text {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .rule-status {
            font-size: 11px;
            color: var(--notion-text-light);
        }

        /* Trading Goals */
        .trading-goals {
            padding: 20px 16px;
            background-color: var(--notion-gray-light);
            border-bottom: 1px solid var(--notion-gray-dark);
        }

        .goals-list {
            list-style: none;
            padding: 0;
        }

        .goal-item {
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--notion-gray-dark);
        }

        .goal-item:last-child {
            margin-bottom: 0;
        }

        .goal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .goal-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .goal-deadline {
            font-size: 12px;
            color: var(--notion-text-light);
            background-color: var(--notion-gray);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .goal-progress {
            margin-top: 12px;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--notion-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--notion-green);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 11px;
            color: var(--notion-text-light);
            display: flex;
            justify-content: space-between;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--notion-text-light);
            flex-direction: column;
            gap: 16px;
        }

        .loading i {
            animation: spin 1s linear infinite;
            font-size: 32px;
        }

        .loading-text {
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            color: var(--notion-text-light);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--notion-purple);
            background-color: var(--notion-purple-light);
        }

        .bottom-nav-btn i {
            font-size: 18px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text-light);
            cursor: pointer;
            padding: 4px;
        }

        .modal-content {
            padding: 24px;
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .summary-stats,
            .templates-grid {
                grid-template-columns: 1fr;
            }
            
            .checklist-actions {
                opacity: 1;
            }
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-container {
                margin: 0;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .page-header {
                border-radius: 12px 12px 0 0;
            }
            
            .plan-summary {
                border-radius: 0;
            }
            
            .plan-section {
                border-radius: 0;
            }
            
            .plan-templates {
                border-radius: 0;
            }
            
            .risk-rules {
                border-radius: 0;
            }
            
            .trading-goals {
                border-radius: 0 0 12px 12px;
            }
            
            .templates-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Loading trading plan...</div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header-title">Trading Plan</div>
        </div>
        <button class="mobile-menu-btn" id="mobileRefreshBtn">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" class="mobile-menu-item">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <a href="journal.html" class="mobile-menu-item">
            <i class="fas fa-book"></i>
            Trading Journal
        </a>
        <a href="analysis.html" class="mobile-menu-item">
            <i class="fas fa-chart-line"></i>
            Advanced Analysis
        </a>
        <a href="add-trade.html" class="mobile-menu-item primary">
            <i class="fas fa-plus-circle"></i>
            Add New Trade
        </a>
        <button class="mobile-menu-item" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal-overlay" id="editItemModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Plan Item</h2>
                <button class="modal-close" id="closeModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Item Text</label>
                    <input type="text" class="form-input" id="editItemText" placeholder="Enter checklist item">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="editItemCategory">
                        <option value="pre-market">Pre-Market Analysis</option>
                        <option value="risk">Risk Management</option>
                        <option value="execution">Trade Execution</option>
                        <option value="post-market">Post-Market Review</option>
                        <option value="psychology">Trading Psychology</option>
                        <option value="education">Education & Learning</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="form-btn" id="cancelEditBtn">
                        Cancel
                    </button>
                    <button class="form-btn primary" id="saveEditBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">ðŸ“‹ Trading Plan</h1>
            <p class="page-subtitle">Your personalized trading checklist and strategy rules</p>
        </div>

        <!-- Plan Summary -->
        <div class="plan-summary" id="planSummary">
            <div class="loading" id="summaryLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Loading plan summary...</div>
            </div>
            <div id="summaryContent" style="display: none;">
                <div class="summary-stats">
                    <div class="summary-card">
                        <div class="summary-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="summary-value" id="completedItems">0</div>
                        <div class="summary-label">Completed Today</div>
                        <div class="summary-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="completionRate">0%</span> completion rate
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon blue">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="summary-value" id="streakDays">0</div>
                        <div class="summary-label">Day Streak</div>
                        <div class="summary-change positive">
                            <i class="fas fa-fire"></i>
                            Keep going!
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon purple">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="summary-value" id="planEfficiency">0%</div>
                        <div class="summary-label">Plan Efficiency</div>
                        <div class="summary-change positive">
                            <i class="fas fa-trend-up"></i>
                            Vs. last week
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon orange">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="summary-value" id="goalProgress">0%</div>
                        <div class="summary-label">Monthly Goal</div>
                        <div class="summary-change positive">
                            <i class="fas fa-flag"></i>
                            On track
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Checklist -->
        <div class="plan-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Daily Trading Checklist</span>
                </div>
                <div class="section-action" onclick="toggleAddForm()">
                    <i class="fas fa-plus"></i>
                    Add Item
                </div>
            </div>
            
            <div class="checklist">
                <div class="checklist-header">
                    <div class="checklist-title">
                        <i class="fas fa-calendar-day"></i>
                        Today's Plan
                    </div>
                    <div class="checklist-progress" id="checklistProgress">0/0 items</div>
                </div>
                
                <ul class="checklist-items" id="checklistItems">
                    <!-- Checklist items will be populated by JavaScript -->
                </ul>
                
                <!-- Add Item Form (Hidden by default) -->
                <div class="add-item-form" id="addItemForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">New Checklist Item</label>
                        <input type="text" class="form-input" id="newItemText" placeholder="e.g., Review weekly economic calendar">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="newItemCategory">
                            <option value="pre-market">Pre-Market Analysis</option>
                            <option value="risk">Risk Management</option>
                            <option value="execution">Trade Execution</option>
                            <option value="post-market">Post-Market Review</option>
                            <option value="psychology">Trading Psychology</option>
                            <option value="education">Education & Learning</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="form-btn" onclick="toggleAddForm()">
                            Cancel
                        </button>
                        <button class="form-btn primary" onclick="addNewItem()">
                            <i class="fas fa-plus"></i>
                            Add Item
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plan Templates -->
        <div class="plan-templates">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-layer-group"></i>
                    <span>Plan Templates</span>
                </div>
                <div class="section-action" onclick="resetToTemplate('default')">
                    <i class="fas fa-redo"></i>
                    Reset Plan
                </div>
            </div>
            
            <div class="templates-grid">
                <div class="template-card" onclick="applyTemplate('scalping')">
                    <div class="template-icon blue">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="template-title">Scalping Plan</div>
                    <div class="template-description">High-frequency, quick trades with tight stops</div>
                </div>
                
                <div class="template-card" onclick="applyTemplate('swing')">
                    <div class="template-icon green">
                        <i class="fas fa-wave-square"></i>
                    </div>
                    <div class="template-title">Swing Trading</div>
                    <div class="template-description">Multi-day holds, technical analysis focused</div>
                </div>
                
                <div class="template-card" onclick="applyTemplate('day')">
                    <div class="template-icon purple">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="template-title">Day Trading</div>
                    <div class="template-description">Intraday trades, close all positions EOD</div>
                </div>
                
                <div class="template-card" onclick="applyTemplate('risk')">
                    <div class="template-icon orange">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="template-title">Risk Management</div>
                    <div class="template-description">Conservative approach, focus on capital preservation</div>
                </div>
            </div>
        </div>

        <!-- Risk Management Rules -->
        <div class="risk-rules">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-shield-alt"></i>
                    <span>Risk Management Rules</span>
                </div>
                <div class="section-action" onclick="toggleRuleForm()">
                    <i class="fas fa-edit"></i>
                    Edit Rules
                </div>
            </div>
            
            <ul class="rules-list" id="riskRules">
                <!-- Risk rules will be populated by JavaScript -->
            </ul>
        </div>

        <!-- Trading Goals -->
        <div class="trading-goals">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-bullseye"></i>
                    <span>Trading Goals</span>
                </div>
                <div class="section-action" onclick="addNewGoal()">
                    <i class="fas fa-plus"></i>
                    Add Goal
                </div>
            </div>
            
            <ul class="goals-list" id="tradingGoals">
                <!-- Trading goals will be populated by JavaScript -->
            </ul>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-home"></i>
            Dashboard
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='journal.html'">
            <i class="fas fa-book"></i>
            Journal
        </button>
        <button class="bottom-nav-btn active">
            <i class="fas fa-clipboard-list"></i>
            Plan
        </button>
        <button class="bottom-nav-btn" onclick="window.location.href='settings.html'">
            <i class="fas fa-cog"></i>
            Settings
        </button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let dailyPlan = {};
        let tradingPlan = {};
        let editingItemId = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobileRefreshBtn').addEventListener('click', loadTradingPlan);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);
            
            // Modal
            document.getElementById('closeModalBtn').addEventListener('click', closeEditModal);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
            document.getElementById('saveEditBtn').addEventListener('click', saveEditedItem);
            document.getElementById('editItemModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
        }

        // Check Authentication
        function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await initializeTradingPlan();
                    authOverlay.classList.add('hidden');
                } else {
                    authMessage.textContent = 'You need to sign in to access your trading plan';
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            });
        }

        // Initialize Trading Plan
        async function initializeTradingPlan() {
            await loadTradingPlan();
        }

        // Load Trading Plan
        async function loadTradingPlan() {
            try {
                // Show loading state
                document.getElementById('summaryLoading').style.display = 'flex';
                document.getElementById('summaryContent').style.display = 'none';
                
                // Load daily plan
                const today = new Date().toDateString();
                const planRef = database.ref('dailyPlans/' + currentUser.uid + '/' + today);
                
                const snapshot = await planRef.once('value');
                if (snapshot.exists()) {
                    dailyPlan = snapshot.val();
                } else {
                    // Create default plan if none exists
                    dailyPlan = getDefaultDailyPlan();
                    await planRef.set(dailyPlan);
                }
                
                // Load trading plan (persistent rules and goals)
                const tradingPlanRef = database.ref('tradingPlans/' + currentUser.uid);
                const tradingSnapshot = await tradingPlanRef.once('value');
                if (tradingSnapshot.exists()) {
                    tradingPlan = tradingSnapshot.val();
                } else {
                    tradingPlan = getDefaultTradingPlan();
                    await tradingPlanRef.set(tradingPlan);
                }
                
                // Update all sections
                updatePlanSummary();
                updateChecklist();
                updateRiskRules();
                updateTradingGoals();
                
            } catch (error) {
                console.error('Error loading trading plan:', error);
                showError('Failed to load trading plan. Please check your connection and try again.');
            }
        }

        // Get Default Daily Plan
        function getDefaultDailyPlan() {
            const today = new Date().toDateString();
            return {
                date: today,
                completed: 0,
                total: 5,
                items: [
                    { id: 1, text: "Review economic calendar and news", completed: false, category: "pre-market" },
                    { id: 2, text: "Analyze key support/resistance levels", completed: false, category: "pre-market" },
                    { id: 3, text: "Set daily risk limit (max 2%)", completed: false, category: "risk" },
                    { id: 4, text: "Wait for confirmed setups only", completed: false, category: "execution" },
                    { id: 5, text: "Review trades and journal entries", completed: false, category: "post-market" }
                ]
            };
        }

        // Get Default Trading Plan
        function getDefaultTradingPlan() {
            return {
                riskRules: [
                    { id: 1, text: "Maximum 2% risk per trade", active: true },
                    { id: 2, text: "Maximum 5% risk per day", active: true },
                    { id: 3, text: "Stop loss mandatory on every trade", active: true },
                    { id: 4, text: "Minimum 1:1.5 risk-reward ratio", active: true },
                    { id: 5, text: "No revenge trading after losses", active: true }
                ],
                goals: [
                    { 
                        id: 1, 
                        title: "Achieve consistent profitability", 
                        description: "Maintain positive P/L for 3 consecutive months",
                        deadline: "2024-06-30",
                        progress: 40,
                        target: 100
                    },
                    { 
                        id: 2, 
                        title: "Improve win rate to 55%", 
                        description: "Focus on quality over quantity of trades",
                        deadline: "2024-05-30",
                        progress: 60,
                        target: 100
                    },
                    { 
                        id: 3, 
                        title: "Complete trading psychology course", 
                        description: "Master emotional control and discipline",
                        deadline: "2024-04-30",
                        progress: 75,
                        target: 100
                    }
                ],
                templates: {
                    scalping: [
                        "Check 1-minute and 5-minute charts",
                        "Set tight stop losses (5-10 pips)",
                        "Quick entries and exits",
                        "Focus on high liquidity pairs",
                        "Monitor order book depth"
                    ],
                    swing: [
                        "Analyze daily and weekly charts",
                        "Set wider stops (50-100 pips)",
                        "Fundamental analysis review",
                        "Check macroeconomic trends",
                        "Position sizing based on volatility"
                    ],
                    day: [
                        "Review overnight news",
                        "Identify session overlaps",
                        "Set intraday profit targets",
                        "Close all positions before EOD",
                        "No overnight positions"
                    ],
                    risk: [
                        "Risk per trade: 0.5%",
                        "Daily max drawdown: 2%",
                        "Weekly max drawdown: 5%",
                        "Monthly max drawdown: 10%",
                        "Emergency stop: -5% daily"
                    ]
                }
            };
        }

        // Update Plan Summary
        function updatePlanSummary() {
            const completed = dailyPlan.items.filter(item => item.completed).length;
            const total = dailyPlan.items.length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            // Calculate streak (simplified - in real app, track actual streak)
            const streakDays = Math.floor(Math.random() * 14) + 1;
            
            // Calculate plan efficiency (simplified)
            const planEfficiency = Math.min(100, completionRate + 20);
            
            // Calculate goal progress
            const goalProgress = tradingPlan.goals.length > 0 ? 
                Math.round(tradingPlan.goals.reduce((sum, goal) => sum + goal.progress, 0) / tradingPlan.goals.length) : 0;
            
            document.getElementById('completedItems').textContent = completed;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('streakDays').textContent = streakDays;
            document.getElementById('planEfficiency').textContent = planEfficiency + '%';
            document.getElementById('goalProgress').textContent = goalProgress + '%';
            
            document.getElementById('summaryLoading').style.display = 'none';
            document.getElementById('summaryContent').style.display = 'block';
        }

        // Update Checklist
        function updateChecklist() {
            const checklistItems = document.getElementById('checklistItems');
            const progressElement = document.getElementById('checklistProgress');
            
            let completedCount = 0;
            let checklistHTML = '';
            
            // Sort items by category for better organization
            const categories = {
                'pre-market': [],
                'risk': [],
                'execution': [],
                'post-market': [],
                'psychology': [],
                'education': []
            };
            
            dailyPlan.items.forEach(item => {
                if (item.completed) completedCount++;
                if (categories[item.category]) {
                    categories[item.category].push(item);
                } else {
                    categories['execution'].push(item);
                }
            });
            
            // Add category headers and items
            Object.entries(categories).forEach(([category, items]) => {
                if (items.length > 0) {
                    const categoryName = getCategoryName(category);
                    checklistHTML += `
                        <div style="padding: 12px 16px; background-color: var(--notion-gray-light); font-size: 12px; font-weight: 600; color: var(--notion-text-light); border-bottom: 1px solid var(--notion-gray);">
                            <i class="fas fa-${getCategoryIcon(category)}"></i>
                            ${categoryName}
                        </div>
                    `;
                    
                    items.forEach(item => {
                        checklistHTML += `
                            <li class="checklist-item" data-item-id="${item.id}">
                                <div class="checklist-checkbox ${item.completed ? 'checked' : ''}" 
                                     onclick="toggleChecklistItem(${item.id})">
                                    ${item.completed ? '<i class="fas fa-check"></i>' : ''}
                                </div>
                                <div class="checklist-text ${item.completed ? 'completed' : ''}">
                                    ${item.text}
                                </div>
                                <div class="checklist-actions">
                                    <button class="checklist-action-btn edit" onclick="editChecklistItem(${item.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="checklist-action-btn delete" onclick="deleteChecklistItem(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        `;
                    });
                }
            });
            
            checklistItems.innerHTML = checklistHTML;
            progressElement.textContent = `${completedCount}/${dailyPlan.items.length} items`;
            
            // Update completed count in plan object
            dailyPlan.completed = completedCount;
            dailyPlan.total = dailyPlan.items.length;
            
            // Save updated plan
            saveDailyPlan();
        }

        // Get Category Name
        function getCategoryName(category) {
            const names = {
                'pre-market': 'Pre-Market Analysis',
                'risk': 'Risk Management',
                'execution': 'Trade Execution',
                'post-market': 'Post-Market Review',
                'psychology': 'Trading Psychology',
                'education': 'Education & Learning'
            };
            return names[category] || category;
        }

        // Get Category Icon
        function getCategoryIcon(category) {
            const icons = {
                'pre-market': 'search',
                'risk': 'shield-alt',
                'execution': 'play',
                'post-market': 'chart-line',
                'psychology': 'brain',
                'education': 'book'
            };
            return icons[category] || 'check';
        }

        // Toggle Checklist Item
        async function toggleChecklistItem(itemId) {
            const item = dailyPlan.items.find(item => item.id === itemId);
            if (item) {
                item.completed = !item.completed;
                updateChecklist();
                updatePlanSummary();
                await saveDailyPlan();
            }
        }

        // Toggle Add Form
        function toggleAddForm() {
            const form = document.getElementById('addItemForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                document.getElementById('newItemText').focus();
            } else {
                form.style.display = 'none';
                document.getElementById('newItemText').value = '';
            }
        }

        // Add New Item
        async function addNewItem() {
            const text = document.getElementById('newItemText').value.trim();
            const category = document.getElementById('newItemCategory').value;
            
            if (!text) {
                alert('Please enter item text');
                return;
            }
            
            // Generate new ID
            const newId = dailyPlan.items.length > 0 ? 
                Math.max(...dailyPlan.items.map(item => item.id)) + 1 : 1;
            
            const newItem = {
                id: newId,
                text: text,
                category: category,
                completed: false
            };
            
            dailyPlan.items.push(newItem);
            updateChecklist();
            updatePlanSummary();
            
            // Reset form
            document.getElementById('newItemText').value = '';
            toggleAddForm();
            
            await saveDailyPlan();
        }

        // Edit Checklist Item
        function editChecklistItem(itemId) {
            const item = dailyPlan.items.find(item => item.id === itemId);
            if (item) {
                editingItemId = itemId;
                document.getElementById('editItemText').value = item.text;
                document.getElementById('editItemCategory').value = item.category;
                document.getElementById('editItemModal').classList.add('active');
            }
        }

        // Save Edited Item
        async function saveEditedItem() {
            const text = document.getElementById('editItemText').value.trim();
            const category = document.getElementById('editItemCategory').value;
            
            if (!text) {
                alert('Please enter item text');
                return;
            }
            
            const item = dailyPlan.items.find(item => item.id === editingItemId);
            if (item) {
                item.text = text;
                item.category = category;
                updateChecklist();
                closeEditModal();
                await saveDailyPlan();
            }
        }

        // Delete Checklist Item
        async function deleteChecklistItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            dailyPlan.items = dailyPlan.items.filter(item => item.id !== itemId);
            updateChecklist();
            updatePlanSummary();
            await saveDailyPlan();
        }

        // Close Edit Modal
        function closeEditModal() {
            document.getElementById('editItemModal').classList.remove('active');
            editingItemId = null;
        }

        // Save Daily Plan
        async function saveDailyPlan() {
            try {
                const today = new Date().toDateString();
                const planRef = database.ref('dailyPlans/' + currentUser.uid + '/' + today);
                await planRef.set(dailyPlan);
            } catch (error) {
                console.error('Error saving daily plan:', error);
            }
        }

        // Apply Template
        async function applyTemplate(templateName) {
            if (!confirm(`Apply ${templateName} template? This will replace your current checklist.`)) {
                return;
            }
            
            const template = tradingPlan.templates[templateName];
            if (!template) {
                alert('Template not found');
                return;
            }
            
            // Clear current items
            dailyPlan.items = [];
            
            // Add template items
            template.forEach((text, index) => {
                let category = 'execution';
                if (text.toLowerCase().includes('risk') || text.includes('%')) category = 'risk';
                else if (text.toLowerCase().includes('review') || text.toLowerCase().includes('analyze')) category = 'pre-market';
                else if (text.toLowerCase().includes('close') || text.toLowerCase().includes('position')) category = 'post-market';
                
                dailyPlan.items.push({
                    id: index + 1,
                    text: text,
                    category: category,
                    completed: false
                });
            });
            
            updateChecklist();
            updatePlanSummary();
            await saveDailyPlan();
            
            alert(`${templateName.charAt(0).toUpperCase() + templateName.slice(1)} template applied successfully!`);
        }

        // Reset to Default Template
        async function resetToTemplate() {
            if (!confirm('Reset to default plan? This will replace your current checklist.')) {
                return;
            }
            
            dailyPlan = getDefaultDailyPlan();
            updateChecklist();
            updatePlanSummary();
            await saveDailyPlan();
            
            alert('Plan reset to default successfully!');
        }

        // Update Risk Rules
        function updateRiskRules() {
            const rulesList = document.getElementById('riskRules');
            let rulesHTML = '';
            
            tradingPlan.riskRules.forEach(rule => {
                rulesHTML += `
                    <li class="rule-item">
                        <div class="rule-icon ${rule.active ? 'green' : 'orange'}">
                            <i class="fas fa-${rule.active ? 'check' : 'exclamation'}"></i>
                        </div>
                        <div class="rule-content">
                            <div class="rule-text">${rule.text}</div>
                            <div class="rule-status">
                                ${rule.active ? 'Active rule' : 'Rule suspended'}
                            </div>
                        </div>
                        <button class="checklist-action-btn edit" onclick="toggleRiskRule(${rule.id})">
                            <i class="fas fa-toggle-${rule.active ? 'on' : 'off'}"></i>
                        </button>
                    </li>
                `;
            });
            
            rulesList.innerHTML = rulesHTML;
        }

        // Toggle Risk Rule
        async function toggleRiskRule(ruleId) {
            const rule = tradingPlan.riskRules.find(r => r.id === ruleId);
            if (rule) {
                rule.active = !rule.active;
                updateRiskRules();
                await saveTradingPlan();
            }
        }

        // Toggle Rule Form (placeholder for future implementation)
        function toggleRuleForm() {
            alert('Rule editing feature coming soon!');
        }

        // Update Trading Goals
        function updateTradingGoals() {
            const goalsList = document.getElementById('tradingGoals');
            let goalsHTML = '';
            
            tradingPlan.goals.forEach(goal => {
                const deadline = new Date(goal.deadline);
                const now = new Date();
                const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                const progressPercent = Math.min(100, Math.round((goal.progress / goal.target) * 100));
                
                goalsHTML += `
                    <li class="goal-item">
                        <div class="goal-header">
                            <div class="goal-title">${goal.title}</div>
                            <div class="goal-deadline">
                                ${daysRemaining > 0 ? `${daysRemaining}d left` : 'Expired'}
                            </div>
                        </div>
                        <div class="rule-text" style="margin-bottom: 12px;">${goal.description}</div>
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="progress-text">
                                <span>${goal.progress}/${goal.target}</span>
                                <span>${progressPercent}% complete</span>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            goalsList.innerHTML = goalsHTML;
        }

        // Add New Goal (placeholder)
        function addNewGoal() {
            alert('Goal creation feature coming soon!');
        }

        // Save Trading Plan
        async function saveTradingPlan() {
            try {
                const planRef = database.ref('tradingPlans/' + currentUser.uid);
                await planRef.set(tradingPlan);
            } catch (error) {
                console.error('Error saving trading plan:', error);
            }
        }

        // Show Error
        function showError(message) {
            const errorHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="empty-state-title">Plan Error</div>
                    <div class="empty-state-text">
                        ${message}
                    </div>
                    <button onclick="loadTradingPlan()" class="mobile-menu-item primary" style="margin-top: 16px; text-align: center;">
                        <i class="fas fa-redo"></i>
                        Retry Loading
                    </button>
                </div>
            `;
            
            document.getElementById('planSummary').innerHTML = errorHTML;
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout User
        function logoutUser() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            });
        }

        // Expose functions to global scope
        window.toggleChecklistItem = toggleChecklistItem;
        window.toggleAddForm = toggleAddForm;
        window.addNewItem = addNewItem;
        window.editChecklistItem = editChecklistItem;
        window.deleteChecklistItem = deleteChecklistItem;
        window.applyTemplate = applyTemplate;
        window.resetToTemplate = resetToTemplate;
        window.toggleRiskRule = toggleRiskRule;
        window.toggleRuleForm = toggleRuleForm;
        window.addNewGoal = addNewGoal;
        window.toggleMobileMenu = toggleMobileMenu;
        window.logoutUser = logoutUser;
        window.loadTradingPlan = loadTradingPlan;
    </script>
</body>
</html>
