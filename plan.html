<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Plan - ICT Scalping Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--notion-gray);
            border-top-color: var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .auth-message {
            font-size: 18px;
            color: var(--notion-text);
            margin-bottom: 20px;
            max-width: 400px;
        }

        .auth-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .auth-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        .auth-btn.secondary {
            background-color: var(--notion-gray);
            color: var(--notion-text);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 16px;
            font-size: 13px;
            color: var(--notion-text-light);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--notion-blue), var(--notion-purple));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sync-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sync-status.syncing {
            background-color: var(--notion-yellow-light);
            color: var(--notion-yellow);
        }

        .sync-status.synced {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .sync-status.error {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .header-btn {
            padding: 4px 12px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background-color: var(--notion-gray-dark);
        }

        .header-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        .header-btn.primary:hover {
            background-color: #0a7ac9;
        }

        .header-btn.green {
            background-color: var(--notion-green);
            color: white;
        }

        .header-btn.green:hover {
            background-color: #0d6a5d;
        }

        .header-btn.logout {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
            border: 1px solid var(--notion-red);
        }

        .header-btn.logout:hover {
            background-color: var(--notion-red);
            color: white;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            margin-left: auto;
        }

        /* Mobile Menu */
        .mobile-menu {
            display: none;
            position: fixed;
            top: 45px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            flex-direction: column;
            gap: 8px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu .header-btn {
            width: 100%;
            justify-content: center;
            padding: 10px 16px;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 60px auto 20px;
            padding: 0 20px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--notion-text);
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--notion-text-light);
            margin-bottom: 24px;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 12px 24px;
            background-color: var(--notion-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .quick-action-btn:hover {
            background-color: #0a7ac9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(12, 140, 233, 0.2);
        }

        .quick-action-btn.green {
            background-color: var(--notion-green);
        }

        .quick-action-btn.green:hover {
            background-color: #0d6a5d;
        }

        .quick-action-btn.orange {
            background-color: var(--notion-orange);
        }

        .quick-action-btn.orange:hover {
            background-color: #e55a2b;
        }

        .quick-action-btn.purple {
            background-color: var(--notion-purple);
        }

        .quick-action-btn.purple:hover {
            background-color: #5d3894;
        }

        /* Trading Plan Grid */
        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .plan-section {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .plan-section:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--notion-blue);
        }

        .edit-btn {
            background: none;
            border: none;
            color: var(--notion-text-light);
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background-color: var(--notion-gray);
            color: var(--notion-text);
        }

        /* Plan Content */
        .plan-content {
            min-height: 200px;
        }

        .plan-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--notion-gray-light);
        }

        .plan-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .item-label {
            font-size: 14px;
            color: var(--notion-text-light);
            margin-bottom: 4px;
        }

        .item-value {
            font-size: 15px;
            color: var(--notion-text);
            font-weight: 500;
        }

        .item-value.multiline {
            white-space: pre-line;
            line-height: 1.6;
        }

        /* Setup Templates */
        .templates-section {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            background-color: var(--notion-gray-light);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--notion-blue);
            transition: all 0.3s ease;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .template-card.green {
            border-left-color: var(--notion-green);
        }

        .template-card.purple {
            border-left-color: var(--notion-purple);
        }

        .template-card.orange {
            border-left-color: var(--notion-orange);
        }

        .template-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .template-name {
            font-weight: 600;
            font-size: 16px;
        }

        .template-stats {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            font-size: 13px;
        }

        .template-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: 700;
        }

        .stat-value.positive {
            color: var(--notion-green);
        }

        .stat-value.negative {
            color: var(--notion-red);
        }

        .stat-label {
            font-size: 11px;
            color: var(--notion-text-light);
        }

        /* Trading Rules */
        .rules-section {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .rules-list {
            list-style: none;
            margin-top: 20px;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--notion-gray-light);
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        .rule-icon {
            color: var(--notion-green);
            font-size: 14px;
            margin-top: 2px;
            min-width: 20px;
        }

        .rule-text {
            flex: 1;
            font-size: 14px;
        }

        /* Journal Notes */
        .notes-section {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .notes-editor {
            margin-top: 20px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--notion-blue);
        }

        .notes-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--notion-text-light);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background-color: var(--notion-gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--notion-blue);
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--notion-blue);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--notion-blue);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.success {
            background-color: var(--notion-green);
        }

        .notification.error {
            background-color: var(--notion-red);
        }

        .notification.info {
            background-color: var(--notion-blue);
        }

        .notification.warning {
            background-color: var(--notion-orange);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--notion-text-light);
        }

        .loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--notion-text-light);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--notion-gray-dark);
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 45px auto 20px;
                padding: 0 16px;
            }
            
            .plan-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .quick-action-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .header-actions {
                display: none;
            }
            
            .sync-status {
                display: none;
            }
            
            .header-title {
                font-size: 13px;
                max-width: 150px;
            }
            
            .user-info {
                display: none;
            }
            
            .templates-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .mobile-menu-btn {
                font-size: 16px;
            }
            
            .header-title {
                font-size: 12px;
                max-width: 120px;
            }
            
            .mobile-menu .header-btn {
                font-size: 14px;
            }
            
            .quick-action-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .page-title {
                font-size: 24px;
            }
        }

        /* User Profile Dropdown */
        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 101;
            display: none;
            margin-top: 8px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--notion-gray);
            background-color: var(--notion-gray-light);
        }

        .dropdown-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--notion-text);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: var(--notion-gray-light);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--notion-gray);
            margin: 4px 0;
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--notion-gray);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--notion-green);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--notion-text);
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="authMessage">Checking authentication...</div>
        <div class="auth-buttons" id="authButtons" style="display: none;">
            <button class="auth-btn primary" id="goToLoginBtn">Go to Login</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="workspace-icon" style="width: 20px; height: 20px; background-color: var(--notion-blue); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">T</div>
        <div class="header-title">ICT Scalping Journal - Trading Plan</div>
        
        <!-- User Info -->
        <div class="user-info" id="userInfo">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">User</span>
        </div>
        
        <!-- Desktop Header Actions -->
        <div class="header-actions">
            <div class="sync-status synced" id="syncStatus">
                <i class="fas fa-cloud"></i> Synced
            </div>
            <a href="dashboard.html" class="header-btn">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a>
            <a href="add-trade.html" class="header-btn primary">
                <i class="fas fa-plus"></i> Add Trade
            </a>
            <a href="AllTrades.html" class="header-btn">
                <i class="fas fa-table"></i> All Trades
            </a>
            <div class="user-dropdown">
                <button class="header-btn" id="userMenuBtn">
                    <i class="fas fa-user"></i> Account
                </button>
                <div class="dropdown-menu" id="userDropdown">
                    <div class="dropdown-header">
                        <strong id="dropdownUserName">User Name</strong>
                        <div style="font-size: 12px; color: var(--notion-text-light);" id="dropdownUserEmail">user@example.com</div>
                    </div>
                    <button class="dropdown-item" id="profileBtn">
                        <i class="fas fa-user-circle"></i> My Profile
                    </button>
                    <button class="dropdown-item" id="settingsBtn">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="dropdownLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="sync-status synced">
            <i class="fas fa-cloud"></i> Synced
        </div>
        <a href="dashboard.html" class="header-btn">
            <i class="fas fa-chart-bar"></i> Dashboard
        </a>
        <a href="add-trade.html" class="header-btn primary">
            <i class="fas fa-plus"></i> Add Trade
        </a>
        <a href="AllTrades.html" class="header-btn">
            <i class="fas fa-table"></i> All Trades
        </a>
        <button class="header-btn logout" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="greetingTitle">ICT Scalping Trading Plan</h1>
            <p class="page-subtitle" id="greetingSubtitle">Define your trading strategy, rules, and risk management</p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="add-trade.html" class="quick-action-btn">
                <i class="fas fa-plus"></i> Add New Trade
            </a>
            <a href="dashboard.html" class="quick-action-btn green">
                <i class="fas fa-chart-line"></i> View Dashboard
            </a>
            <button class="quick-action-btn purple" id="saveAllBtn">
                <i class="fas fa-save"></i> Save All Changes
            </button>
            <button class="quick-action-btn orange" id="resetBtn">
                <i class="fas fa-redo"></i> Reset to Default
            </button>
        </div>

        <!-- Trading Plan Grid -->
        <div class="plan-grid">
            <!-- Risk Management -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-shield-alt"></i> Risk Management
                    </div>
                    <button class="edit-btn" onclick="openModal('risk')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="riskContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Trading Session -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-clock"></i> Trading Session
                    </div>
                    <button class="edit-btn" onclick="openModal('session')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="sessionContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Currency Pairs -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-money-bill-wave"></i> Currency Pairs
                    </div>
                    <button class="edit-btn" onclick="openModal('pairs')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="pairsContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Entry Criteria -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-sign-in-alt"></i> Entry Criteria
                    </div>
                    <button class="edit-btn" onclick="openModal('entry')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="entryContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Exit Strategy -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-sign-out-alt"></i> Exit Strategy
                    </div>
                    <button class="edit-btn" onclick="openModal('exit')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="exitContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Psychology Rules -->
            <div class="plan-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-brain"></i> Psychology Rules
                    </div>
                    <button class="edit-btn" onclick="openModal('psychology')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div class="plan-content" id="psychologyContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup Templates -->
        <div class="templates-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-cube"></i> Setup Templates
                </div>
                <button class="edit-btn" onclick="openModal('templates')">
                    <i class="fas fa-plus"></i> Add Template
                </button>
            </div>
            <div class="templates-grid" id="templatesGrid">
                <!-- Templates will be loaded here -->
            </div>
        </div>

        <!-- Trading Rules -->
        <div class="rules-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-gavel"></i> Trading Rules
                </div>
                <button class="edit-btn" onclick="openModal('rules')">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
            <ul class="rules-list" id="rulesList">
                <!-- Rules will be loaded here -->
            </ul>
        </div>

        <!-- Journal Notes -->
        <div class="notes-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-book"></i> Trading Journal Notes
                </div>
            </div>
            <div class="notes-editor">
                <textarea class="notes-textarea" id="journalNotes" placeholder="Write your trading insights, lessons learned, and improvement ideas here..."></textarea>
                <div class="notes-actions">
                    <button class="header-btn" id="clearNotesBtn">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="header-btn primary" id="saveNotesBtn">
                        <i class="fas fa-save"></i> Save Notes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modals -->
    <div class="modal" id="riskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-shield-alt"></i> Risk Management
                </div>
                <button class="close-btn" onclick="closeModal('risk')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Daily Loss</label>
                <input type="text" class="form-input" id="maxDailyLoss" placeholder="e.g., $500 or 5%">
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Trade Risk</label>
                <input type="text" class="form-input" id="maxTradeRisk" placeholder="e.g., $100 or 2%">
            </div>
            <div class="form-group">
                <label class="form-label">Risk Per Trade (% of Account)</label>
                <input type="number" class="form-input" id="riskPerTradePercent" min="0.1" max="10" step="0.1" placeholder="e.g., 1.5">
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Consecutive Losses Before Stop</label>
                <input type="number" class="form-input" id="maxConsecutiveLosses" min="1" max="10" placeholder="e.g., 3">
            </div>
            <div class="form-group">
                <label class="form-label">Risk Management Notes</label>
                <textarea class="form-textarea" id="riskNotes" placeholder="Additional risk management rules..."></textarea>
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('risk')">Cancel</button>
                <button class="header-btn primary" onclick="saveRiskManagement()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="sessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-clock"></i> Trading Session
                </div>
                <button class="close-btn" onclick="closeModal('session')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Primary Trading Session</label>
                <select class="form-select" id="primarySession">
                    <option value="London">London (07:00 - 16:00 GMT)</option>
                    <option value="New York">New York (12:00 - 21:00 GMT)</option>
                    <option value="Asian">Asian (23:00 - 08:00 GMT)</option>
                    <option value="Sydney">Sydney (21:00 - 06:00 GMT)</option>
                    <option value="Overlap">London-New York Overlap</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Secondary Session (Optional)</label>
                <select class="form-select" id="secondarySession">
                    <option value="">None</option>
                    <option value="London">London</option>
                    <option value="New York">New York</option>
                    <option value="Asian">Asian</option>
                    <option value="Sydney">Sydney</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Trading Days</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="monday" checked>
                        <label class="checkbox-label" for="monday">Monday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="tuesday" checked>
                        <label class="checkbox-label" for="tuesday">Tuesday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wednesday" checked>
                        <label class="checkbox-label" for="wednesday">Wednesday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="thursday" checked>
                        <label class="checkbox-label" for="thursday">Thursday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="friday" checked>
                        <label class="checkbox-label" for="friday">Friday</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Trading Hours Per Day</label>
                <input type="number" class="form-input" id="maxTradingHours" min="1" max="12" placeholder="e.g., 4">
            </div>
            <div class="form-group">
                <label class="form-label">Break Time (minutes between sessions)</label>
                <input type="number" class="form-input" id="breakTime" min="5" max="120" placeholder="e.g., 30">
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('session')">Cancel</button>
                <button class="header-btn primary" onclick="saveTradingSession()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="pairsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-money-bill-wave"></i> Currency Pairs
                </div>
                <button class="close-btn" onclick="closeModal('pairs')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Primary Pairs (Main Focus)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="eurusd" checked>
                        <label class="checkbox-label" for="eurusd">EUR/USD</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="gbpusd" checked>
                        <label class="checkbox-label" for="gbpusd">GBP/USD</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="usdjpy">
                        <label class="checkbox-label" for="usdjpy">USD/JPY</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="audusd">
                        <label class="checkbox-label" for="audusd">AUD/USD</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="usdcad">
                        <label class="checkbox-label" for="usdcad">USD/CAD</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Pairs Per Session</label>
                <input type="number" class="form-input" id="maxPairsPerSession" min="1" max="5" placeholder="e.g., 3">
            </div>
            <div class="form-group">
                <label class="form-label">Pair Selection Criteria</label>
                <textarea class="form-textarea" id="pairCriteria" placeholder="How do you select which pairs to trade?"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Avoid News Trading (High Impact)</label>
                <label class="switch">
                    <input type="checkbox" id="avoidNews">
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 10px; font-size: 14px;">Avoid trading 30 minutes before/after high-impact news</span>
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('pairs')">Cancel</button>
                <button class="header-btn primary" onclick="saveCurrencyPairs()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="entryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sign-in-alt"></i> Entry Criteria
                </div>
                <button class="close-btn" onclick="closeModal('entry')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">ICT Concepts Used</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="fvg">
                        <label class="checkbox-label" for="fvg">Fair Value Gap (FVG)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ob">
                        <label class="checkbox-label" for="ob">Order Block</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="bos">
                        <label class="checkbox-label" for="bos">Break of Structure (BOS)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="choch">
                        <label class="checkbox-label" for="choch">Change of Character (CHoCH)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="liquidity">
                        <label class="checkbox-label" for="liquidity">Liquidity Grab</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mitigation">
                        <label class="checkbox-label" for="mitigation">Mitigation Block</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Timeframe Analysis</label>
                <textarea class="form-textarea" id="timeframeAnalysis" placeholder="e.g., 15M for entry, 1H for direction, 4H for context"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Confirmation Required</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="priceAction" checked>
                        <label class="checkbox-label" for="priceAction">Price Action Confirmation</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="marketStructure">
                        <label class="checkbox-label" for="marketStructure">Market Structure Alignment</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="momentum">
                        <label class="checkbox-label" for="momentum">Momentum Confirmation</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="volume">
                        <label class="checkbox-label" for="volume">Volume Confirmation</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Minimum R:R Ratio for Entry</label>
                <input type="text" class="form-input" id="minRR" placeholder="e.g., 1:2 or 1.5">
            </div>
            <div class="form-group">
                <label class="form-label">Entry Rules</label>
                <textarea class="form-textarea" id="entryRules" placeholder="Detailed entry rules..."></textarea>
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('entry')">Cancel</button>
                <button class="header-btn primary" onclick="saveEntryCriteria()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="exitModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sign-out-alt"></i> Exit Strategy
                </div>
                <button class="close-btn" onclick="closeModal('exit')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Take Profit Levels</label>
                <textarea class="form-textarea" id="takeProfitLevels" placeholder="e.g., TP1 at 1:1, TP2 at 1:2, TP3 at 1:3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Stop Loss Placement</label>
                <textarea class="form-textarea" id="stopLossPlacement" placeholder="e.g., Below/above FVG, beyond recent swing high/low"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Breakeven Rules</label>
                <textarea class="form-textarea" id="breakevenRules" placeholder="When to move stop loss to breakeven..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Trailing Stop Rules</label>
                <textarea class="form-textarea" id="trailingStopRules" placeholder="When and how to trail stop..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Exit Conditions</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="targetHit" checked>
                        <label class="checkbox-label" for="targetHit">Target Hit</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="structureBreak">
                        <label class="checkbox-label" for="structureBreak">Market Structure Break</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="timeExit">
                        <label class="checkbox-label" for="timeExit">Time-based Exit (e.g., end of session)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="newsExit">
                        <label class="checkbox-label" for="newsExit">Exit Before High-Impact News</label>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('exit')">Cancel</button>
                <button class="header-btn primary" onclick="saveExitStrategy()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="psychologyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-brain"></i> Psychology Rules
                </div>
                <button class="close-btn" onclick="closeModal('psychology')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Maximum Emotional Score for Trading</label>
                <input type="number" class="form-input" id="maxEmotionScore" min="1" max="10" placeholder="e.g., 7 (1=calm, 10=emotional)">
            </div>
            <div class="form-group">
                <label class="form-label">After Loss Rules</label>
                <textarea class="form-textarea" id="afterLossRules" placeholder="What to do after a loss..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">After Win Rules</label>
                <textarea class="form-textarea" id="afterWinRules" placeholder="What to do after a win..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Breathing/Relaxation Techniques</label>
                <textarea class="form-textarea" id="relaxationTechniques" placeholder="Techniques to stay calm..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Pre-Trade Routine</label>
                <textarea class="form-textarea" id="preTradeRoutine" placeholder="Routine before starting to trade..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Post-Trade Review</label>
                <textarea class="form-textarea" id="postTradeReview" placeholder="Routine after closing a trade..."></textarea>
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('psychology')">Cancel</button>
                <button class="header-btn primary" onclick="savePsychologyRules()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="templatesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-cube"></i> Setup Template
                </div>
                <button class="close-btn" onclick="closeModal('templates')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Template Name</label>
                <input type="text" class="form-input" id="templateName" placeholder="e.g., FVG Buy Setup, BOS Sell Setup">
            </div>
            <div class="form-group">
                <label class="form-label">Setup Description</label>
                <textarea class="form-textarea" id="templateDescription" placeholder="Describe the setup conditions..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Entry Conditions</label>
                <textarea class="form-textarea" id="templateEntry" placeholder="Specific entry conditions..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Stop Loss</label>
                <textarea class="form-textarea" id="templateSL" placeholder="Stop loss rules..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Take Profit</label>
                <textarea class="form-textarea" id="templateTP" placeholder="Take profit rules..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Expected R:R</label>
                <input type="text" class="form-input" id="templateRR" placeholder="e.g., 1:2 or 1.5">
            </div>
            <div class="form-group">
                <label class="form-label">Success Rate Estimate (%)</label>
                <input type="number" class="form-input" id="templateSuccessRate" min="1" max="100" placeholder="e.g., 65">
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('templates')">Cancel</button>
                <button class="header-btn primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-gavel"></i> Trading Rules
                </div>
                <button class="close-btn" onclick="closeModal('rules')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Add New Rule</label>
                <input type="text" class="form-input" id="newRule" placeholder="e.g., Never add to a losing position">
            </div>
            <div class="form-actions">
                <button class="header-btn" onclick="closeModal('rules')">Cancel</button>
                <button class="header-btn primary" onclick="addTradingRule()">Add Rule</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let tradingPlan = null;
        let unsavedChanges = false;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Check Authentication
        async function checkAuthentication() {
            const authOverlay = document.getElementById('authOverlay');
            const authMessage = document.getElementById('authMessage');
            const authButtons = document.getElementById('authButtons');
            
            try {
                // Check Firebase auth state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;
                        await initializePage();
                        authOverlay.classList.add('hidden');
                    } else {
                        // No user signed in
                        authMessage.textContent = 'You need to sign in to access the trading plan';
                        authButtons.style.display = 'flex';
                        
                        // Setup auth button
                        document.getElementById('goToLoginBtn').onclick = () => {
                            window.location.href = 'index.html';
                        };
                    }
                });

            } catch (error) {
                console.error('Auth check error:', error);
                authMessage.textContent = 'Error checking authentication. Please try again.';
                authButtons.style.display = 'flex';
            }
        }

        // Initialize Page
        async function initializePage() {
            if (!currentUser) return;
            
            // Update user info
            updateUserInfo();
            
            // Setup Firebase connection
            setupFirebase();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load trading plan data
            await loadTradingPlan();
        }

        // Update User Information
        function updateUserInfo() {
            if (!currentUser) return;
            
            const userName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader';
            const userEmail = currentUser.email || 'user@example.com';
            const avatarLetter = userName.charAt(0).toUpperCase();
            
            // Update UI elements
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = avatarLetter;
            document.getElementById('dropdownUserName').textContent = userName;
            document.getElementById('dropdownUserEmail').textContent = userEmail;
            document.getElementById('greetingTitle').textContent = `${userName}'s ICT Scalping Trading Plan`;
        }

        // Setup Firebase Connection
        function setupFirebase() {
            updateSyncStatus('Connecting to Firebase...', 'syncing');
            
            // Check connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    updateSyncStatus('Connected to Firebase', 'synced');
                } else {
                    updateSyncStatus('Offline - Using cached data', 'error');
                }
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // User dropdown
            document.getElementById('userMenuBtn').addEventListener('click', toggleUserDropdown);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('userDropdown');
                const menuBtn = document.getElementById('userMenuBtn');
                
                if (dropdown.classList.contains('show') && 
                    !dropdown.contains(event.target) && 
                    !menuBtn.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Dropdown items
            document.getElementById('profileBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('Profile page coming soon!', 'info');
                document.getElementById('userDropdown').classList.remove('show');
            });
            
            document.getElementById('settingsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('Settings page coming soon!', 'info');
                document.getElementById('userDropdown').classList.remove('show');
            });
            
            document.getElementById('dropdownLogoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                logoutUser();
                document.getElementById('userDropdown').classList.remove('show');
            });

            // Mobile Logout Button
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);

            // Mobile Menu Toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (mobileMenu.classList.contains('active') && 
                    !mobileMenu.contains(event.target) && 
                    !mobileMenuBtn.contains(event.target)) {
                    mobileMenu.classList.remove('active');
                }
            });

            // Quick Actions
            document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);
            document.getElementById('resetBtn').addEventListener('click', resetToDefault);

            // Notes Actions
            document.getElementById('saveNotesBtn').addEventListener('click', saveJournalNotes);
            document.getElementById('clearNotesBtn').addEventListener('click', clearJournalNotes);

            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (unsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        // Toggle User Dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout Function
        async function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    
                    // Clear localStorage
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userUid');
                    
                    showNotification('Logged out successfully', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('Logout failed: ' + error.message, 'error');
                }
            }
        }

        // Load Trading Plan
        async function loadTradingPlan() {
            try {
                if (!currentUser) return;

                updateSyncStatus('Loading trading plan...', 'syncing');

                // Load trading plan from Firebase
                const snapshot = await database.ref('userTradingPlans/' + currentUser.uid).once('value');
                
                if (snapshot.exists()) {
                    tradingPlan = snapshot.val();
                } else {
                    // Create default trading plan
                    tradingPlan = createDefaultTradingPlan();
                    await saveTradingPlanToFirebase();
                }

                // Update UI with loaded data
                updatePlanUI();
                loadTemplates();
                loadTradingRules();
                loadJournalNotes();

                updateSyncStatus('Trading plan loaded', 'synced');

            } catch (error) {
                console.error('Error loading trading plan:', error);
                updateSyncStatus('Failed to load plan', 'error');
                showNotification('Failed to load trading plan', 'error');
                
                // Show default plan
                tradingPlan = createDefaultTradingPlan();
                updatePlanUI();
            }
        }

        // Create Default Trading Plan
        function createDefaultTradingPlan() {
            return {
                riskManagement: {
                    maxDailyLoss: "$500 or 5%",
                    maxTradeRisk: "$100 or 2%",
                    riskPerTradePercent: 1.5,
                    maxConsecutiveLosses: 3,
                    notes: "Never risk more than 2% per trade. Stop trading after 3 consecutive losses."
                },
                tradingSession: {
                    primarySession: "London",
                    secondarySession: "New York",
                    tradingDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
                    maxTradingHours: 4,
                    breakTime: 30
                },
                currencyPairs: {
                    primaryPairs: ["EUR/USD", "GBP/USD"],
                    maxPairsPerSession: 2,
                    pairCriteria: "Focus on pairs with clear market structure and good liquidity",
                    avoidNews: true
                },
                entryCriteria: {
                    ictConcepts: ["FVG", "Order Block", "BOS"],
                    timeframeAnalysis: "15M for entry, 1H for direction, 4H for context",
                    confirmationRequired: ["Price Action Confirmation", "Market Structure Alignment"],
                    minRR: "1:2",
                    entryRules: "Wait for price to confirm FVG or order block. Enter on retest with momentum confirmation."
                },
                exitStrategy: {
                    takeProfitLevels: "TP1 at 1:1, TP2 at 1:2, TP3 at 1:3",
                    stopLossPlacement: "Below/above FVG, beyond recent swing high/low",
                    breakevenRules: "Move to breakeven when price reaches 1:1 R:R",
                    trailingStopRules: "Trail stop at 1:2 and 1:3 levels",
                    exitConditions: ["Target Hit", "Market Structure Break"]
                },
                psychologyRules: {
                    maxEmotionScore: 7,
                    afterLossRules: "Take a 15-minute break. Review trade without emotion. Stick to the plan.",
                    afterWinRules: "Don't get overconfident. Stick to the plan.",
                    relaxationTechniques: "Deep breathing: 4-7-8 technique before entering trades",
                    preTradeRoutine: "Check market context, review plan, set alerts, check emotions",
                    postTradeReview: "Analyze trade objectively, note lessons, update journal"
                },
                templates: [],
                tradingRules: [
                    "Never risk more than 2% per trade",
                    "Stop trading after 3 consecutive losses",
                    "Follow the trading plan strictly",
                    "No revenge trading",
                    "Keep a trading journal for every trade",
                    "Review trades weekly",
                    "Take breaks when tired or emotional"
                ],
                journalNotes: "",
                lastUpdated: Date.now()
            };
        }

        // Update Plan UI
        function updatePlanUI() {
            if (!tradingPlan) return;

            // Risk Management
            updateRiskManagementUI();
            
            // Trading Session
            updateTradingSessionUI();
            
            // Currency Pairs
            updateCurrencyPairsUI();
            
            // Entry Criteria
            updateEntryCriteriaUI();
            
            // Exit Strategy
            updateExitStrategyUI();
            
            // Psychology Rules
            updatePsychologyRulesUI();
        }

        // Update Risk Management UI
        function updateRiskManagementUI() {
            const risk = tradingPlan.riskManagement;
            const content = document.getElementById('riskContent');
            
            content.innerHTML = `
                <div class="plan-item">
                    <div class="item-label">Maximum Daily Loss</div>
                    <div class="item-value">${risk.maxDailyLoss}</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Maximum Trade Risk</div>
                    <div class="item-value">${risk.maxTradeRisk}</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Risk Per Trade</div>
                    <div class="item-value">${risk.riskPerTradePercent}% of account</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Stop After Losses</div>
                    <div class="item-value">Stop trading after ${risk.maxConsecutiveLosses} consecutive losses</div>
                </div>
                ${risk.notes ? `
                <div class="plan-item">
                    <div class="item-label">Notes</div>
                    <div class="item-value multiline">${risk.notes}</div>
                </div>` : ''}
            `;
        }

        // Update Trading Session UI
        function updateTradingSessionUI() {
            const session = tradingPlan.tradingSession;
            const content = document.getElementById('sessionContent');
            
            const days = session.tradingDays.join(', ');
            
            content.innerHTML = `
                <div class="plan-item">
                    <div class="item-label">Primary Session</div>
                    <div class="item-value">${session.primarySession}</div>
                </div>
                ${session.secondarySession ? `
                <div class="plan-item">
                    <div class="item-label">Secondary Session</div>
                    <div class="item-value">${session.secondarySession}</div>
                </div>` : ''}
                <div class="plan-item">
                    <div class="item-label">Trading Days</div>
                    <div class="item-value">${days}</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Maximum Hours/Day</div>
                    <div class="item-value">${session.maxTradingHours} hours</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Break Time</div>
                    <div class="item-value">${session.breakTime} minutes between sessions</div>
                </div>
            `;
        }

        // Update Currency Pairs UI
        function updateCurrencyPairsUI() {
            const pairs = tradingPlan.currencyPairs;
            const content = document.getElementById('pairsContent');
            
            const primaryPairs = Array.isArray(pairs.primaryPairs) ? pairs.primaryPairs.join(', ') : pairs.primaryPairs;
            
            content.innerHTML = `
                <div class="plan-item">
                    <div class="item-label">Primary Pairs</div>
                    <div class="item-value">${primaryPairs}</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Max Pairs/Session</div>
                    <div class="item-value">${pairs.maxPairsPerSession}</div>
                </div>
                ${pairs.pairCriteria ? `
                <div class="plan-item">
                    <div class="item-label">Selection Criteria</div>
                    <div class="item-value multiline">${pairs.pairCriteria}</div>
                </div>` : ''}
                <div class="plan-item">
                    <div class="item-label">Avoid News Trading</div>
                    <div class="item-value">${pairs.avoidNews ? 'Yes' : 'No'}</div>
                </div>
            `;
        }

        // Update Entry Criteria UI
        function updateEntryCriteriaUI() {
            const entry = tradingPlan.entryCriteria;
            const content = document.getElementById('entryContent');
            
            const concepts = Array.isArray(entry.ictConcepts) ? entry.ictConcepts.join(', ') : entry.ictConcepts;
            const confirmations = Array.isArray(entry.confirmationRequired) ? entry.confirmationRequired.join(', ') : entry.confirmationRequired;
            
            content.innerHTML = `
                <div class="plan-item">
                    <div class="item-label">ICT Concepts</div>
                    <div class="item-value">${concepts}</div>
                </div>
                ${entry.timeframeAnalysis ? `
                <div class="plan-item">
                    <div class="item-label">Timeframe Analysis</div>
                    <div class="item-value multiline">${entry.timeframeAnalysis}</div>
                </div>` : ''}
                <div class="plan-item">
                    <div class="item-label">Confirmation Required</div>
                    <div class="item-value">${confirmations}</div>
                </div>
                <div class="plan-item">
                    <div class="item-label">Minimum R:R</div>
                    <div class="item-value">${entry.minRR}</div>
                </div>
                ${entry.entryRules ? `
                <div class="plan-item">
                    <div class="item-label">Entry Rules</div>
                    <div class="item-value multiline">${entry.entryRules}</div>
                </div>` : ''}
            `;
        }

        // Update Exit Strategy UI
        function updateExitStrategyUI() {
            const exit = tradingPlan.exitStrategy;
            const content = document.getElementById('exitContent');
            
            const conditions = Array.isArray(exit.exitConditions) ? exit.exitConditions.join(', ') : exit.exitConditions;
            
            content.innerHTML = `
                ${exit.takeProfitLevels ? `
                <div class="plan-item">
                    <div class="item-label">Take Profit Levels</div>
                    <div class="item-value multiline">${exit.takeProfitLevels}</div>
                </div>` : ''}
                ${exit.stopLossPlacement ? `
                <div class="plan-item">
                    <div class="item-label">Stop Loss Placement</div>
                    <div class="item-value multiline">${exit.stopLossPlacement}</div>
                </div>` : ''}
                ${exit.breakevenRules ? `
                <div class="plan-item">
                    <div class="item-label">Breakeven Rules</div>
                    <div class="item-value multiline">${exit.breakevenRules}</div>
                </div>` : ''}
                ${exit.trailingStopRules ? `
                <div class="plan-item">
                    <div class="item-label">Trailing Stop Rules</div>
                    <div class="item-value multiline">${exit.trailingStopRules}</div>
                </div>` : ''}
                <div class="plan-item">
                    <div class="item-label">Exit Conditions</div>
                    <div class="item-value">${conditions}</div>
                </div>
            `;
        }

        // Update Psychology Rules UI
        function updatePsychologyRulesUI() {
            const psychology = tradingPlan.psychologyRules;
            const content = document.getElementById('psychologyContent');
            
            content.innerHTML = `
                <div class="plan-item">
                    <div class="item-label">Max Emotion Score</div>
                    <div class="item-value">${psychology.maxEmotionScore}/10 (1=calm, 10=emotional)</div>
                </div>
                ${psychology.afterLossRules ? `
                <div class="plan-item">
                    <div class="item-label">After Loss Rules</div>
                    <div class="item-value multiline">${psychology.afterLossRules}</div>
                </div>` : ''}
                ${psychology.afterWinRules ? `
                <div class="plan-item">
                    <div class="item-label">After Win Rules</div>
                    <div class="item-value multiline">${psychology.afterWinRules}</div>
                </div>` : ''}
                ${psychology.relaxationTechniques ? `
                <div class="plan-item">
                    <div class="item-label">Relaxation Techniques</div>
                    <div class="item-value multiline">${psychology.relaxationTechniques}</div>
                </div>` : ''}
                ${psychology.preTradeRoutine ? `
                <div class="plan-item">
                    <div class="item-label">Pre-Trade Routine</div>
                    <div class="item-value multiline">${psychology.preTradeRoutine}</div>
                </div>` : ''}
                ${psychology.postTradeReview ? `
                <div class="plan-item">
                    <div class="item-label">Post-Trade Review</div>
                    <div class="item-value multiline">${psychology.postTradeReview}</div>
                </div>` : ''}
            `;
        }

        // Load Templates
        function loadTemplates() {
            const templates = tradingPlan.templates || [];
            const grid = document.getElementById('templatesGrid');
            
            if (templates.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="empty-text">No setup templates yet. Create your first template!</div>
                        <button class="header-btn primary" onclick="openModal('templates')" style="margin-top: 12px;">
                            <i class="fas fa-plus"></i> Create Template
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            const colors = ['', 'green', 'purple', 'orange'];
            
            templates.forEach((template, index) => {
                const colorClass = colors[index % colors.length];
                
                html += `
                    <div class="template-card ${colorClass}">
                        <div class="template-header">
                            <div class="template-name">${template.name}</div>
                            <button class="edit-btn" onclick="editTemplate(${index})" style="font-size: 12px;">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div style="font-size: 13px; color: var(--notion-text-light); margin-bottom: 8px;">
                            ${template.description.substring(0, 100)}${template.description.length > 100 ? '...' : ''}
                        </div>
                        <div class="template-stats">
                            <div class="template-stat">
                                <div class="stat-value">${template.rr}</div>
                                <div class="stat-label">R:R</div>
                            </div>
                            <div class="template-stat">
                                <div class="stat-value ${template.successRate >= 50 ? 'positive' : 'negative'}">${template.successRate}%</div>
                                <div class="stat-label">Success</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // Load Trading Rules
        function loadTradingRules() {
            const rules = tradingPlan.tradingRules || [];
            const list = document.getElementById('rulesList');
            
            if (rules.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-text">No trading rules yet. Add your first rule!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            rules.forEach((rule, index) => {
                html += `
                    <li class="rule-item">
                        <i class="fas fa-check-circle rule-icon"></i>
                        <div class="rule-text">${rule}</div>
                        <button class="edit-btn" onclick="removeRule(${index})" style="font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </li>
                `;
            });
            
            list.innerHTML = html;
        }

        // Load Journal Notes
        function loadJournalNotes() {
            const notes = tradingPlan.journalNotes || '';
            document.getElementById('journalNotes').value = notes;
        }

        // Open Modal
        function openModal(type) {
            // Close any open modals first
            closeAllModals();
            
            // Load current data into modal
            loadModalData(type);
            
            // Show modal
            document.getElementById(`${type}Modal`).classList.add('active');
        }

        // Close Modal
        function closeModal(type) {
            document.getElementById(`${type}Modal`).classList.remove('active');
        }

        // Close All Modals
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // Load Modal Data
        function loadModalData(type) {
            if (!tradingPlan) return;

            switch(type) {
                case 'risk':
                    const risk = tradingPlan.riskManagement;
                    document.getElementById('maxDailyLoss').value = risk.maxDailyLoss || '';
                    document.getElementById('maxTradeRisk').value = risk.maxTradeRisk || '';
                    document.getElementById('riskPerTradePercent').value = risk.riskPerTradePercent || '';
                    document.getElementById('maxConsecutiveLosses').value = risk.maxConsecutiveLosses || '';
                    document.getElementById('riskNotes').value = risk.notes || '';
                    break;
                    
                case 'session':
                    const session = tradingPlan.tradingSession;
                    document.getElementById('primarySession').value = session.primarySession || 'London';
                    document.getElementById('secondarySession').value = session.secondarySession || '';
                    document.getElementById('maxTradingHours').value = session.maxTradingHours || '';
                    document.getElementById('breakTime').value = session.breakTime || '';
                    
                    // Checkboxes
                    const days = session.tradingDays || [];
                    document.getElementById('monday').checked = days.includes('Monday');
                    document.getElementById('tuesday').checked = days.includes('Tuesday');
                    document.getElementById('wednesday').checked = days.includes('Wednesday');
                    document.getElementById('thursday').checked = days.includes('Thursday');
                    document.getElementById('friday').checked = days.includes('Friday');
                    break;
                    
                case 'pairs':
                    const pairs = tradingPlan.currencyPairs;
                    document.getElementById('maxPairsPerSession').value = pairs.maxPairsPerSession || '';
                    document.getElementById('pairCriteria').value = pairs.pairCriteria || '';
                    document.getElementById('avoidNews').checked = pairs.avoidNews || false;
                    
                    // Checkboxes
                    const primaryPairs = pairs.primaryPairs || [];
                    document.getElementById('eurusd').checked = primaryPairs.includes('EUR/USD');
                    document.getElementById('gbpusd').checked = primaryPairs.includes('GBP/USD');
                    document.getElementById('usdjpy').checked = primaryPairs.includes('USD/JPY');
                    document.getElementById('audusd').checked = primaryPairs.includes('AUD/USD');
                    document.getElementById('usdcad').checked = primaryPairs.includes('USD/CAD');
                    break;
                    
                case 'entry':
                    const entry = tradingPlan.entryCriteria;
                    document.getElementById('timeframeAnalysis').value = entry.timeframeAnalysis || '';
                    document.getElementById('minRR').value = entry.minRR || '';
                    document.getElementById('entryRules').value = entry.entryRules || '';
                    
                    // Checkboxes
                    const concepts = entry.ictConcepts || [];
                    document.getElementById('fvg').checked = concepts.includes('FVG');
                    document.getElementById('ob').checked = concepts.includes('Order Block');
                    document.getElementById('bos').checked = concepts.includes('BOS');
                    document.getElementById('choch').checked = concepts.includes('CHoCH');
                    document.getElementById('liquidity').checked = concepts.includes('Liquidity Grab');
                    document.getElementById('mitigation').checked = concepts.includes('Mitigation Block');
                    
                    const confirmations = entry.confirmationRequired || [];
                    document.getElementById('priceAction').checked = confirmations.includes('Price Action Confirmation');
                    document.getElementById('marketStructure').checked = confirmations.includes('Market Structure Alignment');
                    document.getElementById('momentum').checked = confirmations.includes('Momentum Confirmation');
                    document.getElementById('volume').checked = confirmations.includes('Volume Confirmation');
                    break;
                    
                case 'exit':
                    const exit = tradingPlan.exitStrategy;
                    document.getElementById('takeProfitLevels').value = exit.takeProfitLevels || '';
                    document.getElementById('stopLossPlacement').value = exit.stopLossPlacement || '';
                    document.getElementById('breakevenRules').value = exit.breakevenRules || '';
                    document.getElementById('trailingStopRules').value = exit.trailingStopRules || '';
                    
                    // Checkboxes
                    const conditions = exit.exitConditions || [];
                    document.getElementById('targetHit').checked = conditions.includes('Target Hit');
                    document.getElementById('structureBreak').checked = conditions.includes('Market Structure Break');
                    document.getElementById('timeExit').checked = conditions.includes('Time-based Exit');
                    document.getElementById('newsExit').checked = conditions.includes('Exit Before High-Impact News');
                    break;
                    
                case 'psychology':
                    const psychology = tradingPlan.psychologyRules;
                    document.getElementById('maxEmotionScore').value = psychology.maxEmotionScore || '';
                    document.getElementById('afterLossRules').value = psychology.afterLossRules || '';
                    document.getElementById('afterWinRules').value = psychology.afterWinRules || '';
                    document.getElementById('relaxationTechniques').value = psychology.relaxationTechniques || '';
                    document.getElementById('preTradeRoutine').value = psychology.preTradeRoutine || '';
                    document.getElementById('postTradeReview').value = psychology.postTradeReview || '';
                    break;
                    
                case 'templates':
                    // Clear form for new template
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateDescription').value = '';
                    document.getElementById('templateEntry').value = '';
                    document.getElementById('templateSL').value = '';
                    document.getElementById('templateTP').value = '';
                    document.getElementById('templateRR').value = '';
                    document.getElementById('templateSuccessRate').value = '';
                    break;
                    
                case 'rules':
                    document.getElementById('newRule').value = '';
                    break;
            }
        }

        // Save Risk Management
        async function saveRiskManagement() {
            try {
                tradingPlan.riskManagement = {
                    maxDailyLoss: document.getElementById('maxDailyLoss').value,
                    maxTradeRisk: document.getElementById('maxTradeRisk').value,
                    riskPerTradePercent: parseFloat(document.getElementById('riskPerTradePercent').value) || 1.5,
                    maxConsecutiveLosses: parseInt(document.getElementById('maxConsecutiveLosses').value) || 3,
                    notes: document.getElementById('riskNotes').value
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updateRiskManagementUI();
                closeModal('risk');
                
                showNotification('Risk management saved successfully', 'success');
            } catch (error) {
                console.error('Error saving risk management:', error);
                showNotification('Failed to save risk management', 'error');
            }
        }

        // Save Trading Session
        async function saveTradingSession() {
            try {
                const tradingDays = [];
                if (document.getElementById('monday').checked) tradingDays.push('Monday');
                if (document.getElementById('tuesday').checked) tradingDays.push('Tuesday');
                if (document.getElementById('wednesday').checked) tradingDays.push('Wednesday');
                if (document.getElementById('thursday').checked) tradingDays.push('Thursday');
                if (document.getElementById('friday').checked) tradingDays.push('Friday');
                
                tradingPlan.tradingSession = {
                    primarySession: document.getElementById('primarySession').value,
                    secondarySession: document.getElementById('secondarySession').value || '',
                    tradingDays: tradingDays,
                    maxTradingHours: parseInt(document.getElementById('maxTradingHours').value) || 4,
                    breakTime: parseInt(document.getElementById('breakTime').value) || 30
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updateTradingSessionUI();
                closeModal('session');
                
                showNotification('Trading session saved successfully', 'success');
            } catch (error) {
                console.error('Error saving trading session:', error);
                showNotification('Failed to save trading session', 'error');
            }
        }

        // Save Currency Pairs
        async function saveCurrencyPairs() {
            try {
                const primaryPairs = [];
                if (document.getElementById('eurusd').checked) primaryPairs.push('EUR/USD');
                if (document.getElementById('gbpusd').checked) primaryPairs.push('GBP/USD');
                if (document.getElementById('usdjpy').checked) primaryPairs.push('USD/JPY');
                if (document.getElementById('audusd').checked) primaryPairs.push('AUD/USD');
                if (document.getElementById('usdcad').checked) primaryPairs.push('USD/CAD');
                
                tradingPlan.currencyPairs = {
                    primaryPairs: primaryPairs,
                    maxPairsPerSession: parseInt(document.getElementById('maxPairsPerSession').value) || 2,
                    pairCriteria: document.getElementById('pairCriteria').value,
                    avoidNews: document.getElementById('avoidNews').checked
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updateCurrencyPairsUI();
                closeModal('pairs');
                
                showNotification('Currency pairs saved successfully', 'success');
            } catch (error) {
                console.error('Error saving currency pairs:', error);
                showNotification('Failed to save currency pairs', 'error');
            }
        }

        // Save Entry Criteria
        async function saveEntryCriteria() {
            try {
                const ictConcepts = [];
                if (document.getElementById('fvg').checked) ictConcepts.push('FVG');
                if (document.getElementById('ob').checked) ictConcepts.push('Order Block');
                if (document.getElementById('bos').checked) ictConcepts.push('BOS');
                if (document.getElementById('choch').checked) ictConcepts.push('CHoCH');
                if (document.getElementById('liquidity').checked) ictConcepts.push('Liquidity Grab');
                if (document.getElementById('mitigation').checked) ictConcepts.push('Mitigation Block');
                
                const confirmationRequired = [];
                if (document.getElementById('priceAction').checked) confirmationRequired.push('Price Action Confirmation');
                if (document.getElementById('marketStructure').checked) confirmationRequired.push('Market Structure Alignment');
                if (document.getElementById('momentum').checked) confirmationRequired.push('Momentum Confirmation');
                if (document.getElementById('volume').checked) confirmationRequired.push('Volume Confirmation');
                
                tradingPlan.entryCriteria = {
                    ictConcepts: ictConcepts,
                    timeframeAnalysis: document.getElementById('timeframeAnalysis').value,
                    confirmationRequired: confirmationRequired,
                    minRR: document.getElementById('minRR').value,
                    entryRules: document.getElementById('entryRules').value
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updateEntryCriteriaUI();
                closeModal('entry');
                
                showNotification('Entry criteria saved successfully', 'success');
            } catch (error) {
                console.error('Error saving entry criteria:', error);
                showNotification('Failed to save entry criteria', 'error');
            }
        }

        // Save Exit Strategy
        async function saveExitStrategy() {
            try {
                const exitConditions = [];
                if (document.getElementById('targetHit').checked) exitConditions.push('Target Hit');
                if (document.getElementById('structureBreak').checked) exitConditions.push('Market Structure Break');
                if (document.getElementById('timeExit').checked) exitConditions.push('Time-based Exit');
                if (document.getElementById('newsExit').checked) exitConditions.push('Exit Before High-Impact News');
                
                tradingPlan.exitStrategy = {
                    takeProfitLevels: document.getElementById('takeProfitLevels').value,
                    stopLossPlacement: document.getElementById('stopLossPlacement').value,
                    breakevenRules: document.getElementById('breakevenRules').value,
                    trailingStopRules: document.getElementById('trailingStopRules').value,
                    exitConditions: exitConditions
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updateExitStrategyUI();
                closeModal('exit');
                
                showNotification('Exit strategy saved successfully', 'success');
            } catch (error) {
                console.error('Error saving exit strategy:', error);
                showNotification('Failed to save exit strategy', 'error');
            }
        }

        // Save Psychology Rules
        async function savePsychologyRules() {
            try {
                tradingPlan.psychologyRules = {
                    maxEmotionScore: parseInt(document.getElementById('maxEmotionScore').value) || 7,
                    afterLossRules: document.getElementById('afterLossRules').value,
                    afterWinRules: document.getElementById('afterWinRules').value,
                    relaxationTechniques: document.getElementById('relaxationTechniques').value,
                    preTradeRoutine: document.getElementById('preTradeRoutine').value,
                    postTradeReview: document.getElementById('postTradeReview').value
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                updatePsychologyRulesUI();
                closeModal('psychology');
                
                showNotification('Psychology rules saved successfully', 'success');
            } catch (error) {
                console.error('Error saving psychology rules:', error);
                showNotification('Failed to save psychology rules', 'error');
            }
        }

        // Save Template
        async function saveTemplate() {
            try {
                const template = {
                    name: document.getElementById('templateName').value,
                    description: document.getElementById('templateDescription').value,
                    entry: document.getElementById('templateEntry').value,
                    sl: document.getElementById('templateSL').value,
                    tp: document.getElementById('templateTP').value,
                    rr: document.getElementById('templateRR').value,
                    successRate: parseInt(document.getElementById('templateSuccessRate').value) || 50,
                    created: Date.now()
                };
                
                if (!template.name) {
                    showNotification('Template name is required', 'error');
                    return;
                }
                
                if (!tradingPlan.templates) {
                    tradingPlan.templates = [];
                }
                
                tradingPlan.templates.push(template);
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                loadTemplates();
                closeModal('templates');
                
                showNotification('Template saved successfully', 'success');
            } catch (error) {
                console.error('Error saving template:', error);
                showNotification('Failed to save template', 'error');
            }
        }

        // Edit Template
        function editTemplate(index) {
            const template = tradingPlan.templates[index];
            
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description;
            document.getElementById('templateEntry').value = template.entry;
            document.getElementById('templateSL').value = template.sl;
            document.getElementById('templateTP').value = template.tp;
            document.getElementById('templateRR').value = template.rr;
            document.getElementById('templateSuccessRate').value = template.successRate;
            
            // Change modal to edit mode
            const modal = document.getElementById('templatesModal');
            const title = modal.querySelector('.modal-title');
            const saveBtn = modal.querySelector('.header-btn.primary');
            
            title.innerHTML = '<i class="fas fa-edit"></i> Edit Template';
            saveBtn.innerHTML = 'Update Template';
            saveBtn.onclick = function() { updateTemplate(index); };
            
            openModal('templates');
        }

        // Update Template
        async function updateTemplate(index) {
            try {
                tradingPlan.templates[index] = {
                    name: document.getElementById('templateName').value,
                    description: document.getElementById('templateDescription').value,
                    entry: document.getElementById('templateEntry').value,
                    sl: document.getElementById('templateSL').value,
                    tp: document.getElementById('templateTP').value,
                    rr: document.getElementById('templateRR').value,
                    successRate: parseInt(document.getElementById('templateSuccessRate').value) || 50,
                    created: tradingPlan.templates[index].created,
                    updated: Date.now()
                };
                
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                loadTemplates();
                closeModal('templates');
                
                showNotification('Template updated successfully', 'success');
            } catch (error) {
                console.error('Error updating template:', error);
                showNotification('Failed to update template', 'error');
            }
        }

        // Add Trading Rule
        async function addTradingRule() {
            try {
                const newRule = document.getElementById('newRule').value.trim();
                
                if (!newRule) {
                    showNotification('Please enter a trading rule', 'error');
                    return;
                }
                
                if (!tradingPlan.tradingRules) {
                    tradingPlan.tradingRules = [];
                }
                
                tradingPlan.tradingRules.push(newRule);
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                loadTradingRules();
                closeModal('rules');
                
                showNotification('Trading rule added successfully', 'success');
            } catch (error) {
                console.error('Error adding trading rule:', error);
                showNotification('Failed to add trading rule', 'error');
            }
        }

        // Remove Trading Rule
        async function removeRule(index) {
            if (confirm('Are you sure you want to remove this trading rule?')) {
                try {
                    tradingPlan.tradingRules.splice(index, 1);
                    tradingPlan.lastUpdated = Date.now();
                    unsavedChanges = true;
                    
                    await saveTradingPlanToFirebase();
                    loadTradingRules();
                    
                    showNotification('Trading rule removed', 'success');
                } catch (error) {
                    console.error('Error removing trading rule:', error);
                    showNotification('Failed to remove trading rule', 'error');
                }
            }
        }

        // Save Journal Notes
        async function saveJournalNotes() {
            try {
                const notes = document.getElementById('journalNotes').value;
                tradingPlan.journalNotes = notes;
                tradingPlan.lastUpdated = Date.now();
                unsavedChanges = true;
                
                await saveTradingPlanToFirebase();
                
                showNotification('Journal notes saved successfully', 'success');
            } catch (error) {
                console.error('Error saving journal notes:', error);
                showNotification('Failed to save journal notes', 'error');
            }
        }

        // Clear Journal Notes
        function clearJournalNotes() {
            if (confirm('Are you sure you want to clear all journal notes?')) {
                document.getElementById('journalNotes').value = '';
            }
        }

        // Save All Changes
        async function saveAllChanges() {
            try {
                // Save any pending notes
                await saveJournalNotes();
                
                // Update timestamp
                tradingPlan.lastUpdated = Date.now();
                
                // Save to Firebase
                await saveTradingPlanToFirebase();
                
                unsavedChanges = false;
                showNotification('All changes saved successfully', 'success');
            } catch (error) {
                console.error('Error saving all changes:', error);
                showNotification('Failed to save changes', 'error');
            }
        }

        // Reset to Default
        async function resetToDefault() {
            if (confirm('Are you sure you want to reset your trading plan to default? This will delete all your custom settings.')) {
                try {
                    tradingPlan = createDefaultTradingPlan();
                    tradingPlan.lastUpdated = Date.now();
                    unsavedChanges = true;
                    
                    await saveTradingPlanToFirebase();
                    updatePlanUI();
                    loadTemplates();
                    loadTradingRules();
                    loadJournalNotes();
                    
                    showNotification('Trading plan reset to default', 'success');
                } catch (error) {
                    console.error('Error resetting trading plan:', error);
                    showNotification('Failed to reset trading plan', 'error');
                }
            }
        }

        // Save Trading Plan to Firebase
        async function saveTradingPlanToFirebase() {
            if (!currentUser) return;
            
            try {
                await database.ref('userTradingPlans/' + currentUser.uid).set(tradingPlan);
                updateSyncStatus('Changes saved to cloud', 'synced');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                updateSyncStatus('Failed to save to cloud', 'error');
                throw error;
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Update Sync Status
        function updateSyncStatus(message, status) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'sync-status ' + status;
                
                const icon = status === 'synced' ? 'fa-cloud' : 
                            status === 'syncing' ? 'fa-sync fa-spin' : 
                            'fa-cloud-slash';
                statusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                
                // Also update mobile menu sync status
                const mobileStatus = document.querySelector('.mobile-menu .sync-status');
                if (mobileStatus) {
                    mobileStatus.textContent = message;
                    mobileStatus.className = 'sync-status ' + status;
                    mobileStatus.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                }
            }
        }
    </script>
</body>
</html>
