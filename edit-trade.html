<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Trade - ICT Scalping Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-gray: #f7f6f3;
            --notion-gray-light: #fbfbfa;
            --notion-gray-dark: #e9e9e7;
            --notion-text: #37352f;
            --notion-text-light: #70716e;
            --notion-blue: #0c8ce9;
            --notion-blue-light: #e3f2fd;
            --notion-green: #0f7b6c;
            --notion-green-light: #e8f5e9;
            --notion-red: #d1453b;
            --notion-red-light: #ffebee;
            --notion-purple: #6940a5;
            --notion-purple-light: #f3e5f5;
            --notion-yellow: #ffc800;
            --notion-yellow-light: #fff8e1;
            --notion-orange: #ff6b35;
            --notion-orange-light: #fff3e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sync-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sync-status.syncing {
            background-color: var(--notion-yellow-light);
            color: var(--notion-yellow);
        }

        .sync-status.synced {
            background-color: var(--notion-green-light);
            color: var(--notion-green);
        }

        .sync-status.error {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
        }

        .header-btn {
            padding: 4px 12px;
            background-color: var(--notion-gray);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
        }

        .header-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        .header-btn.green {
            background-color: var(--notion-green);
            color: white;
        }

        .header-btn.red {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
            border: 1px solid var(--notion-red);
        }

        .header-btn.logout {
            background-color: var(--notion-red-light);
            color: var(--notion-red);
            border: 1px solid var(--notion-red);
        }

        .header-btn.logout:hover {
            background-color: var(--notion-red);
            color: white;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--notion-text);
            cursor: pointer;
            padding: 4px;
            margin-left: auto;
        }

        /* Mobile Menu */
        .mobile-menu {
            display: none;
            position: fixed;
            top: 45px;
            left: 0;
            right: 0;
            background-color: var(--notion-bg);
            border-bottom: 1px solid var(--notion-gray-dark);
            padding: 16px;
            z-index: 99;
            flex-direction: column;
            gap: 8px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu .header-btn {
            width: 100%;
            justify-content: center;
            padding: 10px 16px;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 60px auto 20px;
            padding: 0 20px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--notion-text);
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--notion-text-light);
            margin-bottom: 24px;
        }

        /* Form Container */
        .form-container {
            background-color: white;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--notion-text);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--notion-gray-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--notion-blue);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-label.optional::after {
            content: "(optional)";
            font-weight: 400;
            color: var(--notion-text-light);
            margin-left: 6px;
            font-size: 12px;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 16px;
            border: 1px solid var(--notion-gray-dark);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            transition: all 0.3s ease;
            width: 100%;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--notion-blue);
            box-shadow: 0 0 0 3px rgba(12, 140, 233, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-hint {
            font-size: 12px;
            color: var(--notion-text-light);
            margin-top: 4px;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-input {
            display: none;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--notion-gray-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .radio-custom::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--notion-blue);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .radio-input:checked + .radio-custom {
            border-color: var(--notion-blue);
        }

        .radio-input:checked + .radio-custom::after {
            opacity: 1;
        }

        .radio-label {
            font-size: 14px;
            color: var(--notion-text);
        }

        /* Radio Buttons with Colors */
        .radio-option.buy .radio-custom {
            border-color: var(--notion-green);
        }

        .radio-option.buy .radio-input:checked + .radio-custom {
            background-color: var(--notion-green-light);
            border-color: var(--notion-green);
        }

        .radio-option.buy .radio-input:checked + .radio-custom::after {
            background-color: var(--notion-green);
        }

        .radio-option.sell .radio-custom {
            border-color: var(--notion-red);
        }

        .radio-option.sell .radio-input:checked + .radio-custom {
            background-color: var(--notion-red-light);
            border-color: var(--notion-red);
        }

        .radio-option.sell .radio-input:checked + .radio-custom::after {
            background-color: var(--notion-red);
        }

        .radio-option.win .radio-custom {
            border-color: var(--notion-green);
        }

        .radio-option.win .radio-input:checked + .radio-custom {
            background-color: var(--notion-green-light);
            border-color: var(--notion-green);
        }

        .radio-option.win .radio-input:checked + .radio-custom::after {
            background-color: var(--notion-green);
        }

        .radio-option.loss .radio-custom {
            border-color: var(--notion-red);
        }

        .radio-option.loss .radio-input:checked + .radio-custom {
            background-color: var(--notion-red-light);
            border-color: var(--notion-red);
        }

        .radio-option.loss .radio-input:checked + .radio-custom::after {
            background-color: var(--notion-red);
        }

        .radio-option.be .radio-custom {
            border-color: var(--notion-gray);
        }

        .radio-option.be .radio-input:checked + .radio-custom {
            background-color: var(--notion-gray);
            border-color: var(--notion-gray-dark);
        }

        .radio-option.be .radio-input:checked + .radio-custom::after {
            background-color: var(--notion-gray-dark);
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--notion-blue);
        }

        .slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--notion-gray);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--notion-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--notion-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--notion-gray-light);
        }

        .action-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
        }

        .action-btn.primary {
            background-color: var(--notion-blue);
            color: white;
        }

        .action-btn.primary:hover {
            background-color: #0a7ac9;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background-color: var(--notion-gray);
            color: var(--notion-text);
        }

        .action-btn.secondary:hover {
            background-color: var(--notion-gray-dark);
        }

        .action-btn.red {
            background-color: var(--notion-red);
            color: white;
        }

        .action-btn.red:hover {
            background-color: #c0392b;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            color: var(--notion-text-light);
        }

        .loading i {
            margin-right: 12px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.success {
            background-color: var(--notion-green);
        }

        .notification.error {
            background-color: var(--notion-red);
        }

        .notification.info {
            background-color: var(--notion-blue);
        }

        .notification.warning {
            background-color: var(--notion-orange);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 45px auto 20px;
                padding: 0 16px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            /* Show mobile menu button and hide regular header actions */
            .mobile-menu-btn {
                display: block;
            }
            
            .header-actions {
                display: none;
            }
            
            .sync-status {
                display: none;
            }
            
            .header-title {
                font-size: 13px;
                max-width: 150px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .mobile-menu-btn {
                font-size: 16px;
            }
            
            .header-title {
                font-size: 12px;
                max-width: 120px;
            }
            
            .mobile-menu .header-btn {
                font-size: 14px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* Trade Preview */
        .trade-preview {
            background-color: var(--notion-gray-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--notion-gray-dark);
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .preview-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-label {
            font-size: 12px;
            color: var(--notion-text-light);
        }

        .preview-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--notion-text);
        }

        .preview-value.positive {
            color: var(--notion-green);
        }

        .preview-value.negative {
            color: var(--notion-red);
        }

        /* P/L Calculator */
        .pl-calculator {
            background-color: var(--notion-gray-light);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calculator-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--notion-gray-dark);
        }

        .calculator-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .calculator-value {
            font-size: 20px;
            font-weight: 700;
        }

        .calculator-value.positive {
            color: var(--notion-green);
        }

        .calculator-value.negative {
            color: var(--notion-red);
        }

        /* Delete Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--notion-gray-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--notion-text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--notion-text-light);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--notion-gray-dark);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Error Message */
        .error-message {
            color: var(--notion-red);
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--notion-red);
        }
        
        /* Optional Indicator */
        .optional-indicator {
            color: var(--notion-text-light);
            font-weight: 400;
            font-size: 12px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="workspace-icon" style="width: 20px; height: 20px; background-color: var(--notion-blue); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">T</div>
        <div class="header-title">ICT Scalping Journal - Edit Trade</div>
        
        <!-- Desktop Header Actions -->
        <div class="header-actions">
            <div class="sync-status synced" id="syncStatus">
                <i class="fas fa-cloud"></i> Synced
            </div>
            <a href="dashboard.html" class="header-btn">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="all-trades.html" class="header-btn primary">
                <i class="fas fa-list"></i> All Trades
            </a>
            <a href="add-trade.html" class="header-btn">
                <i class="fas fa-plus"></i> Add Trade
            </a>
            <button class="header-btn logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="sync-status synced">
            <i class="fas fa-cloud"></i> Synced
        </div>
        <a href="dashboard.html" class="header-btn">
            <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="all-trades.html" class="header-btn primary">
            <i class="fas fa-list"></i> All Trades
        </a>
        <a href="add-trade.html" class="header-btn">
            <i class="fas fa-plus"></i> Add Trade
        </a>
        <button class="header-btn logout" id="mobileLogoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">✏️ Edit Trade</h1>
            <p class="page-subtitle">Update your trade details - All fields are optional</p>
        </div>

        <!-- Trade Preview -->
        <div class="trade-preview" id="tradePreview" style="display: none;">
            <div class="preview-title">
                <i class="fas fa-eye"></i> Trade Preview
            </div>
            <div class="preview-content" id="previewContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Form Container -->
        <div class="form-container" id="formContainer">
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading trade data...
            </div>
            
            <form id="editTradeForm" style="display: none;">
                <!-- Basic Information Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i> Basic Information
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-calendar-alt"></i> Trade Date
                            </label>
                            <input type="datetime-local" class="form-input" id="tradeDate">
                            <div class="form-hint">When the trade was executed</div>
                            <div class="error-message" id="dateError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-money-bill-wave"></i> Currency Pair
                            </label>
                            <select class="form-select" id="currencyPair">
                                <option value="">Select pair (optional)</option>
                                <option value="EURUSD">EUR/USD</option>
                                <option value="GBPUSD">GBP/USD</option>
                                <option value="USDJPY">USD/JPY</option>
                                <option value="AUDUSD">AUD/USD</option>
                                <option value="USDCAD">USD/CAD</option>
                                <option value="NZDUSD">NZD/USD</option>
                                <option value="USDCHF">USD/CHF</option>
                            </select>
                            <div class="error-message" id="pairError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-arrow-up"></i> Trade Direction
                            </label>
                            <div class="radio-group">
                                <label class="radio-option buy">
                                    <input type="radio" name="direction" value="Buy" class="radio-input" id="directionBuy">
                                    <span class="radio-custom"></span>
                                    <span class="radio-label">Buy</span>
                                </label>
                                <label class="radio-option sell">
                                    <input type="radio" name="direction" value="Sell" class="radio-input" id="directionSell">
                                    <span class="radio-custom"></span>
                                    <span class="radio-label">Sell</span>
                                </label>
                            </div>
                            <div class="error-message" id="directionError"></div>
                        </div>
                    </div>
                </div>

                <!-- Entry & Exit Points Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i> Entry & Exit Points
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-sign-in-alt"></i> Entry Price
                            </label>
                            <input type="number" step="0.00001" class="form-input" id="entryPrice" placeholder="e.g., 1.12345">
                            <div class="error-message" id="entryError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-stop-circle"></i> Stop Loss
                            </label>
                            <input type="number" step="0.00001" class="form-input" id="stopLoss" placeholder="e.g., 1.12000">
                            <div class="error-message" id="stopLossError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-bullseye"></i> Take Profit
                            </label>
                            <input type="number" step="0.00001" class="form-input" id="takeProfit" placeholder="e.g., 1.13000">
                            <div class="error-message" id="takeProfitError"></div>
                        </div>
                    </div>
                    
                    <!-- P/L Calculator -->
                    <div class="pl-calculator" id="plCalculator" style="display: none;">
                        <div class="calculator-title">
                            <i class="fas fa-calculator"></i> P/L Calculator
                        </div>
                        <div class="calculator-result">
                            <span class="calculator-label">Estimated P/L:</span>
                            <span class="calculator-value" id="estimatedPL">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Risk Management Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-shield-alt"></i> Risk Management
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-percentage"></i> Risk Percentage (%)
                            </label>
                            <input type="number" step="0.01" min="0.01" max="10" class="form-input" id="riskPercent" placeholder="e.g., 2.00">
                            <div class="form-hint">Percentage of account risked on this trade</div>
                            <div class="error-message" id="riskError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-balance-scale"></i> Risk/Reward Ratio
                            </label>
                            <input type="text" class="form-input" id="riskReward" placeholder="e.g., 1:2">
                            <div class="form-hint">Format: Risk:Reward (e.g., 1:3)</div>
                            <div class="error-message" id="rrError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-dollar-sign"></i> Position Size
                            </label>
                            <input type="number" step="0.01" class="form-input" id="positionSize" placeholder="e.g., 1000">
                            <div class="form-hint">Size in units (e.g., 1000 for 0.01 lot)</div>
                            <div class="error-message" id="sizeError"></div>
                        </div>
                    </div>
                </div>

                <!-- Trading Context Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-brain"></i> Trading Context
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-cogs"></i> ICT Model
                            </label>
                            <select class="form-select" id="ictModel">
                                <option value="">Select model (optional)</option>
                                <option value="FVG">Fair Value Gap</option>
                                <option value="OB">Order Block</option>
                                <option value="BOS">Break of Structure</option>
                                <option value="CHoCH">Change of Character</option>
                                <option value="Liquidity">Liquidity Grab</option>
                                <option value="MIT">Market Imbalance</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="modelError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-clock"></i> Trading Session
                            </label>
                            <select class="form-select" id="tradingSession">
                                <option value="">Select session (optional)</option>
                                <option value="London">London</option>
                                <option value="New York">New York</option>
                                <option value="Asian">Asian</option>
                                <option value="Sydney">Sydney</option>
                                <option value="Overlap">Overlap</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="sessionError"></div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-cloud-sun"></i> Market Condition
                            </label>
                            <select class="form-select" id="marketCondition">
                                <option value="">Select condition (optional)</option>
                                <option value="Trending">Trending</option>
                                <option value="Ranging">Ranging</option>
                                <option value="Volatile">Volatile</option>
                                <option value="Consolidating">Consolidating</option>
                                <option value="Breakout">Breakout</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-chart-bar"></i> Timeframe
                            </label>
                            <select class="form-select" id="timeframe">
                                <option value="">Select timeframe (optional)</option>
                                <option value="1m">1 Minute</option>
                                <option value="5m">5 Minutes</option>
                                <option value="15m">15 Minutes</option>
                                <option value="1H">1 Hour</option>
                                <option value="4H">4 Hours</option>
                                <option value="1D">Daily</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Trade Result Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-trophy"></i> Trade Result
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-flag-checkered"></i> Trade Result
                            </label>
                            <div class="radio-group">
                                <label class="radio-option win">
                                    <input type="radio" name="result" value="Win" class="radio-input" id="resultWin">
                                    <span class="radio-custom"></span>
                                    <span class="radio-label">Win</span>
                                </label>
                                <label class="radio-option loss">
                                    <input type="radio" name="result" value="Loss" class="radio-input" id="resultLoss">
                                    <span class="radio-custom"></span>
                                    <span class="radio-label">Loss</span>
                                </label>
                                <label class="radio-option be">
                                    <input type="radio" name="result" value="Break Even" class="radio-input" id="resultBE">
                                    <span class="radio-custom"></span>
                                    <span class="radio-label">Break Even</span>
                                </label>
                            </div>
                            <div class="error-message" id="resultError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-dollar-sign"></i> P/L Amount ($)
                            </label>
                            <input type="number" step="0.01" class="form-input" id="plAmount" placeholder="e.g., 150.50 or -75.25">
                            <div class="form-hint">Positive for profit, negative for loss</div>
                            <div class="error-message" id="plError"></div>
                        </div>
                    </div>
                </div>

                <!-- Psychology Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-brain"></i> Psychology & Notes
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-brain"></i> Emotion Before Trade (1-10)
                            </label>
                            <div class="slider-container">
                                <input type="range" min="1" max="10" value="5" class="slider" id="emotionBefore">
                                <span class="slider-value" id="emotionBeforeValue">5</span>
                            </div>
                            <div class="form-hint">1 = Very nervous, 10 = Very confident</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label optional">
                                <i class="fas fa-brain"></i> Emotion After Trade (1-10)
                            </label>
                            <div class="slider-container">
                                <input type="range" min="1" max="10" value="5" class="slider" id="emotionAfter">
                                <span class="slider-value" id="emotionAfterValue">5</span>
                            </div>
                            <div class="form-hint">1 = Very stressed, 10 = Very satisfied</div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label optional">
                            <i class="fas fa-sticky-note"></i> Trade Notes & Analysis
                        </label>
                        <textarea class="form-textarea" id="tradeNotes" placeholder="Describe the trade setup, what went well, what could be improved, lessons learned... (optional)"></textarea>
                        <div class="form-hint">What did you learn from this trade? This field is optional.</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label optional">
                            <i class="fas fa-images"></i> Screenshot URL
                        </label>
                        <input type="url" class="form-input" id="screenshotUrl" placeholder="https://example.com/screenshot.png (optional)">
                        <div class="form-hint">Link to trade screenshot (optional)</div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="action-btn secondary" id="cancelBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="action-btn red" id="deleteBtn">
                        <i class="fas fa-trash"></i> Delete Trade
                    </button>
                    <button type="submit" class="action-btn primary" id="saveBtn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete</h3>
                <button class="modal-close" id="closeDeleteModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this trade?</p>
                <p style="margin-top: 12px; color: var(--notion-text-light); font-size: 14px;">
                    This action cannot be undone. The trade will be permanently removed from your journal.
                </p>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancelDeleteBtn">
                    Cancel
                </button>
                <button class="action-btn red" id="confirmDeleteBtn">
                    Delete Trade
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.firebasestorage.app",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global Variables
        let currentTradeId = null;
        let originalTradeData = null;
        let currentUser = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Initialize Page
        function initializePage() {
            // Get trade ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentTradeId = urlParams.get('id');
            
            if (!currentTradeId) {
                showNotification('No trade ID provided. Redirecting to All Trades.', 'error');
                setTimeout(() => {
                    window.location.href = 'all-trades.html';
                }, 2000);
                return;
            }
            
            setupEventListeners();
            loadTradeData();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logoutUser);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (mobileMenu.classList.contains('active') && 
                    !mobileMenu.contains(event.target) && 
                    !mobileMenuBtn.contains(event.target)) {
                    mobileMenu.classList.remove('active');
                }
            });

            // Form actions
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            document.getElementById('deleteBtn').addEventListener('click', showDeleteModal);
            document.getElementById('saveBtn').addEventListener('click', saveTrade);
            
            // Modals
            document.getElementById('closeDeleteModalBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                const deleteModal = document.getElementById('deleteModal');
                
                if (event.target === deleteModal) {
                    closeDeleteModal();
                }
            });

            // Real-time calculations
            document.getElementById('entryPrice').addEventListener('input', calculatePL);
            document.getElementById('stopLoss').addEventListener('input', calculatePL);
            document.getElementById('takeProfit').addEventListener('input', calculatePL);
            document.getElementById('directionBuy').addEventListener('change', calculatePL);
            document.getElementById('directionSell').addEventListener('change', calculatePL);
            document.getElementById('riskPercent').addEventListener('input', calculatePL);
            document.getElementById('positionSize').addEventListener('input', calculatePL);
            
            // Sliders
            document.getElementById('emotionBefore').addEventListener('input', function() {
                document.getElementById('emotionBeforeValue').textContent = this.value;
            });
            
            document.getElementById('emotionAfter').addEventListener('input', function() {
                document.getElementById('emotionAfterValue').textContent = this.value;
            });
            
            // Real-time preview
            const formInputs = document.querySelectorAll('#editTradeForm input, #editTradeForm select, #editTradeForm textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
            });
            
            // Risk/Reward auto-calculation
            document.getElementById('entryPrice').addEventListener('blur', calculateRiskReward);
            document.getElementById('stopLoss').addEventListener('blur', calculateRiskReward);
            document.getElementById('takeProfit').addEventListener('blur', calculateRiskReward);
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Logout Function
        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    auth.signOut();
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userUid');
                    sessionStorage.clear();
                    
                    showNotification('Logged out successfully', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('Logout failed: ' + error.message, 'error');
                }
            }
        }

        // Load Trade Data
        async function loadTradeData() {
            try {
                updateSyncStatus('Loading trade data...', 'syncing');
                
                // Check authentication
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        
                        // Load trade from Firebase
                        const snapshot = await database.ref(`userTrades/${currentUser.uid}/trades/${currentTradeId}`).once('value');
                        
                        if (!snapshot.exists()) {
                            showNotification('Trade not found', 'error');
                            setTimeout(() => {
                                window.location.href = 'all-trades.html';
                            }, 2000);
                            return;
                        }
                        
                        originalTradeData = snapshot.val();
                        originalTradeData.id = currentTradeId;
                        
                        // Populate form
                        populateForm(originalTradeData);
                        
                        // Show form
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('editTradeForm').style.display = 'block';
                        document.getElementById('tradePreview').style.display = 'block';
                        
                        updateSyncStatus('Trade loaded', 'synced');
                        
                    } else {
                        // User not authenticated
                        showNotification('Please login to edit trades', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                });

            } catch (error) {
                console.error('Error loading trade:', error);
                updateSyncStatus('Failed to load trade', 'error');
                showNotification('Failed to load trade: ' + error.message, 'error');
                
                setTimeout(() => {
                    window.location.href = 'all-trades.html';
                }, 3000);
            }
        }

        // Populate Form with Trade Data
        function populateForm(trade) {
            // Format date for datetime-local input
            if (trade.date || trade.createdAt) {
                const tradeDate = new Date(trade.date || trade.createdAt);
                const formattedDate = tradeDate.toISOString().slice(0, 16);
                document.getElementById('tradeDate').value = formattedDate;
            }
            
            // Populate fields only if they exist in the trade data
            if (trade.pair) document.getElementById('currencyPair').value = trade.pair;
            if (trade.entry) document.getElementById('entryPrice').value = trade.entry;
            if (trade.stopLoss) document.getElementById('stopLoss').value = trade.stopLoss;
            if (trade.takeProfit) document.getElementById('takeProfit').value = trade.takeProfit;
            if (trade.riskPercent) document.getElementById('riskPercent').value = trade.riskPercent;
            if (trade.rr) document.getElementById('riskReward').value = trade.rr;
            if (trade.positionSize) document.getElementById('positionSize').value = trade.positionSize;
            if (trade.model) document.getElementById('ictModel').value = trade.model;
            if (trade.session) document.getElementById('tradingSession').value = trade.session;
            if (trade.marketCondition) document.getElementById('marketCondition').value = trade.marketCondition;
            if (trade.timeframe) document.getElementById('timeframe').value = trade.timeframe;
            if (trade.pl) document.getElementById('plAmount').value = trade.pl;
            if (trade.emotionBefore) {
                document.getElementById('emotionBefore').value = trade.emotionBefore;
                document.getElementById('emotionBeforeValue').textContent = trade.emotionBefore;
            }
            if (trade.emotionAfter) {
                document.getElementById('emotionAfter').value = trade.emotionAfter;
                document.getElementById('emotionAfterValue').textContent = trade.emotionAfter;
            }
            if (trade.notes) document.getElementById('tradeNotes').value = trade.notes;
            if (trade.screenshotUrl) document.getElementById('screenshotUrl').value = trade.screenshotUrl;
            
            // Set radio buttons only if they exist
            if (trade.direction === 'Buy') {
                document.getElementById('directionBuy').checked = true;
            } else if (trade.direction === 'Sell') {
                document.getElementById('directionSell').checked = true;
            }
            
            if (trade.result === 'Win') {
                document.getElementById('resultWin').checked = true;
            } else if (trade.result === 'Loss') {
                document.getElementById('resultLoss').checked = true;
            } else if (trade.result === 'Break Even') {
                document.getElementById('resultBE').checked = true;
            }
            
            // Calculate and update preview
            calculatePL();
            calculateRiskReward();
            updatePreview();
        }

        // Calculate P/L
        function calculatePL() {
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            const direction = document.querySelector('input[name="direction"]:checked')?.value;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 2;
            const positionSize = parseFloat(document.getElementById('positionSize').value) || 1000;
            
            // Only calculate if we have enough data
            if (!entry || !stopLoss || !takeProfit || !direction) {
                document.getElementById('plCalculator').style.display = 'none';
                return;
            }
            
            let estimatedPL = 0;
            
            if (direction === 'Buy') {
                estimatedPL = positionSize * (takeProfit - entry) * 100000; // Simplified calculation
            } else if (direction === 'Sell') {
                estimatedPL = positionSize * (entry - takeProfit) * 100000; // Simplified calculation
            }
            
            // Update P/L calculator
            document.getElementById('plCalculator').style.display = 'block';
            const plElement = document.getElementById('estimatedPL');
            plElement.textContent = estimatedPL >= 0 ? `+$${estimatedPL.toFixed(2)}` : `-$${Math.abs(estimatedPL).toFixed(2)}`;
            plElement.className = estimatedPL >= 0 ? 'calculator-value positive' : 'calculator-value negative';
        }

        // Calculate Risk/Reward Ratio
        function calculateRiskReward() {
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            const direction = document.querySelector('input[name="direction"]:checked')?.value;
            
            if (!entry || !stopLoss || !takeProfit || !direction) {
                return;
            }
            
            let risk = 0;
            let reward = 0;
            
            if (direction === 'Buy') {
                risk = entry - stopLoss;
                reward = takeProfit - entry;
            } else if (direction === 'Sell') {
                risk = stopLoss - entry;
                reward = entry - takeProfit;
            }
            
            if (risk > 0 && reward > 0) {
                const rrRatio = (reward / risk).toFixed(2);
                document.getElementById('riskReward').value = `1:${rrRatio}`;
            }
        }

        // Update Trade Preview
        function updatePreview() {
            const previewContent = document.getElementById('previewContent');
            
            const pair = document.getElementById('currencyPair').value || 'Not set';
            const direction = document.querySelector('input[name="direction"]:checked')?.value || 'Not set';
            const entry = document.getElementById('entryPrice').value || 'Not set';
            const stopLoss = document.getElementById('stopLoss').value || 'Not set';
            const takeProfit = document.getElementById('takeProfit').value || 'Not set';
            const result = document.querySelector('input[name="result"]:checked')?.value || 'Not set';
            const pl = document.getElementById('plAmount').value || '0';
            
            previewContent.innerHTML = `
                <div class="preview-item">
                    <span class="preview-label">Pair:</span>
                    <span class="preview-value">${pair}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Direction:</span>
                    <span class="preview-value ${direction === 'Buy' ? 'positive' : 'negative'}">${direction}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Entry:</span>
                    <span class="preview-value">${entry}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Stop Loss:</span>
                    <span class="preview-value">${stopLoss}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Take Profit:</span>
                    <span class="preview-value">${takeProfit}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Result:</span>
                    <span class="preview-value ${result === 'Win' ? 'positive' : result === 'Loss' ? 'negative' : ''}">${result}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">P/L:</span>
                    <span class="preview-value ${parseFloat(pl) >= 0 ? 'positive' : 'negative'}">${parseFloat(pl) >= 0 ? '+' : ''}$${Math.abs(parseFloat(pl) || 0).toFixed(2)}</span>
                </div>
            `;
        }

        // Validate Form - All fields are optional, only validate format
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-input.error, .form-select.error, .form-textarea.error').forEach(el => {
                el.classList.remove('error');
            });
            
            // Numeric fields validation (only if filled)
            const numericFields = [
                { id: 'entryPrice', message: 'Entry price must be a valid number' },
                { id: 'stopLoss', message: 'Stop loss must be a valid number' },
                { id: 'takeProfit', message: 'Take profit must be a valid number' },
                { id: 'riskPercent', message: 'Risk % must be a valid number' },
                { id: 'positionSize', message: 'Position size must be a valid number' },
                { id: 'plAmount', message: 'P/L must be a valid number' }
            ];
            
            numericFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element.value && element.value.trim() !== '' && isNaN(parseFloat(element.value))) {
                    showError(field.id, field.message);
                    isValid = false;
                }
            });
            
            // Date validation (only if filled)
            const dateValue = document.getElementById('tradeDate').value;
            if (dateValue) {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) {
                    showError('date', 'Please enter a valid date');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Show Error
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            if (errorElement) {
                errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            }
            
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        // Save Trade
        async function saveTrade() {
            if (!validateForm()) {
                showNotification('Please fix the errors in the form', 'error');
                return;
            }
            
            try {
                updateSyncStatus('Saving changes...', 'syncing');
                
                // Get form values - only include fields that are filled
                const tradeData = {};
                
            // Only add fields that have values
                const formFields = {
                    date: document.getElementById('tradeDate').value,
                    pair: document.getElementById('currencyPair').value,
                    direction: document.querySelector('input[name="direction"]:checked')?.value,
                    entry: document.getElementById('entryPrice').value,
                    stopLoss: document.getElementById('stopLoss').value,
                    takeProfit: document.getElementById('takeProfit').value,
                    riskPercent: document.getElementById('riskPercent').value,
                    rr: document.getElementById('riskReward').value,
                    positionSize: document.getElementById('positionSize').value,
                    model: document.getElementById('ictModel').value,
                    session: document.getElementById('tradingSession').value,
                    marketCondition: document.getElementById('marketCondition').value,
                    timeframe: document.getElementById('timeframe').value,
                    result: document.querySelector('input[name="result"]:checked')?.value,
                    pl: document.getElementById('plAmount').value,
                    emotionBefore: document.getElementById('emotionBefore').value,
                    emotionAfter: document.getElementById('emotionAfter').value,
                    notes: document.getElementById('tradeNotes').value,
                    screenshotUrl: document.getElementById('screenshotUrl').value,
                    updatedAt: Date.now()
                };
                
                // Add only non-empty values to tradeData
                Object.keys(formFields).forEach(key => {
                    if (formFields[key] !== undefined && formFields[key] !== null && formFields[key] !== '') {
                        // Parse numeric fields
                        if (['entry', 'stopLoss', 'takeProfit', 'riskPercent', 'positionSize', 'pl', 'emotionBefore', 'emotionAfter'].includes(key)) {
                            const numValue = parseFloat(formFields[key]);
                            if (!isNaN(numValue)) {
                                tradeData[key] = numValue;
                            }
                        } else {
                            tradeData[key] = formFields[key];
                        }
                    }
                });
                
                // Keep original createdAt if it exists
                if (originalTradeData && originalTradeData.createdAt) {
                    tradeData.createdAt = originalTradeData.createdAt;
                } else {
                    tradeData.createdAt = Date.now();
                }
                
                // Save to Firebase - only update fields that were modified
                await database.ref(`userTrades/${currentUser.uid}/trades/${currentTradeId}`).update(tradeData);
                
                updateSyncStatus('Changes saved', 'synced');
                showNotification('Trade updated successfully!', 'success');
                
                // Redirect to all trades after a delay
                setTimeout(() => {
                    window.location.href = 'all-trades.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving trade:', error);
                updateSyncStatus('Failed to save', 'error');
                showNotification('Failed to save trade: ' + error.message, 'error');
            }
        }

        // Cancel Edit
        function cancelEdit() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                window.location.href = 'all-trades.html';
            }
        }

        // Show Delete Modal
        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
        }

        // Close Delete Modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        // Confirm Delete
        async function confirmDelete() {
            try {
                updateSyncStatus('Deleting trade...', 'syncing');
                
                await database.ref(`userTrades/${currentUser.uid}/trades/${currentTradeId}`).remove();
                
                updateSyncStatus('Trade deleted', 'synced');
                showNotification('Trade deleted successfully', 'success');
                
                // Redirect to all trades after a delay
                setTimeout(() => {
                    window.location.href = 'all-trades.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error deleting trade:', error);
                updateSyncStatus('Failed to delete', 'error');
                showNotification('Failed to delete trade: ' + error.message, 'error');
            } finally {
                closeDeleteModal();
            }
        }

        // Update Sync Status
        function updateSyncStatus(message, status) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'sync-status ' + status;
                
                const icon = status === 'synced' ? 'fa-cloud' : 
                            status === 'syncing' ? 'fa-sync fa-spin' : 
                            'fa-cloud-slash';
                statusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                
                // Also update mobile menu sync status
                const mobileStatus = document.querySelector('.mobile-menu .sync-status');
                if (mobileStatus) {
                    mobileStatus.textContent = message;
                    mobileStatus.className = 'sync-status ' + status;
                    mobileStatus.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                }
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    </script>
</body>
</html>
